---
description: UDM Pro (UniFi Dream Machine Pro) connection reference — credentials, auth flow, known gotchas, and testing instructions. Applies when working on cameras, network, UniFi, Protect, or any home automation feature.
globs:
  - scripts/ptz-proxy/**
  - camera-event-poller/**
  - HOMEAUTOMATION*
  - supabase/functions/**/index.ts
  - residents/cameras*
  - shared/services/camera-data*
alwaysApply: false
---

# UniFi Dream Machine Pro — Connection Reference

## Network Reachability

The UDM Pro is at **`192.168.1.1`** on the property LAN (`192.168.1.0/24`).

| Location | Can reach UDM? | How |
|----------|---------------|-----|
| DO Droplet (`159.89.157.120`) | Yes | Tailscale subnet routing via Alpaca Mac |
| Alpaca Mac (home server) | Yes | Direct LAN (on Black Rock City WiFi) |
| Developer laptop / Cursor IDE | **No** | Not on LAN, no Tailscale — use `cam.alpacaplayhouse.com` proxy |
| Supabase Edge Functions | **No** | Must go through DO droplet proxy |
| Browser (client-side) | **No** | Must use `cam.alpacaplayhouse.com` proxy |

**If you're in a Cursor session and need to test the UDM Pro, you CANNOT reach `192.168.1.1` directly.** Use the public proxy endpoints instead (see Testing section below).

## Credentials

| Field | Value |
|-------|-------|
| **Host** | `192.168.1.1` (HTTPS, port 443, self-signed cert) |
| **Username** | `alpacaauto` (local-only admin account) |
| **Password** | Stored in `/opt/ptz-proxy/.env` and `/opt/camera-event-poller/.env` on the DO droplet (env var `UDM_PASS`). **NOT in this repo.** The password is in the gitignored `HOMEAUTOMATION.local.md`. |
| **Auth method** | Session cookie + CSRF token from JWT (NOT API keys) |

### Environment Variables (on DO Droplet)

```bash
UDM_HOST=192.168.1.1
UDM_USER=alpacaauto
UDM_PASS=<password from HOMEAUTOMATION.local.md>
```

Used by: `ptz-proxy` (`/opt/ptz-proxy/.env`), `camera-event-poller` (`/opt/camera-event-poller/.env`).

## Authentication Flow

1. `POST https://192.168.1.1/api/auth/login` with `{"username":"alpacaauto","password":"<UDM_PASS>"}`
2. Response sets a `TOKEN=<jwt>` cookie
3. Decode the JWT payload (base64) → extract `csrfToken` field
4. All subsequent requests must include:
   - `Cookie: TOKEN=<jwt>` header
   - `X-CSRF-Token: <csrfToken>` header
5. Sessions last ~24 hours; code refreshes every 12 hours
6. On 401 responses, re-authenticate and retry once

### Code Pattern (Node.js)

```javascript
const https = require('https');

// MUST disable TLS verification (self-signed cert)
const agent = new https.Agent({ rejectUnauthorized: false });

// Login
const authBody = JSON.stringify({ username: UDM_USER, password: UDM_PASS });
const res = await httpsRequest({
  hostname: '192.168.1.1', port: 443,
  path: '/api/auth/login', method: 'POST',
  headers: { 'Content-Type': 'application/json', 'Content-Length': Buffer.byteLength(authBody) },
  agent,
}, authBody);

// Extract TOKEN cookie
const tokenCookie = res.setCookie.find(c => c.startsWith('TOKEN='));
const sessionCookie = tokenCookie.split(';')[0]; // "TOKEN=xxx"

// Extract CSRF from JWT
const jwt = sessionCookie.replace('TOKEN=', '');
const payloadB64 = jwt.split('.')[1];
const padded = payloadB64 + '='.repeat((4 - payloadB64.length % 4) % 4);
const payload = JSON.parse(Buffer.from(padded, 'base64').toString());
const csrfToken = payload.csrfToken;

// Use in subsequent requests:
headers: { 'Cookie': sessionCookie, 'X-CSRF-Token': csrfToken }
```

## Known Gotchas (Common Failure Causes)

### 1. Password contains `!` — bash history expansion

The UDM password contains `!` which bash interprets as history expansion in double-quoted strings.

**WRONG:**
```bash
curl -d '{"username":"alpacaauto","password":"abc!def"}' ...   # ! expands
```

**RIGHT — use a file:**
```bash
cat > /tmp/unifi_login.json << 'EOF'
{"username":"alpacaauto","password":"abc!def"}
EOF
curl -d @/tmp/unifi_login.json ...
```

In Node.js code this is NOT an issue (JSON.stringify handles it), but in any shell script or `curl` command, always use file-based payloads or single-quoted heredocs.

### 2. Self-signed TLS certificate

The UDM Pro uses a self-signed cert. Every HTTPS client must disable cert verification:

- **Node.js:** `new https.Agent({ rejectUnauthorized: false })`
- **curl:** `-k` flag
- **Python requests:** `verify=False`
- **fetch (Deno/Edge Functions):** Not possible without custom agent — use Node.js https module

### 3. CSRF token is REQUIRED for mutating requests

POST/PATCH/DELETE requests will fail with 403 if the `X-CSRF-Token` header is missing. GET requests may work without it but it's best practice to always include it.

### 4. Session expiry (401 errors)

Sessions last ~24 hours. If you get a 401, re-authenticate. Both `ptz-proxy` and `camera-event-poller` implement `withAuthRetry()` that automatically re-auths on 401.

### 5. Tailscale subnet routing must be active

The DO droplet reaches `192.168.1.1` via Tailscale subnet routing through the Alpaca Mac. If the connection fails from the droplet:

1. `tailscale status` on the droplet — check for "accept-routes" warning
2. `tailscale up --accept-routes` if needed
3. Verify Alpaca Mac is online and advertising routes
4. Check IP forwarding on Alpaca Mac: `sysctl net.inet.ip.forwarding` should be `1`

### 6. Protect API vs Network API — different path prefixes

| API | URL prefix | Purpose |
|-----|-----------|---------|
| Network | `/proxy/network/api/s/default/` | Firewall, DHCP, WiFi, clients |
| Protect | `/proxy/protect/api/` | Cameras, sensors, events, snapshots |
| Auth | `/api/auth/login` | Authentication (shared by both) |

## API Endpoints Quick Reference

### Auth
```
POST /api/auth/login  →  Returns TOKEN cookie
```

### Protect API
```
GET  /proxy/protect/api/bootstrap              # Full system config (heavy, cache it)
GET  /proxy/protect/api/cameras                 # List all cameras
GET  /proxy/protect/api/cameras/{id}            # Camera details
PATCH /proxy/protect/api/cameras/{id}           # Update camera settings
GET  /proxy/protect/api/cameras/{id}/snapshot   # JPEG snapshot
POST /proxy/protect/api/cameras/{id}/move       # PTZ continuous move
POST /proxy/protect/api/cameras/{id}/ptz/goto/{slot}  # PTZ preset
GET  /proxy/protect/api/sensors/{id}            # Sensor state
GET  /proxy/protect/api/events?start=X&end=Y&types=smartDetectZone  # Smart detection events
GET  /proxy/protect/api/thumbnails/e-{eventId}  # Event thumbnail
```

### Network API
```
GET  /proxy/network/api/s/default/stat/health        # Network health
GET  /proxy/network/api/s/default/stat/sta            # Connected clients
GET  /proxy/network/api/s/default/stat/device         # Network devices
GET  /proxy/network/api/s/default/rest/firewallrule   # Firewall rules
GET  /proxy/network/api/s/default/rest/wlanconf       # WiFi configs
```

## Camera IDs

| Camera | Protect ID | LAN IP |
|--------|------------|--------|
| Alpacamera (backyard) | `694c550400317503e400044b` | 192.168.1.173 |
| Front Of House | `696534fc003eed03e4028eee` | 192.168.1.182 |
| Side Yard | `696537cc0067ed03e402929c` | 192.168.1.110 |

## Services That Connect to UDM Pro

| Service | Location | Config file | What it does |
|---------|----------|-------------|-------------|
| `ptz-proxy` | DO droplet (`/opt/ptz-proxy/`) | `.env` | PTZ control, snapshots, camera settings, sensors, **network clients** |
| `camera-event-poller` | DO droplet (`/opt/camera-event-poller/`) | `.env` | Smart detection event polling + SMS alerts |
| `go2rtc` | Alpaca Mac (`~/go2rtc/`) | `go2rtc.yaml` | Camera RTSP restreaming (uses RTSP tokens, not API auth) |
| `talkback-relay` | Alpaca Mac (`~/talkback-relay/`) | N/A | Two-way audio (direct UDP to camera IPs, no API auth) |

## Public Proxy Access (`cam.alpacaplayhouse.com`)

Developer machines, Cursor sessions, and browsers cannot reach the UDM Pro directly at `192.168.1.1`. All access goes through a public HTTPS proxy:

```
Your machine → Caddy (cam.alpacaplayhouse.com, DO droplet)
                  → ptz-proxy (127.0.0.1:8901, DO droplet)
                      → UDM Pro (192.168.1.1, via Tailscale subnet routing)
```

### Proxy Routes (Caddy → ptz-proxy)

Caddy at `cam.alpacaplayhouse.com` forwards these path prefixes to ptz-proxy on port 8901. **Every new ptz-proxy route also needs a `handle` block in the Caddyfile** (`/etc/caddy/Caddyfile` on the DO droplet) or it will return 404.

| Caddy path | ptz-proxy route | UDM API hit |
|------------|-----------------|-------------|
| `/ptz/*` | `POST /ptz/{cameraId}` | Protect: cameras/{id}/move, ptz/goto |
| `/camera/*` | `GET/PATCH /camera/{id}/settings`, `GET /camera/{id}/snapshot` | Protect: cameras/{id} |
| `/sensors` | `GET /sensors` | Protect: bootstrap |
| `/sensor/*` | `GET /sensor/{id}` | Protect: sensors/{id} |
| `/clients*` | `GET /clients`, `GET /clients?search=X` | **Network: stat/sta** |
| `/api/*` | *(not ptz-proxy)* → go2rtc on Alpaca Mac | HLS streaming |
| `/talkback/*` | *(not ptz-proxy)* → talkback-relay on Alpaca Mac | Two-way audio |

### Network Client Discovery (`/clients`)

The `/clients` endpoint queries the UDM's Network API for all connected WiFi and wired clients. This is how you find device IPs on the network.

```bash
# List ALL connected clients
curl -sk 'https://cam.alpacaplayhouse.com/clients'

# Search by hostname, name, MAC, OUI, or IP
curl -sk 'https://cam.alpacaplayhouse.com/clients?search=blink'
curl -sk 'https://cam.alpacaplayhouse.com/clients?search=amazon'
curl -sk 'https://cam.alpacaplayhouse.com/clients?search=192.168.1.21'
curl -sk 'https://cam.alpacaplayhouse.com/clients?search=f0:2f:9e'
```

Returns JSON array:
```json
[{
  "ip": "192.168.1.212",
  "mac": "f0:2f:9e:30:9b:ae",
  "hostname": "Blink-Device",
  "name": null,
  "oui": "Amazon Technologies Inc.",
  "network": "Default",
  "is_wired": false,
  "last_seen": 1770828169,
  "uptime": 943078
}]
```

### Known Devices Found via `/clients`

| Device | IP | MAC | OUI | Hostname |
|--------|-----|-----|-----|----------|
| Blink Camera | `192.168.1.212` | `f0:2f:9e:30:9b:ae` | Amazon Technologies Inc. | `Blink-Device` |

*(Add more devices here as they're discovered.)*

## Testing from Cursor / Developer Machine

```bash
# 1. Quick health check — camera settings (tests full auth chain)
curl -sk 'https://cam.alpacaplayhouse.com/camera/694c550400317503e400044b/settings'
# Expected: {"id":"694c550400317503e400044b","name":"Alpacamera",...}

# 2. Test all three cameras
curl -sk 'https://cam.alpacaplayhouse.com/camera/696534fc003eed03e4028eee/settings'
curl -sk 'https://cam.alpacaplayhouse.com/camera/696537cc0067ed03e402929c/settings'

# 3. Snapshot (returns JPEG binary, check HTTP status)
curl -sk -o /dev/null -w '%{http_code}' 'https://cam.alpacaplayhouse.com/camera/694c550400317503e400044b/snapshot'
# Expected: 200

# 4. Sensors
curl -sk 'https://cam.alpacaplayhouse.com/sensors'
# Expected: JSON array (may be empty if no UP-SENSE sensors paired)

# 5. Network clients (find devices on the LAN)
curl -sk 'https://cam.alpacaplayhouse.com/clients?search=blink'
# Expected: JSON array with matching clients
```

If all return valid responses, the full chain is healthy.

## Deploying ptz-proxy Changes

The ptz-proxy runs on the DO droplet. Source is in the repo at `scripts/ptz-proxy/ptz-proxy.js`. To deploy after making changes:

```bash
# 1. Copy the updated file to the droplet
scp -i ~/.ssh/do_bugfixer scripts/ptz-proxy/ptz-proxy.js root@159.89.157.120:/opt/ptz-proxy/ptz-proxy.js

# 2. Restart the service
ssh -i ~/.ssh/do_bugfixer root@159.89.157.120 'systemctl restart ptz-proxy'

# 3. Verify it's running
ssh -i ~/.ssh/do_bugfixer root@159.89.157.120 'systemctl is-active ptz-proxy'
# Expected: active
```

**If you added a new route to ptz-proxy**, you also need to add a Caddy `handle` block for the new path prefix in `/etc/caddy/Caddyfile` on the droplet, then reload Caddy:

```bash
ssh -i ~/.ssh/do_bugfixer root@159.89.157.120 'caddy validate --config /etc/caddy/Caddyfile && systemctl reload caddy'
```

Without the Caddy block, the new route will work at `http://127.0.0.1:8901/...` on the droplet but return 404 via `cam.alpacaplayhouse.com`.

## Troubleshooting Decision Tree

```
Connection failing?
├── From developer machine / Cursor session?
│   ├── Getting "Not Found" from cam.alpacaplayhouse.com?
│   │   └── Caddy doesn't have a handle block for that route → add one to Caddyfile
│   ├── Getting connection timeout?
│   │   └── DO droplet down, or Caddy not running
│   └── Getting JSON error from ptz-proxy?
│       └── ptz-proxy can't auth to UDM → check droplet logs: journalctl -u ptz-proxy -f
├── From DO droplet?
│   ├── Can't reach 192.168.1.1?
│   │   └── Tailscale issue → check tailscale status, accept-routes, Alpaca Mac online
│   ├── Auth returns non-200?
│   │   ├── 401 → Wrong password, check UDM_PASS in .env
│   │   ├── 403 → Missing CSRF token, or account locked
│   │   └── Connection refused → UDM Pro down or IP changed
│   └── Auth works but API calls fail?
│       ├── 401 → Session expired, re-authenticate
│       └── 403 → CSRF token missing or expired
├── From Supabase Edge Function?
│   └── Cannot reach UDM directly — must proxy through DO droplet
└── Shell scripts failing?
    └── Password has ! character → use file-based payload, not inline JSON
```

## File Locations

### In This Repo

| File | Purpose |
|------|---------|
| `scripts/ptz-proxy/ptz-proxy.js` | PTZ proxy + network clients (reference auth implementation) |
| `camera-event-poller/worker.js` | Event poller (identical auth pattern) |
| `camera-event-poller/install.sh` | Install script with .env template |
| `scripts/go2rtc/go2rtc.yaml` | Camera RTSP stream config (tokens, not API auth) |
| `scripts/talkback-relay/talkback-relay.js` | Two-way audio relay |
| `HOMEAUTOMATION.md` | Full home automation docs (auth examples, endpoints) |
| `HOMEAUTOMATION.local.md` | **GITIGNORED** — actual password lives here |

### On DO Droplet (`159.89.157.120`)

| Path | Purpose |
|------|---------|
| `/opt/ptz-proxy/ptz-proxy.js` | Deployed ptz-proxy (copy from repo) |
| `/opt/ptz-proxy/.env` | `UDM_HOST`, `UDM_USER`, `UDM_PASS` |
| `/opt/camera-event-poller/worker.js` | Deployed event poller |
| `/opt/camera-event-poller/.env` | Same UDM env vars |
| `/etc/caddy/Caddyfile` | Caddy reverse proxy config (routes → ptz-proxy, go2rtc, talkback) |
| `/etc/systemd/system/ptz-proxy.service` | systemd unit for ptz-proxy |
| `/etc/systemd/system/camera-event-poller.service` | systemd unit for event poller |

### SSH Access to Droplet

```bash
ssh -i ~/.ssh/do_bugfixer root@159.89.157.120
```
