<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="preconnect" href="https://aphrrfprbixmhissnjfn.supabase.co">
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <title>Music - AlpacAPPs Residents</title>
  <link rel="icon" type="image/png" href="../favicon.png">
  <link rel="apple-touch-icon" href="../apple-touch-icon.png">
  <link rel="stylesheet" href="../spaces/styles.css?v=5">
  <link rel="stylesheet" href="../spaces/admin/styles.css?v=5">
  <link rel="stylesheet" href="../spaces/admin/manage-shared.css?v=5">
  <link rel="stylesheet" href="residents.css?v=5">
  <script type="module" src="../shared/version-info.js"></script>
  <link rel="stylesheet" href="../styles/site.css">
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <!-- Unauthorized message -->
  <div id="unauthorizedOverlay" class="loading-overlay hidden">
    <div class="unauthorized-card">
      <h2>Access Denied</h2>
      <p>Your account is not authorized to access resident features.</p>
      <div class="unauthorized-actions">
        <a href="/spaces/" class="btn-secondary">View Public Spaces</a>
        <button id="signOutBtn" class="btn-secondary">Sign Out</button>
      </div>
    </div>
  </div>

  <!-- Main app content -->
  <div id="appContent" class="hidden">
    <div id="siteHeader"></div>

    <span data-site-version style="display:none">v260212.47 9:10p</span>

    <div class="context-switcher hidden" id="contextSwitcher">
      <a class="context-switcher-btn active">Resident</a>
      <a href="/spaces/admin/" class="context-switcher-btn">Staff</a>
    </div>

    <!-- Tab Navigation -->
    <div class="manage-tabs" id="tabNav"></div>

    <!-- Main Content - Two Column Layout -->
    <main class="manage-content sonos-page">
      <div class="sonos-layout">

        <!-- LEFT: Music Library + Schedules -->
        <div class="sonos-sidebar">

          <!-- Spotify Search -->
          <aside class="sonos-search-card">
            <div class="sonos-search__header">
              <h3><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px;"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>Search Spotify</h3>
            </div>
            <form id="spotifySearchForm" class="sonos-search__form" autocomplete="off">
              <div class="sonos-search__row">
                <input type="search" id="spotifyQuery" class="sonos-search__input" placeholder="Song, album, or playlist..." required style="flex:1;">
                <select id="spotifyType" class="sonos-search__select" style="flex:0 0 auto; width:auto;">
                  <option value="song">Song</option>
                  <option value="album">Album</option>
                  <option value="playlist">Playlist</option>
                </select>
                <button type="submit" class="sonos-search__btn sonos-search__btn--search" id="spotifySearchBtn" title="Search">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                </button>
              </div>
            </form>
            <div id="spotifySearchStatus" class="sonos-search__status hidden"></div>
            <!-- Search results list -->
            <div id="spotifyResults" class="sonos-search__results hidden"></div>
            <!-- Play bar (shown when results exist) -->
            <div id="spotifyPlayBar" class="sonos-search__play-bar hidden">
              <select id="spotifyZone" class="sonos-search__select sonos-search__zone-select">
                <option value="">Zone...</option>
              </select>
              <button type="button" class="sonos-search__btn sonos-search__btn--play" id="spotifyPlayBtn" title="Play selected" disabled>▶</button>
            </div>
          </aside>

          <aside class="sonos-library">
            <div class="sonos-library__header">
              <h3>Music Library</h3>
              <input type="search" id="librarySearch" class="sonos-library__search"
                placeholder="Filter..." autocomplete="off">
            </div>

            <!-- Library sections rendered dynamically by JS -->
            <div id="libraryBody">
              <p class="text-muted" style="font-size:0.8rem;padding:0.5rem 0;">Loading...</p>
            </div>

            <p class="sonos-library__hint">Drag a playlist or favorite onto a zone to play it. On mobile, tap to select then tap a zone.</p>
          </aside>

          <!-- Scenes -->
          <section class="sonos-scenes-section" id="scenesSection">
            <div class="sonos-scenes__header">
              <h3>Sonic Scenes</h3>
              <button class="btn-small staff-only" id="addSceneBtn" title="Create a new scene">+ New</button>
            </div>
            <div id="scenesList">
              <p class="text-muted" style="font-size:0.8rem;padding:0.75rem 0;text-align:center;">Loading...</p>
            </div>
          </section>

          <!-- Scheduled Alarms -->
          <section class="sonos-schedules-section" id="schedulesSection">
            <div class="sonos-schedules__header">
              <h3>Scheduled</h3>
              <button class="btn-small staff-only" id="addScheduleBtn" title="Add a scheduled alarm">+ Add</button>
            </div>
            <div id="schedulesList">
              <p class="text-muted" style="font-size:0.8rem;padding:0.5rem 0;text-align:center;">Loading...</p>
            </div>
          </section>
        </div>

        <!-- RIGHT: Zone Groups -->
        <div class="sonos-main">
          <section class="section" id="zonesSection">
            <div class="section-header">
              <h2>Zones</h2>
              <div class="section-header-actions">
                <button class="btn-small staff-only" id="groupRoomsBtn" title="Group/ungroup rooms">Group Rooms</button>
                <button class="btn-small" id="refreshZonesBtn" title="Refresh all zone states">Refresh</button>
                <button class="btn-all-off" id="pauseAllBtn" title="Pause all zones">Pause All</button>
              </div>
            </div>
            <div class="section-body">
              <div class="sonos-zones" id="sonosZones">
                <p class="text-muted" style="font-size: 0.85rem; padding: 2rem; text-align: center;">Loading zones...</p>
              </div>
              <div class="poll-status" id="pollStatus"></div>
            </div>
          </section>
        </div>

      </div>

      <!-- Network Optimization Log -->
      <details class="network-opt-log">
        <summary class="network-opt-log__toggle">Network Optimization Log</summary>
        <div class="network-opt-log__body">
          <p class="network-opt-log__intro">UDM Pro settings optimized for Sonos on <strong>Feb 12, 2026</strong> based on Ubiquiti &amp; Sonos best practices. All 12 speakers are wired ethernet on the Default VLAN.</p>
          <table class="network-opt-log__table">
            <thead>
              <tr><th>Change</th><th>Before</th><th>After</th><th>Why</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Network Optimization</td>
                <td><span class="opt-badge opt-badge--bad">ON</span></td>
                <td><span class="opt-badge opt-badge--good">OFF</span></td>
                <td>Auto-Optimize silently enables data rate controls that block older Sonos devices from connecting.</td>
              </tr>
              <tr>
                <td>STP Root Bridge</td>
                <td><span class="opt-badge opt-badge--bad">US-8-60W (4096)</span></td>
                <td><span class="opt-badge opt-badge--good">UDM Pro (4096)</span></td>
                <td>Core router should be root bridge. Prevents STP convergence issues with wired Sonos.</td>
              </tr>
              <tr>
                <td>STP Version (US-8-60W)</td>
                <td><span class="opt-badge opt-badge--bad">STP (legacy 802.1D)</span></td>
                <td><span class="opt-badge opt-badge--good">RSTP</span></td>
                <td>Mixed STP/RSTP causes slow convergence. Standardized to RSTP across all switches.</td>
              </tr>
              <tr>
                <td>US-8-60W STP Priority</td>
                <td>4096</td>
                <td><span class="opt-badge opt-badge--good">8192</span></td>
                <td>Second to UDM Pro in hierarchy. Prevents competing for root bridge.</td>
              </tr>
              <tr>
                <td>Multicast Enhancement</td>
                <td><span class="opt-badge opt-badge--bad">OFF (all SSIDs)</span></td>
                <td><span class="opt-badge opt-badge--good">ON (all SSIDs)</span></td>
                <td>Converts multicast to unicast for wireless clients, improving Sonos app discovery over WiFi.</td>
              </tr>
              <tr>
                <td>DHCP Reservations</td>
                <td><span class="opt-badge opt-badge--bad">None</span></td>
                <td><span class="opt-badge opt-badge--good">All 12 Sonos</span></td>
                <td>Fixed IPs at current addresses for stability and easier troubleshooting.</td>
              </tr>
              <tr>
                <td>2.4GHz Channels</td>
                <td><span class="opt-badge opt-badge--bad">Auto (all 8 APs)</span></td>
                <td><span class="opt-badge opt-badge--good">Fixed 1/6/11</span></td>
                <td>Prevents mid-stream channel changes. Ch1: Living Room, Skyloft, Garage. Ch6: Sauna, Outhouse, Laundry. Ch11: Spartan, Doghouse.</td>
              </tr>
            </tbody>
          </table>
          <details class="network-opt-log__sub">
            <summary>Already Optimal (no changes needed)</summary>
            <ul class="network-opt-log__good-list">
              <li><strong>All Sonos wired</strong> — all 12 speakers on ethernet</li>
              <li><strong>Single VLAN</strong> — no cross-VLAN multicast issues</li>
              <li><strong>2.4GHz Width: HT20</strong> — Sonos recommended</li>
              <li><strong>IGMP Snooping: ON</strong> — constrains multicast flooding</li>
              <li><strong>mDNS: ON</strong> — with Sonos service enabled</li>
              <li><strong>DTIM: 1 (2.4GHz) / 3 (5GHz)</strong> — optimal defaults</li>
              <li><strong>L2 Isolation: OFF</strong> — speakers can communicate</li>
              <li><strong>Proxy ARP: OFF</strong> — doesn't interfere with discovery</li>
              <li><strong>Fast Roaming (802.11r): OFF</strong> — avoids IoT disconnects</li>
              <li><strong>Min RSSI: Disabled</strong> — speakers don't roam</li>
              <li><strong>Min Data Rate: 1 Mbps</strong> — compatible with all Sonos</li>
              <li><strong>Radio AI: Disabled</strong> — no surprise channel swaps</li>
              <li><strong>DHCP Snooping: ON</strong> — protects against rogue DHCP</li>
            </ul>
          </details>
          <details class="network-opt-log__sub">
            <summary>DHCP Reservations (12 speakers)</summary>
            <table class="network-opt-log__table network-opt-log__table--compact">
              <thead><tr><th>MAC</th><th>Fixed IP</th></tr></thead>
              <tbody>
                <tr><td>00:0e:58:ab:6e:c6</td><td>192.168.1.156</td></tr>
                <tr><td>00:0e:58:30:9a:48</td><td>192.168.1.33</td></tr>
                <tr><td>00:0e:58:13:7a:8c</td><td>192.168.1.178</td></tr>
                <tr><td>00:0e:58:20:07:ca</td><td>192.168.1.193</td></tr>
                <tr><td>00:0e:58:10:d6:d6</td><td>192.168.1.47</td></tr>
                <tr><td>00:0e:58:ae:51:9a</td><td>192.168.1.148</td></tr>
                <tr><td>b8:e9:37:a2:34:82</td><td>192.168.1.191</td></tr>
                <tr><td>00:0e:58:a1:2a:1a</td><td>192.168.1.7</td></tr>
                <tr><td>00:0e:58:21:e8:e0</td><td>192.168.1.200</td></tr>
                <tr><td>b8:e9:37:92:72:fc</td><td>192.168.1.97</td></tr>
                <tr><td>00:0e:58:a1:21:46</td><td>192.168.1.29</td></tr>
                <tr><td>00:0e:58:24:46:d6</td><td>192.168.1.25</td></tr>
              </tbody>
            </table>
          </details>
          <p class="network-opt-log__sources">Sources: <a href="https://help.ui.com/hc/en-us/articles/18930473041047" target="_blank" rel="noopener">Ubiquiti Best Practices</a> &middot; <a href="https://support.sonos.com/en/article/configure-your-firewall-to-work-with-sonos" target="_blank" rel="noopener">Sonos Firewall</a> &middot; <a href="https://support.sonos.com/en/article/recommended-settings-for-using-sonos-on-wireless-networks" target="_blank" rel="noopener">Sonos WiFi</a> &middot; <a href="https://github.com/IngmarStein/unifi-sonos-doc" target="_blank" rel="noopener">Community Doc</a></p>
        </div>
      </details>
    </main>
  </div>

  <!-- Instant chrome: skip spinner + pre-render header for returning users -->
  <script src="../shared/instant-chrome.js"></script>

  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3"></script>
  <script type="module" src="sonos.js"></script>
</body>
</html>
