<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="../favicon.png">
  <link rel="apple-touch-icon" href="../apple-touch-icon.png">
  <title>Contact Us — The Austin Alpaca Playhouse</title>
  <meta name="description" content="Get in touch with the Austin Alpaca Playhouse. Contact us about rentals, events, or just to say hello.">


  <!-- Styles -->
  <link rel="stylesheet" href="/styles/site.css">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/assets/branding/whitehead.png">

  <style>
    /* Ask a Question Section */
    .ask-section {
      background: #fdf8f3;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 3rem;
    }

    .ask-section h2 {
      margin-top: 0;
      margin-bottom: 0.5rem;
    }

    .ask-section p {
      color: #666;
      margin-bottom: 1.5rem;
    }

    .question-input-wrapper {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .question-input {
      flex: 1;
      padding: 0.875rem 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .question-input:focus {
      outline: none;
      border-color: var(--aap-accent, #8B4513);
      box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
    }

    .ask-btn {
      padding: 0.875rem 1.5rem;
      background: var(--aap-accent, #8B4513);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .ask-btn:hover {
      background: #6d3610;
    }

    .ask-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Answer Display */
    .answer-container {
      display: none;
      margin-top: 1.5rem;
      padding: 1.25rem;
      background: white;
      border-radius: 8px;
      border: 1px solid #e5e5e5;
    }

    .answer-container.visible {
      display: block;
    }

    .answer-text {
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .answer-feedback {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e5e5e5;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .answer-feedback span {
      font-size: 0.875rem;
      color: #666;
    }

    .feedback-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .feedback-btn:hover {
      border-color: var(--aap-accent, #8B4513);
      color: var(--aap-accent, #8B4513);
    }

    .feedback-btn--negative {
      border-color: #dc2626;
      color: #dc2626;
    }

    .feedback-btn--negative:hover {
      background: #fef2f2;
    }

    /* Low confidence warning */
    .low-confidence-notice {
      display: none;
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: #fef3c7;
      border-radius: 6px;
      font-size: 0.875rem;
      color: #92400e;
    }

    .low-confidence-notice.visible {
      display: block;
    }

    /* Email follow-up form */
    .followup-form {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 8px;
    }

    .followup-form.visible {
      display: block;
    }

    .followup-form p {
      margin: 0 0 0.75rem;
      font-size: 0.875rem;
    }

    .followup-fields {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .followup-input {
      padding: 0.5rem 0.75rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.875rem;
    }

    .followup-btn {
      padding: 0.5rem 1rem;
      background: var(--aap-accent, #8B4513);
      color: white;
      border: none;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.875rem;
      cursor: pointer;
      align-self: flex-start;
    }

    /* Success message */
    .question-submitted {
      display: none;
      padding: 1rem;
      background: #d1fae5;
      border-radius: 8px;
      color: #065f46;
      font-size: 0.9rem;
    }

    .question-submitted.visible {
      display: block;
    }

    /* Loading state */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid white;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Send Message Section */
    .message-section {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      border: 1px solid #e5e5e5;
    }

    .message-section h2 {
      margin-top: 0;
    }

    .contact-methods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .contact-method {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
    }

    .contact-method__icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fdf8f3;
      border-radius: 8px;
      color: var(--aap-accent, #8B4513);
      flex-shrink: 0;
    }

    .contact-method__info h4 {
      margin: 0 0 0.25rem;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .contact-method__info a {
      color: var(--aap-accent, #8B4513);
      text-decoration: none;
    }

    .contact-method__info a:hover {
      text-decoration: underline;
    }

    /* Message form */
    .message-form {
      border-top: 1px solid #e5e5e5;
      padding-top: 1.5rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--aap-accent, #8B4513);
      box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 120px;
    }

    .form-group select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
    }

    .submit-btn {
      width: 100%;
      padding: 1rem;
      background: var(--aap-accent, #8B4513);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .submit-btn:hover {
      background: #6d3610;
    }

    .form-success {
      display: none;
      padding: 1rem;
      background: #d1fae5;
      border-radius: 8px;
      color: #065f46;
      margin-top: 1rem;
    }

    .form-success.visible {
      display: block;
    }

    /* Social links */
    .social-links {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .social-links a {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #666;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .social-links a:hover {
      color: var(--aap-accent, #8B4513);
    }

    @media (max-width: 600px) {
      .question-input-wrapper {
        flex-direction: column;
      }

      .ask-btn {
        width: 100%;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="aap-header aap-header--transparent aap-header--light" id="aap-header">
    <div class="aap-header__inner">
      <a href="/" class="aap-header__logo">
        <img src="/assets/branding/whitehead.png" alt="Austin Alpaca Playhouse">
        <span class="aap-header__logo-text">Austin Alpaca Playhouse</span>
      </a>

      <nav class="aap-nav" id="aap-nav">
<ul class="aap-nav__list">
  <li><a href="/visiting/" class="aap-nav__link">Visiting</a></li>
  <li><a href="/spaces/" class="aap-nav__link">Rentals</a></li>
  <li><a href="/events/" class="aap-nav__link">Events</a></li>
  <li><a href="/community/" class="aap-nav__link">Community</a></li>
  <li><a href="/photos/" class="aap-nav__link">Photos</a></li>
  <li><a href="/contact/" class="aap-nav__link aap-nav__link--active">Contact</a></li>
</ul>
      </nav>

      <button class="aap-menu-toggle" id="aap-menu-toggle" aria-label="Toggle menu">
        <span class="aap-menu-toggle__bar"></span>
        <span class="aap-menu-toggle__bar"></span>
        <span class="aap-menu-toggle__bar"></span>
      </button>
    </div>
  </header>

  <!-- Mobile Navigation -->
  <div class="aap-mobile-nav" id="aap-mobile-nav">
    <button class="aap-mobile-nav__close" id="aap-mobile-nav-close" aria-label="Close menu">×</button>
<ul class="aap-mobile-nav__list">
  <li class="aap-mobile-nav__item"><a href="/visiting/" class="aap-mobile-nav__link">Visiting</a></li>
  <li class="aap-mobile-nav__item"><a href="/spaces/" class="aap-mobile-nav__link">Rentals</a></li>
  <li class="aap-mobile-nav__item"><a href="/events/" class="aap-mobile-nav__link">Events</a></li>
  <li class="aap-mobile-nav__item"><a href="/community/" class="aap-mobile-nav__link">Community</a></li>
  <li class="aap-mobile-nav__item"><a href="/photos/" class="aap-mobile-nav__link">Photos</a></li>
  <li class="aap-mobile-nav__item"><a href="/contact/" class="aap-mobile-nav__link aap-mobile-nav__link--active">Contact</a></li>
</ul>
  </div>

  <!-- Hero Section -->
  <section class="aap-hero aap-hero--short" style="background-image: url('https://aphrrfprbixmhissnjfn.supabase.co/storage/v1/object/public/housephotos/site/hero-alpacas.jpeg')">
    <div class="aap-hero__content">
      <h1 class="aap-hero__title">Contact Us</h1>
      <p class="aap-hero__subtitle">We'd love to hear from you</p>
    </div>
  </section>

  <!-- Content -->
  <div class="aap-content">
    <!-- Ask a Question Section -->
    <div class="ask-section">
      <h2>Ask a Question</h2>
      <p>Get instant answers about rentals, events, visiting, and more.</p>

      <div class="question-input-wrapper">
        <input type="text" id="questionInput" class="question-input" placeholder="What would you like to know?" autocomplete="off">
        <button id="askBtn" class="ask-btn">Ask</button>
      </div>

      <div id="answerContainer" class="answer-container">
        <div id="answerText" class="answer-text"></div>

        <div id="lowConfidenceNotice" class="low-confidence-notice">
          I'm not fully confident in this answer. If this didn't help, let us know and we'll get back to you.
        </div>

        <div class="answer-feedback">
          <span>Was this helpful?</span>
          <button class="feedback-btn" onclick="handleFeedback(true)">Yes, thanks!</button>
          <button class="feedback-btn feedback-btn--negative" onclick="handleFeedback(false)">Not quite</button>
        </div>

        <div id="followupForm" class="followup-form">
          <p>Sorry about that! Leave your info and we'll get back to you with an answer.</p>
          <div class="followup-fields">
            <input type="text" id="followupName" class="followup-input" placeholder="Your name">
            <input type="email" id="followupEmail" class="followup-input" placeholder="Email">
            <input type="tel" id="followupPhone" class="followup-input" placeholder="Phone (optional)">
          </div>
          <button class="followup-btn" onclick="submitFollowup()">Submit to a Human</button>
        </div>

        <div id="questionSubmitted" class="question-submitted">
          Thanks! We've received your question and will update our knowledge base.
        </div>
      </div>
    </div>

    <!-- Send a Message Section -->
    <div class="message-section">
      <h2>Send a Message</h2>
      <p>Reach out directly and we'll get back to you as soon as we can.</p>

      <div class="contact-methods">
        <div class="contact-method">
          <div class="contact-method__icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
          </div>
          <div class="contact-method__info">
            <h4>Text Us</h4>
            <a id="smsLink" href="sms:+17377474737">(737) 747-4737</a>
          </div>
        </div>

        <div class="contact-method">
          <div class="contact-method__icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
          </div>
          <div class="contact-method__info">
            <h4>Location</h4>
            <span>Cedar Creek, TX (30 min east of Austin)</span>
          </div>
        </div>
      </div>

      <form id="messageForm" class="message-form">
        <div class="form-row">
          <div class="form-group">
            <label for="name">Your Name</label>
            <input type="text" id="name" name="name" placeholder="How should we address you?">
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" placeholder="your@email.com">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="phone">Phone (optional)</label>
            <input type="tel" id="phone" name="phone" placeholder="Your phone number">
          </div>
          <div class="form-group">
            <label for="subject">Subject</label>
            <select id="subject" name="subject">
              <option value="general">General Inquiry</option>
              <option value="rental">Rental Inquiry</option>
              <option value="event">Host an Event</option>
              <option value="sauna">Sauna/Spa Session</option>
              <option value="worktrade">Work Trade</option>
              <option value="visit">Visiting</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="message">Message</label>
          <textarea id="message" name="message" placeholder="What would you like to tell us?"></textarea>
        </div>

        <button type="submit" class="submit-btn">Send Message</button>
      </form>

      <div id="formSuccess" class="form-success">
        <strong>Message sent!</strong> We'll get back to you soon.
      </div>
    </div>

    <hr style="margin: 3rem 0;">

    <!-- Social & Quick Links -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
      <div>
        <h3>Follow Us</h3>
        <div class="social-links">
          <a href="https://www.facebook.com/alpacaplayhouse" target="_blank" rel="noopener">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
            </svg>
            Facebook
          </a>
          <a href="https://instagram.com/alpacaplayhouseatx" target="_blank" rel="noopener">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
              <circle cx="12" cy="12" r="4"/>
              <circle cx="18" cy="6" r="1" fill="currentColor"/>
            </svg>
            Instagram
          </a>
        </div>
      </div>

      <div>
        <h3>Quick Links</h3>
        <ul style="list-style: none; padding: 0; margin: 0;">
          <li style="margin-bottom: 0.5rem;"><a href="/spaces/">View Available Rentals</a></li>
          <li style="margin-bottom: 0.5rem;"><a href="/events/">Host an Event</a></li>
          <li style="margin-bottom: 0.5rem;"><a href="/visiting/">Planning to Visit</a></li>
          <li style="margin-bottom: 0.5rem;"><a href="/worktrade/">Work Trade Program</a></li>
          <li><a href="/docs/alpacappsinfra.html">AlpacApps Infra Guide</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="aap-footer">
    <div class="aap-footer__content">
      <div class="aap-footer__logo">
        <img src="/assets/branding/whitehead.png" alt="Austin Alpaca Playhouse" style="height: 60px; margin: 0 auto;">
      </div>

      <div class="aap-footer__social">
        <a href="https://www.facebook.com/alpacaplayhouse" target="_blank" rel="noopener" aria-label="Facebook">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
          </svg>
        </a>
        <a href="https://instagram.com/alpacaplayhouseatx" target="_blank" rel="noopener" aria-label="Instagram">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
            <circle cx="12" cy="12" r="4"/>
            <circle cx="18" cy="6" r="1" fill="currentColor"/>
          </svg>
        </a>
      </div>

      <p class="aap-footer__copyright">
        © 2025 Austin Alpaca Playhouse. All rights reserved.<br>
        160 Still Forest Drive, Cedar Creek, TX 78612
      </p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import { initChatWidget, askQuestion, submitUnansweredQuestion } from '/shared/chat-widget.js';
    import { saveVisitor, getVisitor } from '/shared/visitor-identity.js';

    let currentQuestion = '';
    let currentAnswer = '';
    let isLowConfidence = false;

    // Initialize on load
    document.addEventListener('DOMContentLoaded', async () => {
      await initChatWidget();

      // Load SMS number from Supabase (dynamic import so it can't break the page)
      try {
        const { supabase } = await import('/shared/supabase.js');
        const { data: config } = await supabase
          .from('telnyx_config')
          .select('phone_number, is_active')
          .single();
        if (config?.phone_number && config?.is_active) {
          const digits = config.phone_number.replace(/\D/g, '');
          const d = digits.length === 11 ? digits.slice(1) : digits;
          const display = `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
          const link = document.getElementById('smsLink');
          if (link) {
            link.href = `sms:${config.phone_number}`;
            link.textContent = display;
          }
        }
      } catch (e) {
        console.log('Could not load SMS config:', e.message);
      }

      // Header scroll behavior
      const header = document.getElementById('aap-header');
      window.addEventListener('scroll', () => {
        if (window.scrollY > 50) {
          header.classList.remove('aap-header--transparent');
          header.classList.add('aap-header--solid');
          header.classList.remove('aap-header--light');
          header.classList.add('aap-header--dark');
        } else {
          header.classList.add('aap-header--transparent');
          header.classList.remove('aap-header--solid');
          header.classList.add('aap-header--light');
          header.classList.remove('aap-header--dark');
        }
      });

      // Mobile menu toggle
      const menuToggle = document.getElementById('aap-menu-toggle');
      const mobileNav = document.getElementById('aap-mobile-nav');
      const mobileNavClose = document.getElementById('aap-mobile-nav-close');

      menuToggle.addEventListener('click', () => {
        mobileNav.classList.add('aap-mobile-nav--open');
        document.body.style.overflow = 'hidden';
      });

      mobileNavClose.addEventListener('click', () => {
        mobileNav.classList.remove('aap-mobile-nav--open');
        document.body.style.overflow = '';
      });

      mobileNav.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
          mobileNav.classList.remove('aap-mobile-nav--open');
          document.body.style.overflow = '';
        });
      });
    });

    // Ask question handler
    const questionInput = document.getElementById('questionInput');
    const askBtn = document.getElementById('askBtn');
    const answerContainer = document.getElementById('answerContainer');
    const answerText = document.getElementById('answerText');
    const lowConfidenceNotice = document.getElementById('lowConfidenceNotice');
    const followupForm = document.getElementById('followupForm');
    const questionSubmitted = document.getElementById('questionSubmitted');

    // Auto-fill followup form from saved visitor identity
    const visitor = getVisitor();
    if (visitor.name) document.getElementById('followupName').value = visitor.name;
    if (visitor.email) document.getElementById('followupEmail').value = visitor.email;
    if (visitor.phone) document.getElementById('followupPhone').value = visitor.phone;

    askBtn.addEventListener('click', handleAskQuestion);
    questionInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleAskQuestion();
    });

    async function handleAskQuestion() {
      const question = questionInput.value.trim();
      if (!question) return;

      currentQuestion = question;

      // Show loading state
      askBtn.disabled = true;
      askBtn.innerHTML = '<span class="loading-spinner"></span>Thinking...';

      // Reset answer UI
      answerContainer.classList.remove('visible');
      lowConfidenceNotice.classList.remove('visible');
      followupForm.classList.remove('visible');
      questionSubmitted.classList.remove('visible');
      const feedbackEl = document.querySelector('.answer-feedback');
      if (feedbackEl) feedbackEl.style.display = '';

      try {
        const result = await askQuestion(question);
        currentAnswer = result.answer;
        isLowConfidence = !result.confident;

        answerText.textContent = result.answer;
        answerContainer.classList.add('visible');

        if (!result.confident) {
          lowConfidenceNotice.classList.add('visible');
          // Auto-submit low confidence questions for review
          await submitUnansweredQuestion(question, null, 'low_confidence');
        }
      } catch (error) {
        answerText.textContent = 'Sorry, I had trouble getting an answer. Leave your info below and we\'ll get back to you.';
        answerContainer.classList.add('visible');
        // Hide confidence notice and feedback buttons on error
        lowConfidenceNotice.classList.remove('visible');
        document.querySelector('.answer-feedback').style.display = 'none';
        // Show follow-up form so user can leave contact info
        followupForm.classList.add('visible');
      } finally {
        askBtn.disabled = false;
        askBtn.textContent = 'Ask';
      }
    }

    // Feedback handlers
    window.handleFeedback = async function(helpful) {
      if (helpful) {
        // Hide feedback buttons, show thank you
        document.querySelector('.answer-feedback').style.display = 'none';
        questionSubmitted.textContent = 'Great! Glad we could help.';
        questionSubmitted.classList.add('visible');
      } else {
        // Show follow-up form
        followupForm.classList.add('visible');

        // Submit the question if not already submitted
        if (!isLowConfidence) {
          await submitUnansweredQuestion(currentQuestion, null, 'user_feedback');
        }
      }
    };

    window.submitFollowup = async function() {
      const name = document.getElementById('followupName').value.trim();
      const email = document.getElementById('followupEmail').value.trim();
      const phone = document.getElementById('followupPhone').value.trim();

      if (!name && !email && !phone) {
        // Need at least one way to reach them
        document.getElementById('followupName').focus();
        return;
      }

      // Persist visitor identity for future visits
      saveVisitor({ name, email, phone });

      try {
        await submitUnansweredQuestion(currentQuestion, email || null, 'user_feedback', name || null, phone || null);
      } catch (e) {
        console.error('Error submitting question:', e);
      }

      followupForm.classList.remove('visible');
      questionSubmitted.textContent = "Thanks! We'll get back to you with an answer.";
      questionSubmitted.classList.add('visible');
      document.querySelector('.answer-feedback').style.display = 'none';
    };

    // Message form handling
    const messageForm = document.getElementById('messageForm');
    const formSuccess = document.getElementById('formSuccess');

    // Auto-fill message form from saved visitor identity
    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    if (visitor.name && nameInput && !nameInput.value) nameInput.value = visitor.name;
    if (visitor.email && emailInput && !emailInput.value) emailInput.value = visitor.email;
    if (visitor.phone && phoneInput && !phoneInput.value) phoneInput.value = visitor.phone;

    messageForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = messageForm.querySelector('.submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      const formData = new FormData(messageForm);
      const data = {
        name: formData.get('name') || 'Not provided',
        email: formData.get('email') || 'Not provided',
        phone: formData.get('phone') || 'Not provided',
        subject: formData.get('subject'),
        message: formData.get('message'),
      };

      // Persist visitor identity for future visits
      saveVisitor({ name: data.name, email: data.email, phone: data.phone });

      try {
        const response = await fetch('https://aphrrfprbixmhissnjfn.supabase.co/functions/v1/send-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwaHJyZnByYml4bWhpc3NuamZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzA0MjUsImV4cCI6MjA4NTUwNjQyNX0.yYkdQIq97GQgxK7yT2OQEPi5Tt-a7gM45aF8xjSD6wk'
          },
          body: JSON.stringify({
            type: 'contact_form',
            to: 'alpacaplayhouse@gmail.com',
            reply_to: data.email !== 'Not provided' ? data.email : undefined,
            data: data
          })
        });

        if (!response.ok) throw new Error('Failed to send');

        messageForm.style.display = 'none';
        formSuccess.classList.add('visible');
      } catch (error) {
        console.error('Error sending message:', error);
        submitBtn.textContent = 'Send Message';
        submitBtn.disabled = false;
        alert('Sorry, there was an error sending your message. Please try texting us instead.');
      }
    });
  </script>
</body>
</html>
