{"version":3,"file":"history.js","sourceRoot":"","sources":["../../src/history.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Maintains navigation history across Capgo-controlled reloads when keepUrlPathAfterReload is enabled.\n */\n\nconst KEEP_FLAG_KEY = '__capgo_keep_url_path_after_reload';\nconst HISTORY_STORAGE_KEY = '__capgo_history_stack__';\nconst MAX_STACK_ENTRIES = 100;\n\nconst isBrowser = typeof window !== 'undefined' && typeof document !== 'undefined' && typeof history !== 'undefined';\n\nif (isBrowser) {\n  const win = window as typeof window & {\n    __capgoHistoryPatched?: boolean;\n    __capgoKeepUrlPathAfterReload?: boolean;\n  };\n\n  if (!win.__capgoHistoryPatched) {\n    win.__capgoHistoryPatched = true;\n\n    const isFeatureConfigured = (): boolean => {\n      try {\n        if (win.__capgoKeepUrlPathAfterReload) {\n          return true;\n        }\n      } catch (err) {\n        // ignore access issues\n      }\n      try {\n        return window.localStorage.getItem(KEEP_FLAG_KEY) === '1';\n      } catch (err) {\n        return false;\n      }\n    };\n\n    type StoredHistory = { stack: string[]; index: number };\n\n    const readStored = (): StoredHistory => {\n      try {\n        const raw = window.sessionStorage.getItem(HISTORY_STORAGE_KEY);\n        if (!raw) {\n          return { stack: [], index: -1 };\n        }\n        const parsed = JSON.parse(raw) as StoredHistory;\n        if (!parsed || !Array.isArray(parsed.stack) || typeof parsed.index !== 'number') {\n          return { stack: [], index: -1 };\n        }\n        return parsed;\n      } catch (err) {\n        return { stack: [], index: -1 };\n      }\n    };\n\n    const writeStored = (stack: string[], index: number): void => {\n      try {\n        window.sessionStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify({ stack, index }));\n      } catch (err) {\n        // Storage might be unavailable; fail silently.\n      }\n    };\n\n    const clearStored = (): void => {\n      try {\n        window.sessionStorage.removeItem(HISTORY_STORAGE_KEY);\n      } catch (err) {\n        // ignore\n      }\n    };\n\n    const normalize = (url?: string | URL | null): string | null => {\n      try {\n        const base = url ?? window.location.href;\n        const parsed = new URL(base instanceof URL ? base.toString() : base, window.location.href);\n        return `${parsed.pathname}${parsed.search}${parsed.hash}`;\n      } catch (err) {\n        return null;\n      }\n    };\n\n    const trimStack = (stack: string[], index: number): StoredHistory => {\n      if (stack.length <= MAX_STACK_ENTRIES) {\n        return { stack, index };\n      }\n      const start = stack.length - MAX_STACK_ENTRIES;\n      const trimmed = stack.slice(start);\n      const adjustedIndex = Math.max(0, index - start);\n      return { stack: trimmed, index: adjustedIndex };\n    };\n\n    const runWhenReady = (fn: () => void): void => {\n      if (document.readyState === 'complete' || document.readyState === 'interactive') {\n        fn();\n      } else {\n        window.addEventListener('DOMContentLoaded', fn, { once: true });\n      }\n    };\n\n    let featureActive = false;\n    let isRestoring = false;\n    let restoreScheduled = false;\n\n    const ensureCurrentTracked = () => {\n      if (!featureActive) {\n        return;\n      }\n      const stored = readStored();\n      const current = normalize();\n      if (!current) {\n        return;\n      }\n      if (stored.stack.length === 0) {\n        stored.stack.push(current);\n        stored.index = 0;\n        writeStored(stored.stack, stored.index);\n        return;\n      }\n      if (stored.index < 0 || stored.index >= stored.stack.length) {\n        stored.index = stored.stack.length - 1;\n      }\n      if (stored.stack[stored.index] !== current) {\n        stored.stack[stored.index] = current;\n        writeStored(stored.stack, stored.index);\n      }\n    };\n\n    const record = (url: string | URL | null | undefined, replace: boolean) => {\n      if (!featureActive || isRestoring) {\n        return;\n      }\n      const normalized = normalize(url);\n      if (!normalized) {\n        return;\n      }\n      let { stack, index } = readStored();\n      if (stack.length === 0) {\n        stack.push(normalized);\n        index = stack.length - 1;\n      } else if (replace) {\n        if (index < 0 || index >= stack.length) {\n          index = stack.length - 1;\n        }\n        stack[index] = normalized;\n      } else {\n        if (index >= stack.length - 1) {\n          stack.push(normalized);\n          index = stack.length - 1;\n        } else {\n          stack = stack.slice(0, index + 1);\n          stack.push(normalized);\n          index = stack.length - 1;\n        }\n      }\n      ({ stack, index } = trimStack(stack, index));\n      writeStored(stack, index);\n    };\n\n    const restoreHistory = () => {\n      if (!featureActive || isRestoring) {\n        return;\n      }\n      const stored = readStored();\n      if (stored.stack.length === 0) {\n        ensureCurrentTracked();\n        return;\n      }\n      const targetIndex =\n        stored.index >= 0 && stored.index < stored.stack.length ? stored.index : stored.stack.length - 1;\n      const normalizedCurrent = normalize();\n      if (stored.stack.length === 1 && normalizedCurrent === stored.stack[0]) {\n        return;\n      }\n      const firstEntry = stored.stack[0];\n      if (!firstEntry) {\n        return;\n      }\n      isRestoring = true;\n      try {\n        history.replaceState(history.state, document.title, firstEntry);\n        for (let i = 1; i < stored.stack.length; i += 1) {\n          history.pushState(history.state, document.title, stored.stack[i]);\n        }\n      } catch (err) {\n        isRestoring = false;\n        return;\n      }\n      isRestoring = false;\n      const currentIndex = stored.stack.length - 1;\n      const offset = targetIndex - currentIndex;\n      if (offset !== 0) {\n        history.go(offset);\n      } else {\n        history.replaceState(history.state, document.title, stored.stack[targetIndex]);\n        window.dispatchEvent(new PopStateEvent('popstate'));\n      }\n    };\n\n    const scheduleRestore = () => {\n      if (!featureActive || restoreScheduled) {\n        return;\n      }\n      restoreScheduled = true;\n      runWhenReady(() => {\n        restoreScheduled = false;\n        restoreHistory();\n      });\n    };\n\n    let originalPushState: typeof history.pushState | null = null;\n    let originalReplaceState: typeof history.replaceState | null = null;\n\n    const popstateHandler = () => {\n      if (!featureActive || isRestoring) {\n        return;\n      }\n      const normalized = normalize();\n      if (!normalized) {\n        return;\n      }\n      const stored = readStored();\n      const idx = stored.stack.lastIndexOf(normalized);\n      if (idx >= 0) {\n        stored.index = idx;\n      } else {\n        stored.stack.push(normalized);\n        stored.index = stored.stack.length - 1;\n      }\n      const trimmed = trimStack(stored.stack, stored.index);\n      writeStored(trimmed.stack, trimmed.index);\n    };\n\n    const patchHistory = () => {\n      if (originalPushState && originalReplaceState) {\n        return;\n      }\n      originalPushState = history.pushState;\n      originalReplaceState = history.replaceState;\n\n      history.pushState = function pushStatePatched(state: any, title: string, url?: string | URL | null) {\n        const result = originalPushState?.call(history, state, title, url as any);\n        record(url, false);\n        return result;\n      };\n\n      history.replaceState = function replaceStatePatched(state: any, title: string, url?: string | URL | null) {\n        const result = originalReplaceState?.call(history, state, title, url as any);\n        record(url, true);\n        return result;\n      };\n\n      window.addEventListener('popstate', popstateHandler);\n    };\n\n    const unpatchHistory = () => {\n      if (originalPushState) {\n        history.pushState = originalPushState;\n        originalPushState = null;\n      }\n      if (originalReplaceState) {\n        history.replaceState = originalReplaceState;\n        originalReplaceState = null;\n      }\n      window.removeEventListener('popstate', popstateHandler);\n    };\n\n    const setFeatureActive = (enabled: boolean) => {\n      if (featureActive === enabled) {\n        if (featureActive) {\n          ensureCurrentTracked();\n          scheduleRestore();\n        }\n        return;\n      }\n      featureActive = enabled;\n      if (featureActive) {\n        patchHistory();\n        ensureCurrentTracked();\n        scheduleRestore();\n      } else {\n        unpatchHistory();\n        clearStored();\n      }\n    };\n\n    window.addEventListener('CapacitorUpdaterKeepUrlPathAfterReload', (event) => {\n      const evt = event as CustomEvent<{ enabled?: boolean }>;\n      const enabled = evt?.detail?.enabled;\n      if (typeof enabled === 'boolean') {\n        win.__capgoKeepUrlPathAfterReload = enabled;\n        setFeatureActive(enabled);\n      } else {\n        win.__capgoKeepUrlPathAfterReload = true;\n        setFeatureActive(true);\n      }\n    });\n\n    setFeatureActive(isFeatureConfigured());\n  }\n}\n\nexport {};\n"]}