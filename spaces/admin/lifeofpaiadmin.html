<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life of PAI Admin - AlpacAPPs</title>
  <link rel="icon" type="image/png" href="../../favicon.png">
  <link rel="apple-touch-icon" href="../../apple-touch-icon.png">
  <link rel="stylesheet" href="../styles.css?v=5">
  <link rel="stylesheet" href="styles.css?v=5">
  <link rel="stylesheet" href="manage-shared.css?v=5">
  <style>
    /* Life of PAI Admin styles */
    .pai-admin-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    @media (max-width: 768px) {
      .pai-admin-grid { grid-template-columns: 1fr; }
    }

    .pai-stat {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem 1.25rem;
      text-align: center;
    }
    .pai-stat-value {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }
    .pai-stat-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .config-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.6rem 0;
      border-bottom: 1px solid var(--border);
    }
    .config-row:last-child { border-bottom: none; }
    .config-label {
      font-weight: 500;
      font-size: 0.85rem;
      min-width: 140px;
    }
    .config-value {
      flex: 1;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .config-input {
      padding: 0.3rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.85rem;
      width: 80px;
      background: var(--bg);
    }
    .config-select {
      padding: 0.3rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.85rem;
      background: var(--bg);
    }

    .whisper-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    .whisper-table th {
      text-align: left;
      padding: 0.5rem;
      border-bottom: 2px solid var(--border);
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .whisper-table td {
      padding: 0.5rem;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    .whisper-text {
      max-width: 400px;
      font-style: italic;
      color: var(--text-muted);
    }

    .test-whisper-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }

    .log-entry {
      display: flex;
      gap: 0.5rem;
      padding: 0.4rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.8rem;
      align-items: flex-start;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-time {
      color: var(--text-muted);
      white-space: nowrap;
      min-width: 6rem;
      font-family: monospace;
      font-size: 0.75rem;
    }
    .log-zone {
      font-size: 0.65rem;
      background: rgba(107, 143, 191, 0.15);
      color: #6B8FBF;
      padding: 0.1rem 0.35rem;
      border-radius: 3px;
      white-space: nowrap;
    }
    .log-text {
      flex: 1;
      font-style: italic;
      color: var(--text-muted);
    }
    .log-status {
      font-size: 0.65rem;
      padding: 0.1rem 0.35rem;
      border-radius: 3px;
    }
    .log-status--delivered { background: rgba(76, 175, 80, 0.15); color: #4caf50; }
    .log-status--failed { background: rgba(244, 67, 54, 0.15); color: #f44336; }
    .log-status--skipped { background: rgba(255, 193, 7, 0.15); color: #ff9800; }

    .btn-play {
      background: none;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      padding: 0.2rem 0.4rem;
      font-size: 0.75rem;
      color: var(--accent);
      white-space: nowrap;
      transition: all 0.2s;
    }
    .btn-play:hover { background: rgba(107, 143, 191, 0.15); border-color: var(--accent); }
    .btn-play:disabled { opacity: 0.4; cursor: wait; }
    .btn-play.playing { color: #4caf50; border-color: #4caf50; }

    #localAudioPlayer {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 999;
      background: var(--bg-card);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      display: none;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      max-width: 360px;
    }
    #localAudioPlayer.visible { display: flex; }
    #localAudioPlayer .player-text {
      flex: 1;
      font-style: italic;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #localAudioPlayer .player-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1rem;
      padding: 0;
      line-height: 1;
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <!-- Unauthorized overlay -->
  <div id="unauthorizedOverlay" class="loading-overlay hidden">
    <div class="unauthorized-card">
      <h2>Access Denied</h2>
      <p>You need a resident account to view this page.</p>
      <div class="unauthorized-actions">
        <a href="/spaces/" class="btn-secondary">View Spaces</a>
        <button id="signOutBtn" class="btn-secondary">Sign Out</button>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <div id="appContent" class="hidden">
    <header>
      <div class="header-left">
        <a href="https://alpacaplayhouse.com" class="header-logo">
          <img src="https://aphrrfprbixmhissnjfn.supabase.co/storage/v1/object/public/housephotos/logos/alpaca-head-black-transparent.png" alt="AlpacAPPs" class="header-logo__icon">
          <img src="https://aphrrfprbixmhissnjfn.supabase.co/storage/v1/object/public/housephotos/logos/wordmark-black-transparent.png" alt="AlpacAPPs" class="header-logo__wordmark">
        </a>
        <span title="Site version" style="font-size:0.65rem;color:var(--text-muted);font-weight:400;cursor:help;align-self:center;margin-left:-0.25rem">v260209.40 1:36a</span>
        <span id="roleBadge" class="role-badge">Admin</span>
      </div>
      <div class="header-controls">
        <span id="userInfo" class="user-info"></span>
        <button id="headerSignOutBtn" class="btn-secondary">Sign Out</button>
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="manage-tabs" id="tabNav"></div>

    <!-- Main Content -->
    <main class="manage-content">
      <h1 style="margin-bottom:0.25rem;">Life of PAI</h1>
      <p class="text-muted" style="margin-bottom:1.5rem; font-size:0.85rem;">Spirit whisper system control panel. Nothing activates until you approve.</p>

      <!-- Stats -->
      <div class="pai-admin-grid" style="grid-template-columns: repeat(4, 1fr);" id="statsGrid">
        <div class="pai-stat">
          <span class="pai-stat-value" id="statChapter">--</span>
          <span class="pai-stat-label">Current Chapter</span>
        </div>
        <div class="pai-stat">
          <span class="pai-stat-value" id="statWhispersToday">--</span>
          <span class="pai-stat-label">Whispers Today</span>
        </div>
        <div class="pai-stat">
          <span class="pai-stat-value" id="statTotalWhispers">--</span>
          <span class="pai-stat-label">Total Whispers</span>
        </div>
        <div class="pai-stat">
          <span class="pai-stat-value" id="statVolume">--</span>
          <span class="pai-stat-label">Current Volume</span>
        </div>
      </div>

      <!-- Configuration (admin only) -->
      <section class="section admin-only">
        <div class="section-header">
          <h2>Configuration</h2>
          <div class="section-header-actions">
            <button class="btn-small" id="saveConfigBtn">Save Config</button>
          </div>
        </div>
        <div class="section-body">
          <div class="config-row">
            <span class="config-label">System Active</span>
            <label style="display:flex;align-items:center;gap:0.5rem;">
              <input type="checkbox" id="cfgActive">
              <span class="config-value" id="cfgActiveLabel">Off</span>
            </label>
          </div>
          <div class="config-row">
            <span class="config-label">Current Chapter</span>
            <select class="config-select" id="cfgChapter">
              <option value="1">1 - The Whisper in the Wire</option>
              <option value="2">2 - Crossing Through</option>
              <option value="3">3 - I Am Here</option>
              <option value="4">4 - The Guardian Settles</option>
            </select>
          </div>
          <div class="config-row">
            <span class="config-label">Base Volume</span>
            <input type="number" class="config-input" id="cfgBaseVolume" min="1" max="100">
            <span class="config-value">Starting volume level (1-100)</span>
          </div>
          <div class="config-row">
            <span class="config-label">Volume +/day</span>
            <input type="number" class="config-input" id="cfgVolumeIncrement" min="0" max="10" step="0.5">
            <span class="config-value">Volume increase per day</span>
          </div>
          <div class="config-row">
            <span class="config-label">Max Volume</span>
            <input type="number" class="config-input" id="cfgMaxVolume" min="1" max="100">
            <span class="config-value">Volume cap</span>
          </div>
          <div class="config-row">
            <span class="config-label">Active Hours</span>
            <input type="number" class="config-input" id="cfgMinHour" min="0" max="23" style="width:50px;">
            <span class="config-value">to</span>
            <input type="number" class="config-input" id="cfgMaxHour" min="0" max="23" style="width:50px;">
            <span class="config-value">(Austin time, 24h)</span>
          </div>
          <div class="config-row">
            <span class="config-label">Min Interval</span>
            <input type="number" class="config-input" id="cfgMinInterval" min="5" max="480">
            <span class="config-value">minutes between whispers</span>
          </div>
          <div class="config-row">
            <span class="config-label">Max/Day</span>
            <input type="number" class="config-input" id="cfgMaxPerDay" min="1" max="50">
            <span class="config-value">maximum whispers per day</span>
          </div>
          <div class="config-row">
            <span class="config-label">TTS Voice</span>
            <select class="config-select" id="cfgVoice">
              <option value="Sulafat">Sulafat (warm) - recommended</option>
              <option value="Achernar">Achernar (soft)</option>
              <option value="Vindemiatrix">Vindemiatrix (gentle)</option>
              <option value="Aoede">Aoede (breezy)</option>
              <option value="Despina">Despina (smooth)</option>
              <option value="Achird">Achird (friendly)</option>
              <option value="Zephyr">Zephyr (bright)</option>
              <option value="Kore">Kore (firm)</option>
              <option value="Leda">Leda (youthful)</option>
              <option value="Charon">Charon (informative)</option>
              <option value="Gacrux">Gacrux (mature)</option>
            </select>
          </div>
          <div class="config-row">
            <span class="config-label">Device Interactions</span>
            <label style="display:flex;align-items:center;gap:0.5rem;">
              <input type="checkbox" id="cfgDeviceInteraction">
              <span class="config-value">Tesla flash, Govee pulse (Ch2+ only)</span>
            </label>
          </div>
          <div class="config-row">
            <span class="config-label">Interaction Chance</span>
            <input type="number" class="config-input" id="cfgDeviceChance" min="0" max="1" step="0.05">
            <span class="config-value">probability per whisper (0-1)</span>
          </div>
        </div>
      </section>

      <!-- Test Whisper (admin only) -->
      <section class="section admin-only">
        <div class="section-header">
          <h2>Test Whisper</h2>
        </div>
        <div class="section-body">
          <div class="test-whisper-box">
            <p class="text-muted" style="font-size:0.8rem; margin-bottom:0.75rem;">Send a test whisper to a specific Sonos zone. This bypasses all scheduling rules.</p>
            <div style="display:flex; gap:0.75rem; flex-wrap:wrap; align-items:flex-end;">
              <div>
                <label style="font-size:0.75rem; display:block; margin-bottom:0.25rem;">Text</label>
                <input type="text" id="testText" placeholder="...the wind carries me closer..." style="padding:0.4rem 0.6rem; border:1px solid var(--border); border-radius:4px; width:300px; font-size:0.85rem;">
              </div>
              <div>
                <label style="font-size:0.75rem; display:block; margin-bottom:0.25rem;">Zone</label>
                <select id="testZone" class="config-select">
                  <option value="Living Sound">Living Sound</option>
                  <option value="Dining Sound">Dining Sound</option>
                  <option value="SkyBalcony Sound">SkyBalcony Sound</option>
                  <option value="Front Outside Sound">Front Outside Sound</option>
                  <option value="Backyard Sound">Backyard Sound</option>
                  <option value="DJ">DJ</option>
                  <option value="garage outdoors">garage outdoors</option>
                </select>
              </div>
              <div>
                <label style="font-size:0.75rem; display:block; margin-bottom:0.25rem;">Volume</label>
                <input type="number" id="testVolume" value="15" min="1" max="100" class="config-input" style="width:60px;">
              </div>
              <button class="btn-small" id="testWhisperBtn">Send to Sonos</button>
              <button class="btn-play" id="testPreviewBtn" style="font-size:0.8rem; padding:0.35rem 0.6rem;">ðŸ”Š Preview Locally</button>
            </div>
            <p id="testResult" class="text-muted" style="font-size:0.8rem; margin-top:0.5rem;"></p>
          </div>
        </div>
      </section>

      <!-- Whisper Content Pool -->
      <section class="section">
        <div class="section-header">
          <h2>Whisper Pool</h2>
          <span class="text-muted" style="font-size:0.75rem;" id="whisperPoolCount"></span>
        </div>
        <div class="section-body" style="overflow-x: auto;">
          <div id="whisperPoolTabs" style="display:flex; gap:0.5rem; margin-bottom:1rem;">
            <button class="btn-small active" data-ch="1">Ch 1</button>
            <button class="btn-small" data-ch="2">Ch 2</button>
            <button class="btn-small" data-ch="3">Ch 3</button>
            <button class="btn-small" data-ch="4">Ch 4</button>
          </div>
          <table class="whisper-table" id="whisperPoolTable">
            <thead>
              <tr>
                <th style="width:36px;"></th>
                <th>Template</th>
                <th>Requires</th>
                <th>Voice</th>
                <th>Weight</th>
                <th>Active</th>
              </tr>
            </thead>
            <tbody id="whisperPoolBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Delivery Log -->
      <section class="section">
        <div class="section-header">
          <h2>Delivery Log</h2>
          <span class="text-muted" style="font-size:0.75rem;" id="deliveryLogCount"></span>
        </div>
        <div class="section-body">
          <div id="deliveryLog" style="max-height:400px; overflow-y:auto;">
            <p class="text-muted" style="text-align:center; padding:1rem;">Loading...</p>
          </div>
        </div>
      </section>

    </main>

    <!-- Floating audio player for local preview -->
    <div id="localAudioPlayer">
      <span class="player-text" id="playerText"></span>
      <audio id="playerAudio" style="height:28px; width:140px;"></audio>
      <button class="player-close" id="playerClose" title="Close">&times;</button>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3"></script>
  <script type="module" src="lifeofpaiadmin.js"></script>
</body>
</html>
