<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage - AlpacAPPs Admin</title>
  <link rel="icon" type="image/png" href="../../favicon.png">
  <link rel="apple-touch-icon" href="../../apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css?v=4">
  <link rel="stylesheet" href="styles.css?v=4">
  <link rel="stylesheet" href="media.css?v=4">
  <link rel="stylesheet" href="rentals.css?v=1">
  <link rel="stylesheet" href="events.css?v=1">
  <style>
    .manage-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .manage-tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border);
      margin-bottom: 2rem;
    }

    .manage-tab {
      padding: 1rem 2rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .manage-tab:hover {
      color: var(--text);
    }

    .manage-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .manage-panel {
      display: none;
    }

    .manage-panel.active {
      display: block;
    }

    .section {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .section-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .section-header h2 {
      font-size: 1.125rem;
      font-weight: 600;
    }

    .filter-checkboxes {
      display: flex;
      gap: 1rem;
    }

    .checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.875rem;
      font-weight: 400;
      color: var(--text);
      text-transform: none;
      letter-spacing: normal;
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      margin: 0;
      flex-shrink: 0;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .section-filters {
      padding: 1rem 1.5rem;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .filter-row {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    .filter-group label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .filter-group input[type="text"],
    .filter-group select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.875rem;
      min-width: 140px;
    }

    .filter-group input[type="text"]:focus,
    .filter-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .filter-checkboxes-group {
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-checkboxes-group > label {
      display: none;
    }

    .filter-checkboxes-group .filter-checkboxes {
      height: 36px;
      display: flex;
      align-items: center;
    }

    /* Hide filter toggles on desktop - only show on mobile */
    .filter-toggle,
    .tag-filter-toggle {
      display: none;
    }

    @media (max-width: 900px) {
      .filter-row {
        flex-wrap: wrap;
      }
      .filter-group {
        flex: 1;
        min-width: 140px;
      }
    }

    /* Tags filter in Media tab - allow shrinking and wrapping */
    .media-toolbar .filter-group {
      flex-shrink: 1;
      min-width: 0;
    }

    .media-toolbar .tag-filter-chips {
      max-width: 350px;
      flex-wrap: wrap;
    }

    @media (max-width: 900px) {
      .media-toolbar .tag-filter-chips {
        max-width: 200px;
      }
    }

    @media (max-width: 600px) {
      .media-toolbar .tag-filter-chips {
        max-width: 150px;
      }
    }

    .section-body {
      padding: 1.5rem;
    }

    /* Spaces list */
    .spaces-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .space-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--bg);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .space-item:hover {
      border-color: var(--accent);
    }

    .space-item-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .space-item-thumb {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: var(--radius);
      cursor: pointer;
      transition: opacity 0.15s ease;
    }

    .space-item-thumb:hover {
      opacity: 0.8;
    }

    .space-item-meta {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-left: auto;
      margin-right: 1rem;
    }

    .space-type {
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius);
      font-size: 0.75rem;
      font-weight: 500;
      background: #f1f5f9;
      color: #64748b;
    }

    /* Lightbox */
    .lightbox-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      cursor: pointer;
    }

    .lightbox-overlay.hidden {
      display: none;
    }

    .lightbox-overlay img {
      max-width: 90vw;
      max-height: 90vh;
      object-fit: contain;
      border-radius: var(--radius);
    }

    .lightbox-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .space-item-thumb-placeholder {
      width: 48px;
      height: 48px;
      background: var(--border);
      border-radius: var(--radius);
    }

    .space-item-details h3 {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.125rem;
    }

    .space-item-details small {
      color: var(--text-muted);
    }

    .space-item-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Add space form */
    .add-space-form {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
    }

    .add-space-form .form-group {
      margin-bottom: 0;
    }

    @media (max-width: 768px) {
      .add-space-form {
        grid-template-columns: 1fr;
      }

      /* Mobile container padding */
      .manage-container {
        padding: 1rem;
      }

      /* Mobile tabs - horizontal scroll */
      .manage-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 1rem;
      }

      .manage-tab {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        white-space: nowrap;
        flex-shrink: 0;
      }

      /* Section styles */
      .section-header {
        padding: 0.75rem 1rem;
        flex-wrap: wrap;
      }

      .section-header h2 {
        font-size: 1rem;
      }

      .section-body {
        padding: 1rem;
      }

      /* Filter row mobile */
      .section-filters {
        padding: 0.75rem 1rem;
      }

      .filter-row {
        flex-direction: column;
        gap: 0.75rem;
      }

      .filter-group {
        width: 100%;
        flex-shrink: 1;
      }

      .filter-group input[type="text"],
      .filter-group select {
        width: 100%;
        min-width: 0;
      }

      .filter-checkboxes {
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      /* Collapsible filters on mobile */
      .section-filters {
        position: relative;
      }

      .section-filters.collapsed .filter-row {
        display: none;
      }

      .section-filters.collapsed .filter-toggle {
        margin-bottom: 0;
      }

      .filter-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0;
        margin-bottom: 0.75rem;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--accent);
        border-bottom: 1px solid var(--border);
      }

      .filter-toggle::after {
        content: '▼';
        font-size: 0.6rem;
        transition: transform 0.2s;
      }

      .section-filters.collapsed .filter-toggle::after {
        transform: rotate(-90deg);
      }

      /* Spaces table wrapper for horizontal scroll */
      .spaces-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -1rem;
        padding: 0 1rem;
      }

      .spaces-table-wrapper table {
        min-width: 600px;
      }

      /* Tag filter bar collapsible on mobile */
      .tag-filter-bar {
        padding: 0.5rem 1rem;
        flex-direction: column;
        gap: 0.5rem;
      }

      .tag-filter-bar.collapsed .tag-filter-chips {
        display: none;
      }

      .tag-filter-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--accent);
      }

      .tag-filter-toggle::after {
        content: '▼';
        font-size: 0.5rem;
        transition: transform 0.2s;
      }

      .tag-filter-bar.collapsed .tag-filter-toggle::after {
        transform: rotate(-90deg);
      }

      /* Compact tag groups on mobile */
      .tag-filter-group {
        flex-direction: column;
        gap: 0.25rem;
      }

      .tag-filter-group-label {
        font-size: 0.6rem;
        min-width: unset;
        padding-top: 0;
      }

      .tag-filter-chips {
        gap: 0.25rem;
      }

      .tag-filter-group-chips {
        gap: 0.2rem;
      }

      .tag-filter-chip {
        padding: 0.15rem 0.4rem;
        font-size: 0.6rem;
      }

      /* Users table mobile scroll */
      .users-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .users-table {
        min-width: 500px;
      }

      .users-table th,
      .users-table td {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
      }
    }

    /* User Management Styles */
    .invite-form {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .invite-form input[type="email"] {
      flex: 1;
      min-width: 200px;
      padding: 0.625rem 0.875rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.875rem;
    }

    .invite-form input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .invite-form select {
      padding: 0.625rem 0.875rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.875rem;
      background: var(--bg-card);
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table th,
    .users-table td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .users-table th {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      background: var(--bg);
    }

    .users-table tr:last-child td {
      border-bottom: none;
    }

    .users-table tr:hover td {
      background: var(--bg);
    }

    .role-select {
      padding: 0.375rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.875rem;
      background: var(--bg-card);
    }

    .role-select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .you-tag {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      background: var(--accent-light);
      color: var(--accent);
      border-radius: 4px;
      margin-left: 0.5rem;
    }

    .btn-danger {
      padding: 0.375rem 0.75rem;
      border: 1px solid var(--occupied);
      background: var(--bg-card);
      color: var(--occupied);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-danger:hover {
      background: var(--occupied);
      color: white;
    }

    .users-empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    /* Spaces Table Improvements */
    #tableView table {
      table-layout: fixed;
      width: 100%;
    }

    #tableView th,
    #tableView td {
      padding: 0.625rem 0.75rem;
      vertical-align: middle;
    }

    /* Only apply truncation to table data cells, not headers */
    #tableView td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Allow headers to wrap if needed */
    #tableView th {
      font-size: 0.7rem;
      white-space: normal;
      word-break: break-word;
    }

    /* Column widths with min-widths to prevent excessive truncation */
    #tableView th:nth-child(1),
    #tableView td:nth-child(1) { width: 148px; min-width: 148px; } /* thumbnail - 2x wider */

    #tableView th:nth-child(2),
    #tableView td:nth-child(2) { min-width: 560px; white-space: normal; } /* name + description - 2x wider */

    #tableView th:nth-child(3),
    #tableView td:nth-child(3) { min-width: 55px; } /* rate */

    #tableView th:nth-child(4),
    #tableView td:nth-child(4) { min-width: 70px; white-space: normal; } /* details (size/bath/beds stacked) */

    #tableView th:nth-child(5),
    #tableView td:nth-child(5) { min-width: 60px; white-space: normal; } /* amenities */

    #tableView th:nth-child(6),
    #tableView td:nth-child(6) { min-width: 55px; } /* available */

    #tableView th:nth-child(7),
    #tableView td:nth-child(7) { min-width: 60px; } /* until */

    #tableView th:nth-child(8),
    #tableView td:nth-child(8) { min-width: 80px; white-space: normal; } /* tenant */

    #tableView th:nth-child(9),
    #tableView td:nth-child(9) { min-width: 80px; white-space: normal; } /* lease dates */

    #tableView th:nth-child(10),
    #tableView td:nth-child(10) { min-width: 35px; text-align: center; } /* status */

    #tableView th:nth-child(11),
    #tableView td:nth-child(11) { min-width: 30px; text-align: center; overflow: visible; } /* vis */

    /* Table container should scroll horizontally when needed */
    .table-container {
      overflow-x: auto;
    }

    #tableView table {
      min-width: 1300px;
    }

    #tableView .table-thumbnail {
      width: 128px;
      height: 86px;
      object-fit: cover;
      border-radius: 4px;
      display: block;
    }

    #tableView .table-thumbnail-placeholder {
      width: 128px;
      height: 86px;
      background: var(--bg);
      border-radius: 4px;
      border: 1px dashed var(--border);
    }

    #tableView .td-thumbnail {
      padding: 0.375rem 0.5rem !important;
      width: 74px;
    }

    #tableView .td-details {
      font-size: 0.8rem;
      line-height: 1.4;
      color: var(--text-muted);
    }

    #tableView .td-name-desc {
      min-width: 560px;
    }

    #tableView td small {
      display: block;
      color: var(--text-muted);
      font-size: 0.75rem;
      line-height: 1.3;
    }

    #tableView .badge {
      font-size: 0.65rem;
      padding: 0.2rem 0.5rem;
      white-space: nowrap;
    }

    /* Improve description text */
    .td-description-inline {
      color: var(--text-muted);
      font-size: 0.75rem;
      line-height: 1.3;
      display: block;
      margin-top: 0.125rem;
    }

    /* Filter row cleanup */
    .section-filters {
      padding: 0.875rem 1.25rem;
    }

    .filter-row {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .filter-group {
      min-width: auto;
    }

    .filter-group input[type="text"] {
      width: 160px;
    }

    .filter-group select {
      min-width: 120px;
    }

    .invite-note {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.75rem;
    }

    .role-badge {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .role-badge.admin {
      background: #fef3c7;
      color: #92400e;
    }

    .role-badge.staff {
      background: #e0e7ff;
      color: #3730a3;
    }

    .admin-only-notice {
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: var(--radius);
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #92400e;
    }

    .admin-only-notice svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    /* Template type selector */
    .template-type-select {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      background: var(--bg-card);
      cursor: pointer;
      min-width: 180px;
    }

    .template-type-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Airbnb Sync Styles */
    .sync-status {
      padding: 0.75rem 1rem;
      background: var(--bg);
      border-radius: var(--radius);
      margin-bottom: 1rem;
    }

    .sync-status p {
      margin: 0;
      font-size: 0.875rem;
    }

    .sync-results {
      padding: 1rem;
      background: var(--bg);
      border-radius: var(--radius);
      margin-bottom: 1rem;
    }

    .sync-results h4 {
      margin: 0 0 0.5rem 0;
      font-size: 0.9rem;
    }

    .sync-results ul {
      margin: 0;
      padding-left: 1.25rem;
      font-size: 0.875rem;
    }

    .sync-results li {
      margin-bottom: 0.25rem;
    }

    .linked-spaces-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .occupancy-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .occupancy-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 2px solid var(--border);
      font-weight: 600;
    }

    .occupancy-table th.col-airbnb {
      color: #FF5A5F;
      border-bottom-color: #FF5A5F;
    }

    .occupancy-table th.col-direct {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .occupancy-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    .occupancy-table tr:last-child td {
      border-bottom: none;
    }

    .occupancy-table .space-name {
      font-weight: 600;
      min-width: 140px;
    }

    .occupancy-cell {
      font-size: 0.8rem;
    }

    .occupancy-cell .guest-name {
      font-weight: 500;
    }

    .occupancy-cell .guest-name.airbnb {
      color: #FF5A5F;
    }

    .occupancy-cell .guest-name.tenant {
      color: var(--accent);
    }

    .occupancy-cell .guest-name.blocked {
      color: var(--warning);
    }

    .occupancy-cell .guest-dates {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .occupancy-cell .empty {
      color: var(--text-muted);
    }

    .availability {
      font-weight: 500;
    }

    .availability.available {
      color: var(--success);
    }

    .availability.occupied {
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Image Lightbox (with navigation) -->
  <div id="imageLightbox" class="lightbox hidden">
    <button class="lightbox-close">&times;</button>
    <button class="lightbox-nav lightbox-prev" id="lightboxPrev">&#10094;</button>
    <img id="lightboxImage" src="" alt="">
    <button class="lightbox-nav lightbox-next" id="lightboxNext">&#10095;</button>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <div id="unauthorizedOverlay" class="loading-overlay hidden">
    <div class="unauthorized-card">
      <h2>Access Denied</h2>
      <p>Your account is not authorized to access admin features.</p>
      <p>Please contact an administrator to request access.</p>
      <div class="unauthorized-actions">
        <a href="/spaces/" class="btn-secondary">View Public Spaces</a>
        <button id="signOutBtn" class="btn-secondary">Sign Out</button>
      </div>
    </div>
  </div>

  <div id="appContent" class="hidden">
    <header>
      <div class="header-left">
        <h1>&#129433; AlpacAPPs Admin</h1>
        <span id="roleBadge" class="role-badge">Staff</span>
      </div>
      <div class="header-controls">
        <a href="/spaces/" class="btn-small">Public View</a>
        <span id="userInfo" class="user-info"></span>
        <button id="headerSignOutBtn" class="btn-secondary">Sign Out</button>
      </div>
    </header>

    <div class="manage-container">
      <div class="manage-tabs">
        <button class="manage-tab active" data-tab="spaces">Spaces</button>
        <button class="manage-tab" data-tab="rentals">Rentals</button>
        <button class="manage-tab" data-tab="events">Events</button>
        <button class="manage-tab" data-tab="media">Media</button>
        <button class="manage-tab" data-tab="users">Users</button>
        <button class="manage-tab" data-tab="templates">Templates</button>
        <button class="manage-tab" data-tab="settings">Settings</button>
        <button class="manage-tab" data-tab="accounting">Accounting</button>
        <button class="manage-tab" data-tab="faq">FAQ & AI</button>
      </div>

      <!-- Spaces Panel -->
      <div id="spacesPanel" class="manage-panel active">
        <!-- All Spaces with Card/Table Views -->
        <div class="section">
          <div class="section-header">
            <h2>All Spaces</h2>
            <span id="spacesCount" class="text-muted"></span>
            <div class="view-toggle" style="margin-left: auto;">
              <button id="cardViewBtn" title="Card view">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
                  <rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
                </svg>
              </button>
              <button id="tableViewBtn" class="active" title="Table view">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="section-filters" id="spacesFilters">
            <div class="filter-toggle" onclick="this.parentElement.classList.toggle('collapsed')">
              <span>Filters</span>
            </div>
            <div class="filter-row">
              <div class="filter-group">
                <label for="searchFilter">Search</label>
                <input type="text" id="searchFilter" placeholder="Search spaces...">
              </div>
              <div class="filter-group">
                <label for="parentFilter">Parent Area</label>
                <select id="parentFilter">
                  <option value="">All areas</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="bathFilter">Bathroom</label>
                <select id="bathFilter">
                  <option value="">Any bathroom</option>
                  <option value="private">Private</option>
                  <option value="shared">Shared</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="visibilityFilter">Visibility</label>
                <select id="visibilityFilter">
                  <option value="">All visibility</option>
                  <option value="listed">Listed</option>
                  <option value="unlisted">Unlisted</option>
                  <option value="secret">Secret</option>
                </select>
              </div>
              <div class="filter-group filter-checkboxes-group">
                <label>Type</label>
                <div class="filter-checkboxes">
                  <label class="checkbox-label"><input type="checkbox" id="showDwellings" checked> Dwelling</label>
                  <label class="checkbox-label"><input type="checkbox" id="showEventSpaces" checked> Event Space</label>
                  <label class="checkbox-label"><input type="checkbox" id="showOther" checked> Other</label>
                </div>
              </div>
              <button id="clearSpaceFilters" class="btn-small" style="align-self: flex-end; padding: 0.5rem 0.75rem;">Clear</button>
            </div>
          </div>

          <!-- Card View -->
          <div id="cardView" class="card-grid hidden" style="padding: 1.5rem;">
            <!-- Populated by JS -->
          </div>

          <!-- Table View (default) -->
          <div id="tableView" class="table-container">
            <div class="spaces-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th></th>
                  <th data-sort="name" style="min-width: 560px;">Name</th>
                  <th data-sort="monthly_rate">Rate</th>
                  <th data-sort="sq_footage">Details</th>
                  <th>Amenities</th>
                  <th data-sort="availability">Available</th>
                  <th>Until</th>
                  <th>Tenant</th>
                  <th>Lease Dates</th>
                  <th>Status</th>
                  <th>Vis</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
            </div><!-- end spaces-table-wrapper -->
          </div>
        </div>

        <!-- Archived Spaces -->
        <div class="section" id="archivedSection" style="display: none;">
          <div class="section-header">
            <h2>Archived Spaces</h2>
            <span id="archivedCount" class="text-muted"></span>
          </div>
          <div class="section-body">
            <p class="form-hint" style="margin-bottom: 1rem;">These spaces are hidden from all views but can be restored.</p>
            <div id="archivedSpacesList" class="spaces-list">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Add New Space (at bottom since rarely used) -->
        <div class="section" style="margin-top: 2rem;">
          <div class="section-header">
            <h2>Add New Space</h2>
          </div>
          <div class="section-body">
            <form id="addSpaceForm" class="add-space-form">
              <div class="form-group">
                <label for="newSpaceName">Name *</label>
                <input type="text" id="newSpaceName" required placeholder="e.g., Garden Suite">
              </div>
              <div class="form-group">
                <label for="newSpaceParent">Parent Space</label>
                <select id="newSpaceParent">
                  <option value="">None (top-level)</option>
                </select>
              </div>
              <button type="submit" class="btn-primary">Add Space</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Rentals Panel -->
      <div id="rentalsPanel" class="manage-panel">
        <!-- Pipeline View -->
        <div class="rental-pipeline" id="rentalPipeline">
          <div class="pipeline-column" data-stage="applications">
            <div class="pipeline-header">
              <h3>Applications</h3>
              <span class="pipeline-count" id="applicationsCount">0</span>
            </div>
            <div class="pipeline-cards" id="applicationsCards"></div>
          </div>
          <div class="pipeline-column" data-stage="approved">
            <div class="pipeline-header">
              <h3>Approved</h3>
              <span class="pipeline-count" id="approvedCount">0</span>
            </div>
            <div class="pipeline-cards" id="approvedCards"></div>
          </div>
          <div class="pipeline-column" data-stage="contract">
            <div class="pipeline-header">
              <h3>Contract</h3>
              <span class="pipeline-count" id="contractCount">0</span>
            </div>
            <div class="pipeline-cards" id="contractCards"></div>
          </div>
          <div class="pipeline-column" data-stage="deposit">
            <div class="pipeline-header">
              <h3>Deposit</h3>
              <span class="pipeline-count" id="depositCount">0</span>
            </div>
            <div class="pipeline-cards" id="depositCards"></div>
          </div>
          <div class="pipeline-column" data-stage="ready">
            <div class="pipeline-header">
              <h3>Ready</h3>
              <span class="pipeline-count" id="readyCount">0</span>
            </div>
            <div class="pipeline-cards" id="readyCards"></div>
          </div>
        </div>

        <!-- Denied Section (collapsible) -->
        <details class="section" id="deniedSection" style="margin-top: 1.5rem;">
          <summary class="section-header" style="cursor: pointer;">
            <h2>Denied</h2>
            <span id="deniedCount" class="text-muted">0</span>
          </summary>
          <div class="section-body">
            <div id="deniedList" class="spaces-list"></div>
          </div>
        </details>

        <!-- Active & Upcoming Assignments Table -->
        <div class="section" style="margin-top: 1.5rem;">
          <div class="section-header">
            <h2>Active & Upcoming Assignments</h2>
            <span id="assignmentsCount" class="text-muted">0</span>
          </div>
          <div class="section-body">
            <div id="assignmentsTableContainer">
              <div class="calendar-loading">Loading assignments...</div>
            </div>
          </div>
        </div>

        <!-- Reservations Calendar Section -->
        <div class="section" style="margin-top: 1.5rem;">
          <div class="section-header">
            <h2>Reservations Calendar</h2>
            <div class="calendar-controls">
              <button class="btn-small" id="calendarToday">Today</button>
              <span id="calendarMonthRange" class="calendar-month-label" style="min-width: auto;"></span>
            </div>
          </div>
          <div class="section-body">
            <div id="reservationsCalendar" class="reservations-calendar">
              <div class="calendar-loading">Loading reservations...</div>
            </div>
          </div>
        </div>

        <!-- Create Test Application (for development) -->
        <div class="section" style="margin-top: 1.5rem;">
          <div class="section-header">
            <h2>Create Application</h2>
          </div>
          <div class="section-body">
            <form id="createApplicationForm" class="add-space-form">
              <div class="form-group">
                <label for="newAppPersonId">Person</label>
                <select id="newAppPersonId" required>
                  <option value="">Select a person...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="newAppSpaceId">Desired Space</label>
                <select id="newAppSpaceId">
                  <option value="">Any / Flexible</option>
                </select>
              </div>
              <button type="submit" class="btn-primary">Create Application</button>
            </form>
          </div>
        </div>

        <!-- Airbnb Rentals Section -->
        <div class="section" style="margin-top: 1.5rem;">
          <div class="section-header">
            <h2>Airbnb Rentals</h2>
            <button class="btn-small btn-primary" id="syncAirbnbBtn">Sync Now</button>
          </div>
          <div class="section-body">
            <p class="text-muted" style="margin-bottom: 1rem;">
              Import bookings from Airbnb iCal feeds. Syncs automatically every hour.
            </p>
            <div id="airbnbSyncStatus" class="sync-status">
              <p>Last sync: <span id="lastSyncTime">Never</span></p>
            </div>
            <div id="airbnbSyncResults" class="sync-results hidden">
              <h4>Sync Results</h4>
              <div id="syncResultsContent"></div>
            </div>
            <div class="airbnb-spaces-list" style="margin-top: 1rem;">
              <div id="linkedSpacesList" class="linked-spaces-grid">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Events Panel -->
      <div id="eventsPanel" class="manage-panel">
        <!-- Pipeline View -->
        <div class="event-pipeline" id="eventPipeline">
          <div class="pipeline-column" data-stage="requests">
            <div class="pipeline-header">
              <h3>Requests</h3>
              <span class="pipeline-count" id="eventRequestsCount">0</span>
            </div>
            <div class="pipeline-cards" id="eventRequestsCards"></div>
          </div>
          <div class="pipeline-column" data-stage="approved">
            <div class="pipeline-header">
              <h3>Approved</h3>
              <span class="pipeline-count" id="eventApprovedCount">0</span>
            </div>
            <div class="pipeline-cards" id="eventApprovedCards"></div>
          </div>
          <div class="pipeline-column" data-stage="contract">
            <div class="pipeline-header">
              <h3>Contract</h3>
              <span class="pipeline-count" id="eventContractCount">0</span>
            </div>
            <div class="pipeline-cards" id="eventContractCards"></div>
          </div>
          <div class="pipeline-column" data-stage="deposit">
            <div class="pipeline-header">
              <h3>Deposit</h3>
              <span class="pipeline-count" id="eventDepositCount">0</span>
            </div>
            <div class="pipeline-cards" id="eventDepositCards"></div>
          </div>
          <div class="pipeline-column" data-stage="ready">
            <div class="pipeline-header">
              <h3>Ready</h3>
              <span class="pipeline-count" id="eventReadyCount">0</span>
            </div>
            <div class="pipeline-cards" id="eventReadyCards"></div>
          </div>
        </div>

        <!-- Denied Section (collapsible) -->
        <details class="section" id="eventDeniedSection" style="margin-top: 1.5rem;">
          <summary class="section-header" style="cursor: pointer;">
            <h2>Denied</h2>
            <span id="eventDeniedCount" class="text-muted">0</span>
          </summary>
          <div class="section-body">
            <div id="eventDeniedList" class="spaces-list"></div>
          </div>
        </details>

        <!-- Events Calendar Section -->
        <div class="section" style="margin-top: 1.5rem;">
          <div class="section-header">
            <h2>Events Calendar</h2>
            <div class="calendar-controls">
              <button class="btn-small" id="eventCalendarPrevMonth">&larr;</button>
              <span id="eventCalendarMonthLabel" class="calendar-month-label"></span>
              <button class="btn-small" id="eventCalendarNextMonth">&rarr;</button>
              <button class="btn-small" id="eventCalendarToday" style="margin-left: 0.5rem;">Today</button>
            </div>
          </div>
          <div class="section-body">
            <div id="eventsCalendar" class="events-calendar">
              <div class="calendar-loading">Loading events...</div>
            </div>
          </div>
        </div>

        <!-- Create Event Request Section -->
        <div class="section" style="margin-top: 1.5rem;">
          <div class="section-header">
            <h2>Create Event Request</h2>
          </div>
          <div class="section-body">
            <form id="createEventRequestForm" class="add-space-form">
              <div class="event-form-grid">
                <div class="form-group">
                  <label for="newEventPersonId">Client</label>
                  <select id="newEventPersonId" required>
                    <option value="">Select a person...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="newEventOrgName">Organization (optional)</label>
                  <input type="text" id="newEventOrgName" placeholder="If hosting for an org...">
                </div>
                <div class="form-group">
                  <label for="newEventName">Event Name</label>
                  <input type="text" id="newEventName" required placeholder="e.g., Birthday Party">
                </div>
                <div class="form-group">
                  <label for="newEventType">Event Type</label>
                  <select id="newEventType">
                    <option value="party">Party</option>
                    <option value="workshop">Workshop</option>
                    <option value="retreat">Retreat</option>
                    <option value="ceremony">Ceremony</option>
                    <option value="meeting">Meeting</option>
                    <option value="photoshoot">Photoshoot</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="newEventDate">Event Date</label>
                  <input type="date" id="newEventDate" required>
                </div>
                <div class="form-group">
                  <label>Event Time</label>
                  <div class="time-inputs">
                    <input type="time" id="newEventStartTime" required>
                    <span>to</span>
                    <input type="time" id="newEventEndTime" required>
                  </div>
                </div>
                <div class="form-group">
                  <label for="newEventGuests">Expected Guests</label>
                  <input type="number" id="newEventGuests" required min="1" max="100" value="25">
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="newEventHostedBefore">
                    Has hosted at venue before
                  </label>
                </div>
                <div class="form-group full-width">
                  <label for="newEventDescription">Event Description</label>
                  <textarea id="newEventDescription" rows="2" placeholder="Brief description of the event..."></textarea>
                </div>
              </div>
              <button type="submit" class="btn-primary" style="margin-top: 1rem;">Create Event Request</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Media Panel -->
      <div id="mediaPanel" class="manage-panel">
        <!-- Storage indicator -->
        <div class="storage-banner">
          <div id="storageIndicator" class="storage-indicator-inline"></div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
          <div class="upload-area" id="mediaUploadArea">
            <input type="file" id="mediaFileInput" accept="image/jpeg,image/png,image/webp,image/gif" multiple hidden>
            <div class="upload-prompt">
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <span>Drop images here or <button type="button" class="btn-link" id="mediaBrowseBtn">browse</button></span>
              <span class="upload-hint">JPEG, PNG, WebP, GIF • Max 10 files at once</span>
            </div>
          </div>

          <!-- Upload preview and options (shown when files selected) -->
          <div id="mediaUploadPreview" class="upload-preview-section hidden">
            <div class="upload-preview-header">
              <span><strong id="mediaUploadFileCount">0</strong> files selected</span>
              <button type="button" class="btn-small" id="mediaClearUploadBtn">Clear All</button>
            </div>

            <div id="mediaUploadPreviewGrid" class="upload-preview-grid"></div>

            <div class="upload-options">
              <div class="upload-options-row">
                <div class="form-group">
                  <label for="mediaUploadCaption">Caption for all (optional):</label>
                  <input type="text" id="mediaUploadCaption" placeholder="Leave empty to set per-image">
                </div>
                <div class="form-group">
                  <label for="mediaUploadCategory">Category:</label>
                  <select id="mediaUploadCategory">
                    <option value="space">Space</option>
                    <option value="mktg">Marketing</option>
                    <option value="projects">Projects</option>
                    <option value="archive">Archive</option>
                  </select>
                </div>
              </div>

              <fieldset class="form-fieldset">
                <legend>Tags (apply to all)</legend>
                <div id="mediaUploadTagsContainer" class="tags-container">
                  <!-- Tags populated by JS -->
                </div>
              </fieldset>
            </div>

            <!-- Upload progress -->
            <div id="mediaUploadProgress" class="upload-progress hidden">
              <div class="progress-bar">
                <div class="progress-fill" id="mediaUploadProgressFill"></div>
              </div>
              <p class="progress-text" id="mediaUploadProgressText">Uploading 0 of 0...</p>
            </div>

            <div class="upload-actions">
              <button type="button" class="btn-secondary" id="mediaCancelUploadBtn">Cancel</button>
              <button type="button" class="btn-primary" id="mediaSubmitUploadBtn">Upload All</button>
            </div>
          </div>
        </div>

        <!-- Filters and actions bar -->
        <div class="media-toolbar">
          <div class="toolbar-left">
            <div class="filter-group">
              <label>Category:</label>
              <select id="categoryFilter">
                <option value="">All</option>
                <option value="mktg">Marketing</option>
                <option value="projects">Projects</option>
                <option value="archive">Archive</option>
              </select>
            </div>
          </div>
          <div class="toolbar-right">
            <span id="mediaCount" class="media-count">0 items</span>
            <button id="bulkTagBtn" class="btn-small" disabled>Edit Tags (<span id="selectedCount">0</span>)</button>
            <button id="bulkDeleteBtn" class="btn-danger-outline" disabled>Delete</button>
            <button id="selectAllBtn" class="btn-small">Select All</button>
            <button id="deselectAllBtn" class="btn-small hidden">Deselect All</button>
          </div>
        </div>

        <!-- Tag filters as horizontal row -->
        <div class="tag-filter-bar collapsed" id="tagFilterBar">
          <div class="tag-filter-toggle" onclick="this.parentElement.classList.toggle('collapsed')">
            <span>Space Tags</span>
          </div>
          <div id="tagFilterChips" class="tag-filter-chips"></div>
          <button id="clearFilters" class="btn-small">Clear Filters</button>
        </div>

        <!-- Media grid -->
        <div id="mediaGrid" class="media-library-grid">
          <!-- Media items populated by JS -->
        </div>

        <div id="emptyState" class="empty-state hidden">
          <p>No media found.</p>
          <p class="hint">Upload some images from a space's edit page.</p>
        </div>
      </div>

      <!-- Users Panel -->
      <div id="usersPanel" class="manage-panel">
        <!-- Admin-only notice (shown to non-admins) -->
        <div id="usersAdminNotice" class="admin-only-notice hidden">
          <svg viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <span>Only administrators can manage users. You have read-only access.</span>
        </div>

        <!-- Invite Section (admin only) -->
        <div id="usersInviteSection" class="section">
          <div class="section-header">
            <h2>Invite New User</h2>
          </div>
          <div class="section-body">
            <form id="inviteForm" class="invite-form">
              <input type="email" id="inviteEmail" placeholder="user@gmail.com" required>
              <select id="inviteRole">
                <option value="staff">Staff (read-only)</option>
                <option value="admin">Admin (full access)</option>
              </select>
              <button type="submit" class="btn-primary">Send Invitation</button>
            </form>
            <p class="invite-note">
              Users must sign in with the exact email address you invite.
            </p>
          </div>
        </div>

        <!-- Pending Invitations -->
        <div class="section">
          <div class="section-header">
            <h2>Pending Invitations</h2>
            <span id="pendingCount" class="role-badge staff">0</span>
          </div>
          <div id="pendingSection">
            <div class="users-empty-state">Loading...</div>
          </div>
        </div>

        <!-- Active Users -->
        <div class="section">
          <div class="section-header">
            <h2>Active Users</h2>
            <span id="usersCount" class="role-badge staff">0</span>
          </div>
          <div id="usersSection">
            <div class="users-empty-state">Loading...</div>
          </div>
        </div>
      </div>

      <!-- Templates Panel -->
      <div id="templatesPanel" class="manage-panel">
        <!-- Template Type Selector -->
        <div class="section">
          <div class="section-header">
            <h2>Template Editor</h2>
            <div class="header-actions">
              <select id="templateTypeSelector" class="template-type-select">
                <option value="lease">Lease Agreement</option>
                <option value="event">Event Agreement</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Lease Template Section -->
        <div id="leaseTemplateSection">
          <div class="section">
            <div class="section-header">
              <h2>Lease Agreement Template</h2>
              <div class="header-actions">
                <button type="button" id="loadDefaultTemplateBtn" class="btn-small">Load Default</button>
                <button type="button" id="saveTemplateBtn" class="btn-small btn-primary">Save Template</button>
              </div>
            </div>
            <div class="section-body">
              <p class="text-muted" style="margin-bottom: 1rem;">
                Edit the lease agreement template below. Use <code>{{placeholder}}</code> syntax for dynamic fields.
                The template uses Markdown formatting: <code># Header</code>, <code>**bold**</code>, <code>- bullet list</code>, <code>---</code> for horizontal rule.
              </p>

              <div class="template-editor-container">
                <div class="template-editor">
                  <label for="templateName">Template Name</label>
                  <input type="text" id="templateName" value="Standard Lease Agreement" style="margin-bottom: 1rem;">

                  <label for="templateContent">Template Content</label>
                  <textarea id="templateContent" class="template-textarea" rows="20" placeholder="Enter lease template content..."></textarea>
                </div>

                <div class="placeholder-reference">
                  <h4>Available Placeholders</h4>
                  <div id="placeholderList" class="placeholder-list"></div>
                </div>
              </div>

              <div class="template-actions" style="margin-top: 1rem;">
                <label class="checkbox-label">
                  <input type="checkbox" id="templateMakeActive" checked>
                  Set as active template
                </label>
              </div>

              <div id="templateValidation" class="template-validation" style="display: none; margin-top: 1rem;"></div>
            </div>
          </div>

          <!-- Lease Template History Section -->
          <div class="section">
            <div class="section-header">
              <h2>Template History</h2>
            </div>
            <div class="section-body">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Version</th>
                    <th>Created</th>
                    <th>Active</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="templateHistoryBody">
                  <tr><td colspan="5" class="text-muted">No templates saved yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- SignWell Configuration (only for lease templates) -->
          <div class="section">
            <div class="section-header">
              <h2>SignWell Integration</h2>
            </div>
            <div class="section-body">
              <p class="text-muted" style="margin-bottom: 1rem;">
                Configure SignWell for electronic signature collection. Get your API key from
                <a href="https://www.signwell.com/api/" target="_blank">signwell.com/api</a>.
              </p>
              <div class="form-group">
                <label for="signwellApiKey">API Key</label>
                <input type="password" id="signwellApiKey" placeholder="Enter SignWell API key...">
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="signwellTestMode" checked>
                  Test Mode (documents won't be sent for real signatures)
                </label>
              </div>
              <button type="button" id="saveSignwellConfigBtn" class="btn-small btn-primary">Save SignWell Config</button>
            </div>
          </div>
        </div>

        <!-- Event Template Section -->
        <div id="eventTemplateSection" style="display: none;">
          <div class="section">
            <div class="section-header">
              <h2>Event Agreement Template</h2>
              <div class="header-actions">
                <button type="button" id="loadDefaultEventTemplateBtn" class="btn-small">Load Default</button>
                <button type="button" id="saveEventTemplateBtn" class="btn-small btn-primary">Save Template</button>
              </div>
            </div>
            <div class="section-body">
              <p class="text-muted" style="margin-bottom: 1rem;">
                Edit the event hosting agreement template. Use <code>{{placeholder}}</code> syntax for dynamic fields.
              </p>

              <div class="template-editor-container">
                <div class="template-editor">
                  <label for="eventTemplateName">Template Name</label>
                  <input type="text" id="eventTemplateName" value="Standard Event Agreement" style="margin-bottom: 1rem;">

                  <label for="eventTemplateContent">Template Content</label>
                  <textarea id="eventTemplateContent" class="template-textarea" rows="20" placeholder="Enter event agreement template content..."></textarea>
                </div>

                <div class="placeholder-reference">
                  <h4>Available Placeholders</h4>
                  <div id="eventPlaceholderList" class="placeholder-list"></div>
                </div>
              </div>

              <div class="template-actions" style="margin-top: 1rem;">
                <label class="checkbox-label">
                  <input type="checkbox" id="eventTemplateMakeActive" checked>
                  Set as active template
                </label>
              </div>

              <div id="eventTemplateValidation" class="template-validation" style="display: none; margin-top: 1rem;"></div>
            </div>
          </div>

          <!-- Event Template History Section -->
          <div class="section">
            <div class="section-header">
              <h2>Template History</h2>
            </div>
            <div class="section-body">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Version</th>
                    <th>Created</th>
                    <th>Active</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="eventTemplateHistoryBody">
                  <tr><td colspan="5" class="text-muted">No templates saved yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Panel -->
      <div id="settingsPanel" class="manage-panel">
        <!-- Payment Methods Section -->
        <div class="section">
          <div class="section-header">
            <h2>Payment Methods</h2>
            <button class="btn-small btn-primary" id="addPaymentMethodBtn">+ Add Method</button>
          </div>
          <div class="section-body">
            <p class="text-muted" style="margin-bottom: 1rem;">
              Configure payment methods that tenants can use for rent and deposits.
            </p>
            <div id="paymentMethodsList" class="payment-methods-grid"></div>
          </div>
        </div>

        <!-- Fee Settings Section (Square Payments) -->
        <div class="section">
          <div class="section-header">
            <h2>Payment Fees (Square)</h2>
            <span class="badge" id="squareModeBadge">Test Mode</span>
          </div>
          <div class="section-body">
            <p class="text-muted" style="margin-bottom: 1rem;">
              Configure default fees for rental applications and event deposits. Payments are processed via Square.
            </p>
            <div class="fee-settings-grid" id="feeSettingsGrid">
              <!-- Fee settings loaded by JS -->
            </div>
          </div>
        </div>

        <!-- Discount Codes Section -->
        <div class="section">
          <div class="section-header">
            <h2>Fee Codes</h2>
            <button class="btn-small btn-primary" id="addFeeCodeBtn">+ Add Code</button>
          </div>
          <div class="section-body">
            <p class="text-muted" style="margin-bottom: 1rem;">
              Create codes that set a specific price when entered. Use $0 for a free waiver.
            </p>
            <div id="feeCodesGrid" class="fee-codes-grid">
              <!-- Fee codes loaded by JS -->
            </div>
          </div>
        </div>

        <!-- Square Configuration Section -->
        <div class="section">
          <div class="section-header">
            <h2>Square Configuration</h2>
          </div>
          <div class="section-body">
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="checkbox-label">
                <input type="checkbox" id="squareTestMode">
                <span>Test Mode (use sandbox credentials)</span>
              </label>
            </div>
            <p class="text-muted" style="font-size: 0.8rem;">
              When test mode is enabled, payments go through Square's sandbox environment. Disable for live payments.
            </p>
          </div>
        </div>

        <!-- Telnyx SMS Section -->
        <div class="section">
          <div class="section-header">
            <h2>Telnyx SMS</h2>
            <span class="badge" id="telnyxModeBadge">Loading...</span>
          </div>
          <div class="section-body">
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="checkbox-label">
                <input type="checkbox" id="telnyxTestMode">
                <span>Test Mode (log messages without sending)</span>
              </label>
            </div>
            <div style="margin-bottom: 1rem;">
              <p class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">
                <strong>Phone Number:</strong> <span id="telnyxPhoneDisplay">Loading...</span>
              </p>
              <p class="text-muted" style="font-size: 0.8rem;">
                When test mode is enabled, SMS messages are logged in the database but not actually sent via Telnyx.
              </p>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-small btn-primary" id="openComposeSmsBtn">Compose SMS</button>
              <button class="btn-small" id="openBulkSmsBtn">Send to All Tenants</button>
            </div>
          </div>
        </div>

        <!-- Recent Inbound SMS Section -->
        <div class="section">
          <div class="section-header">
            <h2>Inbound SMS</h2>
            <button class="btn-small" id="refreshInboundSmsBtn">Refresh</button>
          </div>
          <div class="section-body">
            <div id="inboundSmsList" style="max-height: 400px; overflow-y: auto;">
              <p class="text-muted">Loading...</p>
            </div>
          </div>
        </div>

      </div>

      <!-- Accounting Panel -->
      <div id="accountingPanel" class="manage-panel">
        <iframe id="accountingIframe" src="" style="width: 100%; border: none; min-height: 85vh;"></iframe>
      </div>

      <!-- FAQ & AI Panel -->
      <div id="faqPanel" class="manage-panel">
        <iframe id="faqIframe" src="" style="width: 100%; border: none; min-height: 85vh;"></iframe>
      </div>

    </div>
  </div>

  <!-- Compose SMS Modal -->
  <div id="composeSmsModal" class="modal hidden">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 id="composeSmsTitle">Send SMS</h2>
        <button class="modal-close" id="closeComposeSmsModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-bottom: 1rem;">
          <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Recipient</label>
          <select id="smsRecipientSelect" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px;">
            <option value="">Select a tenant...</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 1rem;">
          <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Message</label>
          <textarea id="smsComposeBody" maxlength="1600" placeholder="Type your message..." rows="4" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; resize: vertical; font-family: inherit;"></textarea>
          <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
            <span class="text-muted" style="font-size: 0.75rem;"><span id="smsCharCount">0</span> chars (<span id="smsSegmentCount">0</span> segments)</span>
            <span class="text-muted" style="font-size: 0.75rem;">160 chars = 1 segment</span>
          </div>
        </div>
        <!-- Conversation Thread -->
        <div id="smsConversationSection" class="hidden" style="margin-bottom: 1rem;">
          <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Conversation History</label>
          <div id="smsConversationThread" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; background: #fafafa;"></div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
          <button class="btn-small" id="cancelComposeSmsBtn">Cancel</button>
          <button class="btn-small btn-primary" id="sendSmsBtn">Send SMS</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk SMS Modal -->
  <div id="bulkSmsModal" class="modal hidden">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Send SMS to All Active Tenants</h2>
        <button class="modal-close" id="closeBulkSmsModal">&times;</button>
      </div>
      <div class="modal-body">
        <p class="text-muted" style="margin-bottom: 1rem;">
          <span id="bulkSmsRecipientCount">0</span> active tenants with phone numbers will receive this message.
        </p>
        <div class="form-group" style="margin-bottom: 1rem;">
          <label style="font-weight: 600; display: block; margin-bottom: 0.25rem;">Message</label>
          <textarea id="bulkSmsBody" maxlength="1600" placeholder="Type your announcement..." rows="4" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; resize: vertical; font-family: inherit;"></textarea>
          <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
            <span class="text-muted" style="font-size: 0.75rem;"><span id="bulkSmsCharCount">0</span> chars</span>
            <span class="text-muted" style="font-size: 0.75rem;">160 chars = 1 segment</span>
          </div>
        </div>
        <div id="bulkSmsRecipientList" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem; margin-bottom: 1rem; font-size: 0.85rem; background: #fafafa;">
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
          <button class="btn-small" id="cancelBulkSmsBtn">Cancel</button>
          <button class="btn-small btn-primary" id="sendBulkSmsBtn">Send to All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Space Detail Modal -->
  <div id="spaceDetailModal" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <div class="detail-header-content">
          <h2 id="detailSpaceName">Space Name</h2>
          <div id="detailHeaderButtons" class="detail-header-buttons"></div>
        </div>
        <button class="modal-close" id="closeDetailModal">&times;</button>
      </div>
      <div class="modal-body" id="spaceDetailBody">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Media Picker Modal (Upload or Choose from Library) -->
  <div id="photoUploadModal" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Add Media to <span id="uploadModalSpaceName"></span></h2>
        <button class="modal-close" id="closeUploadModal">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Tab navigation -->
        <div class="media-picker-tabs">
          <button type="button" class="tab-btn active" data-tab="library">From Library</button>
          <button type="button" class="tab-btn" data-tab="upload">Upload New</button>
          <button type="button" class="tab-btn" data-tab="request">Request</button>
        </div>

        <!-- Upload New Tab -->
        <div id="uploadTab" class="tab-content">
          <!-- Storage indicator -->
          <div id="modalStorageIndicator" class="storage-indicator"></div>

          <div class="form-group">
            <label for="photoFile">Select images:</label>
            <input type="file" id="photoFile" accept="image/*,video/*" multiple>
            <p class="form-hint">Select multiple images to bulk upload. Videos require external hosting (coming soon).</p>
          </div>

          <!-- Upload progress and buttons at top for visibility -->
          <div id="uploadProgress" class="upload-progress hidden">
            <div class="progress-bar">
              <div class="progress-fill" id="uploadProgressFill"></div>
            </div>
            <p class="progress-text" id="uploadProgressText">Uploading 0 of 0...</p>
          </div>

          <div class="modal-footer-inline upload-actions">
            <button id="cancelPhotoUpload" type="button" class="btn-secondary">Cancel</button>
            <button id="submitPhotoUpload" type="button" class="btn-primary">Upload All</button>
          </div>

          <!-- Bulk tagging section (shown when multiple files selected) -->
          <div id="bulkTagSection" class="bulk-tag-section hidden">
            <div class="bulk-tag-header">
              <h4><span id="fileCount">0</span> images selected</h4>
              <p class="form-hint">Tags below will apply to ALL selected images</p>
            </div>
          </div>

          <!-- Preview grid for multiple files -->
          <div id="uploadPreviewGrid" class="upload-preview-grid"></div>

          <div class="form-grid">
            <div class="form-group">
              <label for="photoBulkCaption">Caption for all (optional):</label>
              <input type="text" id="photoBulkCaption" placeholder="Leave empty to set per-image">
            </div>
            <div class="form-group">
              <label for="photoCategory">Category:</label>
              <select id="photoCategory">
                <option value="space">Space</option>
                <option value="mktg">Marketing</option>
                <option value="projects">Projects</option>
                <option value="archive">Archive</option>
              </select>
            </div>
          </div>

          <fieldset class="form-fieldset">
            <legend>Tags (apply to all)</legend>
            <p class="form-hint" id="autoTagHint" style="margin-bottom: 0.5rem; color: var(--accent);"></p>
            <div id="uploadTagsContainer" class="tags-container">
              <!-- Tags populated by JS -->
            </div>
          </fieldset>
        </div>

        <!-- Library Tab -->
        <div id="libraryTab" class="tab-content active">
          <!-- Filter controls -->
          <div class="library-filters">
            <div class="form-group">
              <label>Filter by tag:</label>
              <div id="libraryTagFilter" class="tag-filter-chips">
                <!-- Tag chips populated by JS -->
              </div>
            </div>
            <div class="form-group">
              <label for="libraryCategoryFilter">Category:</label>
              <select id="libraryCategoryFilter">
                <option value="">All categories</option>
                <option value="space">Spaces</option>
                <option value="mktg">Marketing</option>
                <option value="projects">Projects</option>
                <option value="archive">Archive</option>
              </select>
            </div>
          </div>

          <!-- Media grid -->
          <div id="libraryMediaGrid" class="library-media-grid">
            <!-- Media items populated by JS -->
          </div>

          <div class="modal-footer-inline">
            <button id="cancelLibrarySelect" type="button" class="btn-secondary">Cancel</button>
            <button id="submitLibrarySelect" type="button" class="btn-primary" disabled>Add Selected (0)</button>
          </div>
        </div>

        <!-- Request Tab -->
        <div id="requestTab" class="tab-content">
          <div class="request-tab-content">
            <p class="form-hint" style="margin-bottom: 1rem;">
              Request a photo to be taken. This creates a task that can be assigned to someone with camera access.
            </p>

            <div class="form-group">
              <label for="requestDescription">Describe the photo needed:</label>
              <textarea id="requestDescription" rows="4" placeholder="e.g., Wide angle shot of the bedroom from the doorway, showing the window and closet..."></textarea>
            </div>

            <fieldset class="form-fieldset">
              <legend>Suggested Tags (for when photo is uploaded)</legend>
              <div id="requestTagsContainer" class="tags-container">
                <!-- Tags populated by JS -->
              </div>
            </fieldset>

            <!-- Existing requests for this space -->
            <div id="existingRequestsSection" class="existing-requests-section hidden">
              <h4>Pending Requests for this Space</h4>
              <div id="existingRequestsList"></div>
            </div>
          </div>

          <div class="modal-footer-inline">
            <button id="cancelPhotoRequest" type="button" class="btn-secondary">Cancel</button>
            <button id="submitPhotoRequest" type="button" class="btn-primary">Submit Request</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Space Modal (Admin Only) -->
  <div id="editSpaceModal" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Edit Space: <span id="editSpaceName"></span></h2>
        <button class="modal-close" id="closeEditModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="editSpaceForm">
          <input type="hidden" id="editSpaceId">

          <div class="form-grid form-grid-3">
            <div class="form-group">
              <label for="editName">Name *</label>
              <input type="text" id="editName" required>
            </div>
            <div class="form-group">
              <label for="editParentSpace">Parent Space</label>
              <select id="editParentSpace">
                <option value="">None (top level)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editType">Type</label>
              <input type="text" id="editType" placeholder="e.g., Dwelling, Amenity">
            </div>
          </div>

          <div class="form-group">
            <label for="editLocation">Slogan</label>
            <input type="text" id="editLocation" placeholder="e.g., Your cozy retreat awaits">
          </div>

          <div class="form-group">
            <label for="editDescription">Description</label>
            <textarea id="editDescription" rows="3"></textarea>
          </div>

          <div class="form-grid form-grid-3">
            <div class="form-group">
              <label for="editMonthlyRate">Monthly Rate ($)</label>
              <input type="number" id="editMonthlyRate" min="0" step="1">
            </div>
            <div class="form-group">
              <label for="editWeeklyRate">Weekly Rate ($)</label>
              <input type="number" id="editWeeklyRate" min="0" step="1">
            </div>
            <div class="form-group">
              <label for="editNightlyRate">Nightly Rate ($)</label>
              <input type="number" id="editNightlyRate" min="0" step="1">
            </div>
          </div>

          <div class="form-grid form-grid-2">
            <div class="form-group">
              <label for="editRentalTerm">Standard Rental Term</label>
              <input type="text" id="editRentalTerm" placeholder="e.g., 6 month lease, 2 month notice, week to week">
            </div>
            <div class="form-group">
              <label for="editStandardDeposit">Standard Deposit</label>
              <input type="text" id="editStandardDeposit" placeholder="e.g., 1 month rent, $150">
            </div>
          </div>

          <div class="form-grid form-grid-3">
            <div class="form-group">
              <label for="editSqFootage">Square Footage</label>
              <input type="number" id="editSqFootage" min="0">
            </div>
            <div class="form-group">
              <label for="editMinResidents">Min Residents</label>
              <input type="number" id="editMinResidents" min="1" value="1">
            </div>
            <div class="form-group">
              <label for="editMaxResidents">Max Residents</label>
              <input type="number" id="editMaxResidents" min="1">
            </div>
          </div>

          <div class="form-grid form-grid-3">
            <div class="form-group">
              <label for="editBathPrivacy">Bathroom Privacy</label>
              <select id="editBathPrivacy">
                <option value="">Not specified</option>
                <option value="private">Private</option>
                <option value="shared">Shared</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editBathFixture">Bathroom Fixture</label>
              <select id="editBathFixture">
                <option value="">Not specified</option>
                <option value="sink_only">Sink only</option>
                <option value="half">Half (toilet + sink)</option>
                <option value="three_quarter">3/4 (shower, no tub)</option>
                <option value="seven_eighth">7/8 (small tub)</option>
                <option value="full">Full (tub/shower)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editGenderRestriction">Gender Restriction</label>
              <select id="editGenderRestriction">
                <option value="none">None</option>
                <option value="female">Female only</option>
                <option value="male">Male only</option>
              </select>
            </div>
          </div>

          <fieldset class="form-fieldset">
            <legend>Beds</legend>
            <div class="form-grid form-grid-3">
              <div class="form-group">
                <label for="editBedsKing">King</label>
                <input type="number" id="editBedsKing" min="0" value="0">
              </div>
              <div class="form-group">
                <label for="editBedsQueen">Queen</label>
                <input type="number" id="editBedsQueen" min="0" value="0">
              </div>
              <div class="form-group">
                <label for="editBedsDouble">Full</label>
                <input type="number" id="editBedsDouble" min="0" value="0">
              </div>
              <div class="form-group">
                <label for="editBedsTwin">Twin</label>
                <input type="number" id="editBedsTwin" min="0" value="0">
              </div>
              <div class="form-group">
                <label for="editBedsFolding">Folding</label>
                <input type="number" id="editBedsFolding" min="0" value="0">
              </div>
            </div>
          </fieldset>

          <fieldset class="form-fieldset">
            <legend>Visibility</legend>
            <div class="form-grid form-grid-4">
              <div class="form-group checkbox-group">
                <label>
                  <input type="checkbox" id="editIsListed">
                  Listed
                </label>
              </div>
              <div class="form-group checkbox-group">
                <label>
                  <input type="checkbox" id="editCanBeDwelling">
                  Dwelling
                </label>
              </div>
              <div class="form-group checkbox-group">
                <label>
                  <input type="checkbox" id="editCanBeEvent">
                  Event
                </label>
              </div>
              <div class="form-group checkbox-group">
                <label>
                  <input type="checkbox" id="editIsSecret">
                  Secret
                </label>
              </div>
            </div>
          </fieldset>

          <fieldset class="form-fieldset">
            <legend>Photos <a href="#" id="addMorePhotosLink" class="add-more-link">+ Add images</a></legend>
            <div id="editPhotosContainer" class="edit-photos-grid">
              <!-- Photos will be populated by JS -->
            </div>
            <p class="form-hint" style="margin-top: 0.5rem;">Drag to reorder. Click x to remove.</p>
          </fieldset>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="archiveSpaceBtn" class="btn-danger" style="margin-right: auto;">Archive Space</button>
        <button type="button" id="cancelEditSpace" class="btn-secondary">Cancel</button>
        <button type="button" id="submitEditSpace" class="btn-primary">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Media Detail/Edit Modal -->
  <div id="mediaDetailModal" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Media Details</h2>
        <button class="modal-close" id="closeMediaDetail">&times;</button>
      </div>
      <div class="modal-body">
        <div class="media-detail-layout">
          <div class="media-preview">
            <img id="detailImage" src="" alt="Media preview">
          </div>
          <div class="media-details">
            <div class="form-group">
              <label for="detailCaption">Caption</label>
              <input type="text" id="detailCaption" placeholder="Add a caption...">
            </div>
            <div class="form-group">
              <label for="detailCategory">Category</label>
              <select id="detailCategory">
                <option value="mktg">Marketing</option>
                <option value="projects">Projects</option>
                <option value="archive">Archive</option>
              </select>
            </div>
            <fieldset class="form-fieldset">
              <legend>Tags</legend>
              <div id="detailTagsContainer" class="tags-container"></div>
            </fieldset>
            <div class="media-meta">
              <p><strong>Size:</strong> <span id="detailSize">-</span></p>
              <p><strong>Dimensions:</strong> <span id="detailDimensions">-</span></p>
              <p><strong>Uploaded:</strong> <span id="detailDate">-</span></p>
              <p><strong>Used in:</strong> <span id="detailSpaces">-</span></p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="deleteMediaBtn" class="btn-danger">Delete Permanently</button>
        <div class="footer-right">
          <button id="cancelMediaDetail" class="btn-secondary">Cancel</button>
          <button id="saveMediaDetail" class="btn-primary">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rental Application Detail Modal -->
  <div id="rentalDetailModal" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="rentalDetailTitle">Application Details</h2>
        <span id="rentalDetailStatus" class="status-badge"></span>
        <span id="rentalDetailTestBadge" class="status-badge test" style="display: none; background: #f59e0b; color: white;">TEST</span>
        <button class="modal-close" id="closeRentalDetail">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Modal tabs -->
        <div class="detail-tabs">
          <button class="detail-tab active" data-detail-tab="applicant">Applicant</button>
          <button class="detail-tab" data-detail-tab="terms">Terms</button>
          <button class="detail-tab" data-detail-tab="documents">Documents</button>
          <button class="detail-tab" data-detail-tab="deposits">Deposits</button>
          <button class="detail-tab" data-detail-tab="rent">Rent</button>
          <button class="detail-tab" data-detail-tab="history">History</button>
        </div>

        <!-- Applicant Tab -->
        <div id="applicantTab" class="detail-tab-content active">
          <div class="applicant-info">
            <div class="form-grid">
              <div class="info-group">
                <label>Name</label>
                <p id="applicantName">-</p>
              </div>
              <div class="info-group">
                <label>Email</label>
                <p id="applicantEmail">-</p>
              </div>
              <div class="info-group">
                <label>Phone</label>
                <p id="applicantPhone">-</p>
              </div>
              <div class="info-group">
                <label>Desired Space</label>
                <p id="applicantDesiredSpace">-</p>
              </div>
              <div class="info-group">
                <label>Desired Move-in</label>
                <p id="applicantDesiredMoveIn">-</p>
              </div>
              <div class="info-group">
                <label>Submitted</label>
                <p id="applicantSubmittedAt">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Terms Tab -->
        <div id="termsTab" class="detail-tab-content">
          <form id="termsForm" class="terms-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="termSpace">Space *</label>
                <select id="termSpace" required>
                  <option value="">Select space...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="termRate">Rate *</label>
                <div class="rate-input-group">
                  <span class="rate-prefix">$</span>
                  <input type="number" id="termRate" min="0" step="1" required>
                  <select id="termRateTerm">
                    <option value="monthly">/ month</option>
                    <option value="weekly">/ week</option>
                    <option value="nightly">/ night</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label for="termMoveIn">Move-in Date *</label>
                <input type="date" id="termMoveIn" required>
              </div>
              <div class="form-group">
                <label for="termLeaseEnd">Lease End Date</label>
                <input type="date" id="termLeaseEnd">
                <small class="form-hint">Leave blank for open-ended</small>
              </div>
              <div class="form-group">
                <label for="termNoticePeriod">Termination Notice</label>
                <select id="termNoticePeriod">
                  <option value="none">None (fixed-length lease)</option>
                  <option value="1_day">1 day notice</option>
                  <option value="1_week">1 week notice</option>
                  <option value="30_days" selected>30 days notice</option>
                  <option value="60_days">60 days notice</option>
                </select>
                <small class="form-hint">Required notice to terminate. Select "None" for fixed-length leases.</small>
              </div>
              <div class="form-group">
                <label for="termSecurityDeposit">Security Deposit</label>
                <input type="number" id="termSecurityDeposit" min="0" step="1" value="0">
                <small class="form-hint">Can be $0. Due at move-in.</small>
              </div>
              <div class="form-group">
                <label for="termReservationDeposit">Reservation Deposit</label>
                <input type="number" id="termReservationDeposit" min="0" step="1" value="0">
                <small class="form-hint">Due after signing. Defaults to 1 month's rent. Credited to first month.</small>
              </div>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label for="termAdditionalTerms">Additional Terms</label>
              <textarea id="termAdditionalTerms" rows="4" placeholder="Any additional terms or conditions to include in the rental agreement..."></textarea>
              <small class="form-hint">Will appear in the "Additional Terms" section of the rental agreement.</small>
            </div>
            <div class="terms-save-row" style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem;">
              <button type="button" id="saveTermsBtn" class="btn-small btn-primary">Save Terms</button>
              <span id="termsSaveStatus" class="save-status"></span>
            </div>
          </form>
        </div>

        <!-- Documents Tab -->
        <div id="documentsTab" class="detail-tab-content">
          <div class="documents-section">
            <!-- Agreement Status -->
            <div class="document-status">
              <h4>Rental Agreement Status</h4>
              <p id="agreementStatusDisplay" class="status-badge">Pending</p>
            </div>

            <!-- Generate Section (always shown) -->
            <div id="generateSection" class="generate-section">
              <h4>Generate Lease Agreement</h4>
              <p class="text-muted" style="margin-bottom: 1rem;">Preview the lease agreement and generate a PDF for signing.</p>
              <div id="leasePreviewContainer" class="lease-preview-container">
                <div id="leasePreview" class="lease-preview"></div>
              </div>
              <div class="generate-actions" style="margin-top: 1rem;">
                <button type="button" id="previewLeaseBtn" class="btn-small">Preview Agreement</button>
                <button type="button" id="generatePdfBtn" class="btn-small btn-primary">Generate PDF</button>
              </div>
              <p id="noTemplateWarning" class="warning-text" style="display: none; margin-top: 0.5rem;">
                No active lease template found. <a href="#" id="createTemplateLink">Create one</a> in the Templates section.
              </p>
            </div>

            <!-- Generated PDF Section (shown after PDF is generated) -->
            <div id="pdfSection" class="pdf-section" style="display: none;">
              <h4>Current Document</h4>
              <div class="pdf-info">
                <a id="pdfDownloadLink" href="#" target="_blank" class="pdf-link">
                  <span class="pdf-icon">📄</span>
                  <span id="pdfFilename">lease-agreement.pdf</span>
                </a>
                <span id="pdfGeneratedAt" class="text-muted"></span>
              </div>
              <div class="pdf-actions" style="margin-top: 1rem;">
                <button type="button" id="sendForSignatureBtn" class="btn-small btn-primary">Send for Signature</button>
              </div>
            </div>

            <!-- Signature Section (shown after sent for signature) -->
            <div id="signatureSection" class="signature-section" style="display: none;">
              <h4>Signature Status</h4>
              <p id="signatureStatusText">Awaiting signature...</p>
              <div id="signedPdfSection" style="display: none; margin-top: 1rem;">
                <a id="signedPdfLink" href="#" target="_blank" class="pdf-link">
                  <span class="pdf-icon">✅</span>
                  <span id="signedPdfFilename">Download Signed Agreement</span>
                </a>
              </div>
              <div class="signature-actions" style="margin-top: 1rem;">
                <button type="button" id="checkSignatureStatusBtn" class="btn-small">Check Status</button>
                <button type="button" id="resendSignatureBtn" class="btn-small">Resend Request</button>
              </div>
            </div>

            <!-- Legacy Manual Section (collapsible, for backwards compatibility) -->
            <details class="legacy-section" style="margin-top: 1.5rem;">
              <summary class="text-muted" style="cursor: pointer;">Manual Document Entry</summary>
              <div style="padding-top: 1rem;">
                <div class="form-group">
                  <label for="agreementDocUrl">Document URL</label>
                  <input type="text" id="agreementDocUrl" placeholder="Paste document URL manually...">
                </div>
                <div class="document-actions" style="margin-top: 1rem;">
                  <button type="button" id="markAgreementGenerated" class="btn-small">Mark as Generated</button>
                  <button type="button" id="markAgreementSent" class="btn-small">Mark as Sent</button>
                  <button type="button" id="markAgreementSigned" class="btn-small btn-primary">Mark as Signed</button>
                </div>
              </div>
            </details>
          </div>
        </div>

        <!-- Deposits Tab -->
        <div id="depositsTab" class="detail-tab-content">
          <!-- Application Fee Credit (if paid) -->
          <div id="applicationFeeSection" class="application-fee-section hidden" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--success-light); border-radius: var(--radius); border-left: 4px solid var(--success);">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--success);">Application Fee Received</h4>
            <p style="margin: 0; font-size: 0.9rem;">
              <strong id="applicationFeeAmount">$0</strong> application fee paid
              <span id="applicationFeeCode" class="hidden"> (code: <code id="applicationFeeCodeValue"></code>)</span>
            </p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
              This will be credited toward the first month's rent. Amount due: <strong id="firstMonthDueAmount">$0</strong>
            </p>
          </div>

          <div class="deposits-grid">
            <div class="deposit-card">
              <h4>Move-in Deposit</h4>
              <p class="deposit-amount" id="moveInDepositAmount">$0</p>
              <p class="deposit-status" id="moveInDepositStatus">Pending</p>
              <button type="button" id="recordMoveInDepositBtn" class="btn-small btn-primary">Record Payment</button>
            </div>
            <div class="deposit-card">
              <h4>Security Deposit</h4>
              <p class="deposit-amount" id="securityDepositAmount">$0</p>
              <p class="deposit-status" id="securityDepositStatus">Pending</p>
              <button type="button" id="recordSecurityDepositBtn" class="btn-small btn-primary">Record Payment</button>
            </div>
          </div>
          <div class="proration-section" style="margin-top: 1.5rem;">
            <h4>Proration Calculator</h4>
            <div id="prorationDetails" class="proration-details"></div>
          </div>
          <div class="deposit-request-section" style="margin-top: 1.5rem;">
            <h4>Request Deposit</h4>
            <button type="button" id="copyDepositRequestBtn" class="btn-small">Copy Payment Instructions</button>
            <button type="button" id="markDepositRequestedBtn" class="btn-small">Mark as Requested</button>
            <button type="button" id="confirmDepositBtn" class="btn-small btn-primary">Confirm Deposit</button>
          </div>
        </div>

        <!-- Rent Tab -->
        <div id="rentTab" class="detail-tab-content">
          <div class="rent-summary">
            <p><strong>Monthly Rent:</strong> <span id="rentMonthlyAmount">$0</span></p>
          </div>
          <div class="rent-history" style="margin-top: 1rem;">
            <h4>Payment History</h4>
            <table id="rentHistoryTable" class="data-table">
              <thead>
                <tr><th>Period</th><th>Amount</th><th>Paid</th><th>Method</th></tr>
              </thead>
              <tbody id="rentHistoryBody">
                <tr><td colspan="4" class="text-muted">No payments recorded</td></tr>
              </tbody>
            </table>
          </div>
          <button type="button" id="recordRentPaymentBtn" class="btn-small btn-primary" style="margin-top: 1rem;">Record Rent Payment</button>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="detail-tab-content">
          <div id="applicationHistory" class="application-history">
            <p class="text-muted">Application timeline will appear here.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div id="rentalActions" class="rental-action-buttons"></div>
      </div>
    </div>
  </div>

  <!-- Fee Code Modal -->
  <div id="feeCodeModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="feeCodeModalTitle">Add Fee Code</h2>
        <button class="modal-close" onclick="closeFeeCodeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="feeCodeForm" class="fee-code-form" onsubmit="saveFeeCode(event)">
          <input type="hidden" id="feeCodeId">
          <div class="form-grid">
            <div class="form-group">
              <label for="feeCodeCode">Code *</label>
              <input type="text" id="feeCodeCode" required placeholder="e.g., FRIEND25" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
              <label for="feeCodeType">Fee Type *</label>
              <select id="feeCodeType" required>
                <option value="rental_application">Rental Application Fee</option>
                <option value="event_cleaning_deposit">Event Cleaning Deposit</option>
                <option value="event_reservation_deposit">Event Reservation Deposit</option>
              </select>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="feeCodePrice">Price ($) *</label>
              <input type="number" id="feeCodePrice" required min="0" step="0.01" value="0" placeholder="0 for free">
              <p class="form-hint">The actual price when this code is used. Enter 0 to waive the fee.</p>
            </div>
            <div class="form-group">
              <label for="feeCodeUsageLimit">Usage Limit</label>
              <input type="number" id="feeCodeUsageLimit" min="1" placeholder="Leave empty for unlimited">
            </div>
          </div>
          <div class="form-group">
            <label for="feeCodeDescription">Description (internal note)</label>
            <input type="text" id="feeCodeDescription" placeholder="e.g., For referrals from John">
          </div>
          <div class="form-group">
            <label for="feeCodeExpires">Expires On</label>
            <input type="date" id="feeCodeExpires">
            <p class="form-hint">Leave empty for no expiration.</p>
          </div>
          <label class="checkbox-label">
            <input type="checkbox" id="feeCodeActive" checked>
            Active (can be used)
          </label>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeFeeCodeModal()">Cancel</button>
        <button type="submit" form="feeCodeForm" class="btn-primary">Save Code</button>
      </div>
    </div>
  </div>

  <!-- Payment Method Modal -->
  <div id="paymentMethodModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="paymentMethodModalTitle">Add Payment Method</h2>
        <button class="modal-close" id="closePaymentMethodModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="paymentMethodForm">
          <input type="hidden" id="paymentMethodId">
          <div class="form-group">
            <label for="paymentMethodName">Name *</label>
            <input type="text" id="paymentMethodName" required placeholder="e.g., Venmo">
          </div>
          <div class="form-group">
            <label for="paymentMethodType">Type *</label>
            <select id="paymentMethodType" required>
              <option value="venmo">Venmo</option>
              <option value="zelle">Zelle</option>
              <option value="paypal">PayPal</option>
              <option value="bank_ach">Bank ACH</option>
            </select>
          </div>
          <div class="form-group">
            <label for="paymentMethodIdentifier">Account Identifier</label>
            <input type="text" id="paymentMethodIdentifier" placeholder="@username, email, or phone">
          </div>
          <div class="form-group">
            <label for="paymentMethodInstructions">Instructions</label>
            <textarea id="paymentMethodInstructions" rows="3" placeholder="Payment instructions..."></textarea>
          </div>
          <label class="checkbox-label">
            <input type="checkbox" id="paymentMethodActive" checked>
            Active (shown to tenants)
          </label>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="deletePaymentMethodBtn" class="btn-danger" style="display: none;">Delete</button>
        <div class="footer-right">
          <button type="button" id="cancelPaymentMethodBtn" class="btn-secondary">Cancel</button>
          <button type="button" id="savePaymentMethodBtn" class="btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Detail Modal -->
  <div id="eventDetailModal" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="eventDetailTitle">Event Details</h2>
        <span id="eventDetailStatus" class="status-badge"></span>
        <span id="eventDetailTestBadge" class="status-badge test" style="display: none; background: #f59e0b; color: white;">TEST</span>
        <button class="modal-close" id="closeEventDetail">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Modal tabs -->
        <div class="detail-tabs">
          <button class="event-detail-tab active" data-event-tab="eventInfo">Event Info</button>
          <button class="event-detail-tab" data-event-tab="eventTerms">Terms</button>
          <button class="event-detail-tab" data-event-tab="eventDocuments">Documents</button>
          <button class="event-detail-tab" data-event-tab="eventDeposits">Deposits</button>
        </div>

        <!-- Event Info Tab -->
        <div id="eventInfoTab" class="event-detail-tab-content active">
          <div class="applicant-info">
            <div class="form-grid">
              <div class="info-group">
                <label>Event Name</label>
                <p id="eventInfoName">-</p>
              </div>
              <div class="info-group">
                <label>Client Name</label>
                <p id="eventInfoClient">-</p>
              </div>
              <div class="info-group">
                <label>Email</label>
                <p id="eventInfoEmail">-</p>
              </div>
              <div class="info-group">
                <label>Phone</label>
                <p id="eventInfoPhone">-</p>
              </div>
              <div class="info-group">
                <label>Organization</label>
                <p id="eventInfoOrg">-</p>
              </div>
              <div class="info-group">
                <label>Event Date</label>
                <p id="eventInfoDate">-</p>
              </div>
              <div class="info-group">
                <label>Time</label>
                <p id="eventInfoTime">-</p>
              </div>
              <div class="info-group">
                <label>Expected Guests</label>
                <p id="eventInfoGuests">-</p>
              </div>
              <div class="info-group">
                <label>Event Type</label>
                <p id="eventInfoType">-</p>
              </div>
              <div class="info-group">
                <label>Submitted</label>
                <p id="eventInfoSubmitted">-</p>
              </div>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label>Description</label>
              <p id="eventInfoDescription" class="text-muted">-</p>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label>Special Requests</label>
              <p id="eventInfoSpecialRequests" class="text-muted">-</p>
            </div>
          </div>
        </div>

        <!-- Event Terms Tab -->
        <div id="eventTermsTab" class="event-detail-tab-content">
          <form id="eventTermsForm" class="terms-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="eventTermMaxGuests">Approved Max Guests *</label>
                <input type="number" id="eventTermMaxGuests" min="1" required>
              </div>
              <div class="form-group">
                <label for="eventTermRentalFee">Rental Fee ($)</label>
                <input type="number" id="eventTermRentalFee" min="0" step="1" value="295">
              </div>
              <div class="form-group">
                <label for="eventTermReservationFee">Reservation Fee ($)</label>
                <input type="number" id="eventTermReservationFee" min="0" step="1" value="95">
                <small class="form-hint">Credits toward rental fee</small>
              </div>
              <div class="form-group">
                <label for="eventTermCleaningDeposit">Cleaning/Damage Deposit ($)</label>
                <input type="number" id="eventTermCleaningDeposit" min="0" step="1" value="195">
                <small class="form-hint">Refundable after event</small>
              </div>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label for="eventTermAdditionalTerms">Additional Terms</label>
              <textarea id="eventTermAdditionalTerms" rows="4" placeholder="Any additional terms or conditions..."></textarea>
            </div>
            <div class="terms-save-row" style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem;">
              <button type="button" id="saveEventTermsBtn" class="btn-small btn-primary">Save Terms</button>
              <span id="eventTermsSaveStatus" class="save-status"></span>
            </div>
          </form>
        </div>

        <!-- Event Documents Tab -->
        <div id="eventDocumentsTab" class="event-detail-tab-content">
          <div class="documents-section">
            <!-- Agreement Status -->
            <div class="document-status">
              <h4>Event Agreement Status</h4>
              <p id="eventAgreementStatusDisplay" class="status-badge">Pending</p>
            </div>

            <!-- Generate Section -->
            <div id="eventGenerateSection" class="generate-section">
              <h4>Generate Event Agreement</h4>
              <p class="text-muted" style="margin-bottom: 1rem;">Preview the event agreement and generate a PDF for signing.</p>
              <div id="eventLeasePreviewContainer" class="lease-preview-container">
                <div id="eventLeasePreview" class="lease-preview"></div>
              </div>
              <div class="generate-actions" style="margin-top: 1rem;">
                <button type="button" id="previewEventLeaseBtn" class="btn-small">Preview Agreement</button>
                <button type="button" id="generateEventPdfBtn" class="btn-small btn-primary">Generate PDF</button>
              </div>
              <p id="noEventTemplateWarning" class="warning-text" style="display: none; margin-top: 0.5rem;">
                No active event template found. <a href="#" id="createEventTemplateLink">Create one</a> in Settings.
              </p>
            </div>

            <!-- Generated PDF Section -->
            <div id="eventPdfSection" class="pdf-section" style="display: none;">
              <h4>Current Document</h4>
              <div class="pdf-info">
                <a id="eventPdfDownloadLink" href="#" target="_blank" class="pdf-link">
                  <span class="pdf-icon">📄</span>
                  <span id="eventPdfFilename">event-agreement.pdf</span>
                </a>
                <span id="eventPdfGeneratedAt" class="text-muted"></span>
              </div>
              <div class="pdf-actions" style="margin-top: 1rem;">
                <button type="button" id="sendEventForSignatureBtn" class="btn-small btn-primary">Send for Signature</button>
              </div>
            </div>

            <!-- Signature Section -->
            <div id="eventSignatureSection" class="signature-section" style="display: none;">
              <h4>Signature Status</h4>
              <p id="eventSignatureStatusText">Awaiting signature...</p>
              <div id="eventSignedPdfSection" style="display: none; margin-top: 1rem;">
                <a id="eventSignedPdfLink" href="#" target="_blank" class="pdf-link">
                  <span class="pdf-icon">✅</span>
                  <span id="eventSignedPdfFilename">Download Signed Agreement</span>
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Event Deposits Tab -->
        <div id="eventDepositsTab" class="event-detail-tab-content">
          <!-- Reservation Deposit Credit (if paid via Square) -->
          <div id="eventReservationFeeSection" class="application-fee-section hidden" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--success-light); border-radius: var(--radius); border-left: 4px solid var(--success);">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--success);">Reservation Deposit Received</h4>
            <p style="margin: 0; font-size: 0.9rem;">
              <strong id="eventReservationFeeAmount">$0</strong> reservation deposit paid
              <span id="eventReservationFeeCode" class="hidden"> (code: <code id="eventReservationFeeCodeValue"></code>)</span>
            </p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
              This will be credited toward the rental fee of <strong id="eventRentalFeeTotal">$295</strong>.
              Remaining rental fee due: <strong id="eventRentalFeeDue">$0</strong>
            </p>
          </div>

          <div class="deposits-grid">
            <div class="deposit-card">
              <h4>Reservation Fee</h4>
              <p class="deposit-amount" id="eventReservationDepositAmount">$95</p>
              <p class="deposit-status" id="eventReservationDepositStatus">Pending</p>
              <button type="button" id="recordEventReservationBtn" class="btn-small btn-primary">Record Payment</button>
            </div>
            <div class="deposit-card">
              <h4>Cleaning Deposit</h4>
              <p class="deposit-amount" id="eventCleaningDepositAmount">$195</p>
              <p class="deposit-status" id="eventCleaningDepositStatus">Pending</p>
              <button type="button" id="recordEventCleaningBtn" class="btn-small btn-primary">Record Payment</button>
            </div>
            <div class="deposit-card">
              <h4>Rental Fee</h4>
              <p class="deposit-amount" id="eventRentalFeeAmount">$295</p>
              <p class="deposit-status" id="eventRentalFeeStatus">Pending</p>
              <button type="button" id="recordEventRentalFeeBtn" class="btn-small btn-primary">Record Payment</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div id="eventDetailActions" class="modal-actions"></div>
      </div>
    </div>
  </div>

  <!-- Record Deposit Modal -->
  <div id="recordDepositModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="recordDepositTitle">Record Deposit</h2>
        <button class="modal-close" id="closeRecordDepositModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="recordDepositForm">
          <input type="hidden" id="depositType">
          <div class="form-group">
            <label>Amount</label>
            <input type="text" id="depositAmount" readonly>
          </div>
          <div class="form-group">
            <label for="depositMethod">Payment Method *</label>
            <select id="depositMethod" required>
              <option value="">Select method...</option>
              <option value="venmo">Venmo</option>
              <option value="zelle">Zelle</option>
              <option value="paypal">PayPal</option>
              <option value="bank_ach">Bank ACH</option>
              <option value="cash">Cash</option>
              <option value="check">Check</option>
            </select>
          </div>
          <div class="form-group">
            <label for="depositTransactionId">Transaction ID (optional)</label>
            <input type="text" id="depositTransactionId" placeholder="Reference number...">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelRecordDepositBtn" class="btn-secondary">Cancel</button>
        <button type="button" id="confirmRecordDepositBtn" class="btn-primary">Record Payment</button>
      </div>
    </div>
  </div>

  <!-- Bulk Tag Edit Modal -->
  <div id="bulkTagModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Tags for <span id="bulkCount">0</span> Items</h2>
        <button class="modal-close" id="closeBulkTag">&times;</button>
      </div>
      <div class="modal-body">
        <p class="form-hint" style="margin-bottom: 1rem;">Select tags to add or remove from all selected items.</p>
        <div class="bulk-tag-actions">
          <div class="bulk-action-group">
            <h4>Add Tags</h4>
            <div id="bulkAddTags" class="tags-container"></div>
          </div>
          <div class="bulk-action-group">
            <h4>Remove Tags</h4>
            <div id="bulkRemoveTags" class="tags-container"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelBulkTag" class="btn-secondary">Cancel</button>
        <button id="applyBulkTags" class="btn-primary">Apply Changes</button>
      </div>
    </div>
  </div>

  <!-- Invitation Text Modal -->
  <div id="inviteTextModal" class="modal hidden">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h2>Invitation Ready</h2>
        <button class="modal-close" id="closeInviteModal">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1rem; color: var(--text-muted);">
          The invitation has been created. Copy the text below and send it via email or message:
        </p>
        <textarea id="inviteTextContent" readonly style="width: 100%; height: 250px; padding: 1rem; font-family: inherit; font-size: 0.875rem; border: 1px solid var(--border); border-radius: var(--radius); resize: none; background: var(--bg);"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="closeInviteModalBtn">Close</button>
        <button class="btn-primary" id="copyInviteTextBtn">Copy to Clipboard</button>
        <button class="btn-primary" id="sendInviteEmailBtn" style="background: var(--available);">Send Email</button>
      </div>
    </div>
  </div>

  <!-- Assignment Detail Modal -->
  <div id="assignmentDetailModal" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="assignmentDetailTitle">Assignment Details</h2>
        <span id="assignmentDetailStatus" class="status-badge"></span>
        <button class="modal-close" id="closeAssignmentDetail">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-grid" style="gap: 1.5rem;">
          <!-- Tenant Info (read-only) -->
          <div class="form-section" style="grid-column: 1 / -1;">
            <h3 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Tenant</h3>
            <div class="form-grid">
              <div class="info-group">
                <label>Name</label>
                <p id="assignmentTenantName">-</p>
              </div>
              <div class="info-group">
                <label>Email</label>
                <p id="assignmentTenantEmail">-</p>
              </div>
              <div class="info-group">
                <label>Phone</label>
                <p id="assignmentTenantPhone">-</p>
              </div>
            </div>
          </div>

          <!-- Space Info -->
          <div class="form-section" style="grid-column: 1 / -1;">
            <h3 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Space & Dates</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="assignmentSpace">Space</label>
                <select id="assignmentSpace">
                  <option value="">Select a space...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="assignmentStatus">Status</label>
                <select id="assignmentStatus">
                  <option value="prospect">Prospect</option>
                  <option value="pending_contract">Pending Contract</option>
                  <option value="contract_sent">Contract Sent</option>
                  <option value="active">Active</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
              <div class="form-group">
                <label for="assignmentStartDate">Start Date</label>
                <input type="date" id="assignmentStartDate">
              </div>
              <div class="form-group">
                <label for="assignmentEndDate">End Date</label>
                <input type="date" id="assignmentEndDate">
                <small class="form-hint">Leave empty for open-ended</small>
              </div>
            </div>
          </div>

          <!-- Financial -->
          <div class="form-section" style="grid-column: 1 / -1;">
            <h3 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Financial</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="assignmentRateAmount">Rate</label>
                <div class="rate-input-group">
                  <span class="rate-prefix">$</span>
                  <input type="number" id="assignmentRateAmount" step="0.01" min="0">
                  <select id="assignmentRateTerm">
                    <option value="monthly">/ month</option>
                    <option value="weekly">/ week</option>
                    <option value="daily">/ day</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label for="assignmentDepositAmount">Deposit Amount</label>
                <div class="rate-input-group">
                  <span class="rate-prefix">$</span>
                  <input type="number" id="assignmentDepositAmount" step="0.01" min="0">
                </div>
              </div>
              <div class="form-group">
                <label for="assignmentNoticeDays">Notice Period (days)</label>
                <input type="number" id="assignmentNoticeDays" min="0" placeholder="e.g., 30">
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="assignmentIsFree" style="width: auto; margin-right: 0.5rem;">
                  Free / No Rent
                </label>
              </div>
            </div>
          </div>

          <!-- Early Departure -->
          <div class="form-section" style="grid-column: 1 / -1;">
            <h3 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Early Departure</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="assignmentDesiredDeparture">Desired Departure Date</label>
                <input type="date" id="assignmentDesiredDeparture">
                <small class="form-hint">If tenant wants to leave early</small>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="assignmentDepartureListed" style="width: auto; margin-right: 0.5rem;">
                  List for availability (show to consumers)
                </label>
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="form-section" style="grid-column: 1 / -1;">
            <h3 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Notes</h3>
            <div class="form-group">
              <textarea id="assignmentNotes" rows="3" placeholder="Any notes about this assignment..."></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="closeAssignmentDetailBtn">Cancel</button>
        <button class="btn-primary" id="saveAssignmentBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3"></script>
  <!-- TUS client for resumable uploads (files > 6MB) -->
  <script src="https://cdn.jsdelivr.net/npm/tus-js-client@4.1.0/dist/tus.min.js"></script>
  <script type="module">
    import { supabase, SUPABASE_URL, SUPABASE_ANON_KEY } from '../../shared/supabase.js';
    import { initAuth, getAuthState, signOut, onAuthStateChange } from '../../shared/auth.js';
    import { mediaService } from '../../shared/media-service.js';
    import { rentalService } from '../../shared/rental-service.js';
    import { eventService } from '../../shared/event-service.js';
    import { leaseTemplateService } from '../../shared/lease-template-service.js';
    import { eventTemplateService } from '../../shared/event-template-service.js';
    import { pdfService } from '../../shared/pdf-service.js';
    import { emailService } from '../../shared/email-service.js';
    import { signwellService } from '../../shared/signwell-service.js';
    import { errorLogger } from '../../shared/error-logger.js';
    import {
      formatDateAustin,
      formatDateTimeFull,
      getAustinToday,
      getAustinTodayISO,
      parseAustinDate,
      isTodayOrAfterAustin,
      getAustinWeekday,
      getAustinMonthYear,
      isSameAustinDay,
      AUSTIN_TIMEZONE
    } from '../../shared/timezone.js';

    // Set up global error handlers for uncaught errors
    errorLogger.setupGlobalHandlers();

    // =============================================
    // TOAST NOTIFICATIONS
    // =============================================
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = {
        success: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>',
        error: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>',
        warning: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
        info: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>'
      };

      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
      `;

      container.appendChild(toast);

      if (duration > 0) {
        setTimeout(() => {
          toast.classList.add('toast-exit');
          setTimeout(() => toast.remove(), 200);
        }, duration);
      }
    }

    // =============================================
    // STATE
    // =============================================
    let authState = null;
    let allSpaces = [];
    let assignments = [];
    let photoRequests = [];
    let archivedSpaces = [];
    let allMedia = [];
    let allTags = [];
    let selectedMediaIds = new Set();
    let currentFilters = { category: '', tags: [] };
    let currentMediaId = null;
    let mediaLoaded = false;
    let mediaUploadFiles = [];
    let storageUsage = null;

    // Spaces view state
    let currentView = 'table';  // 'card' or 'table' - default to table
    let currentSort = { column: 'monthly_rate', direction: 'desc' };

    // Photo upload state
    let currentUploadSpaceId = null;
    let currentUploadContext = null;
    let selectedLibraryMedia = new Set();
    let libraryMedia = [];
    let activeLibraryFilters = { tags: [], category: '' };
    let selectedUploadFiles = [];
    let isPhotoUploading = false;
    let isLibraryLoading = false;

    // Edit space state
    let currentEditSpaceId = null;
    let isSavingSpace = false;

    // Lightbox state
    let lightboxGallery = [];
    let lightboxIndex = 0;
    let currentGalleryUrls = [];

    // Rentals state
    let allApplications = [];
    let allPeople = [];
    let allPaymentMethods = [];
    let currentApplicationId = null;
    let rentalsLoaded = false;

    // Calendar state
    let calendarAssignments = [];
    let calendarCurrentDate = getAustinToday();
    let calendarMonthsDisplayed = 3; // Start with 3 months
    let calendarHasMoreReservations = true; // Track if there are more to load
    let currentAssignmentId = null;

    // Events state
    let allEventRequests = [];
    let currentEventRequestId = null;
    let eventsLoaded = false;
    let eventCalendarCurrentDate = getAustinToday();

    // Users state
    let allUsers = [];
    let allInvitations = [];
    let usersLoaded = false;

    // Settings state
    let settingsLoaded = false;

    // =============================================
    // AUTH HANDLING
    // =============================================
    function handleAuthState(state) {
      authState = state;

      // Set user context for error logging
      if (state.appUser) {
        errorLogger.setUserContext({
          userId: state.appUser.id,
          role: state.appUser.role,
          email: state.appUser.email,
        });
      }

      // Allow both admin and staff to access this page
      if (state.appUser && (state.appUser.role === 'admin' || state.appUser.role === 'staff')) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('appContent').classList.remove('hidden');
        document.getElementById('userInfo').textContent = state.appUser.display_name || state.appUser.email;
        updateRoleUI();
        loadSpacesData();
      } else if (state.appUser) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('unauthorizedOverlay').classList.remove('hidden');
      } else if (state.isAuthenticated && state.isUnauthorized) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('unauthorizedOverlay').classList.remove('hidden');
      } else if (!state.isAuthenticated) {
        window.location.href = '/login/?redirect=' + encodeURIComponent(window.location.pathname);
      }
    }

    function updateRoleUI() {
      if (!authState) return;
      const roleBadge = document.getElementById('roleBadge');
      if (roleBadge) {
        roleBadge.textContent = authState.appUser?.role || 'Staff';
        roleBadge.className = 'role-badge ' + (authState.appUser?.role || 'staff');
      }
      // Show/hide admin-only features
      if (authState.appUser?.role === 'admin') {
        document.body.classList.add('is-admin');
      } else {
        document.body.classList.remove('is-admin');
      }
    }

    // =============================================
    // INITIALIZATION
    // =============================================
    async function init() {
      await initAuth();
      authState = getAuthState();
      onAuthStateChange(handleAuthState);
      handleAuthState(authState);

      // Sign out handlers
      document.getElementById('signOutBtn')?.addEventListener('click', () => signOut());
      document.getElementById('headerSignOutBtn').addEventListener('click', () => signOut());

      // Tab switching
      document.querySelectorAll('.manage-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.manage-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.manage-panel').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');

          // Load media when switching to Media tab
          if (tab.dataset.tab === 'media' && !mediaLoaded) {
            loadMediaLibrary();
          }

          // Load rentals when switching to Rentals tab
          if (tab.dataset.tab === 'rentals' && !rentalsLoaded) {
            loadRentals();
          }

          // Load events when switching to Events tab
          if (tab.dataset.tab === 'events' && !eventsLoaded) {
            loadEvents();
          }

          // Load templates when switching to Templates tab
          if (tab.dataset.tab === 'templates') {
            loadTemplatesPanel();
          }

          // Load users when switching to Users tab
          if (tab.dataset.tab === 'users' && !usersLoaded) {
            loadUsersPanel();
          }

          // Load payment methods when switching to Settings tab
          if (tab.dataset.tab === 'settings' && !settingsLoaded) {
            loadSettingsPanel();
          }

          // Load FAQ iframe when switching to FAQ tab
          if (tab.dataset.tab === 'faq') {
            const iframe = document.getElementById('faqIframe');
            if (!iframe.src || iframe.src === window.location.href) {
              iframe.src = 'faq.html?embed=1';
            }
          }

          // Load Accounting iframe when switching to Accounting tab
          if (tab.dataset.tab === 'accounting') {
            const iframe = document.getElementById('accountingIframe');
            if (!iframe.src || iframe.src === window.location.href) {
              iframe.src = 'accounting.html?embed=1';
            }
          }
        });
      });

      // Also expose switchTab function for programmatic use
      window.switchTab = function(tabName) {
        const tab = document.querySelector(`.manage-tab[data-tab="${tabName}"]`);
        if (tab) tab.click();
      };

      // Handle URL hash navigation (e.g., #rentals, #events)
      function handleHashNavigation() {
        const hash = window.location.hash.replace('#', '');
        const validTabs = ['spaces', 'rentals', 'events', 'media', 'users', 'templates', 'settings', 'faq', 'accounting'];
        if (hash && validTabs.includes(hash)) {
          switchTab(hash);
        }
      }
      handleHashNavigation();
      window.addEventListener('hashchange', handleHashNavigation);

      // Add space form
      document.getElementById('addSpaceForm').addEventListener('submit', handleAddSpace);

      // View toggle
      document.getElementById('cardViewBtn')?.addEventListener('click', () => setView('card'));
      document.getElementById('tableViewBtn')?.addEventListener('click', () => setView('table'));

      // Space filters
      document.getElementById('searchFilter')?.addEventListener('input', renderSpacesView);
      document.getElementById('parentFilter')?.addEventListener('change', renderSpacesView);
      document.getElementById('bathFilter')?.addEventListener('change', renderSpacesView);
      document.getElementById('visibilityFilter')?.addEventListener('change', renderSpacesView);
      document.getElementById('showDwellings')?.addEventListener('change', renderSpacesView);
      document.getElementById('showEventSpaces')?.addEventListener('change', renderSpacesView);
      document.getElementById('showOther')?.addEventListener('change', renderSpacesView);
      document.getElementById('clearSpaceFilters')?.addEventListener('click', () => {
        document.getElementById('searchFilter').value = '';
        document.getElementById('parentFilter').value = '';
        document.getElementById('bathFilter').value = '';
        document.getElementById('visibilityFilter').value = '';
        document.getElementById('showDwellings').checked = true;
        document.getElementById('showEventSpaces').checked = true;
        document.getElementById('showOther').checked = true;
        renderSpacesView();
      });

      // Table sorting
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => handleSort(th.dataset.sort));
      });

      // Setup all modal handlers
      setupSpaceModals();

      // Media library event listeners
      setupMediaEventListeners();

      // Rentals event listeners
      setupRentalsEventListeners();
    }

    // =============================================
    // SPACES TAB - Full data loading with assignments
    // =============================================

    async function loadSpacesData() {
      try {
        // Load spaces with all related data
        const { data: spacesData, error: spacesError } = await supabase
          .from('spaces')
          .select(`
            *,
            parent:parent_id(name),
            space_amenities(amenity:amenity_id(name)),
            media_spaces(
              display_order,
              is_primary,
              media:media_id(
                id,
                url,
                caption,
                title,
                media_type,
                category,
                file_size_bytes,
                media_tag_assignments(tag:tag_id(id,name,color,tag_group))
              )
            )
          `)
          .order('monthly_rate', { ascending: false, nullsFirst: false })
          .order('name');

        if (spacesError) throw spacesError;

        // Load all tags with usage counts
        allTags = await mediaService.getTagsWithUsage();

        // Check storage usage
        storageUsage = await mediaService.getStorageUsage();

        // Load active assignments with people
        const { data: assignmentsData, error: assignmentsError } = await supabase
          .from('assignments')
          .select(`
            *,
            person:person_id(first_name, last_name, type, email, phone),
            assignment_spaces(space_id)
          `)
          .in('status', ['active', 'pending_contract', 'contract_sent'])
          .order('start_date');

        if (assignmentsError) throw assignmentsError;

        // Load photo requests
        const { data: requestsData, error: requestsError } = await supabase
          .from('photo_requests')
          .select('*')
          .in('status', ['pending', 'submitted']);

        if (requestsError) throw requestsError;

        // Process the data
        const allData = spacesData || [];
        assignments = assignmentsData || [];
        photoRequests = requestsData || [];

        const today = getAustinToday();

        // Process each space
        const processedSpaces = allData.map(space => {
          // Map assignments to this space
          const spaceAssignments = assignments
            .filter(a => a.assignment_spaces?.some(as => as.space_id === space.id))
            .sort((a, b) => {
              const aStart = a.start_date ? parseAustinDate(a.start_date) : new Date(0);
              const bStart = b.start_date ? parseAustinDate(b.start_date) : new Date(0);
              return aStart - bStart;
            });

          const currentAssignment = spaceAssignments.find(a => {
            if (a.status !== 'active') return false;
            const effectiveEndDate = (a.desired_departure_listed && a.desired_departure_date) || a.end_date;
            if (!effectiveEndDate) return true;
            return isTodayOrAfterAustin(effectiveEndDate);
          });

          const getEffectiveEndDate = (assignment) => {
            if (!assignment) return null;
            if (assignment.desired_departure_listed && assignment.desired_departure_date) {
              return assignment.desired_departure_date;
            }
            return assignment.end_date;
          };

          const effectiveEndDate = getEffectiveEndDate(currentAssignment);
          const availableFrom = effectiveEndDate
            ? parseAustinDate(effectiveEndDate)
            : today;

          const nextAssignment = spaceAssignments.find(a => {
            if (a === currentAssignment) return false;
            if (!a.start_date) return false;
            const startDate = parseAustinDate(a.start_date);
            return startDate > availableFrom;
          });

          space.currentAssignment = currentAssignment || null;
          space.nextAssignment = nextAssignment || null;
          space.isAvailable = !currentAssignment;
          space.availableFrom = currentAssignment ? (effectiveEndDate ? parseAustinDate(effectiveEndDate) : null) : today;
          space.availableUntil = nextAssignment?.start_date ? parseAustinDate(nextAssignment.start_date) : null;

          space.amenities = space.space_amenities?.map(sa => sa.amenity?.name).filter(Boolean) || [];

          // Process media
          space.photos = (space.media_spaces || [])
            .sort((a, b) => (a.display_order || 0) - (b.display_order || 0))
            .map(ms => {
              if (!ms.media) return null;
              return {
                ...ms.media,
                display_order: ms.display_order,
                is_primary: ms.is_primary,
                tags: ms.media.media_tag_assignments?.map(mta => mta.tag).filter(Boolean) || []
              };
            })
            .filter(p => p && p.url);

          space.photoRequests = photoRequests.filter(pr => pr.space_id === space.id);

          return space;
        });

        // Second pass: propagate parent unavailability to children
        processedSpaces.forEach(space => {
          if (space.parent_id && space.isAvailable) {
            const parentSpace = processedSpaces.find(s => s.id === space.parent_id);
            if (parentSpace && !parentSpace.isAvailable) {
              space.isAvailable = false;
              space.availableFrom = parentSpace.availableFrom;
              if (!space.availableUntil && parentSpace.availableUntil) {
                space.availableUntil = parentSpace.availableUntil;
              }
            }
          }
        });

        // Third pass: propagate child unavailability to parents
        // If any child space is occupied, the parent is also unavailable
        // Note: A space can be both a parent (has children) AND a child (has parent_id)
        processedSpaces.forEach(space => {
          if (space.isAvailable) {
            // Check if this space has any children
            const childSpaces = processedSpaces.filter(s => s.parent_id === space.id);
            if (childSpaces.length > 0) {
              const unavailableChildren = childSpaces.filter(child => !child.isAvailable);
              if (unavailableChildren.length > 0) {
                // At least one child is occupied, so parent becomes unavailable
                space.isAvailable = false;
                // Parent becomes available when ALL children are available
                // So use the latest (max) availableFrom date among unavailable children
                const childAvailableDates = unavailableChildren
                  .map(c => c.availableFrom)
                  .filter(d => d !== null);
                if (childAvailableDates.length > 0) {
                  space.availableFrom = new Date(Math.max(...childAvailableDates.map(d => d.getTime())));
                } else {
                  space.availableFrom = null; // TBD - no known end date
                }
              }
            }
          }
        });

        // Split into active and archived
        allSpaces = processedSpaces.filter(s => !s.is_archived);
        archivedSpaces = processedSpaces.filter(s => s.is_archived === true);

        // Render everything
        renderSpacesView();
        renderArchivedSpaces();
        populateParentDropdown();
        populateParentFilterDropdown();

        // Check for URL parameters
        checkUrlParameters();

      } catch (error) {
        console.error('Error loading spaces data:', error);
        showToast('Failed to load data. Check console for details.', 'error');
      }
    }

    function checkUrlParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      const editSpaceId = urlParams.get('edit');
      if (editSpaceId) {
        const space = allSpaces.find(s => s.id === editSpaceId);
        if (space) {
          openEditSpace(editSpaceId);
          window.history.replaceState({}, '', window.location.pathname);
        }
      }
    }

    function getFilteredSpaces() {
      let filtered = [...allSpaces];

      // Search filter
      const search = document.getElementById('searchFilter')?.value?.toLowerCase() || '';
      if (search) {
        filtered = filtered.filter(s =>
          s.name.toLowerCase().includes(search) ||
          (s.description && s.description.toLowerCase().includes(search))
        );
      }

      // Parent filter
      const parentId = document.getElementById('parentFilter')?.value || '';
      if (parentId) {
        filtered = filtered.filter(s => s.parent?.name === allSpaces.find(p => p.id === parentId)?.name || s.parent_id === parentId);
      }

      // Bath filter
      const bath = document.getElementById('bathFilter')?.value || '';
      if (bath) {
        filtered = filtered.filter(s => s.bath_privacy === bath);
      }

      // Visibility filter
      const visibility = document.getElementById('visibilityFilter')?.value || '';
      if (visibility === 'listed') {
        filtered = filtered.filter(s => s.is_listed && !s.is_secret);
      } else if (visibility === 'unlisted') {
        filtered = filtered.filter(s => !s.is_listed);
      } else if (visibility === 'secret') {
        filtered = filtered.filter(s => s.is_secret);
      }

      // Type filter (Dwellings, Event Spaces, Other)
      const dwellingsChecked = document.getElementById('showDwellings')?.checked ?? true;
      const eventSpacesChecked = document.getElementById('showEventSpaces')?.checked ?? true;
      const otherChecked = document.getElementById('showOther')?.checked ?? true;
      if (!dwellingsChecked || !eventSpacesChecked || !otherChecked) {
        filtered = filtered.filter(s => {
          const isDwelling = s.can_be_dwelling === true;
          const isEventSpace = s.can_be_event === true;
          const isOther = !isDwelling && !isEventSpace;
          if (dwellingsChecked && isDwelling) return true;
          if (eventSpacesChecked && isEventSpace) return true;
          if (otherChecked && isOther) return true;
          return false;
        });
      }

      // Sort: available spaces first, then by selected column
      filtered.sort((a, b) => {
        const aAvailable = !a.currentAssignment;
        const bAvailable = !b.currentAssignment;
        if (aAvailable && !bAvailable) return -1;
        if (!aAvailable && bAvailable) return 1;

        let aVal = a[currentSort.column];
        let bVal = b[currentSort.column];

        if (currentSort.column === 'occupant') {
          aVal = a.currentAssignment?.person?.first_name || '';
          bVal = b.currentAssignment?.person?.first_name || '';
        }

        const aNull = aVal === null || aVal === undefined || aVal === '';
        const bNull = bVal === null || bVal === undefined || bVal === '';
        if (aNull && !bNull) return 1;
        if (!aNull && bNull) return -1;
        if (aNull && bNull) return a.name.localeCompare(b.name);

        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return a.name.localeCompare(b.name);
      });

      return filtered;
    }

    function populateParentFilterDropdown() {
      const select = document.getElementById('parentFilter');
      const parents = new Set();
      allSpaces.forEach(s => {
        if (s.parent?.name) parents.add(s.parent.name);
      });
      const sortedParents = Array.from(parents).sort();
      select.innerHTML = '<option value="">All areas</option>' +
        sortedParents.map(name => {
          const space = allSpaces.find(s => s.name === name);
          return `<option value="${space?.id || ''}">${name}</option>`;
        }).join('');
    }

    // View management
    function setView(view) {
      currentView = view;
      document.getElementById('cardViewBtn')?.classList.toggle('active', view === 'card');
      document.getElementById('tableViewBtn')?.classList.toggle('active', view === 'table');
      document.getElementById('cardView')?.classList.toggle('hidden', view !== 'card');
      document.getElementById('tableView')?.classList.toggle('hidden', view !== 'table');
    }

    function handleSort(column) {
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.sort === column) {
          th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
      renderSpacesView();
    }

    function renderSpacesView() {
      const filtered = getFilteredSpaces();
      document.getElementById('spacesCount').textContent = `${filtered.length} spaces`;
      renderCards(filtered);
      renderTable(filtered);
    }

    function getBedSummary(space) {
      const beds = [];
      if (space.beds_king) beds.push(`${space.beds_king} king`);
      if (space.beds_queen) beds.push(`${space.beds_queen} queen`);
      if (space.beds_double) beds.push(`${space.beds_double} full`);
      if (space.beds_twin) beds.push(`${space.beds_twin} twin`);
      if (space.beds_folding) beds.push(`${space.beds_folding} folding`);
      return beds.join(', ');
    }

    function getParentSpaceId(parentName) {
      const parentSpace = allSpaces.find(s => s.name === parentName);
      return parentSpace ? parentSpace.id : null;
    }

    function renderCards(spacesToRender) {
      const cardView = document.getElementById('cardView');
      const isAdmin = authState?.appUser?.role === 'admin';

      cardView.innerHTML = spacesToRender.map(space => {
        const occupant = space.currentAssignment?.person;
        const photo = space.photos[0];
        const photoCount = space.photos.length;
        const isOccupied = !!space.currentAssignment;

        const fmtDate = (d) => d ? formatDateAustin(d, { month: 'short', day: 'numeric' }) : null;
        const availFromStr = space.availableFrom && space.availableFrom > getAustinToday()
          ? fmtDate(space.availableFrom)
          : 'NOW';
        const availUntilStr = space.availableUntil ? fmtDate(space.availableUntil) : 'Open-ended';

        const fromBadgeClass = availFromStr === 'NOW' ? 'available' : 'occupied';
        const untilBadgeClass = availUntilStr === 'Open-ended' ? 'available' : 'occupied';

        let badges = `<span class="badge ${fromBadgeClass}">Available: ${availFromStr}</span>`;
        badges += `<span class="badge ${untilBadgeClass} badge-right">Until: ${availUntilStr}</span>`;

        if (space.is_secret) badges += '<span class="badge secret">Secret</span>';
        else if (!space.is_listed) badges += '<span class="badge unlisted">Unlisted</span>';

        const beds = getBedSummary(space);
        const bathText = (space.can_be_dwelling && space.bath_privacy && space.bath_privacy !== 'none') ? space.bath_privacy : '';

        const photoCountHtml = photoCount > 1 ? `
          <div class="photo-count">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
              <path d="M21 15l-5-5L5 21"/>
            </svg>
            ${photoCount}
          </div>
        ` : '';

        let occupantHtml = '';
        if (isOccupied && occupant) {
          const name = `${occupant.first_name} ${occupant.last_name || ''}`.trim();
          const endDate = space.currentAssignment.end_date
            ? formatDateAustin(space.currentAssignment.end_date, { month: 'short', day: 'numeric', year: 'numeric' })
            : 'No end date';
          occupantHtml = `
            <div class="card-occupant">
              <strong>${name}</strong> · ${occupant.type}<br>
              <small>Until: ${endDate}</small>
            </div>
          `;
        }

        const pendingRequests = space.photoRequests?.filter(r => r.status === 'pending').length || 0;

        let actionsHtml = '';
        if (isAdmin) {
          actionsHtml = `
            <div class="card-actions">
              <button class="btn-edit" onclick="event.stopPropagation(); openEditSpace('${space.id}')">Edit</button>
              <button class="btn-small" onclick="event.stopPropagation(); openPhotoUpload('${space.id}', '${space.name.replace(/'/g, "\\'")}')">
                Add Images${pendingRequests ? ` (${pendingRequests} pending)` : ''}
              </button>
            </div>
          `;
        }

        return `
          <div class="space-card" onclick="showSpaceDetail('${space.id}')">
            <div class="card-image">
              ${photo
                ? `<img src="${photo.url}" alt="${space.name}" onclick="event.stopPropagation(); openLightboxForSpace('${space.id}', '${photo.url}')" style="cursor: zoom-in;">`
                : `<div class="no-photo">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
                      <path d="M21 15l-5-5L5 21"/>
                    </svg>
                    No photos
                  </div>`
              }
              ${photoCountHtml}
            </div>
            <div class="card-badges">${badges}</div>
            <div class="card-body">
              <div class="card-header">
                <div>
                  <div class="card-title">${space.parent?.name ? `<a href="?edit=${getParentSpaceId(space.parent.name)}" class="card-parent-link" onclick="event.stopPropagation();">${space.parent.name} /</a> ` : ''}${space.name}</div>
                  ${space.description ? `<div class="card-description">${space.description}</div>` : ''}
                </div>
              </div>
              <div class="card-details">
                ${space.sq_footage ? `<span class="detail-item"><span class="detail-icon">📐</span>${space.sq_footage} sq ft</span>` : ''}
                ${beds ? `<span class="detail-item"><span class="detail-icon">🛏️</span>${beds}</span>` : ''}
                ${bathText ? `<span class="detail-item"><span class="detail-icon">🚿</span>${bathText} bath</span>` : ''}
              </div>
              <div class="card-footer">
                ${space.monthly_rate ? `<div class="card-price">$${space.monthly_rate}<span>/mo</span></div>` : ''}
                ${space.amenities.length ? `
                  <div class="card-amenities">
                    ${space.amenities.slice(0, 3).map(a => `<span class="amenity-tag">${a}</span>`).join('')}
                    ${space.amenities.length > 3 ? `<span class="amenity-tag amenity-more">+${space.amenities.length - 3}</span>` : ''}
                  </div>
                ` : ''}
              </div>
              ${occupantHtml}
              ${actionsHtml}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTable(spacesToRender) {
      const tableBody = document.getElementById('tableBody');

      tableBody.innerHTML = spacesToRender.map(space => {
        const isOccupied = !!space.currentAssignment;
        const occupant = space.currentAssignment?.person;
        const beds = getBedSummary(space);

        const occupantName = occupant
          ? `${occupant.first_name} ${occupant.last_name || ''}`.trim()
          : '-';

        const assignment = space.currentAssignment;
        let leaseDatesHtml = '-';
        if (assignment) {
          const startStr = assignment.start_date
            ? formatDateAustin(assignment.start_date, { month: 'short', day: 'numeric', year: '2-digit' })
            : '?';
          const endStr = assignment.end_date
            ? formatDateAustin(assignment.end_date, { month: 'short', day: 'numeric', year: '2-digit' })
            : 'ongoing';
          leaseDatesHtml = `${startStr} - ${endStr}`;

          if (assignment.desired_departure_date) {
            const earlyStr = formatDateAustin(assignment.desired_departure_date, { month: 'short', day: 'numeric', year: '2-digit' });
            const listedIcon = assignment.desired_departure_listed ? '✓' : '';
            leaseDatesHtml += `<br><small style="color:var(--accent);">Early exit: ${earlyStr} ${listedIcon}</small>`;
          }
        }

        const fmtDate = (d) => d ? formatDateAustin(d, { month: 'short', day: 'numeric' }) : null;
        const availFromStr = space.availableFrom && space.availableFrom > getAustinToday()
          ? fmtDate(space.availableFrom)
          : 'NOW';
        const availUntilStr = space.availableUntil ? fmtDate(space.availableUntil) : 'Open-ended';

        // Status badge - use isAvailable (accounts for parent/child propagation)
        // Single letter: A=Available, O=Occupied
        let statusBadge = space.isAvailable
          ? '<span class="badge available" title="Available">A</span>'
          : '<span class="badge occupied" title="Occupied">O</span>';

        // Visibility badge (separate column now)
        let visBadge = '';
        if (space.is_secret) visBadge = '<span class="badge secret" title="Secret">S</span>';
        else if (!space.is_listed) visBadge = '<span class="badge unlisted" title="Unlisted">U</span>';

        const thumbnail = space.photos.length > 0
          ? `<img src="${space.photos[0].url}" alt="" class="table-thumbnail" onclick="event.stopPropagation(); openLightboxForSpace('${space.id}', '${space.photos[0].url}')" style="cursor: zoom-in;">`
          : `<div class="table-thumbnail-placeholder"></div>`;

        const description = space.description
          ? (space.description.length > 100 ? space.description.substring(0, 100) + '...' : space.description)
          : '';

        // Build stacked details: size, bath, beds
        const detailLines = [];
        if (space.sq_footage) detailLines.push(`${space.sq_footage} sqft`);
        if (space.can_be_dwelling && space.bath_privacy && space.bath_privacy !== 'none') detailLines.push(`${space.bath_privacy} bath`);
        if (beds) detailLines.push(beds);
        const detailsHtml = detailLines.length > 0 ? detailLines.join('<br>') : '-';

        return `
          <tr onclick="showSpaceDetail('${space.id}')" style="cursor:pointer;">
            <td class="td-thumbnail">${thumbnail}</td>
            <td class="td-name-desc">${space.parent?.name ? `<a href="?edit=${getParentSpaceId(space.parent.name)}" class="table-parent-link" onclick="event.stopPropagation();">${space.parent.name} /</a> ` : ''}<strong>${space.name}</strong>${description ? `<br><small class="td-description-inline">${description}</small>` : ''}</td>
            <td>${space.monthly_rate ? `$${space.monthly_rate}/mo` : '-'}</td>
            <td class="td-details">${detailsHtml}</td>
            <td>${space.amenities.slice(0, 3).join(', ') || '-'}</td>
            <td>${availFromStr}</td>
            <td>${availUntilStr}</td>
            <td>${occupantName}${occupant?.type ? `<br><small style="color:var(--text-muted)">${occupant.type}</small>` : ''}</td>
            <td>${leaseDatesHtml}</td>
            <td>${statusBadge}</td>
            <td>${visBadge}</td>
          </tr>
        `;
      }).join('');
    }

    function renderArchivedSpaces() {
      const section = document.getElementById('archivedSection');
      const container = document.getElementById('archivedSpacesList');
      const countEl = document.getElementById('archivedCount');

      if (archivedSpaces.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      countEl.textContent = `${archivedSpaces.length} archived`;

      container.innerHTML = archivedSpaces.map(space => {
        const photo = space.photos?.[0];
        const thumbHtml = photo
          ? `<img src="${photo.url}" alt="${space.name}" class="space-item-thumb" onclick="event.stopPropagation(); openLightbox('${photo.url}')">`
          : `<div class="space-item-thumb-placeholder"></div>`;
        return `
          <div class="space-item" style="opacity: 0.7;">
            <div class="space-item-info">
              ${thumbHtml}
              <div class="space-item-details">
                <h3>${space.name}</h3>
                <small>Archived</small>
              </div>
            </div>
            <div class="space-item-actions">
              <button class="btn-small btn-primary" onclick="unarchiveSpace('${space.id}', '${space.name.replace(/'/g, "\\'")}')">Restore</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function populateParentDropdown() {
      const select = document.getElementById('newSpaceParent');
      select.innerHTML = '<option value="">None (top-level)</option>' +
        allSpaces.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    async function handleAddSpace(e) {
      e.preventDefault();
      const name = document.getElementById('newSpaceName').value.trim();
      const parentId = document.getElementById('newSpaceParent').value || null;

      if (!name) {
        showToast('Name is required', 'warning');
        return;
      }

      const { data, error } = await supabase
        .from('spaces')
        .insert({ name, parent_id: parentId, can_be_dwelling: true, is_listed: false })
        .select();

      if (error) {
        showToast('Error creating space: ' + error.message, 'error');
        return;
      }

      document.getElementById('newSpaceName').value = '';
      document.getElementById('newSpaceParent').value = '';
      loadSpacesData();
      showToast('Space created! Click on it to edit.', 'success');
    }

    window.unarchiveSpace = async function(id, name) {
      if (!confirm(`Restore "${name}"? It will appear in the main spaces list again.`)) return;

      const { error } = await supabase
        .from('spaces')
        .update({ is_archived: false })
        .eq('id', id);

      if (error) {
        showToast('Error restoring space: ' + error.message, 'error');
        return;
      }
      loadSpacesData();
      showToast('Space restored', 'success');
    };

    window.deleteSpace = async function(id, name) {
      if (!confirm(`Permanently delete "${name}"? This cannot be undone.\n\nConsider archiving instead if you might need it later.`)) return;

      const { error } = await supabase.from('spaces').delete().eq('id', id);
      if (error) {
        showToast('Error deleting space: ' + error.message, 'error');
        return;
      }
      loadSpacesData();
      showToast('Space deleted', 'success');
    };

    // =============================================
    // SPACE MODALS (Detail, Edit, Photo Upload)
    // =============================================
    function setupSpaceModals() {
      const spaceDetailModal = document.getElementById('spaceDetailModal');
      const photoUploadModal = document.getElementById('photoUploadModal');
      const editSpaceModal = document.getElementById('editSpaceModal');

      // Detail modal
      document.getElementById('closeDetailModal')?.addEventListener('click', () => {
        spaceDetailModal.classList.add('hidden');
      });
      spaceDetailModal?.addEventListener('click', (e) => {
        if (e.target === spaceDetailModal) spaceDetailModal.classList.add('hidden');
      });

      // Photo upload modal
      document.getElementById('closeUploadModal')?.addEventListener('click', () => {
        photoUploadModal.classList.add('hidden');
      });
      document.getElementById('cancelPhotoUpload')?.addEventListener('click', () => {
        photoUploadModal.classList.add('hidden');
      });
      document.getElementById('submitPhotoUpload')?.addEventListener('click', handlePhotoUpload);
      document.getElementById('photoFile')?.addEventListener('change', handleFilePreview);
      photoUploadModal?.addEventListener('click', (e) => {
        if (e.target === photoUploadModal) photoUploadModal.classList.add('hidden');
      });

      // Media picker tab switching
      document.querySelectorAll('#photoUploadModal .media-picker-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchMediaPickerTab(btn.dataset.tab));
      });

      // Library tab handlers
      document.getElementById('cancelLibrarySelect')?.addEventListener('click', () => {
        photoUploadModal.classList.add('hidden');
      });
      document.getElementById('submitLibrarySelect')?.addEventListener('click', handleLibrarySelect);
      document.getElementById('libraryCategoryFilter')?.addEventListener('change', (e) => {
        activeLibraryFilters.category = e.target.value;
        loadLibraryMedia();
      });

      // Request tab handlers
      document.getElementById('cancelPhotoRequest')?.addEventListener('click', () => {
        photoUploadModal.classList.add('hidden');
      });
      document.getElementById('submitPhotoRequest')?.addEventListener('click', handlePhotoRequestSubmit);

      // Edit space modal handlers
      document.getElementById('closeEditModal')?.addEventListener('click', () => {
        editSpaceModal.classList.add('hidden');
      });
      document.getElementById('cancelEditSpace')?.addEventListener('click', () => {
        editSpaceModal.classList.add('hidden');
      });
      document.getElementById('submitEditSpace')?.addEventListener('click', handleEditSpaceSubmit);
      document.getElementById('archiveSpaceBtn')?.addEventListener('click', handleArchiveSpace);
      document.getElementById('editSpaceForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
      });
      editSpaceModal?.addEventListener('click', (e) => {
        if (e.target === editSpaceModal) editSpaceModal.classList.add('hidden');
      });

      // Add more photos link in edit modal
      document.getElementById('addMorePhotosLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        const spaceId = document.getElementById('editSpaceId').value;
        const spaceName = document.getElementById('editName').value;
        if (spaceId) {
          editSpaceModal.classList.add('hidden');
          openPhotoUpload(spaceId, spaceName);
        }
      });

      // Lightbox handlers
      const lightbox = document.getElementById('imageLightbox');
      lightbox?.addEventListener('click', (e) => {
        if (e.target === lightbox || e.target.classList.contains('lightbox-close')) {
          closeLightbox();
        }
      });
      document.getElementById('lightboxPrev')?.addEventListener('click', (e) => { e.stopPropagation(); lightboxPrev(); });
      document.getElementById('lightboxNext')?.addEventListener('click', (e) => { e.stopPropagation(); lightboxNext(); });

      // Keyboard navigation for lightbox
      document.addEventListener('keydown', (e) => {
        const lb = document.getElementById('imageLightbox');
        if (!lb || lb.classList.contains('hidden')) return;
        if (e.key === 'Escape') closeLightbox();
        else if (e.key === 'ArrowLeft') lightboxPrev();
        else if (e.key === 'ArrowRight') lightboxNext();
      });
    }

    // Lightbox functions
    function setCurrentGallery(photos) {
      currentGalleryUrls = photos.map(p => p.url);
    }

    function openLightbox(imageUrl, galleryUrls = null) {
      const lightbox = document.getElementById('imageLightbox');
      const lightboxImage = document.getElementById('lightboxImage');
      if (lightbox && lightboxImage) {
        if (galleryUrls && galleryUrls.length > 0) {
          lightboxGallery = [...galleryUrls];
          lightboxIndex = lightboxGallery.indexOf(imageUrl);
          if (lightboxIndex === -1) lightboxIndex = 0;
        } else if (currentGalleryUrls.length > 0 && currentGalleryUrls.includes(imageUrl)) {
          lightboxGallery = [...currentGalleryUrls];
          lightboxIndex = lightboxGallery.indexOf(imageUrl);
        } else {
          lightboxGallery = [imageUrl];
          lightboxIndex = 0;
        }
        lightboxImage.src = imageUrl;
        lightbox.classList.remove('hidden');
        updateLightboxNav();
      }
    }

    function updateLightboxNav() {
      const prevBtn = document.getElementById('lightboxPrev');
      const nextBtn = document.getElementById('lightboxNext');
      if (prevBtn && nextBtn) {
        const showNav = lightboxGallery.length > 1;
        prevBtn.style.display = showNav ? 'flex' : 'none';
        nextBtn.style.display = showNav ? 'flex' : 'none';
      }
    }

    function lightboxPrev() {
      if (lightboxIndex > 0) {
        lightboxIndex--;
        document.getElementById('lightboxImage').src = lightboxGallery[lightboxIndex];
        updateLightboxNav();
      }
    }

    function lightboxNext() {
      if (lightboxIndex < lightboxGallery.length - 1) {
        lightboxIndex++;
        document.getElementById('lightboxImage').src = lightboxGallery[lightboxIndex];
        updateLightboxNav();
      }
    }

    function closeLightbox() {
      const lightbox = document.getElementById('imageLightbox');
      if (lightbox) {
        lightbox.classList.add('hidden');
        document.getElementById('lightboxImage').src = '';
        lightboxGallery = [];
        lightboxIndex = 0;
      }
    }

    function openLightboxForSpace(spaceId, imageUrl) {
      const space = allSpaces.find(s => s.id === spaceId);
      if (space && space.photos && space.photos.length > 0) {
        const galleryUrls = space.photos.map(p => p.url);
        openLightbox(imageUrl, galleryUrls);
      } else {
        openLightbox(imageUrl);
      }
    }

    // Space detail modal
    function showSpaceDetail(spaceId) {
      const space = allSpaces.find(s => s.id === spaceId);
      if (!space) return;

      const isAdmin = authState?.appUser?.role === 'admin';
      const spaceDetailModal = document.getElementById('spaceDetailModal');

      const headerHtml = space.parent?.name
        ? `<a href="#" class="detail-parent-link" onclick="event.preventDefault(); showSpaceDetail('${getParentSpaceId(space.parent.name)}');">${space.parent.name}</a> / ${space.name}`
        : space.name;
      document.getElementById('detailSpaceName').innerHTML = headerHtml;

      // Populate header buttons for admin
      const headerButtonsHtml = isAdmin ? `
        <button class="btn-primary" onclick="openEditSpace('${space.id}'); spaceDetailModal.classList.add('hidden');">Edit Space</button>
        <button class="btn-secondary" onclick="openPhotoUpload('${space.id}', '${space.name.replace(/'/g, "\\'")}'); spaceDetailModal.classList.add('hidden');">Add Images</button>
      ` : '';
      document.getElementById('detailHeaderButtons').innerHTML = headerButtonsHtml;

      const isOccupied = !!space.currentAssignment;
      const occupant = space.currentAssignment?.person;

      // Get child spaces with photos
      const childSpaces = allSpaces.filter(s => s.parent?.name === space.name && s.photos && s.photos.length > 0);

      // Walk up the parent chain to collect all ancestor photos (same as consumer view)
      const ancestorPhotoSections = [];
      let currentParentName = space.parent?.name;
      while (currentParentName) {
        const parentSpace = allSpaces.find(s => s.name === currentParentName);
        if (parentSpace && parentSpace.photos && parentSpace.photos.length > 0) {
          ancestorPhotoSections.push({
            name: parentSpace.name,
            photos: parentSpace.photos
          });
        }
        // Move up to the next parent
        currentParentName = parentSpace?.parent?.name || null;
      }

      // Combine all photos for lightbox gallery (space photos first, then children, then ancestors)
      const allPhotos = [...space.photos];
      childSpaces.forEach(child => { allPhotos.push(...child.photos); });
      ancestorPhotoSections.forEach(section => { allPhotos.push(...section.photos); });
      if (allPhotos.length) setCurrentGallery(allPhotos);

      let occupantHtml = '';
      if (isOccupied && occupant) {
        const a = space.currentAssignment;
        const desiredDepartureStr = a.desired_departure_date
          ? formatDateAustin(a.desired_departure_date, { month: 'short', day: 'numeric', year: 'numeric' })
          : null;
        const earlyExitHtml = desiredDepartureStr
          ? `<p style="color: var(--accent);"><strong>Early Exit:</strong> ${desiredDepartureStr}</p>`
          : '';
        occupantHtml = `
          <div class="detail-section">
            <h3>Current Occupant</h3>
            <p><strong>${occupant.first_name} ${occupant.last_name || ''}</strong> (${occupant.type})</p>
            ${occupant.email ? `<p>Email: ${occupant.email}</p>` : ''}
            ${occupant.phone ? `<p>Phone: ${occupant.phone}</p>` : ''}
            <p>Rate: $${a.rate_amount}/${a.rate_term}</p>
            <p>Start: ${a.start_date ? formatDateAustin(a.start_date, { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A'}</p>
            <p>End: ${a.end_date ? formatDateAustin(a.end_date, { month: 'short', day: 'numeric', year: 'numeric' }) : 'No end date'}</p>
            ${earlyExitHtml}
            ${isAdmin ? `
              <div style="margin-top: 0.75rem;">
                <label style="font-size: 0.875rem; color: var(--text-muted);">Desired Departure (Early Exit):</label>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem;">
                  <input type="date" id="desiredDepartureDate" value="${a.desired_departure_date || ''}"
                    style="padding: 0.25rem 0.5rem; border: 1px solid var(--border); border-radius: var(--radius);"
                    onchange="updateDesiredDeparture('${a.id}', this.value)">
                  ${a.desired_departure_date ? `
                    <button onclick="toggleDesiredDepartureListed('${a.id}', ${!a.desired_departure_listed})"
                      style="padding: 0.25rem 0.75rem; border: 1px solid ${a.desired_departure_listed ? 'var(--error)' : 'var(--accent)'};
                        background: ${a.desired_departure_listed ? 'var(--error-light)' : 'var(--accent-light)'};
                        color: ${a.desired_departure_listed ? 'var(--error)' : 'var(--accent)'};
                        border-radius: var(--radius); cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                      ${a.desired_departure_listed ? 'Unlist' : 'List'}
                    </button>
                    ${a.desired_departure_listed ? '<span style="color: var(--accent); font-size: 0.75rem;">✓ Listed for new renters</span>' : '<span style="color: var(--text-muted); font-size: 0.75rem;">Not listed yet</span>'}
                  ` : ''}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }

      // Space photos
      const editLink = isAdmin ? `<a href="#" class="edit-photos-link" onclick="event.preventDefault(); openEditSpace('${space.id}'); spaceDetailModal.classList.add('hidden');">Edit photos</a>` : '';
      let spacePhotosHtml = '';
      if (space.photos.length) {
        spacePhotosHtml = `
          <div class="detail-section detail-photos">
            <h3>${space.name} Photos ${editLink}</h3>
            <div class="detail-photos-grid">
              ${space.photos.map(p => `
                <div class="detail-photo" onclick="openLightbox('${p.url}')" style="cursor: zoom-in;">
                  <img src="${p.url}" alt="${p.caption || space.name}">
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Child photos
      let childPhotosHtml = '';
      childSpaces.forEach(child => {
        childPhotosHtml += `
          <div class="detail-section detail-photos">
            <h3>${child.name} Photos</h3>
            <div class="detail-photos-grid">
              ${child.photos.map(p => `
                <div class="detail-photo" onclick="openLightbox('${p.url}')" style="cursor: zoom-in;">
                  <img src="${p.url}" alt="${p.caption || child.name}">
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      // Ancestor photos (each ancestor gets its own section, closest parent first)
      const needsSeparator = (space.photos.length > 0 || childSpaces.length > 0) && ancestorPhotoSections.length > 0;
      let ancestorPhotosHtml = needsSeparator ? '<hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0;">' : '';
      ancestorPhotoSections.forEach(section => {
        ancestorPhotosHtml += `
          <div class="detail-section detail-photos">
            <h3>${section.name} Photos</h3>
            <div class="detail-photos-grid">
              ${section.photos.map(p => `
                <div class="detail-photo" onclick="openLightbox('${p.url}')" style="cursor: zoom-in;">
                  <img src="${p.url}" alt="${p.caption || section.name}">
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      document.getElementById('spaceDetailBody').innerHTML = `
        <div class="detail-grid">
          <div class="detail-section">
            <h3>Details</h3>
            ${space.monthly_rate ? `<p><strong>Rate:</strong> $${space.monthly_rate}/mo</p>` : ''}
            <p><strong>Size:</strong> ${space.sq_footage ? `${space.sq_footage} sq ft` : 'N/A'}</p>
            <p><strong>Beds:</strong> ${getBedSummary(space) || 'N/A'}</p>
            ${space.can_be_dwelling && ((space.bath_privacy && space.bath_privacy !== 'none') || space.bath_fixture) ? `<p><strong>Bathroom:</strong> ${(space.bath_privacy && space.bath_privacy !== 'none') ? space.bath_privacy : ''}${space.bath_fixture ? ` (${space.bath_fixture})` : ''}</p>` : ''}
            <p><strong>Capacity:</strong> ${space.min_residents || 1}-${space.max_residents || '?'} residents</p>
            ${space.gender_restriction && space.gender_restriction !== 'none' ? `<p><strong>Restriction:</strong> ${space.gender_restriction} only</p>` : ''}
          </div>
          <div class="detail-section">
            <h3>Amenities</h3>
            ${space.amenities.length ? `<p>${space.amenities.join(', ')}</p>` : '<p>No amenities listed</p>'}
          </div>
          ${occupantHtml}
        </div>
        ${space.description ? `<div class="detail-section detail-description"><h3>Description</h3><p>${space.description}</p></div>` : ''}
        ${spacePhotosHtml}
        ${childPhotosHtml}
        ${ancestorPhotosHtml}
      `;

      spaceDetailModal.classList.remove('hidden');
    }

    // Edit space modal
    function openEditSpace(spaceId) {
      if (authState?.appUser?.role !== 'admin') {
        showToast('Only admins can edit spaces', 'warning');
        return;
      }

      const space = allSpaces.find(s => s.id === spaceId);
      if (!space) {
        showToast('Space not found', 'error');
        return;
      }

      currentEditSpaceId = spaceId;
      document.getElementById('editSpaceName').textContent = space.name;
      document.getElementById('editSpaceId').value = spaceId;

      // Populate parent space dropdown
      const parentSelect = document.getElementById('editParentSpace');
      if (parentSelect) {
        const possibleParents = allSpaces.filter(s => s.id !== spaceId && !s.is_archived);
        parentSelect.innerHTML = '<option value="">None (top level)</option>' +
          possibleParents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        parentSelect.value = space.parent_id || '';
      }

      // Populate form fields
      document.getElementById('editName').value = space.name || '';
      document.getElementById('editLocation').value = space.location || '';
      document.getElementById('editType').value = space.type || '';
      document.getElementById('editDescription').value = space.description || '';
      document.getElementById('editMonthlyRate').value = space.monthly_rate || '';
      document.getElementById('editWeeklyRate').value = space.weekly_rate || '';
      document.getElementById('editNightlyRate').value = space.nightly_rate || '';
      document.getElementById('editRentalTerm').value = space.rental_term || '';
      document.getElementById('editStandardDeposit').value = space.standard_deposit || '';
      document.getElementById('editSqFootage').value = space.sq_footage || '';
      document.getElementById('editMinResidents').value = space.min_residents || 1;
      document.getElementById('editMaxResidents').value = space.max_residents || '';
      document.getElementById('editBathPrivacy').value = space.bath_privacy || '';
      document.getElementById('editBathFixture').value = space.bath_fixture || '';
      document.getElementById('editGenderRestriction').value = space.gender_restriction || 'none';
      document.getElementById('editBedsKing').value = space.beds_king || 0;
      document.getElementById('editBedsQueen').value = space.beds_queen || 0;
      document.getElementById('editBedsDouble').value = space.beds_double || 0;
      document.getElementById('editBedsTwin').value = space.beds_twin || 0;
      document.getElementById('editBedsFolding').value = space.beds_folding || 0;
      document.getElementById('editIsListed').checked = space.is_listed || false;
      document.getElementById('editIsSecret').checked = space.is_secret || false;
      document.getElementById('editCanBeDwelling').checked = space.can_be_dwelling !== false;
      document.getElementById('editCanBeEvent').checked = space.can_be_event || false;

      renderEditPhotos(space);
      document.getElementById('editSpaceModal').classList.remove('hidden');
    }

    function renderEditPhotos(space) {
      const container = document.getElementById('editPhotosContainer');
      if (!space.photos || space.photos.length === 0) {
        container.innerHTML = '<div class="no-photos-message">No photos yet. Use the Images button to add photos.</div>';
        return;
      }

      setCurrentGallery(space.photos);

      container.innerHTML = space.photos.map((photo, idx) => {
        const primaryBadge = photo.is_primary ? '<span class="photo-tag" style="background: var(--accent);">Primary</span>' : '';
        return `
          <div class="edit-photo-item" draggable="true" data-photo-id="${photo.id}" data-space-id="${space.id}">
            <div class="drag-handle" title="Drag to reorder">⋮⋮</div>
            <img src="${photo.url}" alt="${photo.caption || 'Photo ' + (idx + 1)}" onclick="openLightbox('${photo.url}')" style="cursor: zoom-in;">
            <span class="photo-order">#${idx + 1} ${primaryBadge}</span>
            <button type="button" class="btn-remove-photo" onclick="event.preventDefault(); event.stopPropagation(); removePhotoFromSpace('${space.id}', '${photo.id}')" title="Remove">×</button>
          </div>
        `;
      }).join('');

      initPhotoDragAndDrop(container, space.id);
    }

    function initPhotoDragAndDrop(container, spaceId) {
      let draggedItem = null;

      container.querySelectorAll('.edit-photo-item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          draggedItem = null;
          container.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (draggedItem && draggedItem !== item) {
            item.classList.add('drag-over');
          }
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('drag-over');
        });

        item.addEventListener('drop', async (e) => {
          e.preventDefault();
          item.classList.remove('drag-over');
          if (!draggedItem || draggedItem === item) return;

          const items = [...container.querySelectorAll('.edit-photo-item')];
          const fromIndex = items.indexOf(draggedItem);
          const toIndex = items.indexOf(item);

          if (fromIndex < toIndex) {
            item.parentNode.insertBefore(draggedItem, item.nextSibling);
          } else {
            item.parentNode.insertBefore(draggedItem, item);
          }

          const newOrder = [...container.querySelectorAll('.edit-photo-item')].map(el => el.dataset.photoId);
          await savePhotoOrder(spaceId, newOrder);
        });
      });
    }

    async function savePhotoOrder(spaceId, mediaIds) {
      try {
        await mediaService.reorderInSpace(spaceId, mediaIds);
        const space = allSpaces.find(s => s.id === spaceId);
        if (space) {
          const photoMap = new Map(space.photos.map(p => [p.id, p]));
          space.photos = mediaIds.map(id => photoMap.get(id)).filter(Boolean);
          renderEditPhotos(space);
        }
      } catch (error) {
        console.error('Error saving photo order:', error);
        showToast('Failed to save photo order', 'error');
      }
    }

    async function handleEditSpaceSubmit() {
      if (isSavingSpace) return;

      if (authState?.appUser?.role !== 'admin') {
        showToast('Only admins can edit spaces', 'warning');
        return;
      }

      const spaceId = document.getElementById('editSpaceId').value;
      const name = document.getElementById('editName').value.trim();

      if (!name) {
        showToast('Name is required', 'warning');
        return;
      }

      const submitBtn = document.getElementById('submitEditSpace');
      isSavingSpace = true;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      try {
        const getVal = (id) => document.getElementById(id)?.value?.trim() || null;
        const getInt = (id) => parseInt(document.getElementById(id)?.value) || null;
        const getIntOrZero = (id) => parseInt(document.getElementById(id)?.value) || 0;
        const getChecked = (id) => document.getElementById(id)?.checked || false;

        const updates = {
          name: name,
          parent_id: getVal('editParentSpace') || null,
          location: getVal('editLocation'),
          type: getVal('editType'),
          description: getVal('editDescription'),
          monthly_rate: getInt('editMonthlyRate'),
          weekly_rate: getInt('editWeeklyRate'),
          nightly_rate: getInt('editNightlyRate'),
          rental_term: getVal('editRentalTerm'),
          standard_deposit: getVal('editStandardDeposit'),
          sq_footage: getInt('editSqFootage'),
          min_residents: getInt('editMinResidents') || 1,
          max_residents: getInt('editMaxResidents'),
          bath_privacy: getVal('editBathPrivacy'),
          bath_fixture: getVal('editBathFixture'),
          gender_restriction: getVal('editGenderRestriction') || 'none',
          beds_king: getIntOrZero('editBedsKing'),
          beds_queen: getIntOrZero('editBedsQueen'),
          beds_double: getIntOrZero('editBedsDouble'),
          beds_twin: getIntOrZero('editBedsTwin'),
          beds_folding: getIntOrZero('editBedsFolding'),
          is_listed: getChecked('editIsListed'),
          is_secret: getChecked('editIsSecret'),
          can_be_dwelling: getChecked('editCanBeDwelling'),
          can_be_event: getChecked('editCanBeEvent'),
        };

        const { error } = await supabase
          .from('spaces')
          .update(updates)
          .eq('id', spaceId)
          .select();

        if (error) throw error;

        showToast('Space updated successfully!', 'success');
        document.getElementById('editSpaceModal').classList.add('hidden');
        isSavingSpace = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';

        loadSpacesData();

      } catch (error) {
        console.error('Error updating space:', error);
        showToast('Failed to update space: ' + error.message, 'error');
        isSavingSpace = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';
      }
    }

    async function handleArchiveSpace() {
      if (authState?.appUser?.role !== 'admin') {
        showToast('Only admins can archive spaces', 'warning');
        return;
      }

      const spaceId = document.getElementById('editSpaceId').value;
      const space = allSpaces.find(s => s.id === spaceId);
      if (!space) return;

      if (!confirm(`Archive "${space.name}"?\n\nThis will hide the space from all views but keep it in the database. You can restore it later.`)) return;

      try {
        const { error } = await supabase
          .from('spaces')
          .update({ is_archived: true })
          .eq('id', spaceId)
          .select();

        if (error) throw error;

        showToast(`"${space.name}" has been archived`, 'success');
        document.getElementById('editSpaceModal').classList.add('hidden');
        loadSpacesData();

      } catch (error) {
        console.error('Error archiving space:', error);
        showToast('Failed to archive space: ' + error.message, 'error');
      }
    }

    async function removePhotoFromSpace(spaceId, mediaId) {
      if (authState?.appUser?.role !== 'admin') {
        showToast('Only admins can remove photos', 'warning');
        return;
      }

      try {
        await mediaService.unlinkFromSpace(mediaId, spaceId);
        const space = allSpaces.find(s => s.id === spaceId);
        if (space) {
          space.photos = space.photos.filter(p => p.id !== mediaId);
          renderEditPhotos(space);
        }
        showToast('Photo removed from space', 'success');
      } catch (error) {
        console.error('Error removing photo:', error);
        showToast('Failed to remove photo: ' + error.message, 'error');
      }
    }

    // Photo upload modal functions
    async function openPhotoUpload(spaceId, spaceName, context = 'dwelling', initialTab = 'library') {
      if (authState?.appUser?.role !== 'admin') {
        showToast('Only admins can upload photos', 'warning');
        return;
      }
      console.log('[openPhotoUpload] Opening for space:', spaceId, spaceName);
      currentUploadSpaceId = spaceId;
      currentUploadContext = context;
      selectedLibraryMedia.clear();
      selectedUploadFiles = [];
      isPhotoUploading = false;

      const submitBtn = document.getElementById('submitPhotoUpload');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Upload';
      }

      document.getElementById('uploadModalSpaceName').textContent = spaceName;
      document.getElementById('photoFile').value = '';
      document.getElementById('photoBulkCaption').value = '';
      document.getElementById('uploadPreviewGrid').innerHTML = '';
      document.getElementById('bulkTagSection')?.classList.add('hidden');
      document.getElementById('uploadProgress')?.classList.add('hidden');

      const categorySelect = document.getElementById('photoCategory');
      if (categorySelect) {
        categorySelect.value = context === 'projects' ? 'projects' : 'space';
      }

      renderUploadTags();
      updateModalStorageIndicator();
      activeLibraryFilters = { tags: [], category: '' };
      const libraryCategoryFilter = document.getElementById('libraryCategoryFilter');
      if (libraryCategoryFilter) libraryCategoryFilter.value = '';

      // Show modal immediately but with loading state for library
      const libraryGrid = document.getElementById('libraryMediaGrid');
      if (libraryGrid) {
        libraryGrid.innerHTML = '<div class="library-empty"><p>Loading media library...</p></div>';
      }

      renderLibraryTagFilter();
      renderRequestTab();
      switchMediaPickerTab(initialTab);
      document.getElementById('photoUploadModal').classList.remove('hidden');

      // Load library media in background (non-blocking) - don't let timeout block the modal
      loadLibraryMedia().then(() => {
        console.log('[openPhotoUpload] Library loaded with', libraryMedia?.length || 0, 'items');
      }).catch(err => {
        console.warn('[openPhotoUpload] Library load failed:', err.message);
        // Error state is already shown by loadLibraryMedia
      });
    }

    function updateModalStorageIndicator() {
      const indicator = document.getElementById('modalStorageIndicator');
      if (!indicator || !storageUsage) return;

      const percent = storageUsage.percent_used || 0;
      const used = mediaService.formatBytes(storageUsage.current_bytes || 0);
      const limit = mediaService.formatBytes(storageUsage.limit_bytes || 0);

      let colorClass = 'storage-ok';
      if (percent >= 90) colorClass = 'storage-critical';
      else if (percent >= 70) colorClass = 'storage-warning';

      indicator.innerHTML = `
        <div class="storage-bar ${colorClass}">
          <div class="storage-fill" style="width: ${Math.min(percent, 100)}%"></div>
        </div>
        <div class="storage-text">${used} / ${limit} (${percent.toFixed(1)}%)</div>
      `;
    }

    function switchMediaPickerTab(tabName) {
      document.querySelectorAll('#photoUploadModal .media-picker-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      document.getElementById('uploadTab')?.classList.toggle('active', tabName === 'upload');
      document.getElementById('libraryTab')?.classList.toggle('active', tabName === 'library');
      document.getElementById('requestTab')?.classList.toggle('active', tabName === 'request');
    }

    function getAutoTagsForContext(context) {
      switch (context) {
        case 'dwelling': return ['listing'];
        case 'event': return ['listing'];
        case 'projects': return ['in-progress'];
        case 'social': return ['social'];
        default: return ['listing'];
      }
    }

    function renderUploadTags() {
      const container = document.getElementById('uploadTagsContainer');
      if (!container) return;

      const autoTags = getAutoTagsForContext(currentUploadContext);

      const grouped = {};
      allTags.forEach(tag => {
        const group = tag.tag_group || 'other';
        if (!grouped[group]) grouped[group] = [];
        grouped[group].push(tag);
      });
      const sortedGroups = mediaService.sortTagGroups(grouped);

      container.innerHTML = Object.entries(sortedGroups).map(([group, tags]) => `
        <div class="tag-row">
          <div class="tag-group-label">${group}</div>
          <div class="tag-checkboxes">
            ${tags.map(tag => {
              const isAuto = autoTags.includes(tag.name);
              return `
                <label class="tag-checkbox" style="--tag-color: ${tag.color || '#666'}">
                  <input type="checkbox" value="${tag.name}" ${isAuto ? 'checked' : ''}>
                  <span class="tag-chip">${tag.name}</span>
                </label>
              `;
            }).join('')}
          </div>
        </div>
      `).join('');

      const autoTagHint = document.getElementById('autoTagHint');
      if (autoTagHint) {
        autoTagHint.textContent = autoTags.length ? `Auto-tagged: ${autoTags.join(', ')}` : '';
      }
    }

    function renderRequestTab() {
      const descriptionEl = document.getElementById('requestDescription');
      if (descriptionEl) descriptionEl.value = '';
      renderRequestTags();
      renderExistingRequests();
    }

    function renderRequestTags() {
      const container = document.getElementById('requestTagsContainer');
      if (!container) return;

      const autoTags = getAutoTagsForContext(currentUploadContext);
      const grouped = {};
      allTags.forEach(tag => {
        const group = tag.tag_group || 'other';
        if (!grouped[group]) grouped[group] = [];
        grouped[group].push(tag);
      });
      const sortedGroups = mediaService.sortTagGroups(grouped);

      container.innerHTML = Object.entries(sortedGroups).map(([group, tags]) => `
        <div class="tag-row">
          <div class="tag-group-label">${group}</div>
          <div class="tag-checkboxes">
            ${tags.map(tag => {
              const isAuto = autoTags.includes(tag.name);
              return `
                <label class="tag-checkbox" style="--tag-color: ${tag.color || '#666'}">
                  <input type="checkbox" value="${tag.name}" ${isAuto ? 'checked' : ''}>
                  <span class="tag-chip">${tag.name}</span>
                </label>
              `;
            }).join('')}
          </div>
        </div>
      `).join('');
    }

    function renderExistingRequests() {
      const section = document.getElementById('existingRequestsSection');
      const list = document.getElementById('existingRequestsList');
      if (!section || !list) return;

      const space = allSpaces.find(s => s.id === currentUploadSpaceId);
      const pendingRequests = space?.photoRequests?.filter(r => r.status === 'pending') || [];

      if (pendingRequests.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      list.innerHTML = pendingRequests.map(pr => `
        <div class="existing-request-item">
          <span class="request-status ${pr.status}">${pr.status}</span>
          <p>${pr.description}</p>
          <small>Requested ${formatDateAustin(pr.created_at, { month: 'short', day: 'numeric', year: 'numeric' })}</small>
        </div>
      `).join('');
    }

    async function loadLibraryMedia() {
      // Prevent concurrent calls
      if (isLibraryLoading) {
        console.log('[loadLibraryMedia] Already loading, skipping');
        return;
      }

      console.log('[loadLibraryMedia] Starting, filters:', activeLibraryFilters);
      const container = document.getElementById('libraryMediaGrid');
      isLibraryLoading = true;

      try {
        // Use minimal query (no joins) for much faster loading
        // The library picker only needs basic info to display thumbnails
        const result = await mediaService.search({
          category: activeLibraryFilters.category || null,
          tags: activeLibraryFilters.tags,
          limit: 100,
          minimal: true,  // Skip joins for faster loading
        });

        console.log('[loadLibraryMedia] Search returned', result?.length || 0, 'items');
        libraryMedia = result || [];
        renderLibraryGrid();
      } catch (error) {
        console.error('[loadLibraryMedia] Error loading library:', error);
        libraryMedia = [];
        // Show error state instead of empty state
        if (container) {
          container.innerHTML = `
            <div class="library-empty">
              <p>Failed to load media library. <a href="#" onclick="loadLibraryMedia(); return false;">Try again</a></p>
              <small style="color: #999;">${error.message || 'Unknown error'}</small>
            </div>
          `;
        }
      } finally {
        isLibraryLoading = false;
      }
    }

    function renderLibraryTagFilter() {
      const container = document.getElementById('libraryTagFilter');
      if (!container) return;

      const filterableTags = allTags
        .filter(t => t.tag_group === 'space')
        .sort((a, b) => (b.usage_count || 0) - (a.usage_count || 0));

      container.innerHTML = filterableTags.map(tag => `
        <button type="button"
          class="tag-filter-chip ${activeLibraryFilters.tags.includes(tag.name) ? 'active' : ''}"
          data-tag="${tag.name}"
          onclick="toggleLibraryTagFilter('${tag.name}')"
        >${tag.name}</button>
      `).join('');
    }

    window.toggleLibraryTagFilter = function(tagName) {
      const idx = activeLibraryFilters.tags.indexOf(tagName);
      if (idx >= 0) {
        activeLibraryFilters.tags.splice(idx, 1);
      } else {
        activeLibraryFilters.tags.push(tagName);
      }
      renderLibraryTagFilter();
      loadLibraryMedia();
    };

    function renderLibraryGrid() {
      console.log('[renderLibraryGrid] Called with', libraryMedia?.length || 0, 'items');
      const container = document.getElementById('libraryMediaGrid');
      if (!container) {
        console.warn('[renderLibraryGrid] Container not found!');
        return;
      }

      if (!libraryMedia || libraryMedia.length === 0) {
        console.log('[renderLibraryGrid] Showing empty state');
        container.innerHTML = `
          <div class="library-empty">
            <p>No media found${activeLibraryFilters.tags.length ? ' matching filters' : ''}.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = libraryMedia.map(media => {
        const isSelected = selectedLibraryMedia.has(media.id);
        const tagsHtml = media.tags?.slice(0, 3).map(t => `<span class="tag-chip">${t.name}</span>`).join('') || '';

        return `
          <div class="library-media-item ${isSelected ? 'selected' : ''}"
               data-media-id="${media.id}"
               onclick="toggleLibraryMediaSelection('${media.id}')">
            <img src="${media.url}" alt="${media.caption || 'Media'}">
            ${tagsHtml ? `<div class="media-info">${tagsHtml}</div>` : ''}
          </div>
        `;
      }).join('');

      updateLibrarySelectButton();
    }

    window.toggleLibraryMediaSelection = function(mediaId) {
      if (selectedLibraryMedia.has(mediaId)) {
        selectedLibraryMedia.delete(mediaId);
      } else {
        selectedLibraryMedia.add(mediaId);
      }
      renderLibraryGrid();
    };

    function updateLibrarySelectButton() {
      const btn = document.getElementById('submitLibrarySelect');
      if (!btn) return;
      const count = selectedLibraryMedia.size;
      btn.disabled = count === 0;
      btn.textContent = `Add Selected (${count})`;
    }

    async function handleLibrarySelect() {
      if (selectedLibraryMedia.size === 0) return;

      const submitBtn = document.getElementById('submitLibrarySelect');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding...';

      try {
        const space = allSpaces.find(s => s.id === currentUploadSpaceId);
        let displayOrder = space?.photos?.length || 0;

        for (const mediaId of selectedLibraryMedia) {
          await mediaService.linkToSpace(mediaId, currentUploadSpaceId, displayOrder);
          displayOrder++;
        }

        showToast(`Added ${selectedLibraryMedia.size} media item(s) to space.`, 'success');
        document.getElementById('photoUploadModal').classList.add('hidden');
        loadSpacesData();

      } catch (error) {
        console.error('Error adding media from library:', error);
        showToast('Failed to add media: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        updateLibrarySelectButton();
      }
    }

    function handleFilePreview(e) {
      const files = Array.from(e.target.files);
      if (!files.length) {
        selectedUploadFiles = [];
        renderUploadPreviews();
        return;
      }

      selectedUploadFiles = files.map((file, idx) => ({
        file,
        id: `file-${Date.now()}-${idx}`,
        caption: '',
        preview: null
      }));

      selectedUploadFiles.forEach((item) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          item.preview = ev.target.result;
          renderUploadPreviews();
        };
        reader.readAsDataURL(item.file);
      });

      renderUploadPreviews();
    }

    function renderUploadPreviews() {
      const grid = document.getElementById('uploadPreviewGrid');
      const bulkSection = document.getElementById('bulkTagSection');
      const fileCountEl = document.getElementById('fileCount');
      const submitBtn = document.getElementById('submitPhotoUpload');

      if (!grid) return;

      const count = selectedUploadFiles.length;
      if (fileCountEl) fileCountEl.textContent = count;
      if (bulkSection) bulkSection.classList.toggle('hidden', count <= 1);
      if (submitBtn) submitBtn.textContent = count > 1 ? `Upload All (${count})` : 'Upload';

      if (count === 0) {
        grid.innerHTML = '';
        return;
      }

      grid.innerHTML = selectedUploadFiles.map((item, idx) => `
        <div class="upload-preview-item" data-file-id="${item.id}">
          ${item.preview
            ? `<img src="${item.preview}" alt="Preview ${idx + 1}">`
            : `<div style="display:flex;align-items:center;justify-content:center;height:100%;background:var(--bg);color:var(--text-muted);font-size:0.75rem;">Loading...</div>`
          }
          <span class="preview-index">${idx + 1}</span>
          <button type="button" class="preview-remove" onclick="removeUploadFile('${item.id}')" title="Remove">×</button>
          <div class="preview-caption">
            <input type="text"
              placeholder="Caption..."
              value="${item.caption}"
              onchange="updateFileCaption('${item.id}', this.value)"
              onclick="event.stopPropagation()">
          </div>
        </div>
      `).join('');
    }

    window.removeUploadFile = function(fileId) {
      selectedUploadFiles = selectedUploadFiles.filter(f => f.id !== fileId);
      renderUploadPreviews();
      if (selectedUploadFiles.length === 0) {
        document.getElementById('photoFile').value = '';
      }
    };

    window.updateFileCaption = function(fileId, caption) {
      const item = selectedUploadFiles.find(f => f.id === fileId);
      if (item) item.caption = caption;
    };

    async function handlePhotoUpload() {
      if (isPhotoUploading) return;

      if (authState?.appUser?.role !== 'admin') {
        showToast('Only admins can upload photos', 'warning');
        return;
      }

      if (selectedUploadFiles.length === 0) {
        showToast('Please select at least one image.', 'warning');
        return;
      }

      isPhotoUploading = true;

      const bulkCaption = document.getElementById('photoBulkCaption')?.value.trim() || '';
      const category = document.getElementById('photoCategory')?.value || 'space';

      const selectedTags = [];
      document.querySelectorAll('#uploadTagsContainer input[type="checkbox"]:checked').forEach(cb => {
        selectedTags.push(cb.value);
      });

      const submitBtn = document.getElementById('submitPhotoUpload');
      const progressContainer = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('uploadProgressFill');
      const progressText = document.getElementById('uploadProgressText');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';

      if (selectedUploadFiles.length > 1 && progressContainer) {
        progressContainer.classList.remove('hidden');
      }

      let successCount = 0;
      let failCount = 0;
      const totalFiles = selectedUploadFiles.length;

      try {
        for (let i = 0; i < selectedUploadFiles.length; i++) {
          const item = selectedUploadFiles[i];

          if (progressFill) progressFill.style.width = `${((i) / totalFiles) * 100}%`;
          if (progressText) progressText.textContent = `Uploading ${i + 1} of ${totalFiles}...`;

          const caption = item.caption || bulkCaption;

          try {
            const result = await mediaService.upload(item.file, {
              category,
              caption,
              tags: selectedTags,
              spaceId: currentUploadSpaceId,
            });

            if (result.success) {
              successCount++;
            } else {
              failCount++;
            }
          } catch (err) {
            failCount++;
          }
        }

        if (progressFill) progressFill.style.width = '100%';
        if (progressText) progressText.textContent = 'Complete!';

        if (failCount === 0) {
          showToast(successCount === 1 ? 'Photo uploaded successfully!' : `${successCount} photos uploaded successfully!`, 'success');
        } else {
          showToast(`Uploaded ${successCount} of ${totalFiles} photos. ${failCount} failed.`, 'warning');
        }

        // Close modal and refresh immediately - don't wait for storage usage
        document.getElementById('photoUploadModal').classList.add('hidden');
        loadSpacesData();

        // Update storage usage in background (non-blocking)
        mediaService.getStorageUsage().then(usage => {
          if (usage) storageUsage = usage;
        }).catch(() => {});

      } catch (error) {
        console.error('Error during upload:', error);
        showToast('Upload failed: ' + error.message, 'error');
      } finally {
        isPhotoUploading = false;
        submitBtn.disabled = false;
        submitBtn.textContent = selectedUploadFiles.length > 1 ? `Upload All (${selectedUploadFiles.length})` : 'Upload';
        if (progressContainer) progressContainer.classList.add('hidden');
        selectedUploadFiles = [];
      }
    }

    async function handlePhotoRequestSubmit() {
      const description = document.getElementById('requestDescription')?.value.trim();
      if (!description) {
        showToast('Please describe the photo needed.', 'warning');
        return;
      }

      const suggestedTags = [];
      document.querySelectorAll('#requestTagsContainer input[type="checkbox"]:checked').forEach(cb => {
        suggestedTags.push(cb.value);
      });

      try {
        const { error } = await supabase
          .from('photo_requests')
          .insert({
            space_id: currentUploadSpaceId,
            description: description,
            status: 'pending',
            requested_by: authState.appUser?.id || 'admin',
            suggested_tags: suggestedTags.length > 0 ? suggestedTags : null
          });

        if (error) throw error;

        showToast('Photo request submitted!', 'success');
        document.getElementById('photoUploadModal').classList.add('hidden');
        loadSpacesData();

      } catch (error) {
        console.error('Error submitting photo request:', error);
        showToast('Failed to submit request. Check console for details.', 'error');
      }
    }

    // Desired departure functions
    window.updateDesiredDeparture = async function(assignmentId, dateValue) {
      try {
        const { error } = await supabase
          .from('assignments')
          .update({
            desired_departure_date: dateValue || null,
            desired_departure_listed: false
          })
          .eq('id', assignmentId)
          .select();

        if (error) throw error;

        showToast('Desired departure date updated', 'success');
        loadSpacesData();
      } catch (error) {
        console.error('Error updating desired departure:', error);
        showToast('Failed to update departure date', 'error');
      }
    };

    window.toggleDesiredDepartureListed = async function(assignmentId, listed) {
      try {
        const { error } = await supabase
          .from('assignments')
          .update({ desired_departure_listed: listed })
          .eq('id', assignmentId)
          .select();

        if (error) throw error;

        showToast(listed ? 'Early exit date listed for new renters' : 'Early exit date unlisted', 'success');
        loadSpacesData();
      } catch (error) {
        console.error('Error toggling listed status:', error);
        showToast('Failed to update listing status', 'error');
      }
    };

    // Global function exports
    window.showSpaceDetail = showSpaceDetail;
    window.openEditSpace = openEditSpace;
    window.openPhotoUpload = openPhotoUpload;
    window.openLightbox = openLightbox;
    window.openLightboxForSpace = openLightboxForSpace;
    window.removePhotoFromSpace = removePhotoFromSpace;

    // =============================================
    // MEDIA TAB
    // =============================================
    async function loadMediaLibrary() {
      mediaLoaded = true;
      await Promise.all([loadStorageUsage(), loadTags(), loadMedia()]);
    }

    async function loadStorageUsage() {
      const usage = await mediaService.getStorageUsage();
      if (!usage) return;

      const indicator = document.getElementById('storageIndicator');
      const percent = usage.percent_used;
      let statusClass = 'storage-ok';
      if (percent >= 90) statusClass = 'storage-critical';
      else if (percent >= 70) statusClass = 'storage-warning';

      indicator.className = `storage-indicator-inline ${statusClass}`;
      indicator.innerHTML = `
        <div class="storage-bar">
          <div class="storage-fill" style="width: ${Math.min(percent, 100)}%"></div>
        </div>
        <span class="storage-text">
          ${mediaService.formatBytes(usage.current_bytes)} / ${mediaService.formatBytes(usage.limit_bytes)}
          (${percent.toFixed(1)}%)
        </span>
      `;
    }

    async function loadTags() {
      allTags = await mediaService.getTags();
      renderTagFilters();
    }

    async function loadMedia() {
      const media = await mediaService.search({
        category: currentFilters.category || null,
        tags: currentFilters.tags,
        limit: 200,
      });
      allMedia = media;
      renderMediaGrid();
      updateMediaCount();
    }

    function renderTagFilters() {
      const container = document.getElementById('tagFilterChips');
      if (!container) return;

      // Group tags by tag_group
      const grouped = {};
      allTags.forEach(tag => {
        const group = tag.tag_group || 'other';
        if (!grouped[group]) grouped[group] = [];
        grouped[group].push(tag);
      });
      const sortedGroups = mediaService.sortTagGroups(grouped);

      container.innerHTML = Object.entries(sortedGroups).map(([group, tags]) => `
        <div class="tag-filter-group">
          <span class="tag-filter-group-label">${group}</span>
          <div class="tag-filter-group-chips">
            ${tags.map(tag => `
              <button type="button" class="tag-filter-chip ${currentFilters.tags.includes(tag.name) ? 'active' : ''}"
                data-tag="${tag.name}" style="${tag.color ? `--tag-color: ${tag.color}` : ''}">
                ${tag.name}
              </button>
            `).join('')}
          </div>
        </div>
      `).join('');

      container.querySelectorAll('.tag-filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const tagName = chip.dataset.tag;
          if (currentFilters.tags.includes(tagName)) {
            currentFilters.tags = currentFilters.tags.filter(t => t !== tagName);
            chip.classList.remove('active');
          } else {
            currentFilters.tags.push(tagName);
            chip.classList.add('active');
          }
          loadMedia();
        });
      });
    }

    function renderMediaGrid() {
      const grid = document.getElementById('mediaGrid');
      const emptyState = document.getElementById('emptyState');
      if (!grid) return;

      if (allMedia.length === 0) {
        grid.innerHTML = '';
        emptyState?.classList.remove('hidden');
        return;
      }

      emptyState?.classList.add('hidden');

      grid.innerHTML = allMedia.map(media => {
        const tags = media.tags || [];
        const spacesLinked = media.spaces?.length || 0;
        const isSelected = selectedMediaIds.has(media.id);

        return `
          <div class="media-grid-item ${isSelected ? 'selected' : ''}" data-id="${media.id}">
            <div class="select-checkbox" data-action="select">✓</div>
            <span class="category-badge">${media.category || 'mktg'}</span>
            ${spacesLinked > 0 ? `<span class="spaces-count">${spacesLinked} space${spacesLinked > 1 ? 's' : ''}</span>` : ''}
            <div class="media-thumb">
              <img src="${media.url}" alt="${media.caption || 'Media'}" loading="lazy">
            </div>
            <div class="media-info">
              <div class="media-caption ${!media.caption ? 'no-caption' : ''}">${media.caption || 'No caption'}</div>
              <div class="media-meta">
                <span>${media.file_size_bytes ? mediaService.formatBytes(media.file_size_bytes) : '-'}</span>
                <span>${formatDate(media.uploaded_at)}</span>
              </div>
              <div class="media-tags">
                ${tags.slice(0, 4).map(t => `<span class="media-tag" style="${t.color ? `border-left: 2px solid ${t.color}` : ''}">${t.name}</span>`).join('')}
                ${tags.length > 4 ? `<span class="media-tag">+${tags.length - 4}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');

      grid.querySelectorAll('.media-grid-item').forEach(item => {
        item.addEventListener('click', (e) => {
          const mediaId = item.dataset.id;
          if (e.target.closest('[data-action="select"]')) {
            toggleSelection(mediaId);
            return;
          }
          openMediaDetail(mediaId);
        });
      });
    }

    function updateMediaCount() {
      const el = document.getElementById('mediaCount');
      if (el) el.textContent = `${allMedia.length} items`;
    }

    function toggleSelection(mediaId) {
      if (selectedMediaIds.has(mediaId)) {
        selectedMediaIds.delete(mediaId);
      } else {
        selectedMediaIds.add(mediaId);
      }
      updateSelectionUI();
    }

    function selectAll() {
      allMedia.forEach(m => selectedMediaIds.add(m.id));
      updateSelectionUI();
    }

    function deselectAll() {
      selectedMediaIds.clear();
      updateSelectionUI();
    }

    function updateSelectionUI() {
      const count = selectedMediaIds.size;
      const countEl = document.getElementById('selectedCount');
      const bulkBtn = document.getElementById('bulkTagBtn');
      const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
      const selectAllBtn = document.getElementById('selectAllBtn');
      const deselectAllBtn = document.getElementById('deselectAllBtn');

      if (countEl) countEl.textContent = count;
      if (bulkBtn) bulkBtn.disabled = count === 0;
      if (bulkDeleteBtn) bulkDeleteBtn.disabled = count === 0;

      if (count > 0) {
        selectAllBtn?.classList.add('hidden');
        deselectAllBtn?.classList.remove('hidden');
      } else {
        selectAllBtn?.classList.remove('hidden');
        deselectAllBtn?.classList.add('hidden');
      }

      document.querySelectorAll('.media-grid-item').forEach(item => {
        item.classList.toggle('selected', selectedMediaIds.has(item.dataset.id));
      });
    }

    // =============================================
    // MEDIA DETAIL MODAL
    // =============================================
    async function openMediaDetail(mediaId) {
      const media = allMedia.find(m => m.id === mediaId);
      if (!media) return;

      currentMediaId = mediaId;

      document.getElementById('detailImage').src = media.url;
      document.getElementById('detailCaption').value = media.caption || '';
      document.getElementById('detailCategory').value = media.category || 'mktg';

      document.getElementById('detailSize').textContent = media.file_size_bytes ? mediaService.formatBytes(media.file_size_bytes) : 'Unknown';
      document.getElementById('detailDimensions').textContent = media.width && media.height ? `${media.width} × ${media.height}` : 'Unknown';
      document.getElementById('detailDate').textContent = formatDate(media.uploaded_at, true);

      const spacesLinked = media.spaces?.map(s => {
        const space = allSpaces.find(sp => sp.id === s.space_id);
        return space?.name || 'Unknown';
      }).join(', ') || 'None';
      document.getElementById('detailSpaces').textContent = spacesLinked;

      const groupedTags = await mediaService.getTagsGrouped();
      const mediaTags = media.tags?.map(t => t.name) || [];
      renderDetailTags(groupedTags, mediaTags);

      document.getElementById('mediaDetailModal').classList.remove('hidden');
    }

    function renderDetailTags(groupedTags, selectedTags) {
      const container = document.getElementById('detailTagsContainer');
      if (!container) return;

      const groupNames = Object.keys(groupedTags).sort();
      container.innerHTML = `
        ${groupNames.filter(g => groupedTags[g]?.length > 0).map(group => `
          <div class="tag-group">
            <span class="tag-group-label">${group}</span>
            <div class="tag-checkboxes">
              ${groupedTags[group].map(tag => `
                <label class="tag-checkbox">
                  <input type="checkbox" name="detailTag" value="${tag.name}" ${selectedTags.includes(tag.name) ? 'checked' : ''}>
                  <span class="tag-chip" style="--tag-color: ${tag.color || 'var(--accent)'}">${tag.name}</span>
                </label>
              `).join('')}
            </div>
          </div>
        `).join('')}
      `;
    }

    async function saveMediaDetail() {
      if (!currentMediaId) return;

      const caption = document.getElementById('detailCaption').value.trim();
      const category = document.getElementById('detailCategory').value;
      const selectedTags = Array.from(document.querySelectorAll('#detailTagsContainer input[name="detailTag"]:checked')).map(cb => cb.value);

      const { error } = await supabase.from('media').update({ caption, category }).eq('id', currentMediaId);
      if (error) {
        showToast('Failed to save: ' + error.message, 'error');
        return;
      }

      await supabase.from('media_tag_assignments').delete().eq('media_id', currentMediaId);
      if (selectedTags.length > 0) {
        await mediaService.assignTags(currentMediaId, selectedTags);
      }

      closeMediaDetail();
      await loadMedia();
    }

    function closeMediaDetail() {
      document.getElementById('mediaDetailModal').classList.add('hidden');
      currentMediaId = null;
    }

    async function deleteCurrentMedia() {
      if (!currentMediaId) return;

      const media = allMedia.find(m => m.id === currentMediaId);
      const spacesCount = media?.spaces?.length || 0;

      let confirmMsg = 'Are you sure you want to permanently delete this image?';
      if (spacesCount > 0) {
        confirmMsg = `This image is linked to ${spacesCount} space(s). Deleting it will remove it from all spaces.\n\nAre you sure you want to permanently delete it?`;
      }

      if (!confirm(confirmMsg)) return;

      const result = await mediaService.delete(currentMediaId);
      if (!result.success) {
        showToast('Failed to delete: ' + result.error, 'error');
        return;
      }

      closeMediaDetail();
      await loadMedia();
      await loadStorageUsage();
    }

    // =============================================
    // BULK TAG MODAL
    // =============================================
    async function openBulkTagModal() {
      if (selectedMediaIds.size === 0) return;

      document.getElementById('bulkCount').textContent = selectedMediaIds.size;
      const groupedTags = await mediaService.getTagsGrouped();
      renderBulkTags('bulkAddTags', groupedTags);
      renderBulkTags('bulkRemoveTags', groupedTags);
      document.getElementById('bulkTagModal').classList.remove('hidden');
    }

    function renderBulkTags(containerId, groupedTags) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const groupNames = Object.keys(groupedTags).sort();
      container.innerHTML = groupNames.filter(g => groupedTags[g]?.length > 0).map(group => `
        <div class="tag-group">
          <span class="tag-group-label">${group}</span>
          <div class="tag-checkboxes">
            ${groupedTags[group].map(tag => `
              <label class="tag-checkbox">
                <input type="checkbox" name="${containerId}Tag" value="${tag.name}">
                <span class="tag-chip" style="--tag-color: ${tag.color || 'var(--accent)'}">${tag.name}</span>
              </label>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    async function applyBulkTags() {
      const tagsToAdd = Array.from(document.querySelectorAll('#bulkAddTags input[name="bulkAddTagsTag"]:checked')).map(cb => cb.value);
      const tagsToRemove = Array.from(document.querySelectorAll('#bulkRemoveTags input[name="bulkRemoveTagsTag"]:checked')).map(cb => cb.value);

      if (tagsToAdd.length === 0 && tagsToRemove.length === 0) {
        showToast('Please select at least one tag to add or remove', 'warning');
        return;
      }

      const { data: tagRecords } = await supabase.from('media_tags').select('id, name').in('name', tagsToRemove);
      const tagIdMap = new Map(tagRecords?.map(t => [t.name, t.id]) || []);

      for (const mediaId of selectedMediaIds) {
        if (tagsToAdd.length > 0) await mediaService.assignTags(mediaId, tagsToAdd);
        for (const tagName of tagsToRemove) {
          const tagId = tagIdMap.get(tagName);
          if (tagId) await mediaService.removeTag(mediaId, tagId);
        }
      }

      closeBulkTagModal();
      deselectAll();
      await loadMedia();
    }

    function closeBulkTagModal() {
      document.getElementById('bulkTagModal').classList.add('hidden');
    }

    // =============================================
    // BULK DELETE
    // =============================================
    async function bulkDeleteSelected() {
      const count = selectedMediaIds.size;
      if (count === 0) return;

      const linkedMedia = allMedia.filter(m => selectedMediaIds.has(m.id) && m.spaces?.length > 0);
      let confirmMsg = `Are you sure you want to permanently delete ${count} image${count > 1 ? 's' : ''}?`;

      if (linkedMedia.length > 0) {
        confirmMsg = `${linkedMedia.length} of these images are linked to spaces. Deleting them will remove them from those spaces.\n\n${confirmMsg}`;
      }

      if (!confirm(confirmMsg)) return;

      const btn = document.getElementById('bulkDeleteBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Deleting...';

      let successCount = 0;
      let failCount = 0;
      const idsToDelete = Array.from(selectedMediaIds);

      for (const mediaId of idsToDelete) {
        const result = await mediaService.delete(mediaId);
        if (result.success) {
          successCount++;
        } else {
          console.error(`Failed to delete ${mediaId}:`, result.error);
          failCount++;
        }
      }

      if (failCount === 0) {
        showToast(`${successCount} image${successCount > 1 ? 's' : ''} deleted`, 'success');
      } else {
        showToast(`Deleted ${successCount}, failed ${failCount}`, failCount > 0 ? 'warning' : 'success');
      }

      deselectAll();
      await Promise.all([loadStorageUsage(), loadMedia()]);

      btn.disabled = false;
      btn.textContent = originalText;
    }

    // =============================================
    // MEDIA UPLOAD FUNCTIONALITY
    // =============================================
    function renderMediaUploadTags() {
      const container = document.getElementById('mediaUploadTagsContainer');
      if (!container) return;

      const grouped = {};
      allTags.forEach(tag => {
        const group = tag.tag_group || 'other';
        if (!grouped[group]) grouped[group] = [];
        grouped[group].push(tag);
      });
      const sortedGroups = mediaService.sortTagGroups(grouped);

      container.innerHTML = `
        <div class="inline-add-tag">
          <input type="text" data-quick-input placeholder="Add new tag..." class="quick-tag-input">
          <select data-quick-group class="quick-tag-select">
            <option value="">Category</option>
            ${[...new Set(allTags.map(t => t.tag_group).filter(Boolean))].sort().map(g =>
              `<option value="${g}" ${g === 'space' ? 'selected' : ''}>${g}</option>`
            ).join('')}
            <option value="__new__">+ New...</option>
          </select>
          <input type="text" data-quick-custom placeholder="New category" class="quick-tag-input hidden">
        </div>
        ${Object.entries(sortedGroups).map(([group, tags]) => `
          <div class="tag-row">
            <div class="tag-group-label">${group}</div>
            <div class="tag-checkboxes">
              ${tags.map(tag => `
                <label class="tag-checkbox" style="--tag-color: ${tag.color || '#666'}">
                  <input type="checkbox" value="${tag.name}">
                  <span class="tag-chip">${tag.name}</span>
                </label>
              `).join('')}
            </div>
          </div>
        `).join('')}
      `;

      setupMediaUploadQuickAddTag();
    }

    function setupMediaUploadQuickAddTag() {
      const container = document.getElementById('mediaUploadTagsContainer');
      if (!container) return;

      const input = container.querySelector('[data-quick-input]');
      const groupSelect = container.querySelector('[data-quick-group]');
      const customGroupInput = container.querySelector('[data-quick-custom]');

      if (!input) return;

      groupSelect?.addEventListener('change', (e) => {
        if (e.target.value === '__new__') {
          customGroupInput?.classList.remove('hidden');
          customGroupInput?.focus();
        } else {
          customGroupInput?.classList.add('hidden');
        }
      });

      input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          await mediaUploadQuickCreateTag();
        }
      });
    }

    async function mediaUploadQuickCreateTag() {
      const container = document.getElementById('mediaUploadTagsContainer');
      if (!container) return;

      const input = container.querySelector('[data-quick-input]');
      const groupSelect = container.querySelector('[data-quick-group]');
      const customGroupInput = container.querySelector('[data-quick-custom]');

      const name = input?.value.trim();
      if (!name) return;

      let group = groupSelect?.value;
      if (group === '__new__') {
        group = customGroupInput?.value.trim().toLowerCase();
      }
      if (group === '') group = null;

      try {
        const result = await mediaService.createTag(name, group);

        if (!result.success) {
          if (result.duplicate) {
            showToast('Tag already exists', 'warning');
          } else {
            showToast('Failed to create tag: ' + result.error, 'error');
          }
          return;
        }

        allTags.push(result.tag);
        renderMediaUploadTags();
        renderTagFilters();

        const newCheckbox = container.querySelector(`input[value="${result.tag.name}"]`);
        if (newCheckbox) newCheckbox.checked = true;

        showToast('Tag created', 'success');

      } catch (error) {
        console.error('Error creating tag:', error);
        showToast('Failed to create tag', 'error');
      }
    }

    function handleMediaFileSelect(e) {
      const files = Array.from(e.target.files);
      if (!files.length) return;

      const filesToAdd = files.slice(0, 10);
      if (files.length > 10) {
        showToast('Limited to 10 files at once. First 10 selected.', 'warning');
      }

      mediaUploadFiles = filesToAdd.map((file, idx) => ({
        file,
        id: `file-${Date.now()}-${idx}`,
        caption: '',
        preview: null
      }));

      mediaUploadFiles.forEach((item) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          item.preview = e.target.result;
          renderMediaUploadPreviews();
        };
        reader.readAsDataURL(item.file);
      });

      showMediaUploadPreview();
      renderMediaUploadTags();
    }

    function handleMediaDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('mediaUploadArea').classList.add('drag-over');
    }

    function handleMediaDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('mediaUploadArea').classList.remove('drag-over');
    }

    function handleMediaDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('mediaUploadArea').classList.remove('drag-over');

      const files = Array.from(e.dataTransfer.files).filter(f =>
        ['image/jpeg', 'image/png', 'image/webp', 'image/gif'].includes(f.type)
      );

      if (!files.length) {
        showToast('Please drop image files (JPEG, PNG, WebP, GIF)', 'warning');
        return;
      }

      const filesToAdd = files.slice(0, 10);
      if (files.length > 10) {
        showToast('Limited to 10 files at once. First 10 selected.', 'warning');
      }

      mediaUploadFiles = filesToAdd.map((file, idx) => ({
        file,
        id: `file-${Date.now()}-${idx}`,
        caption: '',
        preview: null
      }));

      mediaUploadFiles.forEach((item) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          item.preview = e.target.result;
          renderMediaUploadPreviews();
        };
        reader.readAsDataURL(item.file);
      });

      showMediaUploadPreview();
      renderMediaUploadTags();
    }

    function showMediaUploadPreview() {
      document.getElementById('mediaUploadArea').classList.add('hidden');
      document.getElementById('mediaUploadPreview').classList.remove('hidden');
      renderMediaUploadPreviews();
    }

    function hideMediaUploadPreview() {
      document.getElementById('mediaUploadArea').classList.remove('hidden');
      document.getElementById('mediaUploadPreview').classList.add('hidden');
      mediaUploadFiles = [];
      document.getElementById('mediaFileInput').value = '';
      document.getElementById('mediaUploadCaption').value = '';
      document.getElementById('mediaUploadCategory').value = 'space';
      document.querySelectorAll('#mediaUploadTagsContainer input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
      });
    }

    function renderMediaUploadPreviews() {
      const grid = document.getElementById('mediaUploadPreviewGrid');
      const fileCountEl = document.getElementById('mediaUploadFileCount');
      const submitBtn = document.getElementById('mediaSubmitUploadBtn');

      if (!grid) return;

      const count = mediaUploadFiles.length;
      if (fileCountEl) fileCountEl.textContent = count;
      if (submitBtn) submitBtn.textContent = count > 1 ? `Upload All (${count})` : 'Upload';

      if (count === 0) {
        hideMediaUploadPreview();
        return;
      }

      grid.innerHTML = mediaUploadFiles.map((item, idx) => `
        <div class="upload-preview-item" data-file-id="${item.id}">
          ${item.preview
            ? `<img src="${item.preview}" alt="Preview ${idx + 1}">`
            : `<div class="preview-loading">Loading...</div>`
          }
          <span class="preview-index">${idx + 1}</span>
          <button type="button" class="preview-remove" data-remove-id="${item.id}" title="Remove">&times;</button>
          <div class="preview-caption">
            <input type="text"
              placeholder="Caption..."
              value="${item.caption}"
              data-caption-id="${item.id}">
          </div>
        </div>
      `).join('');

      grid.querySelectorAll('.preview-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          removeMediaUploadFile(btn.dataset.removeId);
        });
      });

      grid.querySelectorAll('.preview-caption input').forEach(input => {
        input.addEventListener('change', (e) => {
          updateMediaFileCaption(input.dataset.captionId, e.target.value);
        });
        input.addEventListener('click', (e) => e.stopPropagation());
      });
    }

    function removeMediaUploadFile(fileId) {
      mediaUploadFiles = mediaUploadFiles.filter(f => f.id !== fileId);
      renderMediaUploadPreviews();
    }

    function updateMediaFileCaption(fileId, caption) {
      const item = mediaUploadFiles.find(f => f.id === fileId);
      if (item) item.caption = caption;
    }

    // Guard against concurrent uploads
    let isMediaUploading = false;

    async function handleMediaUpload() {
      console.log('handleMediaUpload called');

      // Guard against double-click or multiple submissions
      if (isMediaUploading) {
        console.log('Upload already in progress, ignoring');
        return;
      }

      if (!authState?.isAdmin && !authState?.isStaff) {
        showToast('You do not have permission to upload', 'warning');
        return;
      }

      if (mediaUploadFiles.length === 0) {
        showToast('Please select at least one image.', 'warning');
        return;
      }

      // Set guard before any async work
      isMediaUploading = true;

      const bulkCaption = document.getElementById('mediaUploadCaption')?.value.trim() || '';
      const category = document.getElementById('mediaUploadCategory')?.value || 'space';

      const selectedTags = [];
      document.querySelectorAll('#mediaUploadTagsContainer input[type="checkbox"]:checked').forEach(cb => {
        selectedTags.push(cb.value);
      });

      const submitBtn = document.getElementById('mediaSubmitUploadBtn');
      const progressContainer = document.getElementById('mediaUploadProgress');
      const progressFill = document.getElementById('mediaUploadProgressFill');
      const progressText = document.getElementById('mediaUploadProgressText');

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Uploading...';
      }

      if (mediaUploadFiles.length > 1 && progressContainer) {
        progressContainer.classList.remove('hidden');
      }

      let successCount = 0;
      let failCount = 0;
      const totalFiles = mediaUploadFiles.length;

      try {
        for (let i = 0; i < mediaUploadFiles.length; i++) {
          const item = mediaUploadFiles[i];

          if (progressFill) progressFill.style.width = `${((i) / totalFiles) * 100}%`;
          if (progressText) progressText.textContent = `Uploading ${i + 1} of ${totalFiles}...`;

          const caption = item.caption || bulkCaption;

          try {
            const result = await mediaService.upload(item.file, {
              category,
              caption,
              tags: selectedTags,
            });

            if (result.success) {
              successCount++;
            } else {
              console.error(`Failed to upload ${item.file.name}:`, result.error);
              failCount++;
            }
          } catch (err) {
            console.error(`Error uploading ${item.file.name}:`, err);
            failCount++;
          }
        }

        if (progressFill) progressFill.style.width = '100%';
        if (progressText) progressText.textContent = 'Complete!';

        if (failCount === 0) {
          if (successCount === 1) {
            showToast('Photo uploaded successfully!', 'success');
          } else {
            showToast(`${successCount} photos uploaded successfully!`, 'success');
          }
        } else {
          showToast(`Uploaded ${successCount} of ${totalFiles} photos. ${failCount} failed.`, 'warning');
        }

        await Promise.all([
          loadStorageUsage(),
          loadMedia(),
        ]);

        hideMediaUploadPreview();

      } catch (error) {
        console.error('Error during upload:', error);
        showToast('Upload failed: ' + error.message, 'error');
      } finally {
        // Reset guard
        isMediaUploading = false;
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = mediaUploadFiles.length > 1 ? `Upload All (${mediaUploadFiles.length})` : 'Upload';
        }
        if (progressContainer) progressContainer.classList.add('hidden');
      }
    }

    // =============================================
    // MEDIA EVENT LISTENERS
    // =============================================
    function setupMediaEventListeners() {
      // Upload area - file input and drag/drop
      const uploadArea = document.getElementById('mediaUploadArea');
      const fileInput = document.getElementById('mediaFileInput');
      const browseBtn = document.getElementById('mediaBrowseBtn');

      browseBtn?.addEventListener('click', () => fileInput?.click());
      fileInput?.addEventListener('change', handleMediaFileSelect);

      uploadArea?.addEventListener('dragover', handleMediaDragOver);
      uploadArea?.addEventListener('dragleave', handleMediaDragLeave);
      uploadArea?.addEventListener('drop', handleMediaDrop);

      // Upload controls
      document.getElementById('mediaClearUploadBtn')?.addEventListener('click', hideMediaUploadPreview);
      document.getElementById('mediaCancelUploadBtn')?.addEventListener('click', hideMediaUploadPreview);
      document.getElementById('mediaSubmitUploadBtn')?.addEventListener('click', handleMediaUpload);

      document.getElementById('categoryFilter')?.addEventListener('change', (e) => {
        currentFilters.category = e.target.value;
        loadMedia();
      });

      document.getElementById('clearFilters')?.addEventListener('click', () => {
        currentFilters = { category: '', tags: [] };
        document.getElementById('categoryFilter').value = '';
        document.querySelectorAll('.tag-filter-chip').forEach(c => c.classList.remove('active'));
        loadMedia();
      });

      document.getElementById('selectAllBtn')?.addEventListener('click', selectAll);
      document.getElementById('deselectAllBtn')?.addEventListener('click', deselectAll);
      document.getElementById('bulkTagBtn')?.addEventListener('click', openBulkTagModal);

      document.getElementById('closeMediaDetail')?.addEventListener('click', closeMediaDetail);
      document.getElementById('cancelMediaDetail')?.addEventListener('click', closeMediaDetail);
      document.getElementById('saveMediaDetail')?.addEventListener('click', saveMediaDetail);
      document.getElementById('deleteMediaBtn')?.addEventListener('click', deleteCurrentMedia);

      document.getElementById('closeBulkTag')?.addEventListener('click', closeBulkTagModal);
      document.getElementById('cancelBulkTag')?.addEventListener('click', closeBulkTagModal);
      document.getElementById('applyBulkTags')?.addEventListener('click', applyBulkTags);

      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.classList.add('hidden');
        });
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeMediaDetail();
          closeBulkTagModal();
        }
      });
    }

    // =============================================
    // UTILITIES
    // =============================================
    // formatDate now uses Austin timezone for all displays
    function formatDate(dateStr, full = false) {
      if (!dateStr) return '-';
      return formatDateTimeFull(dateStr, full);
    }

    // Note: openLightbox and closeLightbox are defined earlier in the Spaces tab section

    // =============================================
    // RENTALS TAB
    // =============================================

    async function loadRentals() {
      rentalsLoaded = true;
      await Promise.all([
        loadApplications(),
        loadPeople(),
        loadPaymentMethods(),
        loadCalendarData(),
        loadAirbnbRentals(),
      ]);
      populateRentalDropdowns();
      initCalendarControls();
      initAssignmentDetailModal();
      setupAirbnbSyncListeners();
    }

    async function loadApplications() {
      try {
        allApplications = await rentalService.getApplications();
        renderPipeline();
        renderDeniedDelayed();
      } catch (error) {
        console.error('Error loading applications:', error);
      }
    }

    async function loadPeople() {
      try {
        const { data, error } = await supabase
          .from('people')
          .select('id, first_name, last_name, email, type')
          .order('first_name');
        if (error) throw error;
        allPeople = data || [];
      } catch (error) {
        console.error('Error loading people:', error);
      }
    }

    async function loadPaymentMethods() {
      try {
        allPaymentMethods = await rentalService.getPaymentMethods(false);
        renderPaymentMethods();
      } catch (error) {
        console.error('Error loading payment methods:', error);
      }
    }

    function populateRentalDropdowns() {
      // Populate person dropdown
      const personSelect = document.getElementById('newAppPersonId');
      if (personSelect) {
        personSelect.innerHTML = '<option value="">Select a person...</option>' +
          allPeople.map(p => `<option value="${p.id}">${p.first_name || ''} ${p.last_name || ''} (${p.email || 'no email'})</option>`).join('');
      }

      // Populate space dropdown for new applications (no rate info - just space name)
      const spaceSelect = document.getElementById('newAppSpaceId');
      if (spaceSelect) {
        const dwellings = allSpaces.filter(s => s.can_be_dwelling);
        spaceSelect.innerHTML = '<option value="">Any / Flexible</option>' +
          dwellings.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
      }

      // Populate space dropdown for terms
      const termSpaceSelect = document.getElementById('termSpace');
      if (termSpaceSelect) {
        const dwellings = allSpaces.filter(s => s.can_be_dwelling);
        termSpaceSelect.innerHTML = '<option value="">Select space...</option>' +
          dwellings.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
      }
    }

    function renderPipeline() {
      const stages = ['applications', 'approved', 'contract', 'deposit', 'ready'];

      // Group applications by pipeline stage
      const grouped = {};
      stages.forEach(s => grouped[s] = []);

      allApplications.forEach(app => {
        const stage = rentalService.getPipelineStage(app);
        if (grouped[stage]) {
          grouped[stage].push(app);
        }
      });

      // Render each column
      stages.forEach(stage => {
        const container = document.getElementById(`${stage}Cards`);
        const countEl = document.getElementById(`${stage}Count`);
        const apps = grouped[stage] || [];

        if (countEl) countEl.textContent = apps.length;

        if (container) {
          if (apps.length === 0) {
            container.innerHTML = '<div class="pipeline-empty">No applications</div>';
          } else {
            container.innerHTML = apps.map(app => renderPipelineCard(app)).join('');

            // Add click handlers
            container.querySelectorAll('.pipeline-card').forEach(card => {
              card.addEventListener('click', () => openRentalDetail(card.dataset.id));
            });
          }
        }
      });
    }

    function renderPipelineCard(app) {
      const person = app.person || {};
      const space = app.approved_space || app.desired_space;
      const days = rentalService.daysSince(app.submitted_at);

      let subStatus = '';
      if (app.deposit_status && app.deposit_status !== 'pending') {
        subStatus = app.deposit_status;
      } else if (app.agreement_status && app.agreement_status !== 'pending') {
        subStatus = app.agreement_status;
      }

      const testBadge = app.is_test ? '<span class="test-badge">TEST</span>' : '';

      return `
        <div class="pipeline-card" data-id="${app.id}">
          <div class="card-header">
            <span class="applicant-name">${person.first_name || ''} ${person.last_name || ''}</span>
            ${testBadge}
            <span class="days-ago">${days}d</span>
          </div>
          <div class="card-body">
            <div class="space-name">${space?.name || 'Flexible'}</div>
            ${app.approved_rate ? `<div class="rate">$${app.approved_rate}/${app.approved_rate_term === 'weekly' ? 'wk' : app.approved_rate_term === 'nightly' ? 'night' : 'mo'}</div>` : ''}
          </div>
          ${subStatus ? `
            <div class="card-footer">
              <span class="sub-status">${subStatus}</span>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderDeniedDelayed() {
      const deniedDelayed = allApplications.filter(app =>
        app.application_status === 'denied' || app.application_status === 'delayed'
      );

      const container = document.getElementById('deniedDelayedList');
      const countEl = document.getElementById('deniedDelayedCount');

      if (countEl) countEl.textContent = deniedDelayed.length;

      if (container) {
        if (deniedDelayed.length === 0) {
          container.innerHTML = '<p class="text-muted">No denied or delayed applications.</p>';
        } else {
          container.innerHTML = deniedDelayed.map(app => {
            const person = app.person || {};
            return `
              <div class="space-item" style="cursor: pointer;" onclick="window.openRentalDetail('${app.id}')">
                <div class="space-item-info">
                  <div class="space-item-details">
                    <h3>${person.first_name || ''} ${person.last_name || ''}</h3>
                    <small>${app.application_status} - ${app.denial_reason || app.delay_reason || 'No reason given'}</small>
                  </div>
                </div>
                <div class="space-item-meta">
                  <span class="status-badge ${app.application_status}">${app.application_status}</span>
                </div>
              </div>
            `;
          }).join('');
        }
      }
    }

    function renderPaymentMethods() {
      const container = document.getElementById('paymentMethodsList');
      if (!container) return;

      if (allPaymentMethods.length === 0) {
        container.innerHTML = '<p class="text-muted">No payment methods configured.</p>';
        return;
      }

      container.innerHTML = allPaymentMethods.map(method => {
        const qrUrl = method.qr_code?.url;
        return `
          <div class="payment-method-card ${method.is_active ? '' : 'inactive'}" onclick="window.openPaymentMethodModal('${method.id}')">
            ${qrUrl
              ? `<div class="qr-code"><img src="${qrUrl}" alt="${method.name} QR"></div>`
              : `<div class="qr-placeholder">$</div>`
            }
            <div class="method-info">
              <div class="method-name">${method.name}</div>
              <div class="method-account">${method.account_identifier || '-'}</div>
              <div class="method-type">${method.method_type}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // =============================================
    // RESERVATIONS CALENDAR
    // =============================================

    async function loadCalendarData() {
      try {
        // Load spaces if not already loaded (needed for assignments table and calendar)
        if (allSpaces.length === 0) {
          const { data: spacesData } = await supabase
            .from('spaces')
            .select('id, name, can_be_dwelling, monthly_rate, is_archived')
            .eq('is_archived', false);
          if (spacesData) {
            allSpaces = spacesData;
          }
        }

        // Load assignments with people and spaces
        const { data, error } = await supabase
          .from('assignments')
          .select(`
            *,
            person:person_id(id, first_name, last_name, email, phone),
            assignment_spaces(space_id)
          `)
          .in('status', ['active', 'pending_contract', 'contract_sent'])
          .order('start_date');

        if (error) throw error;
        calendarAssignments = data || [];
        renderAssignmentsTable();
        renderCalendar();
      } catch (error) {
        console.error('Error loading calendar data:', error);
        const container = document.getElementById('reservationsCalendar');
        if (container) {
          container.innerHTML = '<div class="calendar-loading" style="color: var(--danger);">Error loading calendar data</div>';
        }
      }
    }

    function initCalendarControls() {
      document.getElementById('calendarToday')?.addEventListener('click', () => {
        calendarCurrentDate = getAustinToday();
        calendarMonthsDisplayed = 3;
        renderCalendar();
        // Scroll to start
        const container = document.getElementById('reservationsCalendar');
        if (container) container.scrollLeft = 0;
      });

      // Event delegation for reservation bar tooltips and load more button
      const calendarContainer = document.getElementById('reservationsCalendar');
      if (calendarContainer) {
        calendarContainer.addEventListener('mouseenter', (e) => {
          const bar = e.target.closest('.reservation-bar');
          if (bar) showReservationTooltip(e, bar);
        }, true);

        calendarContainer.addEventListener('mouseleave', (e) => {
          const bar = e.target.closest('.reservation-bar');
          if (bar) hideReservationTooltip();
        }, true);

        calendarContainer.addEventListener('click', (e) => {
          if (e.target.closest('#loadMoreMonths')) {
            loadMoreCalendarMonths();
          }
        });
      }
    }

    function loadMoreCalendarMonths() {
      // Check if there are any reservations extending beyond current view
      const lastDay = new Date(calendarCurrentDate.getFullYear(), calendarCurrentDate.getMonth() + calendarMonthsDisplayed, 0);

      const hasReservationsBeyond = calendarAssignments.some(a => {
        const endDate = a.desired_departure_listed && a.desired_departure_date
          ? parseAustinDate(a.desired_departure_date)
          : (a.end_date ? parseAustinDate(a.end_date) : null);
        // Ongoing reservations or ones ending after our view
        return !endDate || endDate > lastDay;
      });

      if (hasReservationsBeyond) {
        calendarMonthsDisplayed += 3;
        renderCalendar();
        // Scroll to the end to see the new months
        setTimeout(() => {
          const container = document.getElementById('reservationsCalendar');
          if (container) {
            container.scrollLeft = container.scrollWidth;
          }
        }, 50);
      } else {
        calendarHasMoreReservations = false;
        renderCalendar();
      }
    }

    function renderAssignmentsTable() {
      const container = document.getElementById('assignmentsTableContainer');
      const countEl = document.getElementById('assignmentsCount');
      if (!container) return;

      if (calendarAssignments.length === 0) {
        container.innerHTML = '<div class="calendar-empty">No active or upcoming assignments</div>';
        if (countEl) countEl.textContent = '0';
        return;
      }

      // Sort assignments: active first, then by start date
      const sorted = [...calendarAssignments].sort((a, b) => {
        // Active first
        if (a.status === 'active' && b.status !== 'active') return -1;
        if (b.status === 'active' && a.status !== 'active') return 1;
        // Then by start date
        const aStart = a.start_date ? parseAustinDate(a.start_date) : new Date(0);
        const bStart = b.start_date ? parseAustinDate(b.start_date) : new Date(0);
        return aStart - bStart;
      });

      if (countEl) countEl.textContent = sorted.length;

      // Build table HTML with scroll wrapper for mobile
      let html = `
        <div class="table-scroll-wrapper">
        <table class="data-table assignments-table">
          <thead>
            <tr>
              <th>Tenant</th>
              <th>Space</th>
              <th>Start</th>
              <th>End</th>
              <th>Rate</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
      `;

      sorted.forEach(assignment => {
        const person = assignment.person || {};
        const tenantName = `${person.first_name || ''} ${person.last_name || ''}`.trim() || 'Unknown';

        // Get space names
        const spaceIds = assignment.assignment_spaces?.map(as => as.space_id) || [];
        const spaceNames = spaceIds.map(id => {
          const space = allSpaces.find(s => s.id === id);
          return space ? space.name : 'Unknown';
        }).join(', ') || 'None';

        const startDate = assignment.start_date
          ? formatDateAustin(assignment.start_date, { month: 'short', day: 'numeric', year: 'numeric' })
          : '-';

        const effectiveEndDate = assignment.desired_departure_listed && assignment.desired_departure_date
          ? assignment.desired_departure_date
          : assignment.end_date;
        const endDate = effectiveEndDate
          ? formatDateAustin(effectiveEndDate, { month: 'short', day: 'numeric', year: 'numeric' })
          : 'Ongoing';

        const rate = assignment.rate_amount
          ? `$${assignment.rate_amount}/${assignment.rate_term || 'mo'}`
          : (assignment.monthly_rent ? `$${assignment.monthly_rent}/mo` : '-');

        const statusClass = assignment.status.replace(/_/g, '-');
        const statusLabel = assignment.status.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

        html += `
          <tr class="clickable-row" data-assignment-id="${assignment.id}">
            <td>
              <div class="tenant-cell">
                <strong>${tenantName}</strong>
                ${person.email ? `<div class="tenant-email">${person.email}</div>` : ''}
              </div>
            </td>
            <td>${spaceNames}</td>
            <td>${startDate}</td>
            <td>${endDate}</td>
            <td>${rate}</td>
            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;

      // Add click handlers for rows
      container.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', () => {
          const assignmentId = row.dataset.assignmentId;
          openAssignmentDetail(assignmentId);
        });
      });
    }

    async function openAssignmentDetail(assignmentId) {
      currentAssignmentId = assignmentId;
      const assignment = calendarAssignments.find(a => a.id === assignmentId);
      if (!assignment) return;

      const modal = document.getElementById('assignmentDetailModal');
      const person = assignment.person || {};

      // Set title
      const tenantName = `${person.first_name || ''} ${person.last_name || ''}`.trim() || 'Unknown';
      document.getElementById('assignmentDetailTitle').textContent = tenantName;

      // Status badge
      const statusBadge = document.getElementById('assignmentDetailStatus');
      const statusLabel = assignment.status.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      statusBadge.textContent = statusLabel;
      statusBadge.className = `status-badge ${assignment.status.replace(/_/g, '-')}`;

      // Tenant info (read-only)
      document.getElementById('assignmentTenantName').textContent = tenantName;
      document.getElementById('assignmentTenantEmail').textContent = person.email || '-';
      document.getElementById('assignmentTenantPhone').textContent = person.phone || '-';

      // Populate space dropdown
      const spaceSelect = document.getElementById('assignmentSpace');
      spaceSelect.innerHTML = '<option value="">Select a space...</option>' +
        allSpaces.filter(s => !s.is_archived).map(s =>
          `<option value="${s.id}">${s.name}</option>`
        ).join('');

      // Set current space (first one if multiple)
      const currentSpaceId = assignment.assignment_spaces?.[0]?.space_id || '';
      spaceSelect.value = currentSpaceId;

      // Set status
      document.getElementById('assignmentStatus').value = assignment.status || 'active';

      // Dates
      document.getElementById('assignmentStartDate').value = assignment.start_date || '';
      document.getElementById('assignmentEndDate').value = assignment.end_date || '';

      // Financial
      document.getElementById('assignmentRateAmount').value = assignment.rate_amount || assignment.monthly_rent || '';
      document.getElementById('assignmentRateTerm').value = assignment.rate_term || 'monthly';
      document.getElementById('assignmentDepositAmount').value = assignment.deposit_amount || '';
      document.getElementById('assignmentNoticeDays').value = assignment.notice_days || '';
      document.getElementById('assignmentIsFree').checked = assignment.is_free || false;

      // Early departure
      document.getElementById('assignmentDesiredDeparture').value = assignment.desired_departure_date || '';
      document.getElementById('assignmentDepartureListed').checked = assignment.desired_departure_listed || false;

      // Notes
      document.getElementById('assignmentNotes').value = assignment.notes || '';

      // Show modal
      modal.classList.remove('hidden');
    }

    function closeAssignmentDetail() {
      document.getElementById('assignmentDetailModal').classList.add('hidden');
      currentAssignmentId = null;
    }

    async function saveAssignment() {
      if (!currentAssignmentId) return;

      const assignment = calendarAssignments.find(a => a.id === currentAssignmentId);
      if (!assignment) return;

      // Get form values
      const rateTermValue = document.getElementById('assignmentRateTerm').value;
      const rateAmount = parseFloat(document.getElementById('assignmentRateAmount').value);

      const updates = {
        status: document.getElementById('assignmentStatus').value,
        start_date: document.getElementById('assignmentStartDate').value || null,
        end_date: document.getElementById('assignmentEndDate').value || null,
        rate_amount: isNaN(rateAmount) ? null : rateAmount,
        deposit_amount: parseFloat(document.getElementById('assignmentDepositAmount').value) || null,
        notice_days: parseInt(document.getElementById('assignmentNoticeDays').value) || null,
        is_free: document.getElementById('assignmentIsFree').checked,
        desired_departure_date: document.getElementById('assignmentDesiredDeparture').value || null,
        desired_departure_listed: document.getElementById('assignmentDepartureListed').checked,
        notes: document.getElementById('assignmentNotes').value || null
      };

      // Only include rate_term if it has a valid value (not empty string)
      if (rateTermValue && ['hourly', 'daily', 'weekly', 'monthly', 'flat'].includes(rateTermValue)) {
        updates.rate_term = rateTermValue;
      }

      console.log('Saving assignment with updates:', updates);

      try {
        const { error } = await supabase
          .from('assignments')
          .update(updates)
          .eq('id', currentAssignmentId);

        if (error) {
          console.error('Supabase error:', error);
          throw error;
        }

        // Update space if changed
        const newSpaceId = document.getElementById('assignmentSpace').value;
        const currentSpaceId = assignment.assignment_spaces?.[0]?.space_id;

        if (newSpaceId && newSpaceId !== currentSpaceId) {
          // Delete old assignment_spaces
          await supabase
            .from('assignment_spaces')
            .delete()
            .eq('assignment_id', currentAssignmentId);

          // Insert new one
          await supabase
            .from('assignment_spaces')
            .insert({ assignment_id: currentAssignmentId, space_id: newSpaceId });
        }

        showToast('Assignment updated', 'success');
        closeAssignmentDetail();

        // Reload data
        await loadCalendarData();
      } catch (error) {
        console.error('Error saving assignment:', error);
        showToast('Failed to save assignment', 'error');
      }
    }

    function initAssignmentDetailModal() {
      document.getElementById('closeAssignmentDetail')?.addEventListener('click', closeAssignmentDetail);
      document.getElementById('closeAssignmentDetailBtn')?.addEventListener('click', closeAssignmentDetail);
      document.getElementById('saveAssignmentBtn')?.addEventListener('click', saveAssignment);

      // Close on backdrop click
      document.getElementById('assignmentDetailModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'assignmentDetailModal') {
          closeAssignmentDetail();
        }
      });
    }

    function renderCalendar() {
      const container = document.getElementById('reservationsCalendar');
      if (!container) return;

      // Get dwelling spaces only
      const dwellingSpaces = allSpaces.filter(s => s.can_be_dwelling && !s.is_archived);

      if (dwellingSpaces.length === 0) {
        container.innerHTML = '<div class="calendar-empty">No dwelling spaces configured</div>';
        return;
      }

      // Get date range for multiple months
      const year = calendarCurrentDate.getFullYear();
      const month = calendarCurrentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + calendarMonthsDisplayed, 0);

      // Update month range label
      const monthRangeLabel = document.getElementById('calendarMonthRange');
      if (monthRangeLabel) {
        const startMonth = formatDateAustin(firstDay, { month: 'short', year: 'numeric' });
        const endMonth = formatDateAustin(lastDay, { month: 'short', year: 'numeric' });
        monthRangeLabel.textContent = `${startMonth} - ${endMonth}`;
      }

      // Generate array of days for all months
      const days = [];
      for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
        days.push(new Date(d));
      }

      const today = getAustinToday();

      // Check if there are reservations extending beyond current view
      const hasReservationsBeyond = calendarAssignments.some(a => {
        const endDate = a.desired_departure_listed && a.desired_departure_date
          ? parseAustinDate(a.desired_departure_date)
          : (a.end_date ? parseAustinDate(a.end_date) : null);
        return !endDate || endDate > lastDay;
      });

      // Build HTML
      let html = '<div class="calendar-timeline-wrapper">';
      html += '<div class="calendar-timeline">';

      // Header row with days - add month separators
      html += '<div class="calendar-header">';
      html += '<div class="calendar-space-label">Space</div>';
      html += '<div class="calendar-days">';

      let currentMonthYear = '';
      days.forEach((day, idx) => {
        const isWeekend = day.getDay() === 0 || day.getDay() === 6;
        const isToday = isSameAustinDay(day, today);
        const monthYear = getAustinMonthYear(day);
        const isFirstOfMonth = day.getDate() === 1;
        const showMonthLabel = monthYear !== currentMonthYear;
        if (showMonthLabel) currentMonthYear = monthYear;

        html += `
          <div class="calendar-day ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''} ${isFirstOfMonth ? 'first-of-month' : ''}">
            ${showMonthLabel ? `<div class="month-label">${monthYear}</div>` : ''}
            <div class="day-num">${day.getDate()}</div>
            <div class="day-name">${getAustinWeekday(day, 'short').slice(0, 2)}</div>
          </div>
        `;
      });

      html += '</div></div>';

      // Rows for each space
      dwellingSpaces.forEach(space => {
        html += '<div class="calendar-row">';
        html += `
          <div class="calendar-space-name">
            <span>${space.name}</span>
            ${space.monthly_rate ? `<span class="space-rate">$${space.monthly_rate}/mo</span>` : ''}
          </div>
        `;
        html += '<div class="calendar-cells">';

        // Add cells for each day
        let prevMonthYear = '';
        days.forEach(day => {
          const isWeekend = day.getDay() === 0 || day.getDay() === 6;
          const isToday = isSameAustinDay(day, today);
          const isFirstOfMonth = day.getDate() === 1;
          html += `<div class="calendar-cell ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''} ${isFirstOfMonth ? 'first-of-month' : ''}" data-date="${day.toISOString().split('T')[0]}"></div>`;
        });

        // Add reservation bars for this space (inside calendar-cells)
        const spaceAssignments = calendarAssignments.filter(a =>
          a.assignment_spaces?.some(as => as.space_id === space.id)
        );

        spaceAssignments.forEach(assignment => {
          const startDate = assignment.start_date ? parseAustinDate(assignment.start_date) : null;
          const endDate = assignment.desired_departure_listed && assignment.desired_departure_date
            ? parseAustinDate(assignment.desired_departure_date)
            : (assignment.end_date ? parseAustinDate(assignment.end_date) : null);

          if (!startDate) return;

          // Clamp dates to visible range
          const visibleStart = new Date(Math.max(startDate.getTime(), firstDay.getTime()));
          const visibleEnd = endDate
            ? new Date(Math.min(endDate.getTime(), lastDay.getTime()))
            : lastDay;

          // Skip if entirely outside visible range
          if (startDate > lastDay || (endDate && endDate < firstDay)) return;

          // Calculate position using pixel width (30px per day)
          const dayWidthPx = 30;
          const startOffset = Math.max(0, (visibleStart - firstDay) / (24 * 60 * 60 * 1000));
          const endOffset = (visibleEnd - firstDay) / (24 * 60 * 60 * 1000) + 1;
          const widthPx = (endOffset - startOffset) * dayWidthPx;
          const leftPx = startOffset * dayWidthPx;

          const person = assignment.person || {};
          const isAirbnb = assignment.airbnb_uid != null;
          let tenantName = `${person.first_name || ''} ${person.last_name || ''}`.trim() || 'Unknown';

          // For Airbnb bookings, show "Airbnb Guest" and extract info from notes if available
          if (isAirbnb && tenantName === 'Airbnb Guest') {
            // Try to extract guest info from notes (e.g., "Imported from Airbnb: Reserved - John Smith")
            const notes = assignment.notes || '';
            const airbnbMatch = notes.match(/Imported from Airbnb: (.+)/);
            if (airbnbMatch && airbnbMatch[1] && airbnbMatch[1] !== 'Airbnb (Not available)') {
              tenantName = airbnbMatch[1];
            } else {
              tenantName = 'Airbnb Guest';
            }
          }

          const rate = assignment.rate_amount
            ? `$${assignment.rate_amount}/${assignment.rate_term || 'mo'}`
            : (assignment.monthly_rent ? `$${assignment.monthly_rent}/mo` : '');

          const tooltipData = JSON.stringify({
            tenant: tenantName,
            email: person.email || '-',
            phone: person.phone || '-',
            start: formatDateAustin(startDate, { month: 'short', day: 'numeric', year: 'numeric' }),
            end: endDate ? formatDateAustin(endDate, { month: 'short', day: 'numeric', year: 'numeric' }) : 'Ongoing',
            rate: rate || 'N/A',
            deposit: assignment.deposit_amount ? `$${assignment.deposit_amount}` : 'N/A',
            status: assignment.status
          }).replace(/"/g, '&quot;');

          html += `
            <div class="reservation-bar ${assignment.status}"
                 style="left: ${leftPx}px; width: ${Math.max(widthPx - 4, 20)}px;"
                 data-tooltip='${tooltipData}'>
              <div class="bar-content">
                <span class="tenant-name">${tenantName}</span>
                ${rate ? `<span class="bar-details">${rate}</span>` : ''}
              </div>
            </div>
          `;
        });

        html += '</div>'; // close calendar-cells
        html += '</div>'; // close calendar-row
      });

      html += '</div>'; // close calendar-timeline

      // Add load more button at the right edge (inside wrapper)
      if (hasReservationsBeyond) {
        html += `
          <div class="load-more-column">
            <button id="loadMoreMonths" class="load-more-btn" title="Load 3 more months">
              <span class="load-more-icon">+3</span>
              <span class="load-more-text">months</span>
            </button>
          </div>
        `;
      } else if (calendarMonthsDisplayed > 3) {
        html += `
          <div class="load-more-column no-more">
            <span class="no-more-message">No more reservations</span>
          </div>
        `;
      }

      html += '</div>'; // close calendar-timeline-wrapper

      // Add tooltip element
      html += '<div id="reservationTooltip" class="reservation-tooltip"></div>';

      container.innerHTML = html;
    }

    function showReservationTooltip(event, element) {
      const tooltip = document.getElementById('reservationTooltip');
      if (!tooltip) return;

      try {
        const data = JSON.parse(element.dataset.tooltip);
        tooltip.innerHTML = `
          <div class="tooltip-header">${data.tenant}</div>
          <div class="tooltip-row"><span class="tooltip-label">Email:</span><span class="tooltip-value">${data.email}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">Phone:</span><span class="tooltip-value">${data.phone}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">Dates:</span><span class="tooltip-value">${data.start} - ${data.end}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">Rate:</span><span class="tooltip-value">${data.rate}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">Deposit:</span><span class="tooltip-value">${data.deposit}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">Status:</span><span class="tooltip-value">${data.status}</span></div>
        `;

        const rect = element.getBoundingClientRect();
        tooltip.style.left = `${Math.min(rect.left, window.innerWidth - 300)}px`;
        tooltip.style.top = `${rect.bottom + 8}px`;
        tooltip.classList.add('visible');
      } catch (e) {
        console.error('Error parsing tooltip data:', e);
      }
    }

    function hideReservationTooltip() {
      const tooltip = document.getElementById('reservationTooltip');
      if (tooltip) tooltip.classList.remove('visible');
    }

    // =============================================
    // RENTAL DETAIL MODAL
    // =============================================

    async function openRentalDetail(applicationId) {
      currentApplicationId = applicationId;
      const app = allApplications.find(a => a.id === applicationId);
      if (!app) return;

      const person = app.person || {};
      const desiredSpace = app.desired_space;
      const approvedSpace = app.approved_space;

      // Update modal header
      document.getElementById('rentalDetailTitle').textContent =
        `${person.first_name || ''} ${person.last_name || ''}`;
      const statusBadge = document.getElementById('rentalDetailStatus');
      statusBadge.textContent = app.application_status;
      statusBadge.className = `status-badge ${app.application_status}`;

      // Show test badge if applicable
      const testBadge = document.getElementById('rentalDetailTestBadge');
      if (testBadge) {
        testBadge.style.display = app.is_test ? 'inline-block' : 'none';
      }

      // Applicant tab
      document.getElementById('applicantName').textContent =
        `${person.first_name || ''} ${person.last_name || ''}`.trim() || '-';
      document.getElementById('applicantEmail').textContent = person.email || '-';
      document.getElementById('applicantPhone').textContent = person.phone || '-';
      document.getElementById('applicantDesiredSpace').textContent = desiredSpace?.name || 'Flexible';
      document.getElementById('applicantDesiredMoveIn').textContent =
        app.desired_move_in ? rentalService.formatDate(app.desired_move_in) : '-';
      document.getElementById('applicantSubmittedAt').textContent =
        rentalService.formatDate(app.submitted_at);

      // Terms tab
      document.getElementById('termSpace').value = app.approved_space_id || app.desired_space_id || '';
      document.getElementById('termRate').value = app.approved_rate || approvedSpace?.monthly_rate || desiredSpace?.monthly_rate || '';
      document.getElementById('termRateTerm').value = app.approved_rate_term || 'monthly';
      document.getElementById('termMoveIn').value = app.approved_move_in || app.desired_move_in || '';
      document.getElementById('termLeaseEnd').value = app.approved_lease_end || '';
      document.getElementById('termNoticePeriod').value = app.notice_period || '30_days';
      document.getElementById('termSecurityDeposit').value = app.security_deposit_amount || 0;
      // Reservation deposit defaults to the approved rate if not set
      const defaultReservationDeposit = app.approved_rate || approvedSpace?.monthly_rate || desiredSpace?.monthly_rate || 0;
      document.getElementById('termReservationDeposit').value = app.reservation_deposit_amount ?? defaultReservationDeposit;
      document.getElementById('termAdditionalTerms').value = app.additional_terms || '';

      // Documents tab
      document.getElementById('agreementStatusDisplay').textContent =
        app.agreement_status || 'Pending';
      document.getElementById('agreementDocUrl').value = app.agreement_document_url || '';

      // Update documents tab state
      await updateDocumentsTabState(app);

      // Deposits tab - Application Fee Section
      const appFeeSection = document.getElementById('applicationFeeSection');
      const appFeePaid = app.application_fee_paid && app.application_fee_amount > 0;
      if (appFeePaid) {
        appFeeSection.classList.remove('hidden');
        document.getElementById('applicationFeeAmount').textContent =
          rentalService.formatCurrency(app.application_fee_amount);

        // Show code if used
        const codeSpan = document.getElementById('applicationFeeCode');
        if (app.application_fee_code) {
          codeSpan.classList.remove('hidden');
          document.getElementById('applicationFeeCodeValue').textContent = app.application_fee_code;
        } else {
          codeSpan.classList.add('hidden');
        }

        // Calculate first month due
        const moveInAmount = app.move_in_deposit_amount || app.approved_rate || 0;
        const firstMonthDue = Math.max(0, moveInAmount - app.application_fee_amount);
        document.getElementById('firstMonthDueAmount').textContent =
          rentalService.formatCurrency(firstMonthDue);
      } else {
        appFeeSection.classList.add('hidden');
      }

      // Move-in and Security Deposits
      document.getElementById('moveInDepositAmount').textContent =
        rentalService.formatCurrency(app.move_in_deposit_amount || app.approved_rate || 0);
      document.getElementById('moveInDepositStatus').textContent =
        app.move_in_deposit_paid ? 'Paid' : 'Pending';
      document.getElementById('moveInDepositStatus').className =
        `deposit-status ${app.move_in_deposit_paid ? 'paid' : ''}`;

      document.getElementById('securityDepositAmount').textContent =
        rentalService.formatCurrency(app.security_deposit_amount || 0);
      document.getElementById('securityDepositStatus').textContent =
        app.security_deposit_paid ? 'Paid' : (app.security_deposit_amount > 0 ? 'Pending' : 'N/A');
      document.getElementById('securityDepositStatus').className =
        `deposit-status ${app.security_deposit_paid ? 'paid' : ''}`;

      // Proration
      if (app.approved_move_in && app.approved_rate) {
        const proration = rentalService.calculateProration(app.approved_move_in, app.approved_rate);
        const application = rentalService.calculateDepositApplication(
          app.approved_move_in, app.approved_rate, app.security_deposit_amount || 0
        );

        document.getElementById('prorationDetails').innerHTML = `
          <p>Move-in: <strong>${rentalService.formatDate(app.approved_move_in)}</strong> (day ${proration.dayOfMonth} of ${proration.daysInMonth})</p>
          <p>Days remaining: <strong>${proration.daysRemaining}</strong></p>
          <p>First month (prorated): <strong class="highlight">${rentalService.formatCurrency(proration.proratedAmount)}</strong></p>
          <p>Move-in deposit: ${rentalService.formatCurrency(application.moveInDeposit)}</p>
          ${application.towardsSecurity > 0 ? `<p>Applied to security: ${rentalService.formatCurrency(application.towardsSecurity)}</p>` : ''}
          ${application.securityRemaining > 0 ? `<p>Additional security due: <strong class="highlight">${rentalService.formatCurrency(application.securityRemaining)}</strong></p>` : ''}
        `;
      } else {
        document.getElementById('prorationDetails').innerHTML = '<p class="text-muted">Set move-in date and rate to calculate proration.</p>';
      }

      // Rent tab
      document.getElementById('rentMonthlyAmount').textContent =
        rentalService.formatCurrency(app.approved_rate);

      // Update action buttons
      updateRentalActions(app);

      // Show modal
      document.getElementById('rentalDetailModal').classList.remove('hidden');

      // Set first tab as active
      switchDetailTab('applicant');
    }

    function switchDetailTab(tabName) {
      document.querySelectorAll('.detail-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.detailTab === tabName);
      });
      document.querySelectorAll('.detail-tab-content').forEach(c => {
        c.classList.toggle('active', c.id === tabName + 'Tab');
      });
    }

    function updateRentalActions(app) {
      const container = document.getElementById('rentalActions');
      if (!container) return;

      let buttons = [];
      const stage = rentalService.getPipelineStage(app);

      switch (stage) {
        case 'applications':
          if (app.application_status === 'submitted') {
            buttons.push('<button class="btn-primary" onclick="startReviewApplication()">Start Review</button>');
          }
          buttons.push('<button class="btn-secondary" onclick="denyApplication()">Deny</button>');
          break;

        case 'approved':
          buttons.push('<button class="btn-primary" onclick="generateAgreement()">Generate Rental Agreement</button>');
          buttons.push('<button class="btn-secondary" onclick="editTerms()">Edit Terms</button>');
          break;

        case 'contract':
          if (app.agreement_status === 'generated') {
            buttons.push('<button class="btn-primary" onclick="markAgreementSent()">Mark as Sent</button>');
          } else if (app.agreement_status === 'sent') {
            buttons.push('<button class="btn-primary" onclick="markAgreementSigned()">Mark as Signed</button>');
          }
          break;

        case 'deposit':
          if (app.deposit_status !== 'confirmed') {
            buttons.push('<button class="btn-primary" onclick="confirmDeposit()">Confirm Deposit</button>');
          }
          break;

        case 'ready':
          buttons.push('<button class="btn-primary" onclick="confirmMoveIn()">Confirm Move-in</button>');
          break;
      }

      // Add approve button if under review
      if (app.application_status === 'under_review') {
        buttons.unshift('<button class="btn-primary" onclick="approveApplication()">Approve</button>');
      }

      // Add test toggle and archive buttons (always available)
      const testLabel = app.is_test ? 'Remove Test Flag' : 'Mark as Test';
      buttons.push(`<button class="btn-secondary btn-small" onclick="toggleTestFlag()" style="margin-left: auto;">${testLabel}</button>`);
      buttons.push('<button class="btn-danger btn-small" onclick="archiveApplication()">Archive</button>');

      container.innerHTML = buttons.join('');
    }

    function closeRentalDetail() {
      document.getElementById('rentalDetailModal').classList.add('hidden');
      currentApplicationId = null;
    }

    // =============================================
    // RENTAL ACTIONS
    // =============================================

    window.openRentalDetail = openRentalDetail;

    window.archiveApplication = async function() {
      if (!currentApplicationId) return;
      if (!confirm('Archive this application? It will be hidden from the pipeline.')) return;
      try {
        await rentalService.archiveApplication(currentApplicationId);
        closeRentalDetail();
        await loadApplications();
        showToast('Application archived', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.toggleTestFlag = async function() {
      if (!currentApplicationId) return;
      try {
        const app = allApplications.find(a => a.id === currentApplicationId);
        const newTestValue = !app?.is_test;
        await rentalService.toggleTestFlag(currentApplicationId, newTestValue);
        await loadApplications();
        openRentalDetail(currentApplicationId);
        showToast(newTestValue ? 'Marked as test' : 'Unmarked as test', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.startReviewApplication = async function() {
      if (!currentApplicationId) return;
      try {
        await rentalService.startReview(currentApplicationId);
        await loadApplications();
        openRentalDetail(currentApplicationId);
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.approveApplication = async function() {
      if (!currentApplicationId) return;

      const spaceId = document.getElementById('termSpace').value;
      const rate = parseFloat(document.getElementById('termRate').value);
      const rateTerm = document.getElementById('termRateTerm').value;
      const moveInDate = document.getElementById('termMoveIn').value;
      const leaseEndDate = document.getElementById('termLeaseEnd').value || null;
      const noticePeriod = document.getElementById('termNoticePeriod').value;
      const securityDeposit = parseFloat(document.getElementById('termSecurityDeposit').value) || 0;
      const additionalTerms = document.getElementById('termAdditionalTerms').value.trim() || null;

      if (!spaceId || !rate || !moveInDate) {
        showToast('Please fill in Space, Rate, and Move-in Date on the Terms tab', 'warning');
        switchDetailTab('terms');
        return;
      }

      try {
        await rentalService.approveApplication(currentApplicationId, {
          spaceId,
          rate,
          rateTerm,
          moveInDate,
          leaseEndDate,
          noticePeriod,
          securityDepositAmount: securityDeposit,
          additionalTerms,
        });
        await loadApplications();

        // Send approval email
        const app = allApplications.find(a => a.id === currentApplicationId);
        if (app?.person?.email) {
          const space = allSpaces.find(s => s.id === spaceId);
          const emailResult = await emailService.sendApplicationApproved({
            person: app.person,
            space: { name: space?.name },
            approved_rate: rate,
            approved_move_in_date: moveInDate,
            approved_end_date: leaseEndDate,
          });
          if (emailResult.success) {
            showToast('Application approved & email sent', 'success');
          } else {
            showToast('Application approved (email failed to send)', 'warning');
          }
        } else {
          showToast('Application approved (no email on file)', 'success');
        }

        openRentalDetail(currentApplicationId);
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.denyApplication = async function() {
      if (!currentApplicationId) return;
      const app = allApplications.find(a => a.id === currentApplicationId);
      const reason = prompt('Reason for denial (optional):');
      try {
        await rentalService.denyApplication(currentApplicationId, reason);
        await loadApplications();

        // Send denial email
        if (app?.person?.email) {
          const emailResult = await emailService.sendApplicationDenied(app, reason);
          if (emailResult.success) {
            showToast('Application denied & email sent', 'success');
          } else {
            showToast('Application denied (email failed to send)', 'warning');
          }
        } else {
          showToast('Application denied (no email on file)', 'success');
        }

        closeRentalDetail();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.delayApplication = async function() {
      if (!currentApplicationId) return;
      const reason = prompt('Reason for delay (optional):');
      try {
        await rentalService.delayApplication(currentApplicationId, reason);
        await loadApplications();
        closeRentalDetail();
        showToast('Application delayed', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.generateAgreement = async function() {
      switchDetailTab('documents');
    };

    window.editTerms = function() {
      switchDetailTab('terms');
    };

    // Save terms without changing status
    window.saveTerms = async function() {
      if (!currentApplicationId) return;

      const statusEl = document.getElementById('termsSaveStatus');
      const saveBtn = document.getElementById('saveTermsBtn');

      try {
        statusEl.textContent = 'Saving...';
        statusEl.className = 'save-status saving';
        saveBtn.disabled = true;

        const terms = getTermsFormData();
        await rentalService.saveTerms(currentApplicationId, terms);

        statusEl.textContent = 'Saved';
        statusEl.className = 'save-status saved';

        // Clear the "Saved" message after 3 seconds
        setTimeout(() => {
          if (statusEl.textContent === 'Saved') {
            statusEl.textContent = '';
          }
        }, 3000);

      } catch (error) {
        statusEl.textContent = 'Error saving';
        statusEl.className = 'save-status error';
        console.error('Error saving terms:', error);
      } finally {
        saveBtn.disabled = false;
      }
    };

    // Helper to collect form data
    function getTermsFormData() {
      return {
        spaceId: document.getElementById('termSpace').value || null,
        rate: parseFloat(document.getElementById('termRate').value) || null,
        rateTerm: document.getElementById('termRateTerm').value || 'monthly',
        moveInDate: document.getElementById('termMoveIn').value || null,
        leaseEndDate: document.getElementById('termLeaseEnd').value || null,
        noticePeriod: document.getElementById('termNoticePeriod').value || '30_days',
        securityDepositAmount: parseFloat(document.getElementById('termSecurityDeposit').value) || 0,
        reservationDepositAmount: parseFloat(document.getElementById('termReservationDeposit').value) || 0,
        additionalTerms: document.getElementById('termAdditionalTerms').value.trim() || null,
      };
    }

    // Debounced auto-save for terms
    let termsAutoSaveTimeout = null;
    function scheduleTermsAutoSave() {
      if (!currentApplicationId) return;

      const statusEl = document.getElementById('termsSaveStatus');
      statusEl.textContent = 'Unsaved changes...';
      statusEl.className = 'save-status';

      clearTimeout(termsAutoSaveTimeout);
      termsAutoSaveTimeout = setTimeout(() => {
        saveTerms();
      }, 1500); // Auto-save after 1.5 seconds of inactivity
    }

    // Setup terms form event listeners for auto-save
    function setupTermsAutoSave() {
      const formFields = [
        'termSpace', 'termRate', 'termRateTerm', 'termMoveIn',
        'termLeaseEnd', 'termNoticePeriod', 'termSecurityDeposit', 'termReservationDeposit', 'termAdditionalTerms'
      ];

      formFields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
          el.addEventListener('change', scheduleTermsAutoSave);
          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
            el.addEventListener('input', scheduleTermsAutoSave);
          }
        }
      });

      // Save button click
      document.getElementById('saveTermsBtn')?.addEventListener('click', () => {
        clearTimeout(termsAutoSaveTimeout);
        saveTerms();
      });
    }

    // Initialize auto-save when DOM is ready
    setupTermsAutoSave();

    window.markAgreementSent = async function() {
      if (!currentApplicationId) return;
      try {
        await rentalService.updateAgreementStatus(currentApplicationId, 'sent');
        await loadApplications();
        openRentalDetail(currentApplicationId);
        showToast('Agreement marked as sent', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.markAgreementSigned = async function() {
      if (!currentApplicationId) return;
      try {
        await rentalService.updateAgreementStatus(currentApplicationId, 'signed');
        await loadApplications();

        // Send lease signed email
        const app = allApplications.find(a => a.id === currentApplicationId);
        if (app?.person?.email) {
          const emailResult = await emailService.sendLeaseSigned(app);
          if (emailResult.success) {
            showToast('Agreement marked as signed & email sent', 'success');
          } else {
            showToast('Agreement marked as signed (email failed to send)', 'warning');
          }
        } else {
          showToast('Agreement marked as signed', 'success');
        }

        openRentalDetail(currentApplicationId);
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.confirmDeposit = async function() {
      if (!currentApplicationId) return;
      try {
        await rentalService.confirmDeposit(currentApplicationId);
        await loadApplications();

        // Send deposits confirmed email
        const app = allApplications.find(a => a.id === currentApplicationId);
        if (app?.person?.email) {
          const emailResult = await emailService.sendDepositsConfirmed(app);
          if (emailResult.success) {
            showToast('Deposit confirmed & email sent', 'success');
          } else {
            showToast('Deposit confirmed (email failed to send)', 'warning');
          }
        } else {
          showToast('Deposit confirmed (no email on file)', 'success');
        }

        openRentalDetail(currentApplicationId);
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.confirmMoveIn = async function() {
      if (!currentApplicationId) return;
      if (!confirm('Confirm move-in? This will create an active assignment.')) return;
      const app = allApplications.find(a => a.id === currentApplicationId);
      try {
        await rentalService.confirmMoveIn(currentApplicationId);
        await loadApplications();

        // Send move-in confirmed email
        if (app?.person?.email) {
          const space = allSpaces.find(s => s.id === app.approved_space_id);
          const emailResult = await emailService.sendMoveInConfirmed({
            person: app.person,
            space: { name: space?.name },
            approved_move_in_date: app.approved_move_in_date,
            approved_rate: app.approved_rate,
          });
          if (emailResult.success) {
            showToast('Move-in confirmed & welcome email sent', 'success');
          } else {
            showToast('Move-in confirmed (email failed to send)', 'warning');
          }
        } else {
          showToast('Move-in confirmed! Assignment created.', 'success');
        }

        closeRentalDetail();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    // =============================================
    // CREATE APPLICATION
    // =============================================

    async function handleCreateApplication(e) {
      e.preventDefault();
      const personId = document.getElementById('newAppPersonId').value;
      const spaceId = document.getElementById('newAppSpaceId').value || null;

      if (!personId) {
        showToast('Please select a person', 'warning');
        return;
      }

      try {
        await rentalService.createApplication(personId, {
          desired_space_id: spaceId,
        });
        await loadApplications();
        document.getElementById('newAppPersonId').value = '';
        document.getElementById('newAppSpaceId').value = '';
        showToast('Application created', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    // =============================================
    // PAYMENT METHODS
    // =============================================

    window.openPaymentMethodModal = function(methodId = null) {
      const modal = document.getElementById('paymentMethodModal');
      const title = document.getElementById('paymentMethodModalTitle');
      const deleteBtn = document.getElementById('deletePaymentMethodBtn');

      if (methodId) {
        const method = allPaymentMethods.find(m => m.id === methodId);
        if (!method) return;

        title.textContent = 'Edit Payment Method';
        document.getElementById('paymentMethodId').value = method.id;
        document.getElementById('paymentMethodName').value = method.name || '';
        document.getElementById('paymentMethodType').value = method.method_type || 'venmo';
        document.getElementById('paymentMethodIdentifier').value = method.account_identifier || '';
        document.getElementById('paymentMethodInstructions').value = method.instructions || '';
        document.getElementById('paymentMethodActive').checked = method.is_active !== false;
        deleteBtn.style.display = 'block';
      } else {
        title.textContent = 'Add Payment Method';
        document.getElementById('paymentMethodForm').reset();
        document.getElementById('paymentMethodId').value = '';
        document.getElementById('paymentMethodActive').checked = true;
        deleteBtn.style.display = 'none';
      }

      modal.classList.remove('hidden');
    };

    async function savePaymentMethod() {
      const id = document.getElementById('paymentMethodId').value || null;
      const data = {
        id,
        name: document.getElementById('paymentMethodName').value.trim(),
        method_type: document.getElementById('paymentMethodType').value,
        account_identifier: document.getElementById('paymentMethodIdentifier').value.trim() || null,
        instructions: document.getElementById('paymentMethodInstructions').value.trim() || null,
        is_active: document.getElementById('paymentMethodActive').checked,
      };

      if (!data.name) {
        showToast('Name is required', 'warning');
        return;
      }

      try {
        await rentalService.savePaymentMethod(data);
        await loadPaymentMethods();
        closePaymentMethodModal();
        showToast('Payment method saved', 'success');
      } catch (error) {
        console.error('Error saving payment method:', error);
        showToast('Error: ' + error.message, 'error');
      }
    }

    async function deletePaymentMethod() {
      const id = document.getElementById('paymentMethodId').value;
      if (!id) return;
      if (!confirm('Delete this payment method?')) return;

      try {
        await rentalService.deletePaymentMethod(id);
        await loadPaymentMethods();
        closePaymentMethodModal();
        showToast('Payment method deleted', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    function closePaymentMethodModal() {
      document.getElementById('paymentMethodModal').classList.add('hidden');
    }

    // =============================================
    // DEPOSIT RECORDING
    // =============================================

    window.openRecordDepositModal = function(type) {
      const app = allApplications.find(a => a.id === currentApplicationId);
      if (!app) return;

      const amount = type === 'move_in' ? app.move_in_deposit_amount : app.security_deposit_amount;

      document.getElementById('depositType').value = type;
      document.getElementById('depositAmount').value = rentalService.formatCurrency(amount);
      document.getElementById('depositMethod').value = '';
      document.getElementById('depositTransactionId').value = '';
      document.getElementById('recordDepositTitle').textContent =
        type === 'move_in' ? 'Record Move-in Deposit' : 'Record Security Deposit';

      document.getElementById('recordDepositModal').classList.remove('hidden');
    };

    async function confirmRecordDeposit() {
      const type = document.getElementById('depositType').value;
      const method = document.getElementById('depositMethod').value;
      const transactionId = document.getElementById('depositTransactionId').value.trim() || null;

      if (!method) {
        showToast('Please select a payment method', 'warning');
        return;
      }

      try {
        if (type === 'move_in') {
          await rentalService.recordMoveInDeposit(currentApplicationId, { method, transactionId });
        } else {
          await rentalService.recordSecurityDeposit(currentApplicationId, { method, transactionId });
        }
        await loadApplications();
        closeRecordDepositModal();
        openRentalDetail(currentApplicationId);
        showToast('Deposit recorded', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    function closeRecordDepositModal() {
      document.getElementById('recordDepositModal').classList.add('hidden');
    }

    // =============================================
    // LEASE AGREEMENT GENERATION
    // =============================================

    let currentLeaseTemplate = null;
    let currentAgreementData = null;

    /**
     * Generate a display filename for lease documents
     * Format: "Alpaca Rental Agreement [Name] [Date].pdf"
     */
    function getLeaseDisplayFilename(app, isSigned = false) {
      const name = app.person
        ? `${app.person.first_name || ''} ${app.person.last_name || ''}`.trim()
        : 'Unknown';
      const cleanName = name.replace(/[^a-zA-Z0-9\s]/g, '').substring(0, 30);
      const dateField = isSigned ? app.agreement_signed_at : app.agreement_generated_at;
      // Use the date field if provided, otherwise use today in Austin timezone
      const dateStr = dateField
        ? formatDateAustin(dateField, { year: 'numeric', month: '2-digit', day: '2-digit' }).split('/').reverse().join('-')
        : getAustinTodayISO();
      const prefix = isSigned ? 'Alpaca Rental Agreement (Signed)' : 'Alpaca Rental Agreement';
      return `${prefix} ${cleanName} ${dateStr}.pdf`;
    }

    async function updateDocumentsTabState(app) {
      const generateSection = document.getElementById('generateSection');
      const pdfSection = document.getElementById('pdfSection');
      const signatureSection = document.getElementById('signatureSection');
      const noTemplateWarning = document.getElementById('noTemplateWarning');
      const leasePreview = document.getElementById('leasePreview');

      // Reset visibility
      generateSection.style.display = 'block';
      pdfSection.style.display = 'none';
      signatureSection.style.display = 'none';
      noTemplateWarning.style.display = 'none';
      leasePreview.innerHTML = '';

      // Load template and agreement data
      try {
        currentLeaseTemplate = await leaseTemplateService.getActiveTemplate();
        currentAgreementData = await rentalService.getAgreementData(app.id);

        if (!currentLeaseTemplate) {
          noTemplateWarning.style.display = 'block';
          return;
        }
      } catch (e) {
        console.error('Error loading template/data:', e);
        leasePreview.innerHTML = '<p class="text-muted">Unable to load agreement data</p>';
        return;
      }

      // Show appropriate section based on agreement status
      const status = app.agreement_status || 'pending';

      if (status === 'signed' && app.signed_pdf_url) {
        // Show signed document - also show the unsigned PDF for reference
        if (app.generated_pdf_url) {
          pdfSection.style.display = 'block';
          document.getElementById('pdfDownloadLink').href = app.generated_pdf_url;
          document.getElementById('pdfFilename').textContent = getLeaseDisplayFilename(app, false);
          if (app.agreement_generated_at) {
            document.getElementById('pdfGeneratedAt').textContent =
              `Generated ${formatDateAustin(app.agreement_generated_at, { month: 'short', day: 'numeric', year: 'numeric' })}`;
          }
        }
        signatureSection.style.display = 'block';
        document.getElementById('signatureStatusText').textContent = 'Agreement signed!';
        document.getElementById('signedPdfSection').style.display = 'block';
        document.getElementById('signedPdfLink').href = app.signed_pdf_url;
        document.getElementById('signedPdfFilename').textContent = getLeaseDisplayFilename(app, true);
      } else if (status === 'sent' && app.signwell_document_id) {
        // Show signature pending status with the unsigned PDF link
        generateSection.style.display = 'none';
        pdfSection.style.display = 'block';
        signatureSection.style.display = 'block';
        document.getElementById('signatureStatusText').textContent = 'Awaiting tenant signature...';
        if (app.generated_pdf_url) {
          document.getElementById('pdfDownloadLink').href = app.generated_pdf_url;
          document.getElementById('pdfFilename').textContent = getLeaseDisplayFilename(app, false);
          if (app.agreement_generated_at) {
            document.getElementById('pdfGeneratedAt').textContent =
              `Generated ${formatDateAustin(app.agreement_generated_at, { month: 'short', day: 'numeric', year: 'numeric' })}`;
          }
        }
      } else if ((status === 'generated' || app.generated_pdf_url) && app.generated_pdf_url) {
        // Show generated PDF alongside generate section (so user can regenerate with new terms)
        generateSection.style.display = 'block';
        pdfSection.style.display = 'block';
        document.getElementById('pdfDownloadLink').href = app.generated_pdf_url;
        document.getElementById('pdfFilename').textContent = getLeaseDisplayFilename(app, false);
        if (app.agreement_generated_at) {
          document.getElementById('pdfGeneratedAt').textContent =
            `Generated ${formatDateAustin(app.agreement_generated_at, { month: 'short', day: 'numeric', year: 'numeric' })}`;
        }
      }
      // Otherwise show generate section (default)
    }

    async function previewLease() {
      if (!currentApplicationId) return;
      const leasePreviewContainer = document.getElementById('leasePreviewContainer');
      const leasePreview = document.getElementById('leasePreview');

      try {
        // Always refresh template and data to get latest terms
        currentLeaseTemplate = await leaseTemplateService.getActiveTemplate();
        currentAgreementData = await rentalService.getAgreementData(currentApplicationId);

        if (!currentLeaseTemplate || !currentAgreementData) {
          showToast('No template or data available. Make sure Terms are filled in.', 'warning');
          return;
        }

        const parsedContent = leaseTemplateService.parseTemplate(
          currentLeaseTemplate.content,
          currentAgreementData
        );
        // Convert markdown to simple HTML for preview
        leasePreview.innerHTML = markdownToHtml(parsedContent);
        leasePreviewContainer.style.display = 'block';
        showToast('Preview loaded with current terms', 'success');
      } catch (e) {
        console.error('Error previewing lease:', e);
        showToast('Error generating preview: ' + e.message, 'error');
      }
    }

    function markdownToHtml(markdown) {
      // Simple markdown to HTML conversion for preview
      let html = markdown
        // Headers
        .replace(/^### (.*$)/gm, '<h4>$1</h4>')
        .replace(/^## (.*$)/gm, '<h3>$1</h3>')
        .replace(/^# (.*$)/gm, '<h2>$1</h2>')
        // Bold
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Horizontal rules
        .replace(/^---$/gm, '<hr>')
        // Line breaks
        .replace(/\n/g, '<br>');

      return html;
    }

    async function generateLeasePdf() {
      if (!currentApplicationId) return;
      const btn = document.getElementById('generatePdfBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Generating...';
      btn.disabled = true;

      try {
        // Always refresh template and data to get latest terms
        currentLeaseTemplate = await leaseTemplateService.getActiveTemplate();
        currentAgreementData = await rentalService.getAgreementData(currentApplicationId);

        if (!currentLeaseTemplate || !currentAgreementData) {
          showToast('No template or data available', 'warning');
          return;
        }

        // Parse template with application data
        const parsedContent = leaseTemplateService.parseTemplate(
          currentLeaseTemplate.content,
          currentAgreementData
        );

        // Generate and upload PDF with smart filename
        const { url, filename } = await pdfService.generateAndUploadLeasePdf(
          parsedContent,
          currentApplicationId,
          { tenantName: currentAgreementData.tenantName }
        );

        // Update application with PDF URL
        await rentalService.updateAgreementStatus(currentApplicationId, 'generated', url);

        // Reload applications and refresh UI
        await loadApplications();
        await openRentalDetail(currentApplicationId);

        showToast('Lease agreement PDF generated!', 'success');
      } catch (e) {
        console.error('Error generating PDF:', e);
        showToast('Error generating PDF: ' + e.message, 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }


    async function sendForSignature() {
      if (!currentApplicationId) return;

      const app = allApplications.find(a => a.id === currentApplicationId);
      if (!app) {
        showToast('Application not found', 'error');
        return;
      }

      if (!app.generated_pdf_url) {
        showToast('Please generate a lease agreement PDF first', 'warning');
        return;
      }

      if (!app.person?.email) {
        showToast('Applicant has no email address on file', 'error');
        return;
      }

      const btn = document.getElementById('sendForSignatureBtn');
      const originalText = btn.textContent;

      try {
        btn.textContent = 'Sending...';
        btn.disabled = true;

        // Send document to SignWell for signing
        const recipientName = `${app.person.first_name} ${app.person.last_name}`;
        const document = await signwellService.sendForSignature(
          currentApplicationId,
          app.generated_pdf_url,
          app.person.email,
          recipientName
        );

        // Also send a notification email via Resend
        const emailResult = await emailService.sendLeaseSent({ person: app.person });

        await loadApplications();
        openRentalDetail(currentApplicationId);

        if (emailResult.success) {
          showToast('Lease sent for signature & notification email sent', 'success');
        } else {
          showToast('Lease sent for signature (notification email failed)', 'warning');
        }
      } catch (error) {
        console.error('Error sending for signature:', error);
        showToast('Error: ' + error.message, 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // =============================================
    // EVENTS TAB
    // =============================================

    async function loadEvents() {
      eventsLoaded = true;
      try {
        // Load event requests
        allEventRequests = await eventService.getRequests();

        // Load people if not already loaded
        if (allPeople.length === 0) {
          const { data: people } = await supabase
            .from('people')
            .select('id, first_name, last_name, email, phone')
            .order('first_name');
          allPeople = people || [];
        }

        // Populate person dropdown
        const personSelect = document.getElementById('newEventPersonId');
        personSelect.innerHTML = '<option value="">Select a person...</option>' +
          allPeople.map(p => `<option value="${p.id}">${p.first_name} ${p.last_name}</option>`).join('');

        renderEventPipeline();
        initEventCalendarControls();
        renderEventCalendar();
      } catch (error) {
        console.error('Error loading events:', error);
        showToast('Error loading events', 'error');
      }
    }

    function renderEventPipeline() {
      // Group requests by pipeline stage
      const stages = {
        requests: [],
        approved: [],
        contract: [],
        deposit: [],
        ready: [],
        denied: [],
        delayed: [],
        complete: [],
      };

      allEventRequests.forEach(req => {
        const stage = eventService.getPipelineStage(req);
        if (stages[stage]) {
          stages[stage].push(req);
        }
      });

      // Render each column
      ['requests', 'approved', 'contract', 'deposit', 'ready'].forEach(stage => {
        const container = document.getElementById(`event${stage.charAt(0).toUpperCase() + stage.slice(1)}Cards`);
        const countEl = document.getElementById(`event${stage.charAt(0).toUpperCase() + stage.slice(1)}Count`);

        if (container) {
          container.innerHTML = stages[stage].length === 0
            ? '<div class="pipeline-empty">No requests</div>'
            : stages[stage].map(req => renderEventCard(req)).join('');
        }
        if (countEl) {
          countEl.textContent = stages[stage].length;
        }
      });

      // Render denied/delayed section
      const deniedDelayed = [...stages.denied, ...stages.delayed];
      const deniedDelayedList = document.getElementById('eventDeniedDelayedList');
      const deniedDelayedCount = document.getElementById('eventDeniedDelayedCount');

      if (deniedDelayedList) {
        deniedDelayedList.innerHTML = deniedDelayed.length === 0
          ? '<p class="text-muted">No denied or delayed requests</p>'
          : deniedDelayed.map(req => renderEventCard(req, true)).join('');
      }
      if (deniedDelayedCount) {
        deniedDelayedCount.textContent = deniedDelayed.length;
      }
    }

    function renderEventCard(req, isCompact = false) {
      const person = req.person;
      const clientName = person ? `${person.first_name || ''} ${person.last_name || ''}`.trim() : 'Unknown';

      const eventDate = req.event_date
        ? formatDateAustin(req.event_date, { month: 'short', day: 'numeric' })
        : '';

      const formatTime = (timeStr) => {
        if (!timeStr) return '';
        const [hours, minutes] = timeStr.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${ampm}`;
      };

      const timeDisplay = req.event_start_time ? formatTime(req.event_start_time) : '';

      const rentalFee = parseFloat(req.rental_fee) || eventService.DEFAULT_FEES.RENTAL_FEE;
      const feeDisplay = rentalFee === 0 ? 'Complementary' : `$${rentalFee}`;

      const testBadge = req.is_test ? '<span class="test-badge">TEST</span>' : '';

      return `
        <div class="pipeline-card event-card" data-id="${req.id}" onclick="openEventDetail('${req.id}')">
          <div class="card-header">
            <div>
              <div class="event-name">${req.event_name || 'Unnamed Event'}</div>
              <div class="event-date">${eventDate} ${timeDisplay}</div>
            </div>
            ${testBadge}
          </div>
          <div class="card-body">
            <div class="client-name">${clientName}</div>
            ${req.organization_name ? `<div class="text-muted" style="font-size: 0.75rem;">${req.organization_name}</div>` : ''}
          </div>
          <div class="card-footer">
            <span class="guest-count">${req.expected_guests || '?'} guests</span>
            <span class="fee-display">${feeDisplay}</span>
          </div>
        </div>
      `;
    }


    // =============================================
    // EVENTS CALENDAR
    // =============================================

    function initEventCalendarControls() {
      document.getElementById('eventCalendarPrevMonth')?.addEventListener('click', () => {
        eventCalendarCurrentDate.setMonth(eventCalendarCurrentDate.getMonth() - 1);
        renderEventCalendar();
      });

      document.getElementById('eventCalendarNextMonth')?.addEventListener('click', () => {
        eventCalendarCurrentDate.setMonth(eventCalendarCurrentDate.getMonth() + 1);
        renderEventCalendar();
      });

      document.getElementById('eventCalendarToday')?.addEventListener('click', () => {
        eventCalendarCurrentDate = getAustinToday();
        renderEventCalendar();
      });

      // Event delegation for event chip tooltips and clicks
      const calendarContainer = document.getElementById('eventsCalendar');
      if (calendarContainer) {
        calendarContainer.addEventListener('mouseenter', (e) => {
          const chip = e.target.closest('.event-chip');
          if (chip) showEventCalendarTooltip(e, chip);
        }, true);

        calendarContainer.addEventListener('mouseleave', (e) => {
          const chip = e.target.closest('.event-chip');
          if (chip) hideEventCalendarTooltip();
        }, true);

        calendarContainer.addEventListener('click', (e) => {
          const chip = e.target.closest('.event-chip');
          if (chip && chip.dataset.id) {
            openEventDetail(chip.dataset.id);
          }
        });
      }
    }

    function renderEventCalendar() {
      const container = document.getElementById('eventsCalendar');
      if (!container) return;

      // Get date range for current month view
      const year = eventCalendarCurrentDate.getFullYear();
      const month = eventCalendarCurrentDate.getMonth();

      // Update month label
      const monthLabel = document.getElementById('eventCalendarMonthLabel');
      if (monthLabel) {
        monthLabel.textContent = formatDateAustin(eventCalendarCurrentDate, { month: 'long', year: 'numeric' });
      }

      // Get first day of month and calculate calendar grid
      const firstDayOfMonth = new Date(year, month, 1);
      const lastDayOfMonth = new Date(year, month + 1, 0);
      const startDay = firstDayOfMonth.getDay(); // 0 = Sunday
      const daysInMonth = lastDayOfMonth.getDate();

      // Get days from previous month to fill first week
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      const prevMonthDays = [];
      for (let i = startDay - 1; i >= 0; i--) {
        prevMonthDays.push({
          day: prevMonthLastDay - i,
          date: new Date(year, month - 1, prevMonthLastDay - i),
          isOtherMonth: true
        });
      }

      // Current month days
      const currentMonthDays = [];
      for (let i = 1; i <= daysInMonth; i++) {
        currentMonthDays.push({
          day: i,
          date: new Date(year, month, i),
          isOtherMonth: false
        });
      }

      // Get days from next month to fill last week
      const totalDaysSoFar = prevMonthDays.length + currentMonthDays.length;
      const nextMonthDays = [];
      const daysNeeded = (7 - (totalDaysSoFar % 7)) % 7;
      for (let i = 1; i <= daysNeeded; i++) {
        nextMonthDays.push({
          day: i,
          date: new Date(year, month + 1, i),
          isOtherMonth: true
        });
      }

      const allDays = [...prevMonthDays, ...currentMonthDays, ...nextMonthDays];
      const today = getAustinToday();

      // Group events by date
      const eventsByDate = {};
      allEventRequests.forEach(req => {
        if (req.event_date) {
          const dateKey = req.event_date.split('T')[0];
          if (!eventsByDate[dateKey]) {
            eventsByDate[dateKey] = [];
          }
          eventsByDate[dateKey].push(req);
        }
      });

      // Build HTML
      let html = '<div class="events-calendar-grid">';

      // Header row
      html += '<div class="events-calendar-header">';
      ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach((day, index) => {
        const isWeekend = index === 0 || index === 6;
        html += `<div class="day-header ${isWeekend ? 'weekend' : ''}">${day}</div>`;
      });
      html += '</div>';

      // Calendar body
      html += '<div class="events-calendar-body">';
      allDays.forEach((dayInfo, index) => {
        const isWeekend = dayInfo.date.getDay() === 0 || dayInfo.date.getDay() === 6;
        const isToday = isSameAustinDay(dayInfo.date, today);
        const dateKey = dayInfo.date.toISOString().split('T')[0];
        const dayEvents = eventsByDate[dateKey] || [];

        let cellClasses = 'events-calendar-cell';
        if (dayInfo.isOtherMonth) cellClasses += ' other-month';
        if (isWeekend) cellClasses += ' weekend';
        if (isToday) cellClasses += ' today';

        html += `<div class="${cellClasses}">`;
        html += `<div class="cell-date">${dayInfo.day}</div>`;
        html += '<div class="cell-events">';

        dayEvents.forEach(event => {
          const status = event.request_status || 'submitted';
          const person = event.person;
          const clientName = person ? `${person.first_name || ''} ${person.last_name || ''}`.trim() : 'Unknown';
          const formatTime = (timeStr) => {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes}${ampm}`;
          };
          const timeDisplay = event.event_start_time ? formatTime(event.event_start_time) : '';
          const rentalFee = parseFloat(event.rental_fee) || eventService.DEFAULT_FEES?.RENTAL_FEE || 0;

          const tooltipData = JSON.stringify({
            name: event.event_name || 'Unnamed Event',
            client: clientName,
            org: event.organization_name || '-',
            time: event.event_start_time ? `${formatTime(event.event_start_time)} - ${formatTime(event.event_end_time)}` : '-',
            guests: event.expected_guests || '?',
            fee: rentalFee === 0 ? 'Complementary' : `$${rentalFee}`,
            deposit: event.security_deposit ? `$${event.security_deposit}` : 'N/A',
            status: status.replace('_', ' ')
          }).replace(/"/g, '&quot;');

          html += `
            <div class="event-chip ${status}"
                 data-id="${event.id}"
                 data-tooltip='${tooltipData}'>
              ${timeDisplay ? `<span class="chip-time">${timeDisplay}</span> ` : ''}
              <span class="chip-name">${event.event_name || 'Event'}</span>
            </div>
          `;
        });

        html += '</div></div>';
      });

      html += '</div></div>';

      // Add tooltip element
      html += '<div id="eventCalendarTooltip" class="event-calendar-tooltip"></div>';

      container.innerHTML = html;
    }

    function showEventCalendarTooltip(event, element) {
      const tooltip = document.getElementById('eventCalendarTooltip');
      if (!tooltip) return;

      try {
        const data = JSON.parse(element.dataset.tooltip);
        tooltip.innerHTML = `
          <div class="tooltip-header">${data.name}</div>
          <div class="tooltip-row"><span class="tooltip-label">Client:</span><span class="tooltip-value">${data.client}</span></div>
          ${data.org !== '-' ? `<div class="tooltip-row"><span class="tooltip-label">Org:</span><span class="tooltip-value">${data.org}</span></div>` : ''}
          <div class="tooltip-row"><span class="tooltip-label">Time:</span><span class="tooltip-value">${data.time}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">Guests:</span><span class="tooltip-value">${data.guests}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">Fee:</span><span class="tooltip-value">${data.fee}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">Deposit:</span><span class="tooltip-value">${data.deposit}</span></div>
          <div class="tooltip-row"><span class="tooltip-label">Status:</span><span class="tooltip-value">${data.status}</span></div>
        `;

        const rect = element.getBoundingClientRect();
        tooltip.style.left = `${Math.min(rect.left, window.innerWidth - 300)}px`;
        tooltip.style.top = `${rect.bottom + 8}px`;
        tooltip.classList.add('visible');
      } catch (e) {
        console.error('Error parsing event tooltip data:', e);
      }
    }

    function hideEventCalendarTooltip() {
      const tooltip = document.getElementById('eventCalendarTooltip');
      if (tooltip) tooltip.classList.remove('visible');
    }

    // Event detail modal state
    let currentEventTemplate = null;
    let currentEventAgreementData = null;

    // Make openEventDetail available globally
    window.openEventDetail = async function(requestId) {
      currentEventRequestId = requestId;
      const req = allEventRequests.find(r => r.id === requestId);
      if (!req) return;

      const person = req.person;
      const clientName = person ? `${person.first_name || ''} ${person.last_name || ''}`.trim() : 'Unknown';

      // Show modal
      document.getElementById('eventDetailModal').classList.remove('hidden');

      // Set header info
      document.getElementById('eventDetailTitle').textContent = req.event_name || 'Event Details';
      document.getElementById('eventDetailStatus').textContent = req.request_status || 'submitted';
      document.getElementById('eventDetailStatus').className = 'status-badge ' + (req.request_status || 'submitted');
      document.getElementById('eventDetailTestBadge').style.display = req.is_test ? 'inline-block' : 'none';

      // Event Info tab
      document.getElementById('eventInfoName').textContent = req.event_name || '-';
      document.getElementById('eventInfoClient').textContent = clientName;
      document.getElementById('eventInfoEmail').textContent = person?.email || '-';
      document.getElementById('eventInfoPhone').textContent = person?.phone || '-';
      document.getElementById('eventInfoOrg').textContent = req.organization_name || '-';
      document.getElementById('eventInfoDate').textContent = req.event_date
        ? formatDateAustin(req.event_date, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })
        : '-';

      const formatTime = (timeStr) => {
        if (!timeStr) return '';
        const [hours, minutes] = timeStr.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${ampm}`;
      };
      document.getElementById('eventInfoTime').textContent =
        req.event_start_time ? `${formatTime(req.event_start_time)} - ${formatTime(req.event_end_time || '')}` : '-';
      document.getElementById('eventInfoGuests').textContent = req.expected_guests || '-';
      document.getElementById('eventInfoType').textContent = req.event_type || '-';
      document.getElementById('eventInfoSubmitted').textContent = req.submitted_at
        ? formatDateAustin(req.submitted_at, { month: 'short', day: 'numeric', year: 'numeric' })
        : '-';
      document.getElementById('eventInfoDescription').textContent = req.event_description || 'No description provided';
      document.getElementById('eventInfoSpecialRequests').textContent = req.special_requests || 'None';

      // Terms tab
      document.getElementById('eventTermMaxGuests').value = req.approved_max_guests || req.expected_guests || 25;
      document.getElementById('eventTermRentalFee').value = req.rental_fee ?? eventService.DEFAULT_FEES.RENTAL_FEE;
      document.getElementById('eventTermReservationFee').value = req.reservation_fee ?? eventService.DEFAULT_FEES.RESERVATION_FEE;
      document.getElementById('eventTermCleaningDeposit').value = req.cleaning_deposit ?? eventService.DEFAULT_FEES.CLEANING_DEPOSIT;
      document.getElementById('eventTermAdditionalTerms').value = req.additional_terms || '';

      // Documents tab
      document.getElementById('eventAgreementStatusDisplay').textContent = req.agreement_status || 'Pending';
      await updateEventDocumentsTabState(req);

      // Deposits tab
      updateEventDepositsTab(req);

      // Action buttons
      updateEventDetailActions(req);

      // Reset to first tab
      document.querySelectorAll('.event-detail-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.event-detail-tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector('.event-detail-tab[data-event-tab="eventInfo"]').classList.add('active');
      document.getElementById('eventInfoTab').classList.add('active');

      // Load template for documents tab
      try {
        currentEventTemplate = await eventTemplateService.getActiveTemplate();
        currentEventAgreementData = await eventService.getAgreementData(req.id);
      } catch (e) {
        console.error('Error loading event template/data:', e);
      }
    };

    function closeEventDetail() {
      document.getElementById('eventDetailModal').classList.add('hidden');
      currentEventRequestId = null;
      currentEventTemplate = null;
      currentEventAgreementData = null;
    }

    async function updateEventDocumentsTabState(req) {
      const generateSection = document.getElementById('eventGenerateSection');
      const pdfSection = document.getElementById('eventPdfSection');
      const signatureSection = document.getElementById('eventSignatureSection');
      const noTemplateWarning = document.getElementById('noEventTemplateWarning');

      // Reset visibility
      generateSection.style.display = 'block';
      pdfSection.style.display = 'none';
      signatureSection.style.display = 'none';
      noTemplateWarning.style.display = 'none';

      // Clear preview
      document.getElementById('eventLeasePreview').innerHTML = '';

      const status = req.agreement_status || 'pending';

      if (status === 'signed' && req.signed_pdf_url) {
        if (req.agreement_document_url) {
          pdfSection.style.display = 'block';
          document.getElementById('eventPdfDownloadLink').href = req.agreement_document_url;
          document.getElementById('eventPdfFilename').textContent = `Event-Agreement-${req.event_name?.substring(0, 20) || 'event'}.pdf`;
        }
        signatureSection.style.display = 'block';
        document.getElementById('eventSignatureStatusText').textContent = 'Agreement signed!';
        document.getElementById('eventSignedPdfSection').style.display = 'block';
        document.getElementById('eventSignedPdfLink').href = req.signed_pdf_url;
      } else if (status === 'sent' && req.signwell_document_id) {
        generateSection.style.display = 'none';
        pdfSection.style.display = 'block';
        signatureSection.style.display = 'block';
        document.getElementById('eventSignatureStatusText').textContent = 'Awaiting client signature...';
        if (req.agreement_document_url) {
          document.getElementById('eventPdfDownloadLink').href = req.agreement_document_url;
          document.getElementById('eventPdfFilename').textContent = `Event-Agreement-${req.event_name?.substring(0, 20) || 'event'}.pdf`;
        }
      } else if (status === 'generated' && req.agreement_document_url) {
        generateSection.style.display = 'block';
        pdfSection.style.display = 'block';
        document.getElementById('eventPdfDownloadLink').href = req.agreement_document_url;
        document.getElementById('eventPdfFilename').textContent = `Event-Agreement-${req.event_name?.substring(0, 20) || 'event'}.pdf`;
        if (req.agreement_generated_at) {
          document.getElementById('eventPdfGeneratedAt').textContent =
            `Generated ${formatDateAustin(req.agreement_generated_at, { month: 'short', day: 'numeric', year: 'numeric' })}`;
        }
      }
    }

    function updateEventDepositsTab(req) {
      const rentalFee = parseFloat(req.rental_fee) || eventService.DEFAULT_FEES.RENTAL_FEE;
      const reservationFee = parseFloat(req.reservation_fee) || eventService.DEFAULT_FEES.RESERVATION_FEE;
      const cleaningDeposit = parseFloat(req.cleaning_deposit) || eventService.DEFAULT_FEES.CLEANING_DEPOSIT;

      // Update amounts
      document.getElementById('eventReservationDepositAmount').textContent = `$${reservationFee}`;
      document.getElementById('eventCleaningDepositAmount').textContent = `$${cleaningDeposit}`;
      document.getElementById('eventRentalFeeAmount').textContent = `$${rentalFee}`;

      // Update statuses
      document.getElementById('eventReservationDepositStatus').textContent =
        req.reservation_fee_paid ? 'Paid' : 'Pending';
      document.getElementById('eventCleaningDepositStatus').textContent =
        req.cleaning_deposit_paid ? 'Paid' : 'Pending';
      document.getElementById('eventRentalFeeStatus').textContent =
        req.rental_fee_paid ? 'Paid' : 'Pending';

      // Show reservation deposit credit section if paid via Square
      const reservationSection = document.getElementById('eventReservationFeeSection');
      if (req.deposit_status === 'paid' && req.reservation_deposit_amount > 0) {
        reservationSection.classList.remove('hidden');
        const paidAmount = parseFloat(req.reservation_deposit_amount);
        document.getElementById('eventReservationFeeAmount').textContent = `$${paidAmount}`;
        document.getElementById('eventRentalFeeTotal').textContent = `$${rentalFee}`;
        document.getElementById('eventRentalFeeDue').textContent = `$${Math.max(0, rentalFee - paidAmount)}`;

        if (req.reservation_deposit_code) {
          document.getElementById('eventReservationFeeCode').classList.remove('hidden');
          document.getElementById('eventReservationFeeCodeValue').textContent = req.reservation_deposit_code;
        } else {
          document.getElementById('eventReservationFeeCode').classList.add('hidden');
        }
      } else {
        reservationSection.classList.add('hidden');
      }
    }

    function updateEventDetailActions(req) {
      const container = document.getElementById('eventDetailActions');
      const buttons = [];
      const stage = eventService.getPipelineStage(req);

      switch (stage) {
        case 'requests':
          buttons.push('<button class="btn-primary" onclick="approveEventRequest()">Approve</button>');
          buttons.push('<button class="btn-secondary" onclick="denyEventRequest()">Deny</button>');
          break;

        case 'approved':
          buttons.push('<button class="btn-primary" onclick="switchToEventTab(\'eventDocuments\')">Generate Agreement</button>');
          break;

        case 'contract':
          if (req.agreement_status === 'generated') {
            buttons.push('<button class="btn-primary" onclick="sendEventForSignature()">Send for Signature</button>');
          }
          break;

        case 'deposit':
          buttons.push('<button class="btn-primary" onclick="confirmEventDeposit()">Confirm Deposits</button>');
          break;

        case 'ready':
          buttons.push('<button class="btn-primary" onclick="markEventCompleted()">Mark Complete</button>');
          break;

        case 'delayed':
          buttons.push('<button class="btn-primary" onclick="reactivateEventRequest()">Reactivate</button>');
          break;
      }

      // Archive button for all
      buttons.push('<button class="btn-secondary" onclick="archiveEventRequest()">Archive</button>');

      container.innerHTML = buttons.join('');
    }

    function switchToEventTab(tabName) {
      document.querySelectorAll('.event-detail-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.event-detail-tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`.event-detail-tab[data-event-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`${tabName}Tab`).classList.add('active');
    }

    async function previewEventAgreement() {
      const req = allEventRequests.find(r => r.id === currentEventRequestId);
      if (!req) return;

      try {
        currentEventTemplate = await eventTemplateService.getActiveTemplate();
        currentEventAgreementData = await eventService.getAgreementData(currentEventRequestId);

        if (!currentEventTemplate || !currentEventAgreementData) {
          showToast('No template or data available. Make sure Terms are filled in.', 'warning');
          return;
        }

        const parsedContent = eventTemplateService.parseTemplate(
          currentEventTemplate.content,
          currentEventAgreementData
        );

        // Convert markdown to HTML (simple version)
        const htmlContent = parsedContent
          .replace(/^### (.*$)/gim, '<h3>$1</h3>')
          .replace(/^## (.*$)/gim, '<h2>$1</h2>')
          .replace(/^# (.*$)/gim, '<h1>$1</h1>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/^- (.*$)/gim, '<li>$1</li>')
          .replace(/\n\n/g, '</p><p>')
          .replace(/\n/g, '<br>');

        document.getElementById('eventLeasePreview').innerHTML = `<div class="markdown-preview"><p>${htmlContent}</p></div>`;
        showToast('Preview loaded', 'success');
      } catch (e) {
        console.error('Error previewing event agreement:', e);
        showToast('Error loading preview: ' + e.message, 'error');
      }
    }

    async function generateEventPdf() {
      const req = allEventRequests.find(r => r.id === currentEventRequestId);
      if (!req) return;

      try {
        currentEventTemplate = await eventTemplateService.getActiveTemplate();
        currentEventAgreementData = await eventService.getAgreementData(currentEventRequestId);

        if (!currentEventTemplate || !currentEventAgreementData) {
          showToast('No template or data available', 'warning');
          return;
        }

        const parsedContent = eventTemplateService.parseTemplate(
          currentEventTemplate.content,
          currentEventAgreementData
        );

        showToast('Generating PDF...', 'info');

        // Generate PDF
        const pdfBlob = await pdfService.generatePdf(parsedContent, {
          title: `Event Agreement - ${req.event_name}`,
          subject: 'Event Hosting Agreement'
        });

        // Upload to Supabase storage
        const filename = `event-agreement-${req.id}-${Date.now()}.pdf`;
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('lease-documents')
          .upload(`generated/${filename}`, pdfBlob, {
            contentType: 'application/pdf',
            upsert: true
          });

        if (uploadError) throw uploadError;

        // Get public URL
        const { data: urlData } = supabase.storage
          .from('lease-documents')
          .getPublicUrl(`generated/${filename}`);

        // Update event request
        await eventService.updateAgreementStatus(currentEventRequestId, 'generated', urlData.publicUrl);

        // Reload events
        allEventRequests = await eventService.getRequests();
        renderEventPipeline();

        // Refresh the modal
        const updatedReq = allEventRequests.find(r => r.id === currentEventRequestId);
        if (updatedReq) {
          await updateEventDocumentsTabState(updatedReq);
          updateEventDetailActions(updatedReq);
        }

        showToast('PDF generated successfully!', 'success');
      } catch (e) {
        console.error('Error generating event PDF:', e);
        showToast('Error generating PDF: ' + e.message, 'error');
      }
    }

    async function saveEventTerms() {
      const statusEl = document.getElementById('eventTermsSaveStatus');
      statusEl.textContent = 'Saving...';

      try {
        await eventService.saveTerms(currentEventRequestId, {
          approved_max_guests: parseInt(document.getElementById('eventTermMaxGuests').value),
          rental_fee: parseFloat(document.getElementById('eventTermRentalFee').value),
          reservation_fee: parseFloat(document.getElementById('eventTermReservationFee').value),
          cleaning_deposit: parseFloat(document.getElementById('eventTermCleaningDeposit').value),
          additional_terms: document.getElementById('eventTermAdditionalTerms').value
        });

        allEventRequests = await eventService.getRequests();
        renderEventPipeline();
        statusEl.textContent = 'Saved!';
        setTimeout(() => statusEl.textContent = '', 2000);
      } catch (e) {
        console.error('Error saving event terms:', e);
        statusEl.textContent = 'Error saving';
        showToast('Error saving terms: ' + e.message, 'error');
      }
    }

    async function approveEventRequest() {
      const req = allEventRequests.find(r => r.id === currentEventRequestId);
      if (!req) return;

      try {
        await eventService.approveRequest(currentEventRequestId, {
          approved_max_guests: parseInt(document.getElementById('eventTermMaxGuests').value) || req.expected_guests,
          rental_fee: parseFloat(document.getElementById('eventTermRentalFee').value),
          reservation_fee: parseFloat(document.getElementById('eventTermReservationFee').value),
          cleaning_deposit: parseFloat(document.getElementById('eventTermCleaningDeposit').value),
          additional_terms: document.getElementById('eventTermAdditionalTerms').value
        });

        allEventRequests = await eventService.getRequests();
        renderEventPipeline();
        closeEventDetail();
        showToast('Event request approved', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function denyEventRequest() {
      const reason = prompt('Enter denial reason:');
      if (!reason) return;

      try {
        await eventService.denyRequest(currentEventRequestId, reason);
        allEventRequests = await eventService.getRequests();
        renderEventPipeline();
        closeEventDetail();
        showToast('Event request denied', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function delayEventRequest() {
      const reason = prompt('Enter delay reason:');
      if (!reason) return;

      try {
        await eventService.delayRequest(currentEventRequestId, reason);
        allEventRequests = await eventService.getRequests();
        renderEventPipeline();
        closeEventDetail();
        showToast('Event request delayed', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function reactivateEventRequest() {
      try {
        await eventService.reactivateRequest(currentEventRequestId);
        allEventRequests = await eventService.getRequests();
        renderEventPipeline();
        closeEventDetail();
        showToast('Event request reactivated', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function archiveEventRequest() {
      if (!confirm('Archive this event request?')) return;

      try {
        await eventService.archiveRequest(currentEventRequestId);
        allEventRequests = await eventService.getRequests();
        renderEventPipeline();
        closeEventDetail();
        showToast('Event request archived', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function confirmEventDeposit() {
      try {
        await eventService.confirmDeposit(currentEventRequestId);
        allEventRequests = await eventService.getRequests();
        renderEventPipeline();
        closeEventDetail();
        showToast('Deposits confirmed', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function markEventCompleted() {
      try {
        await eventService.markEventCompleted(currentEventRequestId);
        allEventRequests = await eventService.getRequests();
        renderEventPipeline();
        closeEventDetail();
        showToast('Event marked as completed', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    // Create event request form handler
    document.getElementById('createEventRequestForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const personId = document.getElementById('newEventPersonId').value;
      const eventData = {
        organization_name: document.getElementById('newEventOrgName').value || null,
        has_hosted_before: document.getElementById('newEventHostedBefore').checked,
        event_name: document.getElementById('newEventName').value,
        event_description: document.getElementById('newEventDescription').value || null,
        event_type: document.getElementById('newEventType').value,
        event_date: document.getElementById('newEventDate').value,
        event_start_time: document.getElementById('newEventStartTime').value,
        event_end_time: document.getElementById('newEventEndTime').value,
        expected_guests: parseInt(document.getElementById('newEventGuests').value) || 25,
      };

      try {
        await eventService.createRequest(personId, eventData);
        showToast('Event request created', 'success');
        e.target.reset();

        // Reload events
        allEventRequests = await eventService.getRequests();
        renderEventPipeline();
      } catch (error) {
        console.error('Error creating event request:', error);
        showToast('Error creating event request', 'error');
      }
    });

    // =============================================
    // USER MANAGEMENT
    // =============================================

    // =============================================
    // SETTINGS TAB
    // =============================================

    async function loadSettingsPanel() {
      settingsLoaded = true;
      await Promise.all([
        loadPaymentMethods(),
        loadFeeSettings(),
        loadFeeCodes(),
        loadSquareConfig(),
        loadTelnyxConfig(),
        loadInboundSms()
      ]);
      setupFeeSettingsListeners();
      setupTelnyxListeners();
    }

    // Fee Settings (Square Payments)
    const FEE_TYPE_LABELS = {
      'rental_application': 'Rental Application Fee',
      'event_rental_fee': 'Event Rental Fee',
      'event_cleaning_deposit': 'Event Cleaning Deposit',
      'event_reservation_deposit': 'Event Reservation Deposit'
    };

    async function loadFeeSettings() {
      const grid = document.getElementById('feeSettingsGrid');
      if (!grid) return;

      try {
        const { data: settings, error } = await supabase
          .from('fee_settings')
          .select('*')
          .eq('is_active', true)
          .order('fee_type');

        if (error) throw error;

        if (!settings || settings.length === 0) {
          grid.innerHTML = '<p class="text-muted">No fee settings configured.</p>';
          return;
        }

        grid.innerHTML = settings.map(setting => `
          <div class="fee-setting-card" data-fee-type="${setting.fee_type}">
            <div class="fee-setting-info">
              <h4>${FEE_TYPE_LABELS[setting.fee_type] || setting.fee_type}</h4>
              <p>${setting.description || ''}</p>
            </div>
            <div class="fee-setting-amount">
              <span>$</span>
              <input type="number"
                     min="0"
                     step="0.01"
                     value="${setting.default_amount}"
                     data-fee-id="${setting.id}"
                     class="fee-amount-input">
            </div>
          </div>
        `).join('');

        // Add change listeners
        grid.querySelectorAll('.fee-amount-input').forEach(input => {
          input.addEventListener('change', handleFeeAmountChange);
        });

      } catch (error) {
        console.error('Error loading fee settings:', error);
        grid.innerHTML = '<p class="text-muted">Error loading fee settings.</p>';
      }
    }

    async function handleFeeAmountChange(e) {
      const input = e.target;
      const feeId = input.dataset.feeId;
      const newAmount = parseFloat(input.value) || 0;

      try {
        const { error } = await supabase
          .from('fee_settings')
          .update({
            default_amount: newAmount,
            updated_at: new Date().toISOString()
          })
          .eq('id', feeId);

        if (error) throw error;
        showToast('Fee amount updated', 'success');
      } catch (error) {
        console.error('Error updating fee:', error);
        showToast('Failed to update fee amount', 'error');
      }
    }

    async function loadFeeCodes() {
      const grid = document.getElementById('feeCodesGrid');
      if (!grid) return;

      try {
        const { data: codes, error } = await supabase
          .from('fee_codes')
          .select('*')
          .order('fee_type')
          .order('code');

        if (error) throw error;

        if (!codes || codes.length === 0) {
          grid.innerHTML = '<div class="fee-codes-empty">No fee codes configured. Click "Add Code" to create one.</div>';
          return;
        }

        grid.innerHTML = codes.map(code => {
          const usageText = code.usage_limit
            ? `${code.times_used}/${code.usage_limit} used`
            : `${code.times_used} used`;
          const expiredClass = code.expires_at && new Date(code.expires_at) < new Date() ? 'expired' : '';
          const inactiveClass = !code.is_active ? 'inactive' : '';

          return `
            <div class="fee-code-card ${expiredClass} ${inactiveClass}">
              <div>
                <span class="code-name">${code.code}</span>
                ${code.description ? `<div class="code-usage">${code.description}</div>` : ''}
              </div>
              <div>
                <span class="code-type">${FEE_TYPE_LABELS[code.fee_type] || code.fee_type}</span>
                <div class="code-usage">${usageText}</div>
              </div>
              <div>
                <span class="code-price ${code.price === 0 ? 'free' : ''}">
                  ${code.price === 0 ? 'FREE' : '$' + code.price.toFixed(2)}
                </span>
              </div>
              <div class="code-actions">
                <button class="btn-small btn-secondary" onclick="editFeeCode('${code.id}')">Edit</button>
                <button class="btn-small btn-danger" onclick="deleteFeeCode('${code.id}', '${code.code}')">Delete</button>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading fee codes:', error);
        grid.innerHTML = '<div class="fee-codes-empty">Error loading fee codes.</div>';
      }
    }

    async function loadSquareConfig() {
      try {
        const { data: config, error } = await supabase
          .from('square_config')
          .select('test_mode')
          .single();

        if (error) throw error;

        const checkbox = document.getElementById('squareTestMode');
        const badge = document.getElementById('squareModeBadge');

        if (checkbox) checkbox.checked = config.test_mode;
        if (badge) {
          badge.textContent = config.test_mode ? 'Test Mode' : 'Live';
          badge.classList.toggle('live', !config.test_mode);
        }

      } catch (error) {
        console.error('Error loading Square config:', error);
      }
    }

    function setupFeeSettingsListeners() {
      // Add Code button
      document.getElementById('addFeeCodeBtn')?.addEventListener('click', () => {
        openFeeCodeModal();
      });

      // Square test mode toggle
      document.getElementById('squareTestMode')?.addEventListener('change', async (e) => {
        const testMode = e.target.checked;
        try {
          const { error } = await supabase
            .from('square_config')
            .update({
              test_mode: testMode,
              updated_at: new Date().toISOString()
            })
            .eq('id', (await supabase.from('square_config').select('id').single()).data.id);

          if (error) throw error;

          const badge = document.getElementById('squareModeBadge');
          if (badge) {
            badge.textContent = testMode ? 'Test Mode' : 'Live';
            badge.classList.toggle('live', !testMode);
          }

          showToast(`Square ${testMode ? 'test' : 'live'} mode enabled`, 'success');
        } catch (error) {
          console.error('Error updating Square mode:', error);
          showToast('Failed to update Square mode', 'error');
          e.target.checked = !testMode; // Revert
        }
      });
    }

    // =============================================
    // TWILIO SMS
    // =============================================

    const SEND_SMS_URL = `${SUPABASE_URL}/functions/v1/send-sms`;

    function formatPhoneE164(phone) {
      if (!phone) return null;
      const digits = phone.replace(/\D/g, '');
      if (digits.length === 10) return `+1${digits}`;
      if (digits.length === 11 && digits.startsWith('1')) return `+${digits}`;
      if (phone.startsWith('+') && digits.length >= 10) return `+${digits}`;
      return null;
    }

    async function loadTelnyxConfig() {
      try {
        const { data: config, error } = await supabase
          .from('telnyx_config')
          .select('phone_number, test_mode, is_active')
          .single();

        if (error) throw error;

        const checkbox = document.getElementById('telnyxTestMode');
        const badge = document.getElementById('telnyxModeBadge');
        const phoneDisplay = document.getElementById('telnyxPhoneDisplay');

        if (checkbox) checkbox.checked = config.test_mode || false;
        if (phoneDisplay) phoneDisplay.textContent = config.phone_number || 'Not configured';
        if (badge) {
          badge.textContent = config.test_mode ? 'Test Mode' : 'Live';
          badge.classList.toggle('live', !config.test_mode);
        }
      } catch (error) {
        console.error('Error loading Telnyx config:', error);
      }
    }

    async function loadInboundSms() {
      const container = document.getElementById('inboundSmsList');
      if (!container) return;

      try {
        const { data: messages, error } = await supabase
          .from('sms_messages')
          .select(`*, person:person_id(id, first_name, last_name, phone)`)
          .eq('direction', 'inbound')
          .order('created_at', { ascending: false })
          .limit(30);

        if (error) throw error;

        if (!messages || messages.length === 0) {
          container.innerHTML = '<p class="text-muted" style="font-size: 0.85rem;">No inbound messages yet.</p>';
          return;
        }

        container.innerHTML = messages.map(msg => {
          const senderName = msg.person
            ? `${msg.person.first_name || ''} ${msg.person.last_name || ''}`.trim()
            : msg.from_number;
          const time = new Date(msg.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
          return `
            <div style="padding: 0.5rem; border-bottom: 1px solid var(--border); cursor: pointer;" onclick="openSmsConversation('${msg.person_id || ''}', '${msg.from_number}')">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong style="font-size: 0.85rem;">${senderName}</strong>
                <span class="text-muted" style="font-size: 0.75rem;">${time}</span>
              </div>
              <p style="margin: 0.25rem 0 0; font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${msg.body}</p>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading inbound SMS:', error);
        container.innerHTML = '<p class="text-muted" style="font-size: 0.85rem; color: red;">Failed to load messages.</p>';
      }
    }

    function setupTelnyxListeners() {
      // Test mode toggle
      document.getElementById('telnyxTestMode')?.addEventListener('change', async (e) => {
        const testMode = e.target.checked;
        try {
          const { error } = await supabase
            .from('telnyx_config')
            .update({ test_mode: testMode, updated_at: new Date().toISOString() })
            .eq('id', 1);
          if (error) throw error;

          const badge = document.getElementById('telnyxModeBadge');
          if (badge) {
            badge.textContent = testMode ? 'Test Mode' : 'Live';
            badge.classList.toggle('live', !testMode);
          }
          showToast(`SMS ${testMode ? 'test' : 'live'} mode enabled`, 'success');
        } catch (error) {
          console.error('Error updating Telnyx mode:', error);
          showToast('Failed to update SMS mode', 'error');
          e.target.checked = !testMode;
        }
      });

      // Compose SMS button
      document.getElementById('openComposeSmsBtn')?.addEventListener('click', openComposeSmsModal);

      // Bulk SMS button
      document.getElementById('openBulkSmsBtn')?.addEventListener('click', openBulkSmsModal);

      // Refresh inbound
      document.getElementById('refreshInboundSmsBtn')?.addEventListener('click', loadInboundSms);

      // Compose modal controls
      document.getElementById('closeComposeSmsModal')?.addEventListener('click', () => {
        document.getElementById('composeSmsModal').classList.add('hidden');
      });
      document.getElementById('cancelComposeSmsBtn')?.addEventListener('click', () => {
        document.getElementById('composeSmsModal').classList.add('hidden');
      });
      document.getElementById('sendSmsBtn')?.addEventListener('click', handleSendSms);

      // Character counter
      document.getElementById('smsComposeBody')?.addEventListener('input', (e) => {
        const len = e.target.value.length;
        document.getElementById('smsCharCount').textContent = len;
        document.getElementById('smsSegmentCount').textContent = Math.ceil(len / 160) || 0;
      });

      // Recipient change - load conversation
      document.getElementById('smsRecipientSelect')?.addEventListener('change', async (e) => {
        const personId = e.target.value;
        const section = document.getElementById('smsConversationSection');
        if (!personId) {
          section.classList.add('hidden');
          return;
        }
        await loadSmsConversation(personId);
      });

      // Bulk modal controls
      document.getElementById('closeBulkSmsModal')?.addEventListener('click', () => {
        document.getElementById('bulkSmsModal').classList.add('hidden');
      });
      document.getElementById('cancelBulkSmsBtn')?.addEventListener('click', () => {
        document.getElementById('bulkSmsModal').classList.add('hidden');
      });
      document.getElementById('sendBulkSmsBtn')?.addEventListener('click', handleSendBulkSms);

      document.getElementById('bulkSmsBody')?.addEventListener('input', (e) => {
        document.getElementById('bulkSmsCharCount').textContent = e.target.value.length;
      });
    }

    async function getActiveTenants() {
      const { data: assignments, error } = await supabase
        .from('assignments')
        .select(`
          id,
          person:person_id(id, first_name, last_name, phone, email)
        `)
        .eq('status', 'active')
        .eq('type', 'dwelling');

      if (error) {
        console.error('Error loading active tenants:', error);
        return [];
      }

      // Deduplicate by person_id
      const seen = new Set();
      return (assignments || [])
        .filter(a => a.person && !seen.has(a.person.id) && seen.add(a.person.id))
        .map(a => a.person);
    }

    async function openComposeSmsModal(presetPersonId = null) {
      const modal = document.getElementById('composeSmsModal');
      const select = document.getElementById('smsRecipientSelect');
      const bodyInput = document.getElementById('smsComposeBody');

      // Reset
      bodyInput.value = '';
      document.getElementById('smsCharCount').textContent = '0';
      document.getElementById('smsSegmentCount').textContent = '0';
      document.getElementById('smsConversationSection').classList.add('hidden');

      // Populate recipients
      const tenants = await getActiveTenants();
      select.innerHTML = '<option value="">Select a tenant...</option>' +
        tenants.map(t => {
          const phone = t.phone ? ` (${t.phone})` : ' (no phone)';
          return `<option value="${t.id}" ${!t.phone ? 'disabled' : ''} ${t.id === presetPersonId ? 'selected' : ''}>${t.first_name || ''} ${t.last_name || ''}${phone}</option>`;
        }).join('');

      modal.classList.remove('hidden');

      // If preset, load conversation
      if (presetPersonId) {
        await loadSmsConversation(presetPersonId);
      }
    }

    async function loadSmsConversation(personId) {
      const section = document.getElementById('smsConversationSection');
      const thread = document.getElementById('smsConversationThread');

      const { data: messages, error } = await supabase
        .from('sms_messages')
        .select('*')
        .eq('person_id', personId)
        .order('created_at', { ascending: true });

      if (error || !messages || messages.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      thread.innerHTML = messages.map(msg => {
        const isOutbound = msg.direction === 'outbound';
        const time = new Date(msg.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        const statusBadge = msg.status === 'test' ? ' <span style="color: #f59e0b; font-size: 0.7rem;">[TEST]</span>' : '';
        return `
          <div style="margin-bottom: 0.5rem; text-align: ${isOutbound ? 'right' : 'left'};">
            <div style="display: inline-block; max-width: 80%; padding: 0.5rem 0.75rem; border-radius: 12px; font-size: 0.85rem; background: ${isOutbound ? '#dcf8c6' : '#f0f0f0'}; text-align: left;">
              ${msg.body}
            </div>
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;">${time}${statusBadge}</div>
          </div>
        `;
      }).join('');

      // Scroll to bottom
      thread.scrollTop = thread.scrollHeight;
    }

    function openSmsConversation(personId, fromNumber) {
      if (personId) {
        openComposeSmsModal(personId);
      } else {
        showToast(`Unknown sender: ${fromNumber}`, 'info');
      }
    }

    async function handleSendSms() {
      const select = document.getElementById('smsRecipientSelect');
      const bodyInput = document.getElementById('smsComposeBody');
      const sendBtn = document.getElementById('sendSmsBtn');
      const personId = select.value;
      const messageBody = bodyInput.value.trim();

      if (!personId) return showToast('Select a recipient', 'error');
      if (!messageBody) return showToast('Enter a message', 'error');

      // Get person phone
      const { data: person, error: personError } = await supabase
        .from('people')
        .select('id, first_name, last_name, phone')
        .eq('id', personId)
        .single();

      if (personError || !person?.phone) {
        return showToast('Recipient has no phone number', 'error');
      }

      const formattedPhone = formatPhoneE164(person.phone);
      if (!formattedPhone) return showToast('Invalid phone number format', 'error');

      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        const { data: { session } } = await supabase.auth.getSession();
        const response = await fetch(SEND_SMS_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session?.access_token || SUPABASE_ANON_KEY}`,
            'apikey': SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({
            type: 'general',
            to: formattedPhone,
            data: { message: messageBody },
            person_id: personId,
          }),
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Failed to send SMS');

        showToast(`SMS sent to ${person.first_name}${result.test_mode ? ' (test mode)' : ''}`, 'success');
        bodyInput.value = '';
        document.getElementById('smsCharCount').textContent = '0';
        document.getElementById('smsSegmentCount').textContent = '0';

        // Refresh conversation
        await loadSmsConversation(personId);
      } catch (error) {
        console.error('Error sending SMS:', error);
        showToast(`Failed to send SMS: ${error.message}`, 'error');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send SMS';
      }
    }

    let bulkSmsRecipients = [];

    async function openBulkSmsModal() {
      const modal = document.getElementById('bulkSmsModal');
      const bodyInput = document.getElementById('bulkSmsBody');
      const countEl = document.getElementById('bulkSmsRecipientCount');
      const listEl = document.getElementById('bulkSmsRecipientList');

      bodyInput.value = '';
      document.getElementById('bulkSmsCharCount').textContent = '0';

      const tenants = await getActiveTenants();
      bulkSmsRecipients = tenants.filter(t => t.phone && formatPhoneE164(t.phone));

      countEl.textContent = bulkSmsRecipients.length;
      listEl.innerHTML = bulkSmsRecipients.map(t =>
        `<div style="padding: 0.25rem 0; border-bottom: 1px solid #f0f0f0;">${t.first_name || ''} ${t.last_name || ''} <span class="text-muted">${t.phone}</span></div>`
      ).join('') || '<p class="text-muted">No tenants with phone numbers found.</p>';

      modal.classList.remove('hidden');
    }

    async function handleSendBulkSms() {
      const bodyInput = document.getElementById('bulkSmsBody');
      const sendBtn = document.getElementById('sendBulkSmsBtn');
      const messageBody = bodyInput.value.trim();

      if (!messageBody) return showToast('Enter a message', 'error');
      if (bulkSmsRecipients.length === 0) return showToast('No recipients with phone numbers', 'error');

      sendBtn.disabled = true;
      sendBtn.textContent = `Sending (0/${bulkSmsRecipients.length})...`;

      const { data: { session } } = await supabase.auth.getSession();
      let sent = 0, failed = 0;

      for (let i = 0; i < bulkSmsRecipients.length; i++) {
        const tenant = bulkSmsRecipients[i];
        const formattedPhone = formatPhoneE164(tenant.phone);
        if (!formattedPhone) { failed++; continue; }

        try {
          const response = await fetch(SEND_SMS_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${session?.access_token || supabaseAnonKey}`,
              'apikey': supabaseAnonKey,
            },
            body: JSON.stringify({
              type: 'bulk_announcement',
              to: formattedPhone,
              data: { message: messageBody, first_name: tenant.first_name },
              person_id: tenant.id,
            }),
          });

          if (response.ok) { sent++; } else { failed++; }
        } catch (e) { failed++; }

        sendBtn.textContent = `Sending (${i + 1}/${bulkSmsRecipients.length})...`;

        // Rate limit between messages
        if (i < bulkSmsRecipients.length - 1) {
          await new Promise(r => setTimeout(r, 1000));
        }
      }

      showToast(`Sent: ${sent}, Failed: ${failed}`, sent > 0 ? 'success' : 'error');
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send to All';
      document.getElementById('bulkSmsModal').classList.add('hidden');
    }

    // Fee Code Modal
    let editingFeeCodeId = null;

    window.openFeeCodeModal = function(codeId = null) {
      editingFeeCodeId = codeId;
      const modal = document.getElementById('feeCodeModal');
      const form = document.getElementById('feeCodeForm');
      const title = document.getElementById('feeCodeModalTitle');

      if (codeId) {
        title.textContent = 'Edit Fee Code';
        loadFeeCodeForEdit(codeId);
      } else {
        title.textContent = 'Add Fee Code';
        form.reset();
        document.getElementById('feeCodeId').value = '';
      }

      modal.classList.remove('hidden');
    };

    async function loadFeeCodeForEdit(codeId) {
      try {
        const { data: code, error } = await supabase
          .from('fee_codes')
          .select('*')
          .eq('id', codeId)
          .single();

        if (error) throw error;

        document.getElementById('feeCodeId').value = code.id;
        document.getElementById('feeCodeCode').value = code.code;
        document.getElementById('feeCodeType').value = code.fee_type;
        document.getElementById('feeCodePrice').value = code.price;
        document.getElementById('feeCodeDescription').value = code.description || '';
        document.getElementById('feeCodeUsageLimit').value = code.usage_limit || '';
        document.getElementById('feeCodeExpires').value = code.expires_at ? code.expires_at.split('T')[0] : '';
        document.getElementById('feeCodeActive').checked = code.is_active;

      } catch (error) {
        console.error('Error loading fee code:', error);
        showToast('Failed to load fee code', 'error');
      }
    }

    window.closeFeeCodeModal = function() {
      document.getElementById('feeCodeModal').classList.add('hidden');
      editingFeeCodeId = null;
    };

    window.saveFeeCode = async function(e) {
      e.preventDefault();

      const codeId = document.getElementById('feeCodeId').value;
      const codeData = {
        code: document.getElementById('feeCodeCode').value.toUpperCase().trim(),
        fee_type: document.getElementById('feeCodeType').value,
        price: parseFloat(document.getElementById('feeCodePrice').value) || 0,
        description: document.getElementById('feeCodeDescription').value.trim() || null,
        usage_limit: parseInt(document.getElementById('feeCodeUsageLimit').value) || null,
        expires_at: document.getElementById('feeCodeExpires').value || null,
        is_active: document.getElementById('feeCodeActive').checked,
        updated_at: new Date().toISOString()
      };

      try {
        if (codeId) {
          // Update existing
          const { error } = await supabase
            .from('fee_codes')
            .update(codeData)
            .eq('id', codeId);
          if (error) throw error;
          showToast('Fee code updated', 'success');
        } else {
          // Create new
          const { error } = await supabase
            .from('fee_codes')
            .insert(codeData);
          if (error) throw error;
          showToast('Fee code created', 'success');
        }

        closeFeeCodeModal();
        await loadFeeCodes();

      } catch (error) {
        console.error('Error saving fee code:', error);
        if (error.message?.includes('duplicate')) {
          showToast('This code already exists for this fee type', 'error');
        } else {
          showToast('Failed to save fee code', 'error');
        }
      }
    };

    window.editFeeCode = function(codeId) {
      window.openFeeCodeModal(codeId);
    };

    window.deleteFeeCode = async function(codeId, codeName) {
      if (!confirm(`Delete code "${codeName}"? This cannot be undone.`)) return;

      try {
        const { error } = await supabase
          .from('fee_codes')
          .delete()
          .eq('id', codeId);

        if (error) throw error;

        showToast('Fee code deleted', 'success');
        await loadFeeCodes();

      } catch (error) {
        console.error('Error deleting fee code:', error);
        showToast('Failed to delete fee code', 'error');
      }
    };

    // Airbnb Sync functionality
    async function loadAirbnbRentals() {
      try {
        const today = getAustinToday();
        const todayStr = getAustinTodayISO();

        // Load all spaces with Airbnb iCal URLs
        const { data: airbnbSpaces, error: spacesError } = await supabase
          .from('spaces')
          .select('id, name, airbnb_ical_url, airbnb_blocked_dates')
          .not('airbnb_ical_url', 'is', null)
          .eq('is_archived', false)
          .order('name');

        if (spacesError) throw spacesError;

        // Load all active/future assignments for these spaces
        const { data: assignments, error: assignmentsError } = await supabase
          .from('assignments')
          .select(`
            id, start_date, end_date, status, airbnb_uid, notes,
            person:person_id(first_name, last_name),
            assignment_spaces(space_id)
          `)
          .in('status', ['active', 'prospect', 'pending_contract', 'contract_sent'])
          .gte('end_date', todayStr)
          .order('start_date', { ascending: true });

        if (assignmentsError) throw assignmentsError;

        const linkedSpacesList = document.getElementById('linkedSpacesList');

        if (airbnbSpaces && airbnbSpaces.length > 0) {
          const fmtDateLocal = (d) => {
            const day = d.getDate();
            const month = d.toLocaleString('en-US', { month: 'short' });
            const year = String(d.getFullYear()).slice(-2);
            return `${day}-${month}-${year}`;
          };

          // Build table rows - one row per space
          const tableRows = airbnbSpaces.map(space => {
            // Get assignments for this space
            const spaceAssignments = (assignments || []).filter(a =>
              a.assignment_spaces?.some(as => as.space_id === space.id)
            );

            // Get blocked dates from Airbnb
            const blockedRanges = space.airbnb_blocked_dates || [];

            // Combine assignments and blocked dates into occupied ranges
            const occupiedRanges = [
              ...spaceAssignments.map(a => {
                const personName = a.person && a.person.first_name !== 'Airbnb'
                  ? `${a.person.first_name} ${a.person.last_name || ''}`.trim()
                  : null;

                let displayName;
                if (a.airbnb_uid) {
                  displayName = personName
                    || (a.notes?.match(/Imported from Airbnb: (.+)/)?.[1])
                    || 'Airbnb Guest';
                } else {
                  displayName = personName || 'Unknown';
                }

                return {
                  start: parseAustinDate(a.start_date),
                  end: parseAustinDate(a.end_date),
                  type: a.airbnb_uid ? 'airbnb' : 'tenant',
                  name: displayName
                };
              }),
              ...blockedRanges.map(r => ({
                start: parseAustinDate(r.start),
                end: parseAustinDate(r.end),
                type: 'blocked',
                name: 'Blocked'
              }))
            ].filter(r => r.end >= today).sort((a, b) => a.start - b.start);

            // Find current Airbnb guest
            const currentAirbnb = occupiedRanges.find(r => r.start <= today && r.end >= today && r.type === 'airbnb');
            // Find current direct guest (tenant or blocked)
            const currentDirect = occupiedRanges.find(r => r.start <= today && r.end >= today && (r.type === 'tenant' || r.type === 'blocked'));

            // Render cell content
            const renderCell = (occupant) => {
              if (!occupant) {
                return '<span class="empty">-</span>';
              }
              const endDate = fmtDateLocal(occupant.end);
              if (occupant.type === 'blocked') {
                return `<div class="guest-name blocked">Blocked</div><div class="guest-dates">until ${endDate}</div>`;
              }
              return `<div class="guest-name ${occupant.type}">${occupant.name}</div><div class="guest-dates">until ${endDate}</div>`;
            };

            return `
              <tr>
                <td class="space-name">${space.name}</td>
                <td class="occupancy-cell">${renderCell(currentAirbnb)}</td>
                <td class="occupancy-cell">${renderCell(currentDirect)}</td>
              </tr>
            `;
          }).join('');

          linkedSpacesList.innerHTML = `
            <table class="occupancy-table">
              <thead>
                <tr>
                  <th>Space</th>
                  <th class="col-airbnb">Airbnb</th>
                  <th class="col-direct">Direct</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          `;
        } else {
          linkedSpacesList.innerHTML = '<p class="text-muted">No spaces linked to Airbnb. Add Airbnb iCal URLs in space settings.</p>';
        }
      } catch (error) {
        console.error('Error loading Airbnb rentals:', error);
      }
    }

    function setupAirbnbSyncListeners() {
      const syncBtn = document.getElementById('syncAirbnbBtn');
      if (syncBtn && !syncBtn.dataset.initialized) {
        syncBtn.dataset.initialized = 'true';
        syncBtn.addEventListener('click', triggerAirbnbSync);
      }
    }

    async function triggerAirbnbSync() {
      const syncBtn = document.getElementById('syncAirbnbBtn');
      const resultsDiv = document.getElementById('airbnbSyncResults');
      const resultsContent = document.getElementById('syncResultsContent');

      syncBtn.disabled = true;
      syncBtn.textContent = 'Syncing...';

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/airbnb-sync`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          },
        });

        const result = await response.json();

        if (result.success) {
          // Update last sync time
          document.getElementById('lastSyncTime').textContent = formatDateTimeFull(new Date(), true);

          // Build blocked dates display
          let blockedDatesHtml = '';
          if (result.results && result.results.length > 0) {
            const spacesWithBlocks = result.results.filter(r => r.blockedRanges && r.blockedRanges.length > 0);
            if (spacesWithBlocks.length > 0) {
              blockedDatesHtml = `
                <p style="margin-top: 1rem;"><strong>Blocked Dates (owner blocks in Airbnb):</strong></p>
                <div style="font-size: 0.875rem; color: var(--text-muted);">
                  ${spacesWithBlocks.map(space => {
                    const ranges = space.blockedRanges.map(r => {
                      const start = formatDateAustin(r.start, { month: 'short', day: 'numeric' });
                      const end = formatDateAustin(r.end, { month: 'short', day: 'numeric' });
                      return `${start} - ${end}`;
                    }).join(', ');
                    return `<p><strong>${space.spaceName}:</strong> ${ranges}</p>`;
                  }).join('')}
                </div>
              `;
            }
          }

          // Show results
          resultsDiv.classList.remove('hidden');
          resultsContent.innerHTML = `
            <p><strong>Summary:</strong></p>
            <ul>
              <li>Spaces processed: ${result.summary.spacesProcessed}</li>
              <li>Bookings created: ${result.summary.totalCreated}</li>
              <li>Bookings updated: ${result.summary.totalUpdated}</li>
              <li>Skipped (unchanged/past/blocked): ${result.summary.totalSkipped}</li>
              ${result.summary.totalErrors > 0 ? `<li style="color: var(--error);">Errors: ${result.summary.totalErrors}</li>` : ''}
            </ul>
            ${blockedDatesHtml}
          `;

          showToast(`Sync complete: ${result.summary.totalCreated} new bookings imported`, 'success');

          // Reload the Airbnb rentals list to show updated data
          await loadAirbnbRentals();
        } else {
          throw new Error(result.error || 'Sync failed');
        }
      } catch (error) {
        console.error('Airbnb sync error:', error);
        showToast(`Sync failed: ${error.message}`, 'error');
      } finally {
        syncBtn.disabled = false;
        syncBtn.textContent = 'Sync Now';
      }
    }

    // =============================================
    // USERS TAB
    // =============================================

    async function loadUsersPanel() {
      usersLoaded = true;

      // Check if user is admin
      const isAdmin = authState?.isAdmin;

      // Show/hide admin-only elements
      const adminNotice = document.getElementById('usersAdminNotice');
      const inviteSection = document.getElementById('usersInviteSection');

      if (!isAdmin) {
        adminNotice.classList.remove('hidden');
        inviteSection.style.display = 'none';
      } else {
        adminNotice.classList.add('hidden');
        inviteSection.style.display = 'block';
      }

      // Load data
      await loadUsersData();
      await loadInvitationsData();
      renderUsersPanel();

      // Setup event listeners for invite form (only once)
      const inviteForm = document.getElementById('inviteForm');
      if (inviteForm && !inviteForm.dataset.initialized) {
        inviteForm.dataset.initialized = 'true';
        inviteForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('inviteEmail').value.trim().toLowerCase();
          const role = document.getElementById('inviteRole').value;
          await inviteUser(email, role);
        });
      }

      // Setup invitation modal listeners (only once)
      const closeInviteModalBtn = document.getElementById('closeInviteModalBtn');
      const closeInviteModal = document.getElementById('closeInviteModal');
      const copyInviteTextBtn = document.getElementById('copyInviteTextBtn');
      const sendInviteEmailBtn = document.getElementById('sendInviteEmailBtn');

      if (closeInviteModalBtn && !closeInviteModalBtn.dataset.initialized) {
        closeInviteModalBtn.dataset.initialized = 'true';
        closeInviteModalBtn.addEventListener('click', closeInviteTextModal);
      }
      if (closeInviteModal && !closeInviteModal.dataset.initialized) {
        closeInviteModal.dataset.initialized = 'true';
        closeInviteModal.addEventListener('click', closeInviteTextModal);
      }
      if (copyInviteTextBtn && !copyInviteTextBtn.dataset.initialized) {
        copyInviteTextBtn.dataset.initialized = 'true';
        copyInviteTextBtn.addEventListener('click', copyInviteText);
      }
      if (sendInviteEmailBtn && !sendInviteEmailBtn.dataset.initialized) {
        sendInviteEmailBtn.dataset.initialized = 'true';
        sendInviteEmailBtn.addEventListener('click', sendInviteEmail);
      }
    }

    async function loadUsersData() {
      const { data, error } = await supabase
        .from('app_users')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error loading users:', error);
        return;
      }

      allUsers = data || [];
    }

    async function loadInvitationsData() {
      const { data, error } = await supabase
        .from('user_invitations')
        .select('*')
        .eq('status', 'pending')
        .order('invited_at', { ascending: false });

      if (error) {
        console.error('Error loading invitations:', error);
        return;
      }

      allInvitations = data || [];
    }

    function renderUsersPanel() {
      renderInvitations();
      renderUsers();
    }

    function renderInvitations() {
      const pendingCount = document.getElementById('pendingCount');
      const pendingSection = document.getElementById('pendingSection');
      const isAdmin = authState?.isAdmin;

      pendingCount.textContent = allInvitations.length;

      if (allInvitations.length === 0) {
        pendingSection.innerHTML = `
          <div class="users-empty-state">
            No pending invitations
          </div>
        `;
        return;
      }

      pendingSection.innerHTML = `
        <div class="table-scroll-wrapper">
        <table class="users-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Invited</th>
              <th>Expires</th>
              ${isAdmin ? '<th>Actions</th>' : ''}
            </tr>
          </thead>
          <tbody>
            ${allInvitations.map(inv => `
              <tr>
                <td>${inv.email}</td>
                <td><span class="role-badge ${inv.role}">${inv.role}</span></td>
                <td>${formatDateAustin(inv.invited_at, { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                <td>${formatDateAustin(inv.expires_at, { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                ${isAdmin ? `
                  <td>
                    <button class="btn-danger" onclick="revokeInvitation('${inv.id}')">Revoke</button>
                  </td>
                ` : ''}
              </tr>
            `).join('')}
          </tbody>
        </table>
        </div>
      `;
    }

    function renderUsers() {
      const usersCount = document.getElementById('usersCount');
      const usersSection = document.getElementById('usersSection');
      const isAdmin = authState?.isAdmin;
      const currentUserId = authState?.appUser?.id;

      usersCount.textContent = allUsers.length;

      if (allUsers.length === 0) {
        usersSection.innerHTML = `
          <div class="users-empty-state">
            No users yet
          </div>
        `;
        return;
      }

      usersSection.innerHTML = `
        <div class="table-scroll-wrapper">
        <table class="users-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Last Login</th>
              ${isAdmin ? '<th>Actions</th>' : ''}
            </tr>
          </thead>
          <tbody>
            ${allUsers.map(u => {
              const isCurrentUser = u.id === currentUserId;
              return `
                <tr>
                  <td>
                    ${u.display_name || '-'}
                    ${isCurrentUser ? '<span class="you-tag">You</span>' : ''}
                  </td>
                  <td>${u.email}</td>
                  <td>
                    ${isAdmin && !isCurrentUser ? `
                      <select
                        class="role-select"
                        data-user-id="${u.id}"
                        onchange="updateUserRole('${u.id}', this.value)"
                      >
                        <option value="staff" ${u.role === 'staff' ? 'selected' : ''}>Staff</option>
                        <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                      </select>
                    ` : `
                      <span class="role-badge ${u.role}">${u.role}</span>
                    `}
                  </td>
                  <td>${u.last_login_at ? formatDateAustin(u.last_login_at, { month: 'short', day: 'numeric', year: 'numeric' }) : 'Never'}</td>
                  ${isAdmin ? `
                    <td>
                      ${isCurrentUser
                        ? '-'
                        : `<button class="btn-danger" onclick="removeUser('${u.id}')">Remove</button>`
                      }
                    </td>
                  ` : ''}
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        </div>
      `;
    }

    async function inviteUser(email, role) {
      // Validate email
      if (!email || !email.includes('@')) {
        showToast('Please enter a valid email address', 'warning');
        return;
      }

      // Check if user already exists
      const existing = allUsers.find(u => u.email.toLowerCase() === email);
      if (existing) {
        showToast('This user already has an account', 'warning');
        return;
      }

      // Check if invitation already pending
      const pendingInvite = allInvitations.find(i => i.email.toLowerCase() === email);
      if (pendingInvite) {
        showToast('An invitation is already pending for this email', 'warning');
        return;
      }

      try {
        const { error } = await supabase
          .from('user_invitations')
          .insert({
            email: email,
            role: role,
            invited_by: authState?.appUser?.id
          });

        if (error) throw error;

        document.getElementById('inviteEmail').value = '';

        await loadInvitationsData();
        renderUsersPanel();

        // Show invitation text modal
        showInvitationModal(email, role);

      } catch (error) {
        console.error('Error inviting user:', error);
        showToast('Failed to send invitation: ' + error.message, 'error');
      }
    }

    // Store current invitation details for sending email
    let currentInviteEmail = null;
    let currentInviteRole = null;

    function showInvitationModal(email, role) {
      currentInviteEmail = email;
      currentInviteRole = role;

      const roleDescription = role === 'admin'
        ? 'full admin access (view all spaces, occupant details, edit spaces, manage photos, and invite users)'
        : 'staff access (view all spaces and occupant details)';

      const inviteText = `Hi,

You've been invited to access AlpacApp as ${role === 'admin' ? 'an admin' : 'a staff member'}.

You will have ${roleDescription}.

To get started:
1. Go to: https://alpacaplayhouse.com/login/
2. Click "Sign in with Google" using this email address (${email})

Your access has already been pre-approved, so you'll have immediate access once you sign in.

If there are any problems or suggestions for improvements, please email them to alpacaplayhouse@gmail.com as soon as you can and they will be rapidly addressed.`;

      // Show modal
      const modal = document.getElementById('inviteTextModal');
      document.getElementById('inviteTextContent').value = inviteText;
      modal.classList.remove('hidden');
    }

    function copyInviteText() {
      const textarea = document.getElementById('inviteTextContent');
      textarea.select();
      document.execCommand('copy');
      showToast('Invitation text copied to clipboard', 'success');
    }

    function closeInviteTextModal() {
      document.getElementById('inviteTextModal').classList.add('hidden');
      currentInviteEmail = null;
      currentInviteRole = null;
    }

    async function sendInviteEmail() {
      if (!currentInviteEmail || !currentInviteRole) {
        showToast('No invitation to send', 'error');
        return;
      }

      const btn = document.getElementById('sendInviteEmailBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Sending...';
      btn.disabled = true;

      try {
        const loginUrl = 'https://alpacaplayhouse.com/login/';
        const emailResult = await emailService.sendStaffInvitation(currentInviteEmail, currentInviteRole, loginUrl);

        if (emailResult.success) {
          // Update email tracking in database
          const invitation = allInvitations.find(i => i.email.toLowerCase() === currentInviteEmail.toLowerCase());
          if (invitation) {
            await supabase
              .from('user_invitations')
              .update({
                email_sent_at: new Date().toISOString(),
                email_send_count: (invitation.email_send_count || 0) + 1
              })
              .eq('id', invitation.id);
          }

          showToast('Email sent to ' + currentInviteEmail, 'success');
          closeInviteTextModal();
          await loadInvitationsData();
          renderUsersPanel();
        } else {
          showToast('Failed to send email: ' + (emailResult.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Error sending invitation email:', error);
        showToast('Failed to send email: ' + error.message, 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    async function revokeInvitation(invitationId) {
      try {
        const { error } = await supabase
          .from('user_invitations')
          .update({ status: 'revoked' })
          .eq('id', invitationId);

        if (error) throw error;

        await loadInvitationsData();
        renderUsersPanel();
        showToast('Invitation revoked', 'success');

      } catch (error) {
        console.error('Error revoking invitation:', error);
        showToast('Failed to revoke: ' + error.message, 'error');
      }
    }

    async function updateUserRole(userId, newRole) {
      try {
        const { error } = await supabase
          .from('app_users')
          .update({ role: newRole })
          .eq('id', userId);

        if (error) throw error;

        await loadUsersData();
        renderUsersPanel();
        showToast('Role updated', 'success');

      } catch (error) {
        console.error('Error updating role:', error);
        showToast('Failed to update role: ' + error.message, 'error');
      }
    }

    async function removeUser(userId) {
      if (!confirm('Remove this user? They will no longer be able to access admin features.')) return;

      try {
        const { error } = await supabase
          .from('app_users')
          .delete()
          .eq('id', userId);

        if (error) throw error;

        await loadUsersData();
        renderUsersPanel();
        showToast('User removed', 'success');

      } catch (error) {
        console.error('Error removing user:', error);
        showToast('Failed to remove user: ' + error.message, 'error');
      }
    }

    // Make user management functions globally accessible
    window.revokeInvitation = revokeInvitation;
    window.updateUserRole = updateUserRole;
    window.removeUser = removeUser;

    // =============================================
    // TEMPLATES EDITOR
    // =============================================

    async function loadTemplatesPanel() {
      // Load lease placeholder reference
      const placeholders = leaseTemplateService.getAvailablePlaceholders();
      const placeholderList = document.getElementById('placeholderList');
      placeholderList.innerHTML = Object.entries(placeholders)
        .map(([key, desc]) => `
          <div class="placeholder-item">
            <code>{{${key}}}</code>
            <span class="placeholder-desc">${desc}</span>
          </div>
        `).join('');

      // Load active lease template
      try {
        const template = await leaseTemplateService.getActiveTemplate();
        if (template) {
          document.getElementById('templateName').value = template.name;
          document.getElementById('templateContent').value = template.content;
        } else {
          // Load default template
          document.getElementById('templateContent').value = leaseTemplateService.getDefaultTemplate();
        }
      } catch (e) {
        console.error('Error loading lease template:', e);
      }

      // Load template history
      await loadTemplateHistory();

      // Load SignWell config
      await loadSignwellConfig();

      // Load event placeholder reference
      const eventPlaceholders = eventTemplateService.getAvailablePlaceholders();
      const eventPlaceholderList = document.getElementById('eventPlaceholderList');
      if (eventPlaceholderList) {
        eventPlaceholderList.innerHTML = Object.entries(eventPlaceholders)
          .map(([key, desc]) => `
            <div class="placeholder-item">
              <code>{{${key}}}</code>
              <span class="placeholder-desc">${desc}</span>
            </div>
          `).join('');
      }

      // Load active event template
      try {
        const eventTemplate = await eventTemplateService.getActiveTemplate();
        if (eventTemplate) {
          document.getElementById('eventTemplateName').value = eventTemplate.name;
          document.getElementById('eventTemplateContent').value = eventTemplate.content;
        } else {
          // Load default template
          document.getElementById('eventTemplateContent').value = eventTemplateService.getDefaultTemplate();
        }
      } catch (e) {
        console.error('Error loading event template:', e);
      }

      // Load event template history
      await loadEventTemplateHistory();
    }

    async function loadTemplateHistory() {
      try {
        const templates = await leaseTemplateService.getAllTemplates();
        const tbody = document.getElementById('templateHistoryBody');

        if (templates.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No templates saved yet</td></tr>';
          return;
        }

        tbody.innerHTML = templates.map(t => `
          <tr>
            <td>${t.name}</td>
            <td>v${t.version}</td>
            <td>${formatDateAustin(t.created_at, { month: 'short', day: 'numeric', year: 'numeric' })}</td>
            <td>${t.is_active ? '<span class="status-badge active">Active</span>' : ''}</td>
            <td>
              <button class="btn-small" onclick="loadTemplate('${t.id}')">Load</button>
              ${!t.is_active ? `<button class="btn-small" onclick="setActiveTemplate('${t.id}')">Set Active</button>` : ''}
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Error loading template history:', e);
      }
    }

    window.loadTemplate = async function(templateId) {
      try {
        const { data, error } = await supabase
          .from('lease_templates')
          .select('*')
          .eq('id', templateId)
          .single();

        if (error) throw error;

        document.getElementById('templateName').value = data.name;
        document.getElementById('templateContent').value = data.content;
        showToast('Template loaded', 'success');
      } catch (e) {
        showToast('Error loading template: ' + e.message, 'error');
      }
    };

    window.setActiveTemplate = async function(templateId) {
      try {
        await leaseTemplateService.setActiveTemplate(templateId);
        await loadTemplateHistory();
        showToast('Template set as active', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    };

    async function saveTemplate() {
      const name = document.getElementById('templateName').value.trim();
      const content = document.getElementById('templateContent').value;
      const makeActive = document.getElementById('templateMakeActive').checked;

      if (!name) {
        showToast('Please enter a template name', 'warning');
        return;
      }

      if (!content.trim()) {
        showToast('Template content cannot be empty', 'warning');
        return;
      }

      // Validate template
      const validation = leaseTemplateService.validateTemplate(content);
      const validationDiv = document.getElementById('templateValidation');

      if (!validation.isValid) {
        validationDiv.innerHTML = `
          <div class="validation-error">
            <strong>Validation Errors:</strong>
            <ul>${validation.errors.map(e => `<li>${e}</li>`).join('')}</ul>
          </div>
        `;
        validationDiv.style.display = 'block';
        return;
      }

      if (validation.warnings.length > 0) {
        validationDiv.innerHTML = `
          <div class="validation-warning">
            <strong>Warnings:</strong>
            <ul>${validation.warnings.map(w => `<li>${w}</li>`).join('')}</ul>
          </div>
        `;
        validationDiv.style.display = 'block';
      } else {
        validationDiv.style.display = 'none';
      }

      try {
        await leaseTemplateService.saveTemplate(content, name, makeActive);
        await loadTemplateHistory();
        showToast('Template saved successfully!', 'success');
      } catch (e) {
        showToast('Error saving template: ' + e.message, 'error');
      }
    }

    function loadDefaultTemplate() {
      document.getElementById('templateContent').value = leaseTemplateService.getDefaultTemplate();
      document.getElementById('templateName').value = 'Standard Lease Agreement';
      showToast('Default template loaded', 'info');
    }

    // =============================================
    // EVENT TEMPLATE FUNCTIONS
    // =============================================

    async function loadEventTemplateHistory() {
      try {
        const templates = await eventTemplateService.getAllTemplates();
        const tbody = document.getElementById('eventTemplateHistoryBody');
        if (!tbody) return;

        if (templates.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No templates saved yet</td></tr>';
          return;
        }

        tbody.innerHTML = templates.map(t => `
          <tr>
            <td>${t.name}</td>
            <td>v${t.version}</td>
            <td>${formatDateAustin(t.created_at, { month: 'short', day: 'numeric', year: 'numeric' })}</td>
            <td>${t.is_active ? '<span class="status-badge active">Active</span>' : ''}</td>
            <td>
              <button class="btn-small" onclick="loadEventTemplate('${t.id}')">Load</button>
              ${!t.is_active ? `<button class="btn-small" onclick="setActiveEventTemplate('${t.id}')">Set Active</button>` : ''}
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Error loading event template history:', e);
      }
    }

    window.loadEventTemplate = async function(templateId) {
      try {
        const { data, error } = await supabase
          .from('event_agreement_templates')
          .select('*')
          .eq('id', templateId)
          .single();

        if (error) throw error;

        document.getElementById('eventTemplateName').value = data.name;
        document.getElementById('eventTemplateContent').value = data.content;
        showToast('Event template loaded', 'success');
      } catch (e) {
        showToast('Error loading event template: ' + e.message, 'error');
      }
    };

    window.setActiveEventTemplate = async function(templateId) {
      try {
        await eventTemplateService.setActiveTemplate(templateId);
        await loadEventTemplateHistory();
        showToast('Event template set as active', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    };

    async function saveEventTemplate() {
      const name = document.getElementById('eventTemplateName').value.trim();
      const content = document.getElementById('eventTemplateContent').value;
      const makeActive = document.getElementById('eventTemplateMakeActive').checked;

      if (!name) {
        showToast('Please enter a template name', 'warning');
        return;
      }

      if (!content.trim()) {
        showToast('Template content cannot be empty', 'warning');
        return;
      }

      // Validate template
      const validation = eventTemplateService.validateTemplate(content);
      const validationDiv = document.getElementById('eventTemplateValidation');

      if (!validation.isValid) {
        validationDiv.innerHTML = `
          <div class="validation-error">
            <strong>Validation Errors:</strong>
            <ul>${validation.errors.map(e => `<li>${e}</li>`).join('')}</ul>
          </div>
        `;
        validationDiv.style.display = 'block';
        return;
      }

      if (validation.warnings.length > 0) {
        validationDiv.innerHTML = `
          <div class="validation-warning">
            <strong>Warnings:</strong>
            <ul>${validation.warnings.map(w => `<li>${w}</li>`).join('')}</ul>
          </div>
        `;
        validationDiv.style.display = 'block';
      } else {
        validationDiv.style.display = 'none';
      }

      try {
        await eventTemplateService.saveTemplate(content, name, makeActive);
        await loadEventTemplateHistory();
        showToast('Event template saved successfully!', 'success');
      } catch (e) {
        showToast('Error saving event template: ' + e.message, 'error');
      }
    }

    function loadDefaultEventTemplate() {
      document.getElementById('eventTemplateContent').value = eventTemplateService.getDefaultTemplate();
      document.getElementById('eventTemplateName').value = 'Standard Event Agreement';
      showToast('Default event template loaded', 'info');
    }

    async function loadSignwellConfig() {
      try {
        const { data, error } = await supabase
          .from('signwell_config')
          .select('*')
          .single();

        if (data) {
          document.getElementById('signwellApiKey').value = data.api_key || '';
          document.getElementById('signwellTestMode').checked = data.test_mode !== false;
        }
      } catch (e) {
        console.error('Error loading SignWell config:', e);
      }
    }

    async function saveSignwellConfig() {
      const apiKey = document.getElementById('signwellApiKey').value.trim();
      const testMode = document.getElementById('signwellTestMode').checked;

      try {
        const { error } = await supabase
          .from('signwell_config')
          .upsert({
            id: 1,
            api_key: apiKey || null,
            test_mode: testMode,
            updated_at: new Date().toISOString(),
          });

        if (error) throw error;
        showToast('SignWell configuration saved', 'success');
      } catch (e) {
        showToast('Error saving config: ' + e.message, 'error');
      }
    }

    // =============================================
    // COPY TO CLIPBOARD
    // =============================================

    async function copyDepositRequest() {
      if (!currentApplicationId) return;
      try {
        const message = await rentalService.generateDepositRequestMessage(currentApplicationId);
        await navigator.clipboard.writeText(message);
        showToast('Payment instructions copied to clipboard', 'success');
      } catch (e) {
        showToast('Failed to copy: ' + e.message, 'error');
      }
    }

    async function markDepositRequested() {
      if (!currentApplicationId) return;
      try {
        await rentalService.requestDeposit(currentApplicationId);
        await loadApplications();

        // Send deposit request email
        const app = allApplications.find(a => a.id === currentApplicationId);
        if (app?.person?.email) {
          const emailResult = await emailService.sendDepositRequested(app);
          if (emailResult.success) {
            showToast('Deposit requested & email sent', 'success');
          } else {
            showToast('Deposit requested (email failed to send)', 'warning');
          }
        } else {
          showToast('Deposit requested (no email on file)', 'success');
        }

        openRentalDetail(currentApplicationId);
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    // =============================================
    // RENTALS EVENT LISTENERS
    // =============================================

    function setupRentalsEventListeners() {
      // Create application form
      document.getElementById('createApplicationForm')?.addEventListener('submit', handleCreateApplication);

      // Add payment method button
      document.getElementById('addPaymentMethodBtn')?.addEventListener('click', () => openPaymentMethodModal());

      // Payment method modal
      document.getElementById('closePaymentMethodModal')?.addEventListener('click', closePaymentMethodModal);
      document.getElementById('cancelPaymentMethodBtn')?.addEventListener('click', closePaymentMethodModal);
      document.getElementById('savePaymentMethodBtn')?.addEventListener('click', savePaymentMethod);
      document.getElementById('deletePaymentMethodBtn')?.addEventListener('click', deletePaymentMethod);

      // Rental detail modal
      document.getElementById('closeRentalDetail')?.addEventListener('click', closeRentalDetail);

      // Detail tabs
      document.querySelectorAll('.detail-tab').forEach(tab => {
        tab.addEventListener('click', () => switchDetailTab(tab.dataset.detailTab));
      });

      // New lease agreement actions
      document.getElementById('previewLeaseBtn')?.addEventListener('click', previewLease);
      document.getElementById('generatePdfBtn')?.addEventListener('click', generateLeasePdf);
      document.getElementById('sendForSignatureBtn')?.addEventListener('click', sendForSignature);
      document.getElementById('checkSignatureStatusBtn')?.addEventListener('click', () => {
        showToast('Checking signature status...', 'info');
        // TODO: signwellService.getDocumentStatus()
      });
      document.getElementById('resendSignatureBtn')?.addEventListener('click', () => {
        showToast('Resending signature request...', 'info');
        // TODO: signwellService.resendRequest()
      });
      document.getElementById('createTemplateLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab('templates'); // Switch to templates tab
        showToast('Create a lease template in the Templates tab', 'info');
      });

      // Templates panel event listeners - Template type selector
      document.getElementById('templateTypeSelector')?.addEventListener('change', (e) => {
        const type = e.target.value;
        document.getElementById('leaseTemplateSection').style.display = type === 'lease' ? 'block' : 'none';
        document.getElementById('eventTemplateSection').style.display = type === 'event' ? 'block' : 'none';
      });

      // Templates panel event listeners - Lease templates
      document.getElementById('loadDefaultTemplateBtn')?.addEventListener('click', loadDefaultTemplate);
      document.getElementById('saveTemplateBtn')?.addEventListener('click', saveTemplate);
      document.getElementById('saveSignwellConfigBtn')?.addEventListener('click', saveSignwellConfig);

      // Templates panel event listeners - Event templates
      document.getElementById('loadDefaultEventTemplateBtn')?.addEventListener('click', loadDefaultEventTemplate);
      document.getElementById('saveEventTemplateBtn')?.addEventListener('click', saveEventTemplate);

      // Legacy manual agreement actions (backwards compatibility)
      document.getElementById('markAgreementGenerated')?.addEventListener('click', async () => {
        if (!currentApplicationId) return;
        const url = document.getElementById('agreementDocUrl').value.trim();
        try {
          await rentalService.updateAgreementStatus(currentApplicationId, 'generated', url || null);
          await loadApplications();
          openRentalDetail(currentApplicationId);
          showToast('Agreement marked as generated', 'success');
        } catch (error) {
          showToast('Error: ' + error.message, 'error');
        }
      });
      document.getElementById('markAgreementSent')?.addEventListener('click', markAgreementSent);
      document.getElementById('markAgreementSigned')?.addEventListener('click', markAgreementSigned);

      // Deposit actions
      document.getElementById('recordMoveInDepositBtn')?.addEventListener('click', () => openRecordDepositModal('move_in'));
      document.getElementById('recordSecurityDepositBtn')?.addEventListener('click', () => openRecordDepositModal('security'));
      document.getElementById('copyDepositRequestBtn')?.addEventListener('click', copyDepositRequest);
      document.getElementById('markDepositRequestedBtn')?.addEventListener('click', markDepositRequested);
      document.getElementById('confirmDepositBtn')?.addEventListener('click', confirmDeposit);

      // Record deposit modal
      document.getElementById('closeRecordDepositModal')?.addEventListener('click', closeRecordDepositModal);
      document.getElementById('cancelRecordDepositBtn')?.addEventListener('click', closeRecordDepositModal);
      document.getElementById('confirmRecordDepositBtn')?.addEventListener('click', confirmRecordDeposit);

      // Event detail modal
      document.getElementById('closeEventDetail')?.addEventListener('click', closeEventDetail);

      // Event detail tabs
      document.querySelectorAll('.event-detail-tab').forEach(tab => {
        tab.addEventListener('click', () => switchToEventTab(tab.dataset.eventTab));
      });

      // Event terms
      document.getElementById('saveEventTermsBtn')?.addEventListener('click', saveEventTerms);

      // Event documents
      document.getElementById('previewEventLeaseBtn')?.addEventListener('click', previewEventAgreement);
      document.getElementById('generateEventPdfBtn')?.addEventListener('click', generateEventPdf);
      document.getElementById('createEventTemplateLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        closeEventDetail();
        switchTab('templates');
        document.getElementById('templateTypeSelector').value = 'event';
        document.getElementById('leaseTemplateSection').style.display = 'none';
        document.getElementById('eventTemplateSection').style.display = 'block';
        showToast('Create an event template below', 'info');
      });

      // Close modals on backdrop click
      document.getElementById('rentalDetailModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'rentalDetailModal') closeRentalDetail();
      });
      document.getElementById('paymentMethodModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'paymentMethodModal') closePaymentMethodModal();
      });
      document.getElementById('recordDepositModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'recordDepositModal') closeRecordDepositModal();
      });
      document.getElementById('eventDetailModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'eventDetailModal') closeEventDetail();
      });
    }

    init();
  </script>
</body>
</html>
