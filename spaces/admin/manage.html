<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage - AlpacAPPs Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css?v=4">
  <link rel="stylesheet" href="styles.css?v=4">
  <link rel="stylesheet" href="media.css?v=4">
  <link rel="stylesheet" href="rentals.css?v=1">
  <style>
    .manage-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .manage-tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border);
      margin-bottom: 2rem;
    }

    .manage-tab {
      padding: 1rem 2rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .manage-tab:hover {
      color: var(--text);
    }

    .manage-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .manage-panel {
      display: none;
    }

    .manage-panel.active {
      display: block;
    }

    .section {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .section-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .section-header h2 {
      font-size: 1.125rem;
      font-weight: 600;
    }

    .filter-checkboxes {
      display: flex;
      gap: 1rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.875rem;
      color: var(--text);
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      margin: 0;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .section-filters {
      padding: 1rem 1.5rem;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .filter-row {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    .filter-group label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .filter-group input[type="text"],
    .filter-group select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.875rem;
      min-width: 140px;
    }

    .filter-group input[type="text"]:focus,
    .filter-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .filter-checkboxes-group {
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-checkboxes-group > label {
      display: none;
    }

    .filter-checkboxes-group .filter-checkboxes {
      height: 36px;
      display: flex;
      align-items: center;
    }

    @media (max-width: 900px) {
      .filter-row {
        flex-wrap: wrap;
      }
      .filter-group {
        flex: 1;
        min-width: 140px;
      }
    }

    .section-body {
      padding: 1.5rem;
    }

    /* Spaces list */
    .spaces-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .space-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--bg);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .space-item:hover {
      border-color: var(--accent);
    }

    .space-item-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .space-item-thumb {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: var(--radius);
      cursor: pointer;
      transition: opacity 0.15s ease;
    }

    .space-item-thumb:hover {
      opacity: 0.8;
    }

    .space-item-meta {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-left: auto;
      margin-right: 1rem;
    }

    .space-type {
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius);
      font-size: 0.75rem;
      font-weight: 500;
      background: #f1f5f9;
      color: #64748b;
    }

    /* Lightbox */
    .lightbox-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      cursor: pointer;
    }

    .lightbox-overlay.hidden {
      display: none;
    }

    .lightbox-overlay img {
      max-width: 90vw;
      max-height: 90vh;
      object-fit: contain;
      border-radius: var(--radius);
    }

    .lightbox-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .space-item-thumb-placeholder {
      width: 48px;
      height: 48px;
      background: var(--border);
      border-radius: var(--radius);
    }

    .space-item-details h3 {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.125rem;
    }

    .space-item-details small {
      color: var(--text-muted);
    }

    .space-item-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Add space form */
    .add-space-form {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
    }

    .add-space-form .form-group {
      margin-bottom: 0;
    }

    @media (max-width: 768px) {
      .add-space-form {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Lightbox -->
  <div id="lightboxOverlay" class="lightbox-overlay hidden" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
    <img id="lightboxImage" src="" alt="Full size image">
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <div id="unauthorizedOverlay" class="loading-overlay hidden">
    <div class="unauthorized-card">
      <h2>Access Denied</h2>
      <p>Only admins can access the Manage section.</p>
      <div class="unauthorized-actions">
        <a href="/GenAlpacaOps/spaces/admin/" class="btn-secondary">Back to Admin</a>
        <button id="signOutBtn" class="btn-secondary">Sign Out</button>
      </div>
    </div>
  </div>

  <div id="appContent" class="hidden">
    <header>
      <div class="header-left">
        <h1>&#129433; AlpacAPPs Admin</h1>
        <span class="role-badge">Admin</span>
      </div>
      <div class="header-controls">
        <a href="/GenAlpacaOps/spaces/admin/" class="btn-small">‚Üê Back to Spaces</a>
        <a href="/GenAlpacaOps/spaces/" class="btn-small">Public View</a>
        <span id="userInfo" class="user-info"></span>
        <button id="headerSignOutBtn" class="btn-secondary">Sign Out</button>
      </div>
    </header>

    <div class="manage-container">
      <div class="manage-tabs">
        <button class="manage-tab active" data-tab="spaces">Spaces</button>
        <button class="manage-tab" data-tab="rentals">Rentals</button>
        <button class="manage-tab" data-tab="media">Media</button>
        <button class="manage-tab" data-tab="users">Users</button>
        <button class="manage-tab" data-tab="settings">Settings</button>
      </div>

      <!-- Spaces Panel -->
      <div id="spacesPanel" class="manage-panel active">
        <div class="section">
          <div class="section-header">
            <h2>Add New Space</h2>
          </div>
          <div class="section-body">
            <form id="addSpaceForm" class="add-space-form">
              <div class="form-group">
                <label for="newSpaceName">Name *</label>
                <input type="text" id="newSpaceName" required placeholder="e.g., Garden Suite">
              </div>
              <div class="form-group">
                <label for="newSpaceParent">Parent Space</label>
                <select id="newSpaceParent">
                  <option value="">None (top-level)</option>
                </select>
              </div>
              <button type="submit" class="btn-primary">Add Space</button>
            </form>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>All Spaces</h2>
            <span id="spacesCount" class="text-muted"></span>
          </div>
          <div class="section-filters">
            <div class="filter-row">
              <div class="filter-group">
                <label for="searchFilter">Search</label>
                <input type="text" id="searchFilter" placeholder="Search spaces...">
              </div>
              <div class="filter-group">
                <label for="parentFilter">Parent Area</label>
                <select id="parentFilter">
                  <option value="">All areas</option>
                </select>
              </div>
              <div class="filter-group filter-checkboxes-group">
                <label>Type</label>
                <div class="filter-checkboxes">
                  <label class="checkbox-label"><input type="checkbox" id="showDwellings" checked> Dwelling</label>
                  <label class="checkbox-label"><input type="checkbox" id="showNonDwellings"> Non-dwelling</label>
                </div>
              </div>
              <button id="clearSpaceFilters" class="btn-small" style="align-self: flex-end;">Clear</button>
            </div>
          </div>
          <div class="section-body">
            <div id="spacesList" class="spaces-list">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <div class="section" id="archivedSection" style="display: none;">
          <div class="section-header">
            <h2>Archived Spaces</h2>
            <span id="archivedCount" class="text-muted"></span>
          </div>
          <div class="section-body">
            <p class="form-hint" style="margin-bottom: 1rem;">These spaces are hidden from all views but can be restored.</p>
            <div id="archivedSpacesList" class="spaces-list">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- Rentals Panel -->
      <div id="rentalsPanel" class="manage-panel">
        <!-- Pipeline View -->
        <div class="rental-pipeline" id="rentalPipeline">
          <div class="pipeline-column" data-stage="applications">
            <div class="pipeline-header">
              <h3>Applications</h3>
              <span class="pipeline-count" id="applicationsCount">0</span>
            </div>
            <div class="pipeline-cards" id="applicationsCards"></div>
          </div>
          <div class="pipeline-column" data-stage="approved">
            <div class="pipeline-header">
              <h3>Approved</h3>
              <span class="pipeline-count" id="approvedCount">0</span>
            </div>
            <div class="pipeline-cards" id="approvedCards"></div>
          </div>
          <div class="pipeline-column" data-stage="contract">
            <div class="pipeline-header">
              <h3>Contract</h3>
              <span class="pipeline-count" id="contractCount">0</span>
            </div>
            <div class="pipeline-cards" id="contractCards"></div>
          </div>
          <div class="pipeline-column" data-stage="deposit">
            <div class="pipeline-header">
              <h3>Deposit</h3>
              <span class="pipeline-count" id="depositCount">0</span>
            </div>
            <div class="pipeline-cards" id="depositCards"></div>
          </div>
          <div class="pipeline-column" data-stage="ready">
            <div class="pipeline-header">
              <h3>Ready</h3>
              <span class="pipeline-count" id="readyCount">0</span>
            </div>
            <div class="pipeline-cards" id="readyCards"></div>
          </div>
        </div>

        <!-- Denied/Delayed Section (collapsible) -->
        <details class="section" id="deniedDelayedSection" style="margin-top: 1.5rem;">
          <summary class="section-header" style="cursor: pointer;">
            <h2>Denied & Delayed</h2>
            <span id="deniedDelayedCount" class="text-muted">0</span>
          </summary>
          <div class="section-body">
            <div id="deniedDelayedList" class="spaces-list"></div>
          </div>
        </details>

        <!-- Payment Methods Section -->
        <div class="section" style="margin-top: 1.5rem;">
          <div class="section-header">
            <h2>Payment Methods</h2>
            <button class="btn-small btn-primary" id="addPaymentMethodBtn">+ Add Method</button>
          </div>
          <div class="section-body">
            <div id="paymentMethodsList" class="payment-methods-grid"></div>
          </div>
        </div>

        <!-- Create Test Application (for development) -->
        <div class="section" style="margin-top: 1.5rem;">
          <div class="section-header">
            <h2>Create Application</h2>
          </div>
          <div class="section-body">
            <form id="createApplicationForm" class="add-space-form">
              <div class="form-group">
                <label for="newAppPersonId">Person</label>
                <select id="newAppPersonId" required>
                  <option value="">Select a person...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="newAppSpaceId">Desired Space</label>
                <select id="newAppSpaceId">
                  <option value="">Any / Flexible</option>
                </select>
              </div>
              <button type="submit" class="btn-primary">Create Application</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Media Panel -->
      <div id="mediaPanel" class="manage-panel">
        <!-- Storage indicator -->
        <div class="storage-banner">
          <div id="storageIndicator" class="storage-indicator-inline"></div>
        </div>

        <!-- Filters and actions bar -->
        <div class="media-toolbar">
          <div class="toolbar-left">
            <div class="filter-group">
              <label>Category:</label>
              <select id="categoryFilter">
                <option value="">All</option>
                <option value="mktg">Marketing</option>
                <option value="projects">Projects</option>
                <option value="archive">Archive</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Tags:</label>
              <div id="tagFilterChips" class="tag-filter-chips"></div>
            </div>
            <button id="clearFilters" class="btn-small">Clear Filters</button>
          </div>
          <div class="toolbar-right">
            <span id="mediaCount" class="media-count">0 items</span>
            <button id="bulkTagBtn" class="btn-small" disabled>Edit Tags (<span id="selectedCount">0</span>)</button>
            <button id="selectAllBtn" class="btn-small">Select All</button>
            <button id="deselectAllBtn" class="btn-small hidden">Deselect All</button>
          </div>
        </div>

        <!-- Media grid -->
        <div id="mediaGrid" class="media-library-grid">
          <!-- Media items populated by JS -->
        </div>

        <div id="emptyState" class="empty-state hidden">
          <p>No media found.</p>
          <p class="hint">Upload some images from a space's edit page.</p>
        </div>
      </div>

      <!-- Users Panel -->
      <div id="usersPanel" class="manage-panel">
        <div class="section">
          <div class="section-header">
            <h2>User Management</h2>
          </div>
          <div class="section-body">
            <p>Go to <a href="users.html">User Management</a> to invite users and manage roles.</p>
          </div>
        </div>
      </div>

      <!-- Settings Panel -->
      <div id="settingsPanel" class="manage-panel">
        <!-- Lease Template Section -->
        <div class="section">
          <div class="section-header">
            <h2>Lease Agreement Template</h2>
            <div class="header-actions">
              <button type="button" id="loadDefaultTemplateBtn" class="btn-small">Load Default</button>
              <button type="button" id="saveTemplateBtn" class="btn-small btn-primary">Save Template</button>
            </div>
          </div>
          <div class="section-body">
            <p class="text-muted" style="margin-bottom: 1rem;">
              Edit the lease agreement template below. Use <code>{{placeholder}}</code> syntax for dynamic fields.
              The template uses Markdown formatting: <code># Header</code>, <code>**bold**</code>, <code>- bullet list</code>, <code>---</code> for horizontal rule.
            </p>

            <div class="template-editor-container">
              <div class="template-editor">
                <label for="templateName">Template Name</label>
                <input type="text" id="templateName" value="Standard Lease Agreement" style="margin-bottom: 1rem;">

                <label for="templateContent">Template Content</label>
                <textarea id="templateContent" class="template-textarea" rows="20" placeholder="Enter lease template content..."></textarea>
              </div>

              <div class="placeholder-reference">
                <h4>Available Placeholders</h4>
                <div id="placeholderList" class="placeholder-list"></div>
              </div>
            </div>

            <div class="template-actions" style="margin-top: 1rem;">
              <label class="checkbox-label">
                <input type="checkbox" id="templateMakeActive" checked>
                Set as active template
              </label>
            </div>

            <div id="templateValidation" class="template-validation" style="display: none; margin-top: 1rem;"></div>
          </div>
        </div>

        <!-- Template History Section -->
        <div class="section">
          <div class="section-header">
            <h2>Template History</h2>
          </div>
          <div class="section-body">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Version</th>
                  <th>Created</th>
                  <th>Active</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="templateHistoryBody">
                <tr><td colspan="5" class="text-muted">No templates saved yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- SignWell Configuration -->
        <div class="section">
          <div class="section-header">
            <h2>SignWell Integration</h2>
          </div>
          <div class="section-body">
            <p class="text-muted" style="margin-bottom: 1rem;">
              Configure SignWell for electronic signature collection. Get your API key from
              <a href="https://www.signwell.com/api/" target="_blank">signwell.com/api</a>.
            </p>
            <div class="form-group">
              <label for="signwellApiKey">API Key</label>
              <input type="password" id="signwellApiKey" placeholder="Enter SignWell API key...">
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="signwellTestMode" checked>
                Test Mode (documents won't be sent for real signatures)
              </label>
            </div>
            <button type="button" id="saveSignwellConfigBtn" class="btn-small btn-primary">Save SignWell Config</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Media Detail/Edit Modal -->
  <div id="mediaDetailModal" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Media Details</h2>
        <button class="modal-close" id="closeMediaDetail">&times;</button>
      </div>
      <div class="modal-body">
        <div class="media-detail-layout">
          <div class="media-preview">
            <img id="detailImage" src="" alt="Media preview">
          </div>
          <div class="media-details">
            <div class="form-group">
              <label for="detailCaption">Caption</label>
              <input type="text" id="detailCaption" placeholder="Add a caption...">
            </div>
            <div class="form-group">
              <label for="detailCategory">Category</label>
              <select id="detailCategory">
                <option value="mktg">Marketing</option>
                <option value="projects">Projects</option>
                <option value="archive">Archive</option>
              </select>
            </div>
            <fieldset class="form-fieldset">
              <legend>Tags</legend>
              <div id="detailTagsContainer" class="tags-container"></div>
            </fieldset>
            <div class="media-meta">
              <p><strong>Size:</strong> <span id="detailSize">-</span></p>
              <p><strong>Dimensions:</strong> <span id="detailDimensions">-</span></p>
              <p><strong>Uploaded:</strong> <span id="detailDate">-</span></p>
              <p><strong>Used in:</strong> <span id="detailSpaces">-</span></p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="deleteMediaBtn" class="btn-danger">Delete Permanently</button>
        <div class="footer-right">
          <button id="cancelMediaDetail" class="btn-secondary">Cancel</button>
          <button id="saveMediaDetail" class="btn-primary">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rental Application Detail Modal -->
  <div id="rentalDetailModal" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="rentalDetailTitle">Application Details</h2>
        <span id="rentalDetailStatus" class="status-badge"></span>
        <span id="rentalDetailTestBadge" class="status-badge test" style="display: none; background: #f59e0b; color: white;">TEST</span>
        <button class="modal-close" id="closeRentalDetail">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Modal tabs -->
        <div class="detail-tabs">
          <button class="detail-tab active" data-detail-tab="applicant">Applicant</button>
          <button class="detail-tab" data-detail-tab="terms">Terms</button>
          <button class="detail-tab" data-detail-tab="documents">Documents</button>
          <button class="detail-tab" data-detail-tab="deposits">Deposits</button>
          <button class="detail-tab" data-detail-tab="rent">Rent</button>
          <button class="detail-tab" data-detail-tab="history">History</button>
        </div>

        <!-- Applicant Tab -->
        <div id="applicantTab" class="detail-tab-content active">
          <div class="applicant-info">
            <div class="form-grid">
              <div class="info-group">
                <label>Name</label>
                <p id="applicantName">-</p>
              </div>
              <div class="info-group">
                <label>Email</label>
                <p id="applicantEmail">-</p>
              </div>
              <div class="info-group">
                <label>Phone</label>
                <p id="applicantPhone">-</p>
              </div>
              <div class="info-group">
                <label>Desired Space</label>
                <p id="applicantDesiredSpace">-</p>
              </div>
              <div class="info-group">
                <label>Desired Move-in</label>
                <p id="applicantDesiredMoveIn">-</p>
              </div>
              <div class="info-group">
                <label>Submitted</label>
                <p id="applicantSubmittedAt">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Terms Tab -->
        <div id="termsTab" class="detail-tab-content">
          <form id="termsForm" class="terms-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="termSpace">Space *</label>
                <select id="termSpace" required>
                  <option value="">Select space...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="termRate">Rate *</label>
                <div class="rate-input-group">
                  <span class="rate-prefix">$</span>
                  <input type="number" id="termRate" min="0" step="1" required>
                  <select id="termRateTerm">
                    <option value="monthly">/ month</option>
                    <option value="weekly">/ week</option>
                    <option value="nightly">/ night</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label for="termMoveIn">Move-in Date *</label>
                <input type="date" id="termMoveIn" required>
              </div>
              <div class="form-group">
                <label for="termLeaseEnd">Lease End Date</label>
                <input type="date" id="termLeaseEnd">
                <small class="form-hint">Leave blank for open-ended</small>
              </div>
              <div class="form-group">
                <label for="termNoticePeriod">Termination Notice</label>
                <select id="termNoticePeriod">
                  <option value="none">None (fixed-length lease)</option>
                  <option value="1_day">1 day notice</option>
                  <option value="1_week">1 week notice</option>
                  <option value="30_days" selected>30 days notice</option>
                  <option value="60_days">60 days notice</option>
                </select>
                <small class="form-hint">Required notice to terminate. Select "None" for fixed-length leases.</small>
              </div>
              <div class="form-group">
                <label for="termSecurityDeposit">Security Deposit</label>
                <input type="number" id="termSecurityDeposit" min="0" step="1" value="0">
                <small class="form-hint">Can be $0. Move-in deposit is always 1 period's rent.</small>
              </div>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label for="termAdditionalTerms">Additional Terms</label>
              <textarea id="termAdditionalTerms" rows="4" placeholder="Any additional terms or conditions to include in the rental agreement..."></textarea>
              <small class="form-hint">Will appear in the "Additional Terms" section of the rental agreement.</small>
            </div>
          </form>
        </div>

        <!-- Documents Tab -->
        <div id="documentsTab" class="detail-tab-content">
          <div class="documents-section">
            <!-- Agreement Status -->
            <div class="document-status">
              <h4>Rental Agreement Status</h4>
              <p id="agreementStatusDisplay" class="status-badge">Pending</p>
            </div>

            <!-- Generate Section (shown when no PDF yet) -->
            <div id="generateSection" class="generate-section">
              <h4>Generate Lease Agreement</h4>
              <p class="text-muted" style="margin-bottom: 1rem;">Preview the lease agreement and generate a PDF for signing.</p>
              <div id="leasePreviewContainer" class="lease-preview-container">
                <div id="leasePreview" class="lease-preview"></div>
              </div>
              <div class="generate-actions" style="margin-top: 1rem;">
                <button type="button" id="previewLeaseBtn" class="btn-small">Preview Agreement</button>
                <button type="button" id="generatePdfBtn" class="btn-small btn-primary">Generate PDF</button>
              </div>
              <p id="noTemplateWarning" class="warning-text" style="display: none; margin-top: 0.5rem;">
                No active lease template found. <a href="#" id="createTemplateLink">Create one</a> in the Templates section.
              </p>
            </div>

            <!-- Generated PDF Section (shown after PDF is generated) -->
            <div id="pdfSection" class="pdf-section" style="display: none;">
              <h4>Generated Document</h4>
              <div class="pdf-info">
                <a id="pdfDownloadLink" href="#" target="_blank" class="pdf-link">
                  <span class="pdf-icon">üìÑ</span>
                  <span id="pdfFilename">lease-agreement.pdf</span>
                </a>
                <span id="pdfGeneratedAt" class="text-muted"></span>
              </div>
              <div class="pdf-actions" style="margin-top: 1rem;">
                <button type="button" id="regeneratePdfBtn" class="btn-small">Regenerate</button>
                <button type="button" id="sendForSignatureBtn" class="btn-small btn-primary">Send for Signature</button>
              </div>
            </div>

            <!-- Signature Section (shown after sent for signature) -->
            <div id="signatureSection" class="signature-section" style="display: none;">
              <h4>Signature Status</h4>
              <p id="signatureStatusText">Awaiting signature...</p>
              <div id="signedPdfSection" style="display: none; margin-top: 1rem;">
                <a id="signedPdfLink" href="#" target="_blank" class="pdf-link">
                  <span class="pdf-icon">‚úÖ</span>
                  <span>Download Signed Agreement</span>
                </a>
              </div>
              <div class="signature-actions" style="margin-top: 1rem;">
                <button type="button" id="checkSignatureStatusBtn" class="btn-small">Check Status</button>
                <button type="button" id="resendSignatureBtn" class="btn-small">Resend Request</button>
              </div>
            </div>

            <!-- Legacy Manual Section (collapsible, for backwards compatibility) -->
            <details class="legacy-section" style="margin-top: 1.5rem;">
              <summary class="text-muted" style="cursor: pointer;">Manual Document Entry</summary>
              <div style="padding-top: 1rem;">
                <div class="form-group">
                  <label for="agreementDocUrl">Document URL</label>
                  <input type="text" id="agreementDocUrl" placeholder="Paste document URL manually...">
                </div>
                <div class="document-actions" style="margin-top: 1rem;">
                  <button type="button" id="markAgreementGenerated" class="btn-small">Mark as Generated</button>
                  <button type="button" id="markAgreementSent" class="btn-small">Mark as Sent</button>
                  <button type="button" id="markAgreementSigned" class="btn-small btn-primary">Mark as Signed</button>
                </div>
              </div>
            </details>
          </div>
        </div>

        <!-- Deposits Tab -->
        <div id="depositsTab" class="detail-tab-content">
          <div class="deposits-grid">
            <div class="deposit-card">
              <h4>Move-in Deposit</h4>
              <p class="deposit-amount" id="moveInDepositAmount">$0</p>
              <p class="deposit-status" id="moveInDepositStatus">Pending</p>
              <button type="button" id="recordMoveInDepositBtn" class="btn-small btn-primary">Record Payment</button>
            </div>
            <div class="deposit-card">
              <h4>Security Deposit</h4>
              <p class="deposit-amount" id="securityDepositAmount">$0</p>
              <p class="deposit-status" id="securityDepositStatus">Pending</p>
              <button type="button" id="recordSecurityDepositBtn" class="btn-small btn-primary">Record Payment</button>
            </div>
          </div>
          <div class="proration-section" style="margin-top: 1.5rem;">
            <h4>Proration Calculator</h4>
            <div id="prorationDetails" class="proration-details"></div>
          </div>
          <div class="deposit-request-section" style="margin-top: 1.5rem;">
            <h4>Request Deposit</h4>
            <button type="button" id="copyDepositRequestBtn" class="btn-small">Copy Payment Instructions</button>
            <button type="button" id="markDepositRequestedBtn" class="btn-small">Mark as Requested</button>
            <button type="button" id="confirmDepositBtn" class="btn-small btn-primary">Confirm Deposit</button>
          </div>
        </div>

        <!-- Rent Tab -->
        <div id="rentTab" class="detail-tab-content">
          <div class="rent-summary">
            <p><strong>Monthly Rent:</strong> <span id="rentMonthlyAmount">$0</span></p>
          </div>
          <div class="rent-history" style="margin-top: 1rem;">
            <h4>Payment History</h4>
            <table id="rentHistoryTable" class="data-table">
              <thead>
                <tr><th>Period</th><th>Amount</th><th>Paid</th><th>Method</th></tr>
              </thead>
              <tbody id="rentHistoryBody">
                <tr><td colspan="4" class="text-muted">No payments recorded</td></tr>
              </tbody>
            </table>
          </div>
          <button type="button" id="recordRentPaymentBtn" class="btn-small btn-primary" style="margin-top: 1rem;">Record Rent Payment</button>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="detail-tab-content">
          <div id="applicationHistory" class="application-history">
            <p class="text-muted">Application timeline will appear here.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div id="rentalActions" class="rental-action-buttons"></div>
      </div>
    </div>
  </div>

  <!-- Payment Method Modal -->
  <div id="paymentMethodModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="paymentMethodModalTitle">Add Payment Method</h2>
        <button class="modal-close" id="closePaymentMethodModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="paymentMethodForm">
          <input type="hidden" id="paymentMethodId">
          <div class="form-group">
            <label for="paymentMethodName">Name *</label>
            <input type="text" id="paymentMethodName" required placeholder="e.g., Venmo">
          </div>
          <div class="form-group">
            <label for="paymentMethodType">Type *</label>
            <select id="paymentMethodType" required>
              <option value="venmo">Venmo</option>
              <option value="zelle">Zelle</option>
              <option value="paypal">PayPal</option>
              <option value="bank_ach">Bank ACH</option>
            </select>
          </div>
          <div class="form-group">
            <label for="paymentMethodIdentifier">Account Identifier</label>
            <input type="text" id="paymentMethodIdentifier" placeholder="@username, email, or phone">
          </div>
          <div class="form-group">
            <label for="paymentMethodInstructions">Instructions</label>
            <textarea id="paymentMethodInstructions" rows="3" placeholder="Payment instructions..."></textarea>
          </div>
          <label class="checkbox-label">
            <input type="checkbox" id="paymentMethodActive" checked>
            Active (shown to tenants)
          </label>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="deletePaymentMethodBtn" class="btn-danger" style="display: none;">Delete</button>
        <div class="footer-right">
          <button type="button" id="cancelPaymentMethodBtn" class="btn-secondary">Cancel</button>
          <button type="button" id="savePaymentMethodBtn" class="btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Record Deposit Modal -->
  <div id="recordDepositModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="recordDepositTitle">Record Deposit</h2>
        <button class="modal-close" id="closeRecordDepositModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="recordDepositForm">
          <input type="hidden" id="depositType">
          <div class="form-group">
            <label>Amount</label>
            <input type="text" id="depositAmount" readonly>
          </div>
          <div class="form-group">
            <label for="depositMethod">Payment Method *</label>
            <select id="depositMethod" required>
              <option value="">Select method...</option>
              <option value="venmo">Venmo</option>
              <option value="zelle">Zelle</option>
              <option value="paypal">PayPal</option>
              <option value="bank_ach">Bank ACH</option>
              <option value="cash">Cash</option>
              <option value="check">Check</option>
            </select>
          </div>
          <div class="form-group">
            <label for="depositTransactionId">Transaction ID (optional)</label>
            <input type="text" id="depositTransactionId" placeholder="Reference number...">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelRecordDepositBtn" class="btn-secondary">Cancel</button>
        <button type="button" id="confirmRecordDepositBtn" class="btn-primary">Record Payment</button>
      </div>
    </div>
  </div>

  <!-- Bulk Tag Edit Modal -->
  <div id="bulkTagModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Tags for <span id="bulkCount">0</span> Items</h2>
        <button class="modal-close" id="closeBulkTag">&times;</button>
      </div>
      <div class="modal-body">
        <p class="form-hint" style="margin-bottom: 1rem;">Select tags to add or remove from all selected items.</p>
        <div class="bulk-tag-actions">
          <div class="bulk-action-group">
            <h4>Add Tags</h4>
            <div id="bulkAddTags" class="tags-container"></div>
          </div>
          <div class="bulk-action-group">
            <h4>Remove Tags</h4>
            <div id="bulkRemoveTags" class="tags-container"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelBulkTag" class="btn-secondary">Cancel</button>
        <button id="applyBulkTags" class="btn-primary">Apply Changes</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3"></script>
  <script type="module">
    import { supabase } from '../../shared/supabase.js';
    import { initAuth, getAuthState, signOut, onAuthStateChange } from '../../shared/auth.js';
    import { mediaService } from '../../shared/media-service.js';
    import { rentalService } from '../../shared/rental-service.js';
    import { leaseTemplateService } from '../../shared/lease-template-service.js';
    import { pdfService } from '../../shared/pdf-service.js';

    // =============================================
    // TOAST NOTIFICATIONS
    // =============================================
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = {
        success: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>',
        error: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>',
        warning: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
        info: '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>'
      };

      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
      `;

      container.appendChild(toast);

      if (duration > 0) {
        setTimeout(() => {
          toast.classList.add('toast-exit');
          setTimeout(() => toast.remove(), 200);
        }, duration);
      }
    }

    // =============================================
    // STATE
    // =============================================
    let authState = null;
    let allSpaces = [];
    let allMedia = [];
    let allTags = [];
    let selectedMediaIds = new Set();
    let currentFilters = { category: '', tags: [] };
    let currentMediaId = null;
    let mediaLoaded = false;

    // Rentals state
    let allApplications = [];
    let allPeople = [];
    let allPaymentMethods = [];
    let currentApplicationId = null;
    let rentalsLoaded = false;

    // =============================================
    // AUTH HANDLING
    // =============================================
    function handleAuthState(state) {
      authState = state;
      if (state.appUser && state.appUser.role === 'admin') {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('appContent').classList.remove('hidden');
        document.getElementById('userInfo').textContent = state.appUser.display_name || state.appUser.email;
        loadSpaces();
      } else if (state.appUser) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('unauthorizedOverlay').classList.remove('hidden');
      } else if (state.isAuthenticated && state.isUnauthorized) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('unauthorizedOverlay').classList.remove('hidden');
      } else if (!state.isAuthenticated) {
        window.location.href = '/GenAlpacaOps/login/?redirect=' + encodeURIComponent(window.location.pathname);
      }
    }

    // =============================================
    // INITIALIZATION
    // =============================================
    async function init() {
      await initAuth();
      authState = getAuthState();
      onAuthStateChange(handleAuthState);
      handleAuthState(authState);

      // Sign out handlers
      document.getElementById('signOutBtn')?.addEventListener('click', () => signOut());
      document.getElementById('headerSignOutBtn').addEventListener('click', () => signOut());

      // Tab switching
      document.querySelectorAll('.manage-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.manage-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.manage-panel').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');

          // Load media when switching to Media tab
          if (tab.dataset.tab === 'media' && !mediaLoaded) {
            loadMediaLibrary();
          }

          // Load rentals when switching to Rentals tab
          if (tab.dataset.tab === 'rentals' && !rentalsLoaded) {
            loadRentals();
          }

          // Load settings when switching to Settings tab
          if (tab.dataset.tab === 'settings') {
            loadSettingsPanel();
          }
        });
      });

      // Also expose switchTab function for programmatic use
      window.switchTab = function(tabName) {
        const tab = document.querySelector(`.manage-tab[data-tab="${tabName}"]`);
        if (tab) tab.click();
      };

      // Add space form
      document.getElementById('addSpaceForm').addEventListener('submit', handleAddSpace);

      // Space filters
      document.getElementById('searchFilter').addEventListener('input', renderSpaces);
      document.getElementById('parentFilter').addEventListener('change', renderSpaces);
      document.getElementById('showDwellings').addEventListener('change', renderSpaces);
      document.getElementById('showNonDwellings').addEventListener('change', renderSpaces);
      document.getElementById('clearSpaceFilters').addEventListener('click', () => {
        document.getElementById('searchFilter').value = '';
        document.getElementById('parentFilter').value = '';
        document.getElementById('showDwellings').checked = true;
        document.getElementById('showNonDwellings').checked = false;
        renderSpaces();
      });

      // Media library event listeners
      setupMediaEventListeners();

      // Rentals event listeners
      setupRentalsEventListeners();
    }

    // =============================================
    // SPACES TAB
    // =============================================
    let archivedSpaces = [];

    async function loadSpaces() {
      // Load all spaces with primary media for thumbnails
      const { data, error } = await supabase
        .from('spaces')
        .select(`
          id, name, parent_id, can_be_dwelling, type, is_listed, monthly_rate, is_archived, bath_privacy,
          media_spaces(
            display_order,
            is_primary,
            media:media_id(url)
          )
        `)
        .order('name');

      if (error) {
        console.error('Error loading spaces:', error);
        return;
      }

      const allData = (data || []).map(space => {
        // Get the primary photo or first photo
        const mediaSpaces = space.media_spaces || [];
        const primaryMedia = mediaSpaces.find(ms => ms.is_primary) ||
                            mediaSpaces.sort((a, b) => (a.display_order || 0) - (b.display_order || 0))[0];
        space.thumbnail = primaryMedia?.media?.url || null;
        return space;
      });

      // Split into active and archived (is_archived column may not exist yet)
      allSpaces = allData.filter(s => !s.is_archived);
      archivedSpaces = allData.filter(s => s.is_archived === true);

      renderSpaces();
      renderArchivedSpaces();
      populateParentDropdown();
      populateParentFilterDropdown();
    }

    function getFilteredSpaces() {
      const searchTerm = document.getElementById('searchFilter').value.toLowerCase().trim();
      const parentId = document.getElementById('parentFilter').value;
      const showDwellings = document.getElementById('showDwellings').checked;
      const showNonDwellings = document.getElementById('showNonDwellings').checked;

      let filtered = allSpaces.filter(space => {
        // Search filter
        if (searchTerm && !space.name.toLowerCase().includes(searchTerm)) {
          return false;
        }

        // Parent filter - match direct parent or any ancestor
        if (parentId) {
          if (!isDescendantOf(space, parentId)) {
            return false;
          }
        }

        // Dwelling/Non-dwelling filter
        const isDwelling = space.can_be_dwelling === true;
        if (isDwelling && !showDwellings) return false;
        if (!isDwelling && !showNonDwellings) return false;

        return true;
      });

      // Sort: dwellings first, then by name
      filtered.sort((a, b) => {
        const aIsDwelling = a.can_be_dwelling === true;
        const bIsDwelling = b.can_be_dwelling === true;
        if (aIsDwelling && !bIsDwelling) return -1;
        if (!aIsDwelling && bIsDwelling) return 1;
        return a.name.localeCompare(b.name);
      });

      return filtered;
    }

    // Check if a space is a descendant of a given parent
    function isDescendantOf(space, parentId) {
      if (space.parent_id === parentId) return true;
      if (!space.parent_id) return false;
      const parent = allSpaces.find(s => s.id === space.parent_id);
      if (!parent) return false;
      return isDescendantOf(parent, parentId);
    }

    function populateParentFilterDropdown() {
      const select = document.getElementById('parentFilter');
      // Get top-level spaces and major parent areas
      const parentAreas = allSpaces
        .filter(s => !s.parent_id || allSpaces.some(child => child.parent_id === s.id))
        .sort((a, b) => a.name.localeCompare(b.name));

      select.innerHTML = '<option value="">All areas</option>' +
        parentAreas.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    function renderSpaces() {
      const container = document.getElementById('spacesList');
      const filtered = getFilteredSpaces();
      document.getElementById('spacesCount').textContent = `${filtered.length} spaces`;

      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-muted">No spaces match the current filters.</p>';
        return;
      }

      container.innerHTML = filtered.map(space => {
        const parent = allSpaces.find(s => s.id === space.parent_id);
        const thumbHtml = space.thumbnail
          ? `<img src="${space.thumbnail}" alt="${space.name}" class="space-item-thumb" onclick="event.stopPropagation(); openLightbox('${space.thumbnail}')">`
          : `<div class="space-item-thumb-placeholder"></div>`;

        return `
          <div class="space-item">
            <div class="space-item-info">
              ${thumbHtml}
              <div class="space-item-details">
                <h3>${space.name}</h3>
                <small>
                  ${parent ? `in ${parent.name}` : 'Top-level'}
                  ${space.monthly_rate ? ` ‚Ä¢ $${space.monthly_rate}/mo` : ''}
                </small>
              </div>
            </div>
            <div class="space-item-meta">
              ${space.type ? `<span class="space-type">${space.type}</span>` : ''}
            </div>
            <div class="space-item-actions">
              <a href="/GenAlpacaOps/spaces/admin/?edit=${space.id}" class="btn-small">Edit</a>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderArchivedSpaces() {
      const section = document.getElementById('archivedSection');
      const container = document.getElementById('archivedSpacesList');
      const countEl = document.getElementById('archivedCount');

      if (archivedSpaces.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      countEl.textContent = `${archivedSpaces.length} archived`;

      container.innerHTML = archivedSpaces.map(space => {
        const thumbHtml = space.thumbnail
          ? `<img src="${space.thumbnail}" alt="${space.name}" class="space-item-thumb" onclick="event.stopPropagation(); openLightbox('${space.thumbnail}')">`
          : `<div class="space-item-thumb-placeholder"></div>`;
        return `
          <div class="space-item" style="opacity: 0.7;">
            <div class="space-item-info">
              ${thumbHtml}
              <div class="space-item-details">
                <h3>${space.name}</h3>
                <small>Archived</small>
              </div>
            </div>
            <div class="space-item-actions">
              <button class="btn-small btn-primary" onclick="unarchiveSpace('${space.id}', '${space.name.replace(/'/g, "\\'")}')">Restore</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function populateParentDropdown() {
      const select = document.getElementById('newSpaceParent');
      select.innerHTML = '<option value="">None (top-level)</option>' +
        allSpaces.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    async function handleAddSpace(e) {
      e.preventDefault();
      const name = document.getElementById('newSpaceName').value.trim();
      const parentId = document.getElementById('newSpaceParent').value || null;

      if (!name) {
        showToast('Name is required', 'warning');
        return;
      }

      const { data, error } = await supabase
        .from('spaces')
        .insert({ name, parent_id: parentId, can_be_dwelling: true, is_listed: false })
        .select();

      if (error) {
        showToast('Error creating space: ' + error.message, 'error');
        return;
      }

      document.getElementById('newSpaceName').value = '';
      document.getElementById('newSpaceParent').value = '';
      loadSpaces();
      showToast('Space created! You can now edit it from the main admin page.', 'success');
    }

    window.unarchiveSpace = async function(id, name) {
      if (!confirm(`Restore "${name}"? It will appear in the main spaces list again.`)) return;

      const { error } = await supabase
        .from('spaces')
        .update({ is_archived: false })
        .eq('id', id);

      if (error) {
        showToast('Error restoring space: ' + error.message, 'error');
        return;
      }
      loadSpaces();
      showToast('Space restored', 'success');
    };

    window.deleteSpace = async function(id, name) {
      if (!confirm(`Permanently delete "${name}"? This cannot be undone.\n\nConsider archiving instead if you might need it later.`)) return;

      const { error } = await supabase.from('spaces').delete().eq('id', id);
      if (error) {
        showToast('Error deleting space: ' + error.message, 'error');
        return;
      }
      loadSpaces();
      showToast('Space deleted', 'success');
    };

    // =============================================
    // MEDIA TAB
    // =============================================
    async function loadMediaLibrary() {
      mediaLoaded = true;
      await Promise.all([loadStorageUsage(), loadTags(), loadMedia()]);
    }

    async function loadStorageUsage() {
      const usage = await mediaService.getStorageUsage();
      if (!usage) return;

      const indicator = document.getElementById('storageIndicator');
      const percent = usage.percent_used;
      let statusClass = 'storage-ok';
      if (percent >= 90) statusClass = 'storage-critical';
      else if (percent >= 70) statusClass = 'storage-warning';

      indicator.className = `storage-indicator-inline ${statusClass}`;
      indicator.innerHTML = `
        <div class="storage-bar">
          <div class="storage-fill" style="width: ${Math.min(percent, 100)}%"></div>
        </div>
        <span class="storage-text">
          ${mediaService.formatBytes(usage.current_bytes)} / ${mediaService.formatBytes(usage.limit_bytes)}
          (${percent.toFixed(1)}%)
        </span>
      `;
    }

    async function loadTags() {
      allTags = await mediaService.getTags();
      renderTagFilters();
    }

    async function loadMedia() {
      const media = await mediaService.search({
        category: currentFilters.category || null,
        tags: currentFilters.tags,
        limit: 200,
      });
      allMedia = media;
      renderMediaGrid();
      updateMediaCount();
    }

    function renderTagFilters() {
      const container = document.getElementById('tagFilterChips');
      if (!container) return;

      container.innerHTML = allTags.map(tag => `
        <button type="button" class="tag-filter-chip ${currentFilters.tags.includes(tag.name) ? 'active' : ''}"
          data-tag="${tag.name}" style="${tag.color ? `--tag-color: ${tag.color}` : ''}">
          ${tag.name}
        </button>
      `).join('');

      container.querySelectorAll('.tag-filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const tagName = chip.dataset.tag;
          if (currentFilters.tags.includes(tagName)) {
            currentFilters.tags = currentFilters.tags.filter(t => t !== tagName);
            chip.classList.remove('active');
          } else {
            currentFilters.tags.push(tagName);
            chip.classList.add('active');
          }
          loadMedia();
        });
      });
    }

    function renderMediaGrid() {
      const grid = document.getElementById('mediaGrid');
      const emptyState = document.getElementById('emptyState');
      if (!grid) return;

      if (allMedia.length === 0) {
        grid.innerHTML = '';
        emptyState?.classList.remove('hidden');
        return;
      }

      emptyState?.classList.add('hidden');

      grid.innerHTML = allMedia.map(media => {
        const tags = media.tags || [];
        const spacesLinked = media.spaces?.length || 0;
        const isSelected = selectedMediaIds.has(media.id);

        return `
          <div class="media-grid-item ${isSelected ? 'selected' : ''}" data-id="${media.id}">
            <div class="select-checkbox" data-action="select">‚úì</div>
            <span class="category-badge">${media.category || 'mktg'}</span>
            ${spacesLinked > 0 ? `<span class="spaces-count">${spacesLinked} space${spacesLinked > 1 ? 's' : ''}</span>` : ''}
            <div class="media-thumb">
              <img src="${media.url}" alt="${media.caption || 'Media'}" loading="lazy">
            </div>
            <div class="media-info">
              <div class="media-caption ${!media.caption ? 'no-caption' : ''}">${media.caption || 'No caption'}</div>
              <div class="media-meta">
                <span>${media.file_size_bytes ? mediaService.formatBytes(media.file_size_bytes) : '-'}</span>
                <span>${formatDate(media.uploaded_at)}</span>
              </div>
              <div class="media-tags">
                ${tags.slice(0, 4).map(t => `<span class="media-tag" style="${t.color ? `border-left: 2px solid ${t.color}` : ''}">${t.name}</span>`).join('')}
                ${tags.length > 4 ? `<span class="media-tag">+${tags.length - 4}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');

      grid.querySelectorAll('.media-grid-item').forEach(item => {
        item.addEventListener('click', (e) => {
          const mediaId = item.dataset.id;
          if (e.target.closest('[data-action="select"]')) {
            toggleSelection(mediaId);
            return;
          }
          openMediaDetail(mediaId);
        });
      });
    }

    function updateMediaCount() {
      const el = document.getElementById('mediaCount');
      if (el) el.textContent = `${allMedia.length} items`;
    }

    function toggleSelection(mediaId) {
      if (selectedMediaIds.has(mediaId)) {
        selectedMediaIds.delete(mediaId);
      } else {
        selectedMediaIds.add(mediaId);
      }
      updateSelectionUI();
    }

    function selectAll() {
      allMedia.forEach(m => selectedMediaIds.add(m.id));
      updateSelectionUI();
    }

    function deselectAll() {
      selectedMediaIds.clear();
      updateSelectionUI();
    }

    function updateSelectionUI() {
      const count = selectedMediaIds.size;
      const countEl = document.getElementById('selectedCount');
      const bulkBtn = document.getElementById('bulkTagBtn');
      const selectAllBtn = document.getElementById('selectAllBtn');
      const deselectAllBtn = document.getElementById('deselectAllBtn');

      if (countEl) countEl.textContent = count;
      if (bulkBtn) bulkBtn.disabled = count === 0;

      if (count > 0) {
        selectAllBtn?.classList.add('hidden');
        deselectAllBtn?.classList.remove('hidden');
      } else {
        selectAllBtn?.classList.remove('hidden');
        deselectAllBtn?.classList.add('hidden');
      }

      document.querySelectorAll('.media-grid-item').forEach(item => {
        item.classList.toggle('selected', selectedMediaIds.has(item.dataset.id));
      });
    }

    // =============================================
    // MEDIA DETAIL MODAL
    // =============================================
    async function openMediaDetail(mediaId) {
      const media = allMedia.find(m => m.id === mediaId);
      if (!media) return;

      currentMediaId = mediaId;

      document.getElementById('detailImage').src = media.url;
      document.getElementById('detailCaption').value = media.caption || '';
      document.getElementById('detailCategory').value = media.category || 'mktg';

      document.getElementById('detailSize').textContent = media.file_size_bytes ? mediaService.formatBytes(media.file_size_bytes) : 'Unknown';
      document.getElementById('detailDimensions').textContent = media.width && media.height ? `${media.width} √ó ${media.height}` : 'Unknown';
      document.getElementById('detailDate').textContent = formatDate(media.uploaded_at, true);

      const spacesLinked = media.spaces?.map(s => {
        const space = allSpaces.find(sp => sp.id === s.space_id);
        return space?.name || 'Unknown';
      }).join(', ') || 'None';
      document.getElementById('detailSpaces').textContent = spacesLinked;

      const groupedTags = await mediaService.getTagsGrouped();
      const mediaTags = media.tags?.map(t => t.name) || [];
      renderDetailTags(groupedTags, mediaTags);

      document.getElementById('mediaDetailModal').classList.remove('hidden');
    }

    function renderDetailTags(groupedTags, selectedTags) {
      const container = document.getElementById('detailTagsContainer');
      if (!container) return;

      const groupNames = Object.keys(groupedTags).sort();
      container.innerHTML = `
        ${groupNames.filter(g => groupedTags[g]?.length > 0).map(group => `
          <div class="tag-group">
            <span class="tag-group-label">${group}</span>
            <div class="tag-checkboxes">
              ${groupedTags[group].map(tag => `
                <label class="tag-checkbox">
                  <input type="checkbox" name="detailTag" value="${tag.name}" ${selectedTags.includes(tag.name) ? 'checked' : ''}>
                  <span class="tag-chip" style="--tag-color: ${tag.color || 'var(--accent)'}">${tag.name}</span>
                </label>
              `).join('')}
            </div>
          </div>
        `).join('')}
      `;
    }

    async function saveMediaDetail() {
      if (!currentMediaId) return;

      const caption = document.getElementById('detailCaption').value.trim();
      const category = document.getElementById('detailCategory').value;
      const selectedTags = Array.from(document.querySelectorAll('#detailTagsContainer input[name="detailTag"]:checked')).map(cb => cb.value);

      const { error } = await supabase.from('media').update({ caption, category }).eq('id', currentMediaId);
      if (error) {
        showToast('Failed to save: ' + error.message, 'error');
        return;
      }

      await supabase.from('media_tag_assignments').delete().eq('media_id', currentMediaId);
      if (selectedTags.length > 0) {
        await mediaService.assignTags(currentMediaId, selectedTags);
      }

      closeMediaDetail();
      await loadMedia();
    }

    function closeMediaDetail() {
      document.getElementById('mediaDetailModal').classList.add('hidden');
      currentMediaId = null;
    }

    async function deleteCurrentMedia() {
      if (!currentMediaId) return;

      const media = allMedia.find(m => m.id === currentMediaId);
      const spacesCount = media?.spaces?.length || 0;

      let confirmMsg = 'Are you sure you want to permanently delete this image?';
      if (spacesCount > 0) {
        confirmMsg = `This image is linked to ${spacesCount} space(s). Deleting it will remove it from all spaces.\n\nAre you sure you want to permanently delete it?`;
      }

      if (!confirm(confirmMsg)) return;

      const result = await mediaService.delete(currentMediaId);
      if (!result.success) {
        showToast('Failed to delete: ' + result.error, 'error');
        return;
      }

      closeMediaDetail();
      await loadMedia();
      await loadStorageUsage();
    }

    // =============================================
    // BULK TAG MODAL
    // =============================================
    async function openBulkTagModal() {
      if (selectedMediaIds.size === 0) return;

      document.getElementById('bulkCount').textContent = selectedMediaIds.size;
      const groupedTags = await mediaService.getTagsGrouped();
      renderBulkTags('bulkAddTags', groupedTags);
      renderBulkTags('bulkRemoveTags', groupedTags);
      document.getElementById('bulkTagModal').classList.remove('hidden');
    }

    function renderBulkTags(containerId, groupedTags) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const groupNames = Object.keys(groupedTags).sort();
      container.innerHTML = groupNames.filter(g => groupedTags[g]?.length > 0).map(group => `
        <div class="tag-group">
          <span class="tag-group-label">${group}</span>
          <div class="tag-checkboxes">
            ${groupedTags[group].map(tag => `
              <label class="tag-checkbox">
                <input type="checkbox" name="${containerId}Tag" value="${tag.name}">
                <span class="tag-chip" style="--tag-color: ${tag.color || 'var(--accent)'}">${tag.name}</span>
              </label>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    async function applyBulkTags() {
      const tagsToAdd = Array.from(document.querySelectorAll('#bulkAddTags input[name="bulkAddTagsTag"]:checked')).map(cb => cb.value);
      const tagsToRemove = Array.from(document.querySelectorAll('#bulkRemoveTags input[name="bulkRemoveTagsTag"]:checked')).map(cb => cb.value);

      if (tagsToAdd.length === 0 && tagsToRemove.length === 0) {
        showToast('Please select at least one tag to add or remove', 'warning');
        return;
      }

      const { data: tagRecords } = await supabase.from('media_tags').select('id, name').in('name', tagsToRemove);
      const tagIdMap = new Map(tagRecords?.map(t => [t.name, t.id]) || []);

      for (const mediaId of selectedMediaIds) {
        if (tagsToAdd.length > 0) await mediaService.assignTags(mediaId, tagsToAdd);
        for (const tagName of tagsToRemove) {
          const tagId = tagIdMap.get(tagName);
          if (tagId) await mediaService.removeTag(mediaId, tagId);
        }
      }

      closeBulkTagModal();
      deselectAll();
      await loadMedia();
    }

    function closeBulkTagModal() {
      document.getElementById('bulkTagModal').classList.add('hidden');
    }

    // =============================================
    // MEDIA EVENT LISTENERS
    // =============================================
    function setupMediaEventListeners() {
      document.getElementById('categoryFilter')?.addEventListener('change', (e) => {
        currentFilters.category = e.target.value;
        loadMedia();
      });

      document.getElementById('clearFilters')?.addEventListener('click', () => {
        currentFilters = { category: '', tags: [] };
        document.getElementById('categoryFilter').value = '';
        document.querySelectorAll('.tag-filter-chip').forEach(c => c.classList.remove('active'));
        loadMedia();
      });

      document.getElementById('selectAllBtn')?.addEventListener('click', selectAll);
      document.getElementById('deselectAllBtn')?.addEventListener('click', deselectAll);
      document.getElementById('bulkTagBtn')?.addEventListener('click', openBulkTagModal);

      document.getElementById('closeMediaDetail')?.addEventListener('click', closeMediaDetail);
      document.getElementById('cancelMediaDetail')?.addEventListener('click', closeMediaDetail);
      document.getElementById('saveMediaDetail')?.addEventListener('click', saveMediaDetail);
      document.getElementById('deleteMediaBtn')?.addEventListener('click', deleteCurrentMedia);

      document.getElementById('closeBulkTag')?.addEventListener('click', closeBulkTagModal);
      document.getElementById('cancelBulkTag')?.addEventListener('click', closeBulkTagModal);
      document.getElementById('applyBulkTags')?.addEventListener('click', applyBulkTags);

      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.classList.add('hidden');
        });
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeMediaDetail();
          closeBulkTagModal();
        }
      });
    }

    // =============================================
    // UTILITIES
    // =============================================
    function formatDate(dateStr, full = false) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      if (full) {
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      }
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Lightbox functions
    function openLightbox(url) {
      const overlay = document.getElementById('lightboxOverlay');
      const img = document.getElementById('lightboxImage');
      img.src = url;
      overlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      const overlay = document.getElementById('lightboxOverlay');
      overlay.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Close lightbox on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeLightbox();
      }
    });

    // =============================================
    // RENTALS TAB
    // =============================================

    async function loadRentals() {
      rentalsLoaded = true;
      await Promise.all([
        loadApplications(),
        loadPeople(),
        loadPaymentMethods(),
      ]);
      populateRentalDropdowns();
    }

    async function loadApplications() {
      try {
        allApplications = await rentalService.getApplications();
        renderPipeline();
        renderDeniedDelayed();
      } catch (error) {
        console.error('Error loading applications:', error);
      }
    }

    async function loadPeople() {
      try {
        const { data, error } = await supabase
          .from('people')
          .select('id, first_name, last_name, email, type')
          .order('first_name');
        if (error) throw error;
        allPeople = data || [];
      } catch (error) {
        console.error('Error loading people:', error);
      }
    }

    async function loadPaymentMethods() {
      try {
        allPaymentMethods = await rentalService.getPaymentMethods(false);
        renderPaymentMethods();
      } catch (error) {
        console.error('Error loading payment methods:', error);
      }
    }

    function populateRentalDropdowns() {
      // Populate person dropdown
      const personSelect = document.getElementById('newAppPersonId');
      if (personSelect) {
        personSelect.innerHTML = '<option value="">Select a person...</option>' +
          allPeople.map(p => `<option value="${p.id}">${p.first_name || ''} ${p.last_name || ''} (${p.email || 'no email'})</option>`).join('');
      }

      // Populate space dropdown for new applications (no rate info - just space name)
      const spaceSelect = document.getElementById('newAppSpaceId');
      if (spaceSelect) {
        const dwellings = allSpaces.filter(s => s.can_be_dwelling);
        spaceSelect.innerHTML = '<option value="">Any / Flexible</option>' +
          dwellings.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
      }

      // Populate space dropdown for terms
      const termSpaceSelect = document.getElementById('termSpace');
      if (termSpaceSelect) {
        const dwellings = allSpaces.filter(s => s.can_be_dwelling);
        termSpaceSelect.innerHTML = '<option value="">Select space...</option>' +
          dwellings.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
      }
    }

    function renderPipeline() {
      const stages = ['applications', 'approved', 'contract', 'deposit', 'ready'];

      // Group applications by pipeline stage
      const grouped = {};
      stages.forEach(s => grouped[s] = []);

      allApplications.forEach(app => {
        const stage = rentalService.getPipelineStage(app);
        if (grouped[stage]) {
          grouped[stage].push(app);
        }
      });

      // Render each column
      stages.forEach(stage => {
        const container = document.getElementById(`${stage}Cards`);
        const countEl = document.getElementById(`${stage}Count`);
        const apps = grouped[stage] || [];

        if (countEl) countEl.textContent = apps.length;

        if (container) {
          if (apps.length === 0) {
            container.innerHTML = '<div class="pipeline-empty">No applications</div>';
          } else {
            container.innerHTML = apps.map(app => renderPipelineCard(app)).join('');

            // Add click handlers
            container.querySelectorAll('.pipeline-card').forEach(card => {
              card.addEventListener('click', () => openRentalDetail(card.dataset.id));
            });
          }
        }
      });
    }

    function renderPipelineCard(app) {
      const person = app.person || {};
      const space = app.approved_space || app.desired_space;
      const days = rentalService.daysSince(app.submitted_at);

      let subStatus = '';
      if (app.deposit_status && app.deposit_status !== 'pending') {
        subStatus = app.deposit_status;
      } else if (app.agreement_status && app.agreement_status !== 'pending') {
        subStatus = app.agreement_status;
      }

      const testBadge = app.is_test ? '<span class="test-badge">TEST</span>' : '';

      return `
        <div class="pipeline-card" data-id="${app.id}">
          <div class="card-header">
            <span class="applicant-name">${person.first_name || ''} ${person.last_name || ''}</span>
            ${testBadge}
            <span class="days-ago">${days}d</span>
          </div>
          <div class="card-body">
            <div class="space-name">${space?.name || 'Flexible'}</div>
            ${app.approved_rate ? `<div class="rate">$${app.approved_rate}/${app.approved_rate_term === 'weekly' ? 'wk' : app.approved_rate_term === 'nightly' ? 'night' : 'mo'}</div>` : ''}
          </div>
          ${subStatus ? `
            <div class="card-footer">
              <span class="sub-status">${subStatus}</span>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderDeniedDelayed() {
      const deniedDelayed = allApplications.filter(app =>
        app.application_status === 'denied' || app.application_status === 'delayed'
      );

      const container = document.getElementById('deniedDelayedList');
      const countEl = document.getElementById('deniedDelayedCount');

      if (countEl) countEl.textContent = deniedDelayed.length;

      if (container) {
        if (deniedDelayed.length === 0) {
          container.innerHTML = '<p class="text-muted">No denied or delayed applications.</p>';
        } else {
          container.innerHTML = deniedDelayed.map(app => {
            const person = app.person || {};
            return `
              <div class="space-item" style="cursor: pointer;" onclick="window.openRentalDetail('${app.id}')">
                <div class="space-item-info">
                  <div class="space-item-details">
                    <h3>${person.first_name || ''} ${person.last_name || ''}</h3>
                    <small>${app.application_status} - ${app.denial_reason || app.delay_reason || 'No reason given'}</small>
                  </div>
                </div>
                <div class="space-item-meta">
                  <span class="status-badge ${app.application_status}">${app.application_status}</span>
                </div>
              </div>
            `;
          }).join('');
        }
      }
    }

    function renderPaymentMethods() {
      const container = document.getElementById('paymentMethodsList');
      if (!container) return;

      if (allPaymentMethods.length === 0) {
        container.innerHTML = '<p class="text-muted">No payment methods configured.</p>';
        return;
      }

      container.innerHTML = allPaymentMethods.map(method => {
        const qrUrl = method.qr_code?.url;
        return `
          <div class="payment-method-card ${method.is_active ? '' : 'inactive'}" onclick="window.openPaymentMethodModal('${method.id}')">
            ${qrUrl
              ? `<div class="qr-code"><img src="${qrUrl}" alt="${method.name} QR"></div>`
              : `<div class="qr-placeholder">$</div>`
            }
            <div class="method-info">
              <div class="method-name">${method.name}</div>
              <div class="method-account">${method.account_identifier || '-'}</div>
              <div class="method-type">${method.method_type}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // =============================================
    // RENTAL DETAIL MODAL
    // =============================================

    async function openRentalDetail(applicationId) {
      currentApplicationId = applicationId;
      const app = allApplications.find(a => a.id === applicationId);
      if (!app) return;

      const person = app.person || {};
      const desiredSpace = app.desired_space;
      const approvedSpace = app.approved_space;

      // Update modal header
      document.getElementById('rentalDetailTitle').textContent =
        `${person.first_name || ''} ${person.last_name || ''}`;
      const statusBadge = document.getElementById('rentalDetailStatus');
      statusBadge.textContent = app.application_status;
      statusBadge.className = `status-badge ${app.application_status}`;

      // Show test badge if applicable
      const testBadge = document.getElementById('rentalDetailTestBadge');
      if (testBadge) {
        testBadge.style.display = app.is_test ? 'inline-block' : 'none';
      }

      // Applicant tab
      document.getElementById('applicantName').textContent =
        `${person.first_name || ''} ${person.last_name || ''}`.trim() || '-';
      document.getElementById('applicantEmail').textContent = person.email || '-';
      document.getElementById('applicantPhone').textContent = person.phone || '-';
      document.getElementById('applicantDesiredSpace').textContent = desiredSpace?.name || 'Flexible';
      document.getElementById('applicantDesiredMoveIn').textContent =
        app.desired_move_in ? rentalService.formatDate(app.desired_move_in) : '-';
      document.getElementById('applicantSubmittedAt').textContent =
        rentalService.formatDate(app.submitted_at);

      // Terms tab
      document.getElementById('termSpace').value = app.approved_space_id || app.desired_space_id || '';
      document.getElementById('termRate').value = app.approved_rate || approvedSpace?.monthly_rate || desiredSpace?.monthly_rate || '';
      document.getElementById('termRateTerm').value = app.approved_rate_term || 'monthly';
      document.getElementById('termMoveIn').value = app.approved_move_in || app.desired_move_in || '';
      document.getElementById('termLeaseEnd').value = app.approved_lease_end || '';
      document.getElementById('termNoticePeriod').value = app.notice_period || '30_days';
      document.getElementById('termSecurityDeposit').value = app.security_deposit_amount || 0;
      document.getElementById('termAdditionalTerms').value = app.additional_terms || '';

      // Documents tab
      document.getElementById('agreementStatusDisplay').textContent =
        app.agreement_status || 'Pending';
      document.getElementById('agreementDocUrl').value = app.agreement_document_url || '';

      // Update documents tab state
      await updateDocumentsTabState(app);

      // Deposits tab
      document.getElementById('moveInDepositAmount').textContent =
        rentalService.formatCurrency(app.move_in_deposit_amount || app.approved_rate || 0);
      document.getElementById('moveInDepositStatus').textContent =
        app.move_in_deposit_paid ? 'Paid' : 'Pending';
      document.getElementById('moveInDepositStatus').className =
        `deposit-status ${app.move_in_deposit_paid ? 'paid' : ''}`;

      document.getElementById('securityDepositAmount').textContent =
        rentalService.formatCurrency(app.security_deposit_amount || 0);
      document.getElementById('securityDepositStatus').textContent =
        app.security_deposit_paid ? 'Paid' : (app.security_deposit_amount > 0 ? 'Pending' : 'N/A');
      document.getElementById('securityDepositStatus').className =
        `deposit-status ${app.security_deposit_paid ? 'paid' : ''}`;

      // Proration
      if (app.approved_move_in && app.approved_rate) {
        const proration = rentalService.calculateProration(app.approved_move_in, app.approved_rate);
        const application = rentalService.calculateDepositApplication(
          app.approved_move_in, app.approved_rate, app.security_deposit_amount || 0
        );

        document.getElementById('prorationDetails').innerHTML = `
          <p>Move-in: <strong>${rentalService.formatDate(app.approved_move_in)}</strong> (day ${proration.dayOfMonth} of ${proration.daysInMonth})</p>
          <p>Days remaining: <strong>${proration.daysRemaining}</strong></p>
          <p>First month (prorated): <strong class="highlight">${rentalService.formatCurrency(proration.proratedAmount)}</strong></p>
          <p>Move-in deposit: ${rentalService.formatCurrency(application.moveInDeposit)}</p>
          ${application.towardsSecurity > 0 ? `<p>Applied to security: ${rentalService.formatCurrency(application.towardsSecurity)}</p>` : ''}
          ${application.securityRemaining > 0 ? `<p>Additional security due: <strong class="highlight">${rentalService.formatCurrency(application.securityRemaining)}</strong></p>` : ''}
        `;
      } else {
        document.getElementById('prorationDetails').innerHTML = '<p class="text-muted">Set move-in date and rate to calculate proration.</p>';
      }

      // Rent tab
      document.getElementById('rentMonthlyAmount').textContent =
        rentalService.formatCurrency(app.approved_rate);

      // Update action buttons
      updateRentalActions(app);

      // Show modal
      document.getElementById('rentalDetailModal').classList.remove('hidden');

      // Set first tab as active
      switchDetailTab('applicant');
    }

    function switchDetailTab(tabName) {
      document.querySelectorAll('.detail-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.detailTab === tabName);
      });
      document.querySelectorAll('.detail-tab-content').forEach(c => {
        c.classList.toggle('active', c.id === tabName + 'Tab');
      });
    }

    function updateRentalActions(app) {
      const container = document.getElementById('rentalActions');
      if (!container) return;

      let buttons = [];
      const stage = rentalService.getPipelineStage(app);

      switch (stage) {
        case 'applications':
          if (app.application_status === 'submitted') {
            buttons.push('<button class="btn-primary" onclick="startReviewApplication()">Start Review</button>');
          }
          buttons.push('<button class="btn-secondary" onclick="denyApplication()">Deny</button>');
          buttons.push('<button class="btn-secondary" onclick="delayApplication()">Delay</button>');
          break;

        case 'approved':
          buttons.push('<button class="btn-primary" onclick="generateAgreement()">Generate Rental Agreement</button>');
          buttons.push('<button class="btn-secondary" onclick="editTerms()">Edit Terms</button>');
          break;

        case 'contract':
          if (app.agreement_status === 'generated') {
            buttons.push('<button class="btn-primary" onclick="markAgreementSent()">Mark as Sent</button>');
          } else if (app.agreement_status === 'sent') {
            buttons.push('<button class="btn-primary" onclick="markAgreementSigned()">Mark as Signed</button>');
          }
          break;

        case 'deposit':
          if (app.deposit_status !== 'confirmed') {
            buttons.push('<button class="btn-primary" onclick="confirmDeposit()">Confirm Deposit</button>');
          }
          break;

        case 'ready':
          buttons.push('<button class="btn-primary" onclick="confirmMoveIn()">Confirm Move-in</button>');
          break;
      }

      // Add approve button if under review
      if (app.application_status === 'under_review') {
        buttons.unshift('<button class="btn-primary" onclick="approveApplication()">Approve</button>');
      }

      // Add test toggle and archive buttons (always available)
      const testLabel = app.is_test ? 'Remove Test Flag' : 'Mark as Test';
      buttons.push(`<button class="btn-secondary btn-small" onclick="toggleTestFlag()" style="margin-left: auto;">${testLabel}</button>`);
      buttons.push('<button class="btn-danger btn-small" onclick="archiveApplication()">Archive</button>');

      container.innerHTML = buttons.join('');
    }

    function closeRentalDetail() {
      document.getElementById('rentalDetailModal').classList.add('hidden');
      currentApplicationId = null;
    }

    // =============================================
    // RENTAL ACTIONS
    // =============================================

    window.openRentalDetail = openRentalDetail;

    window.archiveApplication = async function() {
      if (!currentApplicationId) return;
      if (!confirm('Archive this application? It will be hidden from the pipeline.')) return;
      try {
        await rentalService.archiveApplication(currentApplicationId);
        closeRentalDetail();
        await loadApplications();
        showToast('Application archived', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.toggleTestFlag = async function() {
      if (!currentApplicationId) return;
      try {
        const app = allApplications.find(a => a.id === currentApplicationId);
        const newTestValue = !app?.is_test;
        await rentalService.toggleTestFlag(currentApplicationId, newTestValue);
        await loadApplications();
        openRentalDetail(currentApplicationId);
        showToast(newTestValue ? 'Marked as test' : 'Unmarked as test', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.startReviewApplication = async function() {
      if (!currentApplicationId) return;
      try {
        await rentalService.startReview(currentApplicationId);
        await loadApplications();
        openRentalDetail(currentApplicationId);
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.approveApplication = async function() {
      if (!currentApplicationId) return;

      const spaceId = document.getElementById('termSpace').value;
      const rate = parseFloat(document.getElementById('termRate').value);
      const rateTerm = document.getElementById('termRateTerm').value;
      const moveInDate = document.getElementById('termMoveIn').value;
      const leaseEndDate = document.getElementById('termLeaseEnd').value || null;
      const noticePeriod = document.getElementById('termNoticePeriod').value;
      const securityDeposit = parseFloat(document.getElementById('termSecurityDeposit').value) || 0;
      const additionalTerms = document.getElementById('termAdditionalTerms').value.trim() || null;

      if (!spaceId || !rate || !moveInDate) {
        showToast('Please fill in Space, Rate, and Move-in Date on the Terms tab', 'warning');
        switchDetailTab('terms');
        return;
      }

      try {
        await rentalService.approveApplication(currentApplicationId, {
          spaceId,
          rate,
          rateTerm,
          moveInDate,
          leaseEndDate,
          noticePeriod,
          securityDepositAmount: securityDeposit,
          additionalTerms,
        });
        await loadApplications();
        openRentalDetail(currentApplicationId);
        showToast('Application approved', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.denyApplication = async function() {
      if (!currentApplicationId) return;
      const reason = prompt('Reason for denial (optional):');
      try {
        await rentalService.denyApplication(currentApplicationId, reason);
        await loadApplications();
        closeRentalDetail();
        showToast('Application denied', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.delayApplication = async function() {
      if (!currentApplicationId) return;
      const reason = prompt('Reason for delay (optional):');
      try {
        await rentalService.delayApplication(currentApplicationId, reason);
        await loadApplications();
        closeRentalDetail();
        showToast('Application delayed', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.generateAgreement = async function() {
      switchDetailTab('documents');
    };

    window.editTerms = function() {
      switchDetailTab('terms');
    };

    window.markAgreementSent = async function() {
      if (!currentApplicationId) return;
      try {
        await rentalService.updateAgreementStatus(currentApplicationId, 'sent');
        await loadApplications();
        openRentalDetail(currentApplicationId);
        showToast('Agreement marked as sent', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.markAgreementSigned = async function() {
      if (!currentApplicationId) return;
      try {
        await rentalService.updateAgreementStatus(currentApplicationId, 'signed');
        await loadApplications();
        openRentalDetail(currentApplicationId);
        showToast('Agreement marked as signed', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.confirmDeposit = async function() {
      if (!currentApplicationId) return;
      try {
        await rentalService.confirmDeposit(currentApplicationId);
        await loadApplications();
        openRentalDetail(currentApplicationId);
        showToast('Deposit confirmed', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    window.confirmMoveIn = async function() {
      if (!currentApplicationId) return;
      if (!confirm('Confirm move-in? This will create an active assignment.')) return;
      try {
        await rentalService.confirmMoveIn(currentApplicationId);
        await loadApplications();
        closeRentalDetail();
        showToast('Move-in confirmed! Assignment created.', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    };

    // =============================================
    // CREATE APPLICATION
    // =============================================

    async function handleCreateApplication(e) {
      e.preventDefault();
      const personId = document.getElementById('newAppPersonId').value;
      const spaceId = document.getElementById('newAppSpaceId').value || null;

      if (!personId) {
        showToast('Please select a person', 'warning');
        return;
      }

      try {
        await rentalService.createApplication(personId, {
          desired_space_id: spaceId,
        });
        await loadApplications();
        document.getElementById('newAppPersonId').value = '';
        document.getElementById('newAppSpaceId').value = '';
        showToast('Application created', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    // =============================================
    // PAYMENT METHODS
    // =============================================

    window.openPaymentMethodModal = function(methodId = null) {
      const modal = document.getElementById('paymentMethodModal');
      const title = document.getElementById('paymentMethodModalTitle');
      const deleteBtn = document.getElementById('deletePaymentMethodBtn');

      if (methodId) {
        const method = allPaymentMethods.find(m => m.id === methodId);
        if (!method) return;

        title.textContent = 'Edit Payment Method';
        document.getElementById('paymentMethodId').value = method.id;
        document.getElementById('paymentMethodName').value = method.name || '';
        document.getElementById('paymentMethodType').value = method.method_type || 'venmo';
        document.getElementById('paymentMethodIdentifier').value = method.account_identifier || '';
        document.getElementById('paymentMethodInstructions').value = method.instructions || '';
        document.getElementById('paymentMethodActive').checked = method.is_active !== false;
        deleteBtn.style.display = 'block';
      } else {
        title.textContent = 'Add Payment Method';
        document.getElementById('paymentMethodForm').reset();
        document.getElementById('paymentMethodId').value = '';
        document.getElementById('paymentMethodActive').checked = true;
        deleteBtn.style.display = 'none';
      }

      modal.classList.remove('hidden');
    };

    async function savePaymentMethod() {
      const id = document.getElementById('paymentMethodId').value || null;
      const data = {
        id,
        name: document.getElementById('paymentMethodName').value.trim(),
        method_type: document.getElementById('paymentMethodType').value,
        account_identifier: document.getElementById('paymentMethodIdentifier').value.trim() || null,
        instructions: document.getElementById('paymentMethodInstructions').value.trim() || null,
        is_active: document.getElementById('paymentMethodActive').checked,
      };

      if (!data.name) {
        showToast('Name is required', 'warning');
        return;
      }

      try {
        await rentalService.savePaymentMethod(data);
        await loadPaymentMethods();
        closePaymentMethodModal();
        showToast('Payment method saved', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    async function deletePaymentMethod() {
      const id = document.getElementById('paymentMethodId').value;
      if (!id) return;
      if (!confirm('Delete this payment method?')) return;

      try {
        await rentalService.deletePaymentMethod(id);
        await loadPaymentMethods();
        closePaymentMethodModal();
        showToast('Payment method deleted', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    function closePaymentMethodModal() {
      document.getElementById('paymentMethodModal').classList.add('hidden');
    }

    // =============================================
    // DEPOSIT RECORDING
    // =============================================

    window.openRecordDepositModal = function(type) {
      const app = allApplications.find(a => a.id === currentApplicationId);
      if (!app) return;

      const amount = type === 'move_in' ? app.move_in_deposit_amount : app.security_deposit_amount;

      document.getElementById('depositType').value = type;
      document.getElementById('depositAmount').value = rentalService.formatCurrency(amount);
      document.getElementById('depositMethod').value = '';
      document.getElementById('depositTransactionId').value = '';
      document.getElementById('recordDepositTitle').textContent =
        type === 'move_in' ? 'Record Move-in Deposit' : 'Record Security Deposit';

      document.getElementById('recordDepositModal').classList.remove('hidden');
    };

    async function confirmRecordDeposit() {
      const type = document.getElementById('depositType').value;
      const method = document.getElementById('depositMethod').value;
      const transactionId = document.getElementById('depositTransactionId').value.trim() || null;

      if (!method) {
        showToast('Please select a payment method', 'warning');
        return;
      }

      try {
        if (type === 'move_in') {
          await rentalService.recordMoveInDeposit(currentApplicationId, { method, transactionId });
        } else {
          await rentalService.recordSecurityDeposit(currentApplicationId, { method, transactionId });
        }
        await loadApplications();
        closeRecordDepositModal();
        openRentalDetail(currentApplicationId);
        showToast('Deposit recorded', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    function closeRecordDepositModal() {
      document.getElementById('recordDepositModal').classList.add('hidden');
    }

    // =============================================
    // LEASE AGREEMENT GENERATION
    // =============================================

    let currentLeaseTemplate = null;
    let currentAgreementData = null;

    async function updateDocumentsTabState(app) {
      const generateSection = document.getElementById('generateSection');
      const pdfSection = document.getElementById('pdfSection');
      const signatureSection = document.getElementById('signatureSection');
      const noTemplateWarning = document.getElementById('noTemplateWarning');
      const leasePreview = document.getElementById('leasePreview');

      // Reset visibility
      generateSection.style.display = 'block';
      pdfSection.style.display = 'none';
      signatureSection.style.display = 'none';
      noTemplateWarning.style.display = 'none';
      leasePreview.innerHTML = '';

      // Load template and agreement data
      try {
        currentLeaseTemplate = await leaseTemplateService.getActiveTemplate();
        currentAgreementData = await rentalService.getAgreementData(app.id);

        if (!currentLeaseTemplate) {
          noTemplateWarning.style.display = 'block';
          return;
        }
      } catch (e) {
        console.error('Error loading template/data:', e);
        leasePreview.innerHTML = '<p class="text-muted">Unable to load agreement data</p>';
        return;
      }

      // Show appropriate section based on agreement status
      const status = app.agreement_status || 'pending';

      if (status === 'signed' && app.signed_pdf_url) {
        // Show signed document
        pdfSection.style.display = 'none';
        signatureSection.style.display = 'block';
        document.getElementById('signatureStatusText').textContent = 'Agreement signed!';
        document.getElementById('signedPdfSection').style.display = 'block';
        document.getElementById('signedPdfLink').href = app.signed_pdf_url;
      } else if (status === 'sent' && app.signwell_document_id) {
        // Show signature pending status
        generateSection.style.display = 'none';
        pdfSection.style.display = 'block';
        signatureSection.style.display = 'block';
        document.getElementById('signatureStatusText').textContent = 'Awaiting tenant signature...';
        if (app.generated_pdf_url) {
          document.getElementById('pdfDownloadLink').href = app.generated_pdf_url;
        }
      } else if ((status === 'generated' || app.generated_pdf_url) && app.generated_pdf_url) {
        // Show generated PDF
        generateSection.style.display = 'none';
        pdfSection.style.display = 'block';
        document.getElementById('pdfDownloadLink').href = app.generated_pdf_url;
        document.getElementById('pdfFilename').textContent = 'lease-agreement.pdf';
        if (app.agreement_generated_at) {
          document.getElementById('pdfGeneratedAt').textContent =
            `Generated ${new Date(app.agreement_generated_at).toLocaleDateString()}`;
        }
      }
      // Otherwise show generate section (default)
    }

    async function previewLease() {
      const leasePreview = document.getElementById('leasePreview');

      if (!currentLeaseTemplate || !currentAgreementData) {
        showToast('No template or data available', 'warning');
        return;
      }

      try {
        const parsedContent = leaseTemplateService.parseTemplate(
          currentLeaseTemplate.content,
          currentAgreementData
        );
        // Convert markdown to simple HTML for preview
        leasePreview.innerHTML = markdownToHtml(parsedContent);
        leasePreview.style.display = 'block';
      } catch (e) {
        console.error('Error previewing lease:', e);
        showToast('Error generating preview: ' + e.message, 'error');
      }
    }

    function markdownToHtml(markdown) {
      // Simple markdown to HTML conversion for preview
      let html = markdown
        // Headers
        .replace(/^### (.*$)/gm, '<h4>$1</h4>')
        .replace(/^## (.*$)/gm, '<h3>$1</h3>')
        .replace(/^# (.*$)/gm, '<h2>$1</h2>')
        // Bold
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Horizontal rules
        .replace(/^---$/gm, '<hr>')
        // Line breaks
        .replace(/\n/g, '<br>');

      return html;
    }

    async function generateLeasePdf() {
      if (!currentLeaseTemplate || !currentAgreementData) {
        showToast('No template or data available', 'warning');
        return;
      }

      const btn = document.getElementById('generatePdfBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Generating...';
      btn.disabled = true;

      try {
        // Parse template with application data
        const parsedContent = leaseTemplateService.parseTemplate(
          currentLeaseTemplate.content,
          currentAgreementData
        );

        // Generate and upload PDF
        const { url, filename } = await pdfService.generateAndUploadLeasePdf(
          parsedContent,
          currentApplicationId
        );

        // Update application with PDF URL
        await rentalService.updateAgreementStatus(currentApplicationId, 'generated', url);

        // Reload applications and refresh UI
        await loadApplications();
        await openRentalDetail(currentApplicationId);

        showToast('Lease agreement PDF generated!', 'success');
      } catch (e) {
        console.error('Error generating PDF:', e);
        showToast('Error generating PDF: ' + e.message, 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    async function regeneratePdf() {
      if (confirm('This will replace the existing PDF. Continue?')) {
        await generateLeasePdf();
      }
    }

    async function sendForSignature() {
      showToast('SignWell integration coming soon. For now, send the PDF manually.', 'info');
      // TODO: Integrate with SignWell API
      // const app = allApplications.find(a => a.id === currentApplicationId);
      // await signwellService.createDocument(app.generated_pdf_url, app.person.email, app.person.first_name + ' ' + app.person.last_name);
    }

    // =============================================
    // SETTINGS / TEMPLATE EDITOR
    // =============================================

    async function loadSettingsPanel() {
      // Load placeholder reference
      const placeholders = leaseTemplateService.getAvailablePlaceholders();
      const placeholderList = document.getElementById('placeholderList');
      placeholderList.innerHTML = Object.entries(placeholders)
        .map(([key, desc]) => `
          <div class="placeholder-item">
            <code>{{${key}}}</code>
            <span class="placeholder-desc">${desc}</span>
          </div>
        `).join('');

      // Load active template
      try {
        const template = await leaseTemplateService.getActiveTemplate();
        if (template) {
          document.getElementById('templateName').value = template.name;
          document.getElementById('templateContent').value = template.content;
        } else {
          // Load default template
          document.getElementById('templateContent').value = leaseTemplateService.getDefaultTemplate();
        }
      } catch (e) {
        console.error('Error loading template:', e);
      }

      // Load template history
      await loadTemplateHistory();

      // Load SignWell config
      await loadSignwellConfig();
    }

    async function loadTemplateHistory() {
      try {
        const templates = await leaseTemplateService.getAllTemplates();
        const tbody = document.getElementById('templateHistoryBody');

        if (templates.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No templates saved yet</td></tr>';
          return;
        }

        tbody.innerHTML = templates.map(t => `
          <tr>
            <td>${t.name}</td>
            <td>v${t.version}</td>
            <td>${new Date(t.created_at).toLocaleDateString()}</td>
            <td>${t.is_active ? '<span class="status-badge active">Active</span>' : ''}</td>
            <td>
              <button class="btn-small" onclick="loadTemplate('${t.id}')">Load</button>
              ${!t.is_active ? `<button class="btn-small" onclick="setActiveTemplate('${t.id}')">Set Active</button>` : ''}
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Error loading template history:', e);
      }
    }

    window.loadTemplate = async function(templateId) {
      try {
        const { data, error } = await supabase
          .from('lease_templates')
          .select('*')
          .eq('id', templateId)
          .single();

        if (error) throw error;

        document.getElementById('templateName').value = data.name;
        document.getElementById('templateContent').value = data.content;
        showToast('Template loaded', 'success');
      } catch (e) {
        showToast('Error loading template: ' + e.message, 'error');
      }
    };

    window.setActiveTemplate = async function(templateId) {
      try {
        await leaseTemplateService.setActiveTemplate(templateId);
        await loadTemplateHistory();
        showToast('Template set as active', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    };

    async function saveTemplate() {
      const name = document.getElementById('templateName').value.trim();
      const content = document.getElementById('templateContent').value;
      const makeActive = document.getElementById('templateMakeActive').checked;

      if (!name) {
        showToast('Please enter a template name', 'warning');
        return;
      }

      if (!content.trim()) {
        showToast('Template content cannot be empty', 'warning');
        return;
      }

      // Validate template
      const validation = leaseTemplateService.validateTemplate(content);
      const validationDiv = document.getElementById('templateValidation');

      if (!validation.isValid) {
        validationDiv.innerHTML = `
          <div class="validation-error">
            <strong>Validation Errors:</strong>
            <ul>${validation.errors.map(e => `<li>${e}</li>`).join('')}</ul>
          </div>
        `;
        validationDiv.style.display = 'block';
        return;
      }

      if (validation.warnings.length > 0) {
        validationDiv.innerHTML = `
          <div class="validation-warning">
            <strong>Warnings:</strong>
            <ul>${validation.warnings.map(w => `<li>${w}</li>`).join('')}</ul>
          </div>
        `;
        validationDiv.style.display = 'block';
      } else {
        validationDiv.style.display = 'none';
      }

      try {
        await leaseTemplateService.saveTemplate(content, name, makeActive);
        await loadTemplateHistory();
        showToast('Template saved successfully!', 'success');
      } catch (e) {
        showToast('Error saving template: ' + e.message, 'error');
      }
    }

    function loadDefaultTemplate() {
      document.getElementById('templateContent').value = leaseTemplateService.getDefaultTemplate();
      document.getElementById('templateName').value = 'Standard Lease Agreement';
      showToast('Default template loaded', 'info');
    }

    async function loadSignwellConfig() {
      try {
        const { data, error } = await supabase
          .from('signwell_config')
          .select('*')
          .single();

        if (data) {
          document.getElementById('signwellApiKey').value = data.api_key || '';
          document.getElementById('signwellTestMode').checked = data.test_mode !== false;
        }
      } catch (e) {
        console.error('Error loading SignWell config:', e);
      }
    }

    async function saveSignwellConfig() {
      const apiKey = document.getElementById('signwellApiKey').value.trim();
      const testMode = document.getElementById('signwellTestMode').checked;

      try {
        const { error } = await supabase
          .from('signwell_config')
          .upsert({
            id: 1,
            api_key: apiKey || null,
            test_mode: testMode,
            updated_at: new Date().toISOString(),
          });

        if (error) throw error;
        showToast('SignWell configuration saved', 'success');
      } catch (e) {
        showToast('Error saving config: ' + e.message, 'error');
      }
    }

    // =============================================
    // COPY TO CLIPBOARD
    // =============================================

    async function copyDepositRequest() {
      if (!currentApplicationId) return;
      try {
        const message = await rentalService.generateDepositRequestMessage(currentApplicationId);
        await navigator.clipboard.writeText(message);
        showToast('Payment instructions copied to clipboard', 'success');
      } catch (e) {
        showToast('Failed to copy: ' + e.message, 'error');
      }
    }

    async function markDepositRequested() {
      if (!currentApplicationId) return;
      try {
        await rentalService.requestDeposit(currentApplicationId);
        await loadApplications();
        openRentalDetail(currentApplicationId);
        showToast('Deposit requested', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    // =============================================
    // RENTALS EVENT LISTENERS
    // =============================================

    function setupRentalsEventListeners() {
      // Create application form
      document.getElementById('createApplicationForm')?.addEventListener('submit', handleCreateApplication);

      // Add payment method button
      document.getElementById('addPaymentMethodBtn')?.addEventListener('click', () => openPaymentMethodModal());

      // Payment method modal
      document.getElementById('closePaymentMethodModal')?.addEventListener('click', closePaymentMethodModal);
      document.getElementById('cancelPaymentMethodBtn')?.addEventListener('click', closePaymentMethodModal);
      document.getElementById('savePaymentMethodBtn')?.addEventListener('click', savePaymentMethod);
      document.getElementById('deletePaymentMethodBtn')?.addEventListener('click', deletePaymentMethod);

      // Rental detail modal
      document.getElementById('closeRentalDetail')?.addEventListener('click', closeRentalDetail);

      // Detail tabs
      document.querySelectorAll('.detail-tab').forEach(tab => {
        tab.addEventListener('click', () => switchDetailTab(tab.dataset.detailTab));
      });

      // New lease agreement actions
      document.getElementById('previewLeaseBtn')?.addEventListener('click', previewLease);
      document.getElementById('generatePdfBtn')?.addEventListener('click', generateLeasePdf);
      document.getElementById('regeneratePdfBtn')?.addEventListener('click', regeneratePdf);
      document.getElementById('sendForSignatureBtn')?.addEventListener('click', sendForSignature);
      document.getElementById('checkSignatureStatusBtn')?.addEventListener('click', () => {
        showToast('Checking signature status...', 'info');
        // TODO: signwellService.getDocumentStatus()
      });
      document.getElementById('resendSignatureBtn')?.addEventListener('click', () => {
        showToast('Resending signature request...', 'info');
        // TODO: signwellService.resendRequest()
      });
      document.getElementById('createTemplateLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab('settings'); // Switch to settings/templates tab
        showToast('Create a lease template in the Settings tab', 'info');
      });

      // Settings panel event listeners
      document.getElementById('loadDefaultTemplateBtn')?.addEventListener('click', loadDefaultTemplate);
      document.getElementById('saveTemplateBtn')?.addEventListener('click', saveTemplate);
      document.getElementById('saveSignwellConfigBtn')?.addEventListener('click', saveSignwellConfig);

      // Legacy manual agreement actions (backwards compatibility)
      document.getElementById('markAgreementGenerated')?.addEventListener('click', async () => {
        if (!currentApplicationId) return;
        const url = document.getElementById('agreementDocUrl').value.trim();
        try {
          await rentalService.updateAgreementStatus(currentApplicationId, 'generated', url || null);
          await loadApplications();
          openRentalDetail(currentApplicationId);
          showToast('Agreement marked as generated', 'success');
        } catch (error) {
          showToast('Error: ' + error.message, 'error');
        }
      });
      document.getElementById('markAgreementSent')?.addEventListener('click', markAgreementSent);
      document.getElementById('markAgreementSigned')?.addEventListener('click', markAgreementSigned);

      // Deposit actions
      document.getElementById('recordMoveInDepositBtn')?.addEventListener('click', () => openRecordDepositModal('move_in'));
      document.getElementById('recordSecurityDepositBtn')?.addEventListener('click', () => openRecordDepositModal('security'));
      document.getElementById('copyDepositRequestBtn')?.addEventListener('click', copyDepositRequest);
      document.getElementById('markDepositRequestedBtn')?.addEventListener('click', markDepositRequested);
      document.getElementById('confirmDepositBtn')?.addEventListener('click', confirmDeposit);

      // Record deposit modal
      document.getElementById('closeRecordDepositModal')?.addEventListener('click', closeRecordDepositModal);
      document.getElementById('cancelRecordDepositBtn')?.addEventListener('click', closeRecordDepositModal);
      document.getElementById('confirmRecordDepositBtn')?.addEventListener('click', confirmRecordDeposit);

      // Close modals on backdrop click
      document.getElementById('rentalDetailModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'rentalDetailModal') closeRentalDetail();
      });
      document.getElementById('paymentMethodModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'paymentMethodModal') closePaymentMethodModal();
      });
      document.getElementById('recordDepositModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'recordDepositModal') closeRecordDepositModal();
      });
    }

    init();
  </script>
</body>
</html>
