<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events - AlpacAPPs Admin</title>
  <link rel="icon" type="image/png" href="../../favicon.png">
  <link rel="apple-touch-icon" href="../../apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css?v=5">
  <link rel="stylesheet" href="styles.css?v=5">
  <link rel="stylesheet" href="manage-shared.css?v=1">
  <link rel="stylesheet" href="events.css?v=1">
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Image Lightbox -->
  <div id="imageLightbox" class="lightbox hidden">
    <button class="lightbox-close">&times;</button>
    <button class="lightbox-nav lightbox-prev" id="lightboxPrev">&#10094;</button>
    <img id="lightboxImage" src="" alt="">
    <button class="lightbox-nav lightbox-next" id="lightboxNext">&#10095;</button>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <div id="unauthorizedOverlay" class="loading-overlay hidden">
    <div class="unauthorized-card">
      <h2>Access Denied</h2>
      <p id="unauthorizedEmail" style="opacity:0.7;font-size:0.9em"></p>
      <p>Your account is not authorized to access admin features.</p>
      <p>Please contact an administrator to request access.</p>
      <div class="unauthorized-actions">
        <a href="/spaces/" class="btn-secondary">View Public Spaces</a>
        <button id="signOutBtn" class="btn-secondary">Sign Out</button>
      </div>
    </div>
  </div>

  <div id="appContent" class="hidden">
    <header>
      <div class="header-left">
        <a href="https://alpacaplayhouse.com" class="header-logo">
          <img src="https://aphrrfprbixmhissnjfn.supabase.co/storage/v1/object/public/housephotos/logos/alpaca-head-black-transparent.png" alt="AlpacAPPs" class="header-logo__icon">
          <img src="https://aphrrfprbixmhissnjfn.supabase.co/storage/v1/object/public/housephotos/logos/wordmark-black-transparent.png" alt="AlpacAPPs" class="header-logo__wordmark">
        </a>
        <span title="Site version" style="font-size:0.65rem;color:var(--text-muted);font-weight:400;cursor:help;align-self:center;margin-left:-0.25rem">v260208.77 7:47p</span>
        <span id="roleBadge" class="role-badge">Staff</span>
      </div>
      <div class="header-controls">
        <span id="userInfo" class="user-info"></span>
        <button id="headerSignOutBtn" class="btn-secondary">Sign Out</button>
      </div>
    </header>

    <div class="context-switcher hidden" id="contextSwitcher">
      <a href="/residents/" class="context-switcher-btn">Resident</a>
      <a class="context-switcher-btn active">Staff</a>
    </div>

    <div class="manage-container">
      <div class="manage-tabs">
        <!-- Tab navigation rendered by admin-shell.js -->
      </div>

      <!-- Events Panel -->
      <div class="manage-panel active">
        <!-- Pipeline View -->
        <div class="event-pipeline" id="eventPipeline">
          <div class="pipeline-column" data-stage="requests">
            <div class="pipeline-header">
              <h3>Requests</h3>
              <span class="pipeline-count" id="eventRequestsCount">0</span>
            </div>
            <div class="pipeline-cards" id="eventRequestsCards"></div>
          </div>
          <div class="pipeline-column" data-stage="approved">
            <div class="pipeline-header">
              <h3>Approved</h3>
              <span class="pipeline-count" id="eventApprovedCount">0</span>
            </div>
            <div class="pipeline-cards" id="eventApprovedCards"></div>
          </div>
          <div class="pipeline-column" data-stage="contract">
            <div class="pipeline-header">
              <h3>Contract</h3>
              <span class="pipeline-count" id="eventContractCount">0</span>
            </div>
            <div class="pipeline-cards" id="eventContractCards"></div>
          </div>
          <div class="pipeline-column" data-stage="deposit">
            <div class="pipeline-header">
              <h3>Deposit</h3>
              <span class="pipeline-count" id="eventDepositCount">0</span>
            </div>
            <div class="pipeline-cards" id="eventDepositCards"></div>
          </div>
          <div class="pipeline-column" data-stage="ready">
            <div class="pipeline-header">
              <h3>Ready</h3>
              <span class="pipeline-count" id="eventReadyCount">0</span>
            </div>
            <div class="pipeline-cards" id="eventReadyCards"></div>
          </div>
        </div>

        <!-- Denied Section (collapsible) -->
        <details class="section" id="eventDeniedSection" style="margin-top: 1.5rem;">
          <summary class="section-header" style="cursor: pointer;">
            <h2>Denied</h2>
            <span id="eventDeniedCount" class="text-muted">0</span>
          </summary>
          <div class="section-body">
            <div id="eventDeniedList" class="spaces-list"></div>
          </div>
        </details>

        <!-- Events Calendar Section -->
        <div class="section" style="margin-top: 1.5rem;">
          <div class="section-header">
            <h2>Events Calendar</h2>
            <div class="calendar-controls">
              <button class="btn-small" id="eventCalendarPrevMonth">&larr;</button>
              <span id="eventCalendarMonthLabel" class="calendar-month-label"></span>
              <button class="btn-small" id="eventCalendarNextMonth">&rarr;</button>
              <button class="btn-small" id="eventCalendarToday" style="margin-left: 0.5rem;">Today</button>
            </div>
          </div>
          <div class="section-body">
            <div id="eventsCalendar" class="events-calendar">
              <div class="calendar-loading">Loading events...</div>
            </div>
          </div>
        </div>

        <!-- Create Event Request Section -->
        <div class="section" style="margin-top: 1.5rem;">
          <div class="section-header">
            <h2>Create Event Request</h2>
          </div>
          <div class="section-body">
            <form id="createEventRequestForm" class="add-space-form">
              <div class="event-form-grid">
                <div class="form-group">
                  <label for="newEventPersonId">Client</label>
                  <select id="newEventPersonId" required>
                    <option value="">Select a person...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="newEventOrgName">Organization (optional)</label>
                  <input type="text" id="newEventOrgName" placeholder="If hosting for an org...">
                </div>
                <div class="form-group">
                  <label for="newEventName">Event Name</label>
                  <input type="text" id="newEventName" required placeholder="e.g., Birthday Party">
                </div>
                <div class="form-group">
                  <label for="newEventType">Event Type</label>
                  <select id="newEventType">
                    <option value="party">Party</option>
                    <option value="workshop">Workshop</option>
                    <option value="retreat">Retreat</option>
                    <option value="ceremony">Ceremony</option>
                    <option value="meeting">Meeting</option>
                    <option value="photoshoot">Photoshoot</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="newEventDate">Event Date</label>
                  <input type="date" id="newEventDate" required>
                </div>
                <div class="form-group">
                  <label>Event Time</label>
                  <div class="time-inputs">
                    <input type="time" id="newEventStartTime" required>
                    <span>to</span>
                    <input type="time" id="newEventEndTime" required>
                  </div>
                </div>
                <div class="form-group">
                  <label for="newEventGuests">Expected Guests</label>
                  <input type="number" id="newEventGuests" required min="1" max="100" value="25">
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="newEventHostedBefore">
                    Has hosted at venue before
                  </label>
                </div>
                <div class="form-group full-width">
                  <label for="newEventDescription">Event Description</label>
                  <textarea id="newEventDescription" rows="2" placeholder="Brief description of the event..."></textarea>
                </div>
              </div>
              <button type="submit" class="btn-primary" style="margin-top: 1rem;">Create Event Request</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Detail Modal -->
  <div id="eventDetailModal" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="eventDetailTitle">Event Details</h2>
        <span id="eventDetailStatus" class="status-badge"></span>
        <span id="eventDetailTestBadge" class="status-badge test" style="display: none; background: #f59e0b; color: white;">TEST</span>
        <button class="modal-close" id="closeEventDetail">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Modal tabs -->
        <div class="detail-tabs">
          <button class="event-detail-tab active" data-event-tab="eventInfo">Event Info</button>
          <button class="event-detail-tab" data-event-tab="eventTerms">Terms</button>
          <button class="event-detail-tab" data-event-tab="eventDocuments">Documents</button>
          <button class="event-detail-tab" data-event-tab="eventDeposits">Deposits</button>
        </div>

        <!-- Event Info Tab -->
        <div id="eventInfoTab" class="event-detail-tab-content active">
          <div class="applicant-info">
            <div class="form-grid">
              <div class="info-group">
                <label>Event Name</label>
                <p id="eventInfoName">-</p>
              </div>
              <div class="info-group">
                <label>Client Name</label>
                <p id="eventInfoClient">-</p>
              </div>
              <div class="info-group">
                <label>Email</label>
                <p id="eventInfoEmail">-</p>
              </div>
              <div class="info-group">
                <label>Phone</label>
                <p id="eventInfoPhone">-</p>
              </div>
              <div class="info-group">
                <label>Organization</label>
                <p id="eventInfoOrg">-</p>
              </div>
              <div class="info-group">
                <label>Event Date</label>
                <p id="eventInfoDate">-</p>
              </div>
              <div class="info-group">
                <label>Time</label>
                <p id="eventInfoTime">-</p>
              </div>
              <div class="info-group">
                <label>Expected Guests</label>
                <p id="eventInfoGuests">-</p>
              </div>
              <div class="info-group">
                <label>Event Type</label>
                <p id="eventInfoType">-</p>
              </div>
              <div class="info-group">
                <label>Submitted</label>
                <p id="eventInfoSubmitted">-</p>
              </div>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label>Description</label>
              <p id="eventInfoDescription" class="text-muted">-</p>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label>Special Requests</label>
              <p id="eventInfoSpecialRequests" class="text-muted">-</p>
            </div>
          </div>
        </div>

        <!-- Event Terms Tab -->
        <div id="eventTermsTab" class="event-detail-tab-content">
          <form id="eventTermsForm" class="terms-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="eventTermMaxGuests">Approved Max Guests <span class="required">*</span></label>
                <input type="number" id="eventTermMaxGuests" min="1" required>
              </div>
              <div class="form-group">
                <label for="eventTermRentalFee">Rental Fee ($) <span class="required">*</span></label>
                <input type="number" id="eventTermRentalFee" min="0" step="1" value="295">
              </div>
              <div class="form-group">
                <label for="eventTermReservationFee">Reservation Deposit ($)</label>
                <input type="number" id="eventTermReservationFee" min="0" step="1" value="95">
                <small class="form-hint">Credits toward rental fee</small>
              </div>
              <div class="form-group">
                <label for="eventTermCleaningDeposit">Cleaning/Damage Deposit ($)</label>
                <input type="number" id="eventTermCleaningDeposit" min="0" step="1" value="195">
                <small class="form-hint">Refundable after event</small>
              </div>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label for="eventTermAdditionalTerms">Additional Terms</label>
              <textarea id="eventTermAdditionalTerms" rows="4" placeholder="Any additional terms or conditions..."></textarea>
            </div>
            <div class="terms-save-row" style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem;">
              <button type="button" id="saveEventTermsBtn" class="btn-small btn-primary">Save Terms</button>
              <span id="eventTermsSaveStatus" class="save-status"></span>
            </div>
          </form>
        </div>

        <!-- Event Documents Tab -->
        <div id="eventDocumentsTab" class="event-detail-tab-content">
          <div class="documents-section">
            <!-- Agreement Status -->
            <div class="document-status">
              <h4>Event Agreement Status</h4>
              <p id="eventAgreementStatusDisplay" class="status-badge">Pending</p>
            </div>

            <!-- Generate Section -->
            <div id="eventGenerateSection" class="generate-section">
              <h4>Generate Event Agreement</h4>
              <p class="text-muted" style="margin-bottom: 1rem;">Preview the event agreement and generate a PDF for signing.</p>
              <div id="eventLeasePreviewContainer" class="lease-preview-container">
                <div id="eventLeasePreview" class="lease-preview"></div>
              </div>
              <div class="generate-actions" style="margin-top: 1rem;">
                <button type="button" id="previewEventLeaseBtn" class="btn-small">Preview Agreement</button>
                <button type="button" id="generateEventPdfBtn" class="btn-small btn-primary">Generate PDF</button>
              </div>
              <p id="noEventTemplateWarning" class="warning-text" style="display: none; margin-top: 0.5rem;">
                No active event template found. Create one in Templates settings.
              </p>
            </div>

            <!-- Generated PDF Section -->
            <div id="eventPdfSection" class="pdf-section" style="display: none;">
              <h4>Current Document</h4>
              <div class="pdf-info">
                <a id="eventPdfDownloadLink" href="#" target="_blank" class="pdf-link">
                  <span class="pdf-icon">ðŸ“„</span>
                  <span id="eventPdfFilename">event-agreement.pdf</span>
                </a>
                <span id="eventPdfGeneratedAt" class="text-muted"></span>
              </div>
              <div class="pdf-actions" style="margin-top: 1rem;">
                <button type="button" id="sendEventForSignatureBtn" class="btn-small btn-primary">Send for Signature</button>
              </div>
            </div>

            <!-- Signature Section -->
            <div id="eventSignatureSection" class="signature-section" style="display: none;">
              <h4>Signature Status</h4>
              <p id="eventSignatureStatusText">Awaiting signature...</p>
              <div id="eventSignedPdfSection" style="display: none; margin-top: 1rem;">
                <a id="eventSignedPdfLink" href="#" target="_blank" class="pdf-link">
                  <span class="pdf-icon">âœ…</span>
                  <span id="eventSignedPdfFilename">Download Signed Agreement</span>
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Event Deposits Tab -->
        <div id="eventDepositsTab" class="event-detail-tab-content">
          <!-- Reservation Deposit Credit (if paid via Square) -->
          <div id="eventReservationFeeSection" class="application-fee-section hidden" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--success-light); border-radius: var(--radius); border-left: 4px solid var(--success);">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--success);">Reservation Deposit Received</h4>
            <p style="margin: 0; font-size: 0.9rem;">
              <strong id="eventReservationFeeAmount">$0</strong> reservation deposit paid
              <span id="eventReservationFeeCode" class="hidden"> (code: <code id="eventReservationFeeCodeValue"></code>)</span>
            </p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-muted);">
              This will be credited toward the rental fee of <strong id="eventRentalFeeTotal">$295</strong>.
              Remaining rental fee due: <strong id="eventRentalFeeDue">$0</strong>
            </p>
          </div>

          <div class="deposits-grid">
            <div class="deposit-card">
              <h4>Reservation Deposit</h4>
              <p class="deposit-amount" id="eventReservationDepositAmount">$95</p>
              <p class="deposit-status" id="eventReservationDepositStatus">Pending</p>
              <button type="button" id="recordEventReservationBtn" class="btn-small btn-primary">Record Payment</button>
            </div>
            <div class="deposit-card">
              <h4>Cleaning Deposit</h4>
              <p class="deposit-amount" id="eventCleaningDepositAmount">$195</p>
              <p class="deposit-status" id="eventCleaningDepositStatus">Pending</p>
              <button type="button" id="recordEventCleaningBtn" class="btn-small btn-primary">Record Payment</button>
            </div>
            <div class="deposit-card">
              <h4>Rental Fee</h4>
              <p class="deposit-amount" id="eventRentalFeeAmount">$295</p>
              <p class="deposit-status" id="eventRentalFeeStatus">Pending</p>
              <button type="button" id="recordEventRentalFeeBtn" class="btn-small btn-primary">Record Payment</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div id="eventDetailActions" class="modal-actions"></div>
      </div>
    </div>
  </div>

  <!-- Record Deposit Modal -->
  <div id="recordDepositModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="recordDepositTitle">Record Deposit</h2>
        <button class="modal-close" id="closeRecordDepositModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="recordDepositForm">
          <input type="hidden" id="depositType">
          <div class="form-group">
            <label>Amount</label>
            <input type="text" id="depositAmount" readonly>
          </div>
          <div class="form-group">
            <label for="depositMethod">Payment Method <span class="required">*</span></label>
            <select id="depositMethod" required>
              <option value="">Select method...</option>
              <option value="venmo">Venmo</option>
              <option value="zelle">Zelle</option>
              <option value="cash">Cash</option>
              <option value="check">Check</option>
              <option value="square">Square</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="depositTransactionId">Transaction ID (optional)</label>
            <input type="text" id="depositTransactionId" placeholder="Reference or confirmation number">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" id="closeRecordDepositBtn">Cancel</button>
        <button type="button" class="btn-primary" id="confirmRecordDepositBtn">Record Payment</button>
      </div>
    </div>
  </div>

  <script type="module" src="../../shared/version-info.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3"></script>
  <script type="module" src="events.js"></script>
</body>
</html>
