<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apply - Alpaca Playhouse Austin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #faf9f7;
      --bg-card: #ffffff;
      --text: #2d3142;
      --text-muted: #7a7d8c;
      --border: #e8e9ed;
      --accent: #3d8b7a;
      --accent-light: #e5f4f1;
      --error: #e07a5f;
      --error-light: #fdf0ec;
      --success: #5a9e8f;
      --success-light: #e8f5f2;
      --radius: 8px;
      --shadow: 0 1px 3px rgba(45,49,66,0.06), 0 1px 2px rgba(45,49,66,0.08);
      --shadow-lg: 0 4px 12px rgba(45,49,66,0.08), 0 2px 4px rgba(45,49,66,0.06);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    header {
      padding: 1.5rem 2rem;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 0.25rem;
    }

    header p {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    main {
      max-width: 720px;
      margin: 0 auto;
      padding: 2rem;
    }

    .form-container {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .form-section {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .form-section:last-of-type {
      border-bottom: none;
    }

    .form-section h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--accent);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
    }

    .form-group label .required {
      color: var(--error);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.625rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.95rem;
      background: var(--bg);
      transition: border-color 0.15s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .form-group input.error,
    .form-group select.error,
    .form-group textarea.error {
      border-color: var(--error);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .checkbox-group {
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: 1.125rem;
      height: 1.125rem;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .checkbox-group label {
      cursor: pointer;
    }

    .hidden {
      display: none !important;
    }

    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      margin-top: 0.375rem;
      font-size: 0.85rem;
    }

    .checkbox-inline input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .checkbox-inline label {
      font-weight: 400;
      color: var(--text-muted);
      cursor: pointer;
    }

    .form-actions {
      padding: 1.5rem;
      background: var(--bg);
      display: flex;
      justify-content: center;
    }

    .btn-submit {
      padding: 0.875rem 2.5rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .btn-submit:hover {
      background: #327568;
    }

    .btn-submit:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }

    /* Success state */
    .success-message {
      text-align: center;
      padding: 2rem;
    }

    .success-message .icon {
      font-size: 3.5rem;
      margin-bottom: 0.75rem;
    }

    .success-message h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--success);
    }

    .success-message > p {
      color: var(--text-muted);
      margin-bottom: 1rem;
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
    }

    .success-message a.btn-primary {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: white;
      text-decoration: none;
      border-radius: var(--radius);
      font-weight: 500;
      transition: background 0.15s ease;
    }

    .success-message a.btn-primary:hover {
      background: #327568;
    }

    /* Application Summary */
    .application-summary {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin: 1.5rem 0;
      text-align: left;
    }

    .application-summary h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.75rem;
      text-align: center;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-row .label {
      color: var(--text-muted);
    }

    .summary-row .value {
      font-weight: 500;
      color: var(--text);
      text-align: right;
    }

    /* What's Next Section */
    .whats-next {
      background: var(--accent-light);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin: 1.5rem 0;
      text-align: left;
    }

    .whats-next h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.75rem;
      text-align: center;
    }

    .whats-next ol {
      margin: 0;
      padding-left: 1.25rem;
    }

    .whats-next li {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .whats-next li:last-child {
      margin-bottom: 0;
    }

    .questions-contact {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 1rem 0;
    }

    .questions-contact a {
      color: var(--accent);
      text-decoration: none;
    }

    .questions-contact a:hover {
      text-decoration: underline;
    }

    /* Error message */
    .error-banner {
      padding: 1rem 1.5rem;
      background: var(--error-light);
      color: var(--error);
      border-bottom: 1px solid var(--error);
      font-weight: 500;
    }

    /* Loading state */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Application Fee Section */
    .fee-section {
      background: var(--accent-light);
      border-left: 4px solid var(--accent);
    }

    .fee-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--bg-card);
      border-radius: var(--radius);
      margin-bottom: 1rem;
    }

    .fee-label {
      font-weight: 500;
    }

    .fee-amount {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    .fee-amount.free {
      color: var(--success);
    }

    .fee-original {
      text-decoration: line-through;
      color: var(--text-muted);
      font-size: 1rem;
      margin-right: 0.5rem;
    }

    .discount-row {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .discount-row .form-group {
      flex: 1;
    }

    .discount-row button {
      padding: 0.625rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    .discount-row button:hover {
      background: var(--bg);
    }

    .code-message {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      padding: 0.5rem;
      border-radius: var(--radius);
    }

    .code-message.success {
      background: var(--success-light);
      color: var(--success);
    }

    .code-message.error {
      background: var(--error-light);
      color: var(--error);
    }

    /* Payment Card Section */
    .payment-section {
      display: none;
    }

    .payment-section.visible {
      display: block;
    }

    #card-container {
      min-height: 90px;
      padding: 1rem;
      background: var(--bg);
      border-radius: var(--radius);
      margin-bottom: 1rem;
    }

    .payment-note {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
      margin-top: 0.5rem;
    }

    .payment-note img {
      height: 24px;
      vertical-align: middle;
      margin-left: 0.5rem;
    }

    @media (max-width: 600px) {
      header {
        padding: 1.25rem 1rem;
      }

      header h1 {
        font-size: 1.5rem;
      }

      main {
        padding: 1rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .form-section {
        padding: 1.25rem;
      }

      .form-actions {
        padding: 1.25rem;
      }

      .btn-submit {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Alpaca Playhouse Austin</h1>
    <p>Residency Application</p>
  </header>

  <main>
    <div class="form-container" id="formContainer">
      <form id="applicationForm">
        <div id="errorBanner" class="error-banner hidden"></div>

        <!-- Section 1: Basic Info -->
        <div class="form-section">
          <h2>Basic Information</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="first_name">First Name <span class="required">*</span></label>
              <input type="text" id="first_name" name="first_name" required>
            </div>
            <div class="form-group">
              <label for="last_name">Last Name <span class="required">*</span></label>
              <input type="text" id="last_name" name="last_name" required>
            </div>
            <div class="form-group">
              <label for="email">Email <span class="required">*</span></label>
              <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
              <label for="phone">Phone</label>
              <input type="tel" id="phone" name="phone">
            </div>
            <div class="form-group">
              <label for="whatsapp">WhatsApp</label>
              <input type="text" id="whatsapp" name="whatsapp" placeholder="Phone number">
              <div class="checkbox-inline">
                <input type="checkbox" id="whatsapp_same_as_phone">
                <label for="whatsapp_same_as_phone">Same as phone</label>
              </div>
            </div>
            <div class="form-group">
              <label for="date_of_birth">Date of Birth</label>
              <input type="date" id="date_of_birth" name="date_of_birth">
            </div>
            <div class="form-group">
              <label for="gender">Gender</label>
              <select id="gender" name="gender">
                <option value="">Select...</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label for="current_address">Current Address</label>
              <textarea id="current_address" name="current_address" rows="2"></textarea>
            </div>
          </div>
        </div>

        <!-- Section 2: Desired Housing -->
        <div class="form-section">
          <h2>Desired Housing</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="desired_space_id">Preferred Space</label>
              <select id="desired_space_id" name="desired_space_id">
                <option value="">Flexible / Unknown</option>
              </select>
            </div>
            <div class="form-group">
              <label for="desired_move_in">Desired Move-in Date</label>
              <input type="date" id="desired_move_in" name="desired_move_in">
            </div>
            <div class="form-group full-width">
              <label for="desired_term">Desired Term</label>
              <input type="text" id="desired_term" name="desired_term" placeholder="e.g. 6 months, 1 year, flexible">
            </div>
          </div>
        </div>

        <!-- Section 3: Financial -->
        <div class="form-section">
          <h2>Financial Information</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="employment_status">Employment Status</label>
              <input type="text" id="employment_status" name="employment_status" placeholder="e.g. Full-time, Self-employed">
            </div>
            <div class="form-group">
              <label for="employer">Employer</label>
              <input type="text" id="employer" name="employer" placeholder="Company or business name">
            </div>
            <div class="form-group">
              <label for="monthly_income">Monthly Income ($)</label>
              <input type="number" id="monthly_income" name="monthly_income" min="0" step="1">
            </div>
            <div class="form-group">
              <label for="deposit_return_method">Preferred Deposit Return Method</label>
              <select id="deposit_return_method" name="deposit_return_method">
                <option value="">Select...</option>
                <option value="zelle">Zelle</option>
                <option value="venmo">Venmo</option>
                <option value="paypal">PayPal</option>
                <option value="check">Check</option>
                <option value="cash">Cash</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Section 4: Previous Residence -->
        <div class="form-section">
          <h2>Previous Residence</h2>
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="prev_address">Address</label>
              <textarea id="prev_address" name="prev_address" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label for="prev_start_date">Move-in Date</label>
              <input type="date" id="prev_start_date" name="prev_start_date">
            </div>
            <div class="form-group">
              <label for="prev_end_date">Move-out Date</label>
              <input type="date" id="prev_end_date" name="prev_end_date">
            </div>
            <div class="form-group">
              <label for="landlord_name">Landlord Name</label>
              <input type="text" id="landlord_name" name="landlord_name">
            </div>
            <div class="form-group">
              <label for="landlord_contact">Landlord Contact</label>
              <input type="text" id="landlord_contact" name="landlord_contact" placeholder="Phone or email">
            </div>
            <div class="form-group full-width">
              <label for="reason_for_leaving">Reason for Leaving</label>
              <textarea id="reason_for_leaving" name="reason_for_leaving" rows="2"></textarea>
            </div>
            <div class="form-group full-width checkbox-group">
              <input type="checkbox" id="prior_evictions" name="prior_evictions">
              <label for="prior_evictions">I have had a prior eviction</label>
            </div>
          </div>
        </div>

        <!-- Section 5: Household -->
        <div class="form-section">
          <h2>Household</h2>
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="partner_email">Email of partner if applying together</label>
              <input type="email" id="partner_email" name="partner_email" placeholder="Leave blank if not applicable">
            </div>
            <div class="form-group full-width">
              <label for="kids_ages">Children's Ages</label>
              <input type="text" id="kids_ages" name="kids_ages" placeholder="e.g. 4, 7, 12 (leave blank if none)">
            </div>
          </div>
        </div>

        <!-- Section 6: Property Details -->
        <div class="form-section">
          <h2>Property Details</h2>
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="vehicles">Vehicles</label>
              <textarea id="vehicles" name="vehicles" rows="2" placeholder="Describe type and size (e.g. Honda Civic sedan, Ford F-150 truck)"></textarea>
            </div>
            <div class="form-group full-width">
              <label for="pets">Pets</label>
              <textarea id="pets" name="pets" rows="2" placeholder="Type and details (e.g. 2 cats, 1 medium dog - golden retriever)"></textarea>
            </div>
            <div class="form-group full-width">
              <label for="allergies">Allergies</label>
              <input type="text" id="allergies" name="allergies" placeholder="Any allergies we should know about">
            </div>
          </div>
        </div>

        <!-- Section 7: Social Profiles -->
        <div class="form-section">
          <h2>Social Profiles <span style="font-weight: 400; color: var(--text-muted);">(Optional)</span></h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="instagram">Instagram</label>
              <input type="text" id="instagram" name="instagram" placeholder="@username">
            </div>
            <div class="form-group">
              <label for="facebook">Facebook</label>
              <input type="text" id="facebook" name="facebook" placeholder="Profile URL or name">
            </div>
            <div class="form-group">
              <label for="x_handle">X (Twitter)</label>
              <input type="text" id="x_handle" name="x_handle" placeholder="@handle">
            </div>
            <div class="form-group">
              <label for="myspace">MySpace</label>
              <input type="text" id="myspace" name="myspace" placeholder="Profile URL">
            </div>
          </div>
        </div>

        <!-- Section 8: Referral -->
        <div class="form-section">
          <h2>Referral</h2>
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="referral_source">How did you hear about us?</label>
              <input type="text" id="referral_source" name="referral_source" placeholder="e.g. Friend, Google, Social Media">
            </div>
          </div>
        </div>

        <!-- Section 9: Application Fee -->
        <div class="form-section fee-section">
          <h2>Application Fee</h2>
          <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">
            A non-refundable application fee is required to process your application.
          </p>
          <div class="fee-display">
            <span class="fee-label">Application Fee</span>
            <div>
              <span class="fee-original hidden" id="feeOriginal"></span>
              <span class="fee-amount" id="feeAmount">Loading...</span>
            </div>
          </div>
          <div class="discount-row">
            <div class="form-group">
              <label for="discount_code">Have a code?</label>
              <input type="text" id="discount_code" name="discount_code" placeholder="Enter code" style="text-transform: uppercase;">
            </div>
            <button type="button" id="applyCodeBtn">Apply</button>
          </div>
          <div id="codeMessage" class="code-message hidden"></div>
          <p class="payment-note" style="margin-top: 1rem;">
            <span id="secureTestTrigger" style="cursor: default;">Secure</span> payment powered by Square
          </p>
        </div>

        <!-- Payment Section (shown when fee > $0) -->
        <div class="form-section payment-section" id="paymentSection">
          <h2>Payment</h2>
          <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">
            Enter your card details to pay the application fee.
          </p>
          <div id="card-container">
            <!-- Square Card Element will be inserted here -->
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-submit" id="submitBtn">Submit Application</button>
        </div>
      </form>
    </div>

    <!-- Success Message (hidden by default) -->
    <div class="form-container hidden" id="successContainer">
      <div class="success-message">
        <div class="icon">&#129433;</div>
        <h2>Application Submitted!</h2>
        <p>Thank you for your interest in Alpaca Playhouse Austin. We've received your application and will be in touch with all due haste.</p>

        <div class="application-summary">
          <h3>Your Application Summary</h3>
          <div class="summary-row">
            <span class="label">Space</span>
            <span class="value" id="summarySpace">Flexible (we'll find the best fit)</span>
          </div>
          <div class="summary-row" id="summaryRateRow" style="display: none;">
            <span class="label">Monthly Rate</span>
            <span class="value" id="summaryRate"></span>
          </div>
          <div class="summary-row" id="summaryMoveInRow" style="display: none;">
            <span class="label">Desired Move-in</span>
            <span class="value" id="summaryMoveIn"></span>
          </div>
          <div class="summary-row" id="summaryTermRow" style="display: none;">
            <span class="label">Desired Term</span>
            <span class="value" id="summaryTerm"></span>
          </div>
          <div class="summary-row" id="summaryFeeRow" style="display: none;">
            <span class="label">Application Fee</span>
            <span class="value" id="summaryFee"></span>
          </div>
        </div>

        <div class="whats-next">
          <h3>What Happens Next</h3>
          <ol>
            <li>We'll review your application with all due haste</li>
            <li>If approved, we'll send you a lease agreement to sign electronically</li>
          </ol>
        </div>

        <p class="questions-contact">Questions? Email <a href="mailto:alpacaplayhouse@gmail.com">alpacaplayhouse@gmail.com</a></p>

        <a href="https://alpacaplayhouse.com" class="btn-primary">Learn About Our Community</a>
      </div>
    </div>
  </main>

  <!-- Load Supabase library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    // Import shared Supabase config (single source of truth)
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from '../../shared/supabase.js';
    const SUPABASE_KEY = SUPABASE_ANON_KEY;

    // Fee type constant
    const FEE_TYPE = 'rental_application';

    // State
    let feeAmount = 0;
    let originalAmount = 0;
    let appliedCode = null;
    let squareCard = null;
    let squarePayments = null;

    // Elements
    const form = document.getElementById('applicationForm');
    const formContainer = document.getElementById('formContainer');
    const successContainer = document.getElementById('successContainer');
    const errorBanner = document.getElementById('errorBanner');
    const submitBtn = document.getElementById('submitBtn');
    const spaceSelect = document.getElementById('desired_space_id');
    const phoneInput = document.getElementById('phone');
    const whatsappInput = document.getElementById('whatsapp');
    const whatsappSameCheckbox = document.getElementById('whatsapp_same_as_phone');
    const feeAmountEl = document.getElementById('feeAmount');
    const feeOriginalEl = document.getElementById('feeOriginal');
    const paymentSection = document.getElementById('paymentSection');
    const discountCodeInput = document.getElementById('discount_code');
    const applyCodeBtn = document.getElementById('applyCodeBtn');
    const codeMessage = document.getElementById('codeMessage');

    // Load application fee settings
    async function loadFeeSettings() {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/fee_settings?fee_type=eq.${FEE_TYPE}&is_active=eq.true&select=default_amount`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        if (!response.ok) throw new Error('Failed to load fee settings');

        const [settings] = await response.json();
        if (settings) {
          originalAmount = parseFloat(settings.default_amount);
          feeAmount = originalAmount;
          updateFeeDisplay();
        }
      } catch (error) {
        console.error('Error loading fee settings:', error);
        feeAmountEl.textContent = 'Error loading fee';
      }
    }

    // Update fee display and payment section visibility
    function updateFeeDisplay() {
      if (feeAmount === 0) {
        feeAmountEl.textContent = 'FREE';
        feeAmountEl.classList.add('free');
        paymentSection.classList.remove('visible');
      } else {
        feeAmountEl.textContent = `$${feeAmount.toFixed(2)}`;
        feeAmountEl.classList.remove('free');
        paymentSection.classList.add('visible');
        initializeSquare();
      }

      // Show original price if code applied
      if (appliedCode && originalAmount !== feeAmount) {
        feeOriginalEl.textContent = `$${originalAmount.toFixed(2)}`;
        feeOriginalEl.classList.remove('hidden');
      } else {
        feeOriginalEl.classList.add('hidden');
      }
    }

    // Validate discount code
    async function validateCode(code) {
      if (!code) return null;

      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/fee_codes?code=eq.${code.toUpperCase()}&fee_type=eq.${FEE_TYPE}&is_active=eq.true&select=*`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        if (!response.ok) throw new Error('Failed to validate code');

        const [codeData] = await response.json();

        if (!codeData) {
          return { valid: false, message: 'Invalid code' };
        }

        // Check expiration
        if (codeData.expires_at && new Date(codeData.expires_at) < new Date()) {
          return { valid: false, message: 'Code has expired' };
        }

        // Check usage limit
        if (codeData.usage_limit !== null && codeData.times_used >= codeData.usage_limit) {
          return { valid: false, message: 'Code has reached its usage limit' };
        }

        return {
          valid: true,
          price: parseFloat(codeData.price),
          message: codeData.price === 0 ? 'Application fee waived!' : `Code applied! Fee: $${codeData.price.toFixed(2)}`
        };
      } catch (error) {
        console.error('Error validating code:', error);
        return { valid: false, message: 'Error validating code' };
      }
    }

    // Apply code button handler
    applyCodeBtn.addEventListener('click', async () => {
      const code = discountCodeInput.value.trim();

      if (!code) {
        codeMessage.classList.add('hidden');
        appliedCode = null;
        feeAmount = originalAmount;
        updateFeeDisplay();
        return;
      }

      applyCodeBtn.disabled = true;
      applyCodeBtn.textContent = 'Checking...';

      const result = await validateCode(code);

      applyCodeBtn.disabled = false;
      applyCodeBtn.textContent = 'Apply';

      codeMessage.textContent = result.message;
      codeMessage.classList.remove('hidden', 'success', 'error');
      codeMessage.classList.add(result.valid ? 'success' : 'error');

      if (result.valid) {
        appliedCode = code.toUpperCase();
        feeAmount = result.price;
      } else {
        appliedCode = null;
        feeAmount = originalAmount;
      }

      updateFeeDisplay();
    });

    // Initialize Square SDK
    async function initializeSquare() {
      if (squarePayments) return; // Already initialized

      try {
        // Load Square config
        const configResponse = await fetch(
          `${SUPABASE_URL}/rest/v1/square_config?select=sandbox_app_id,production_app_id,sandbox_location_id,production_location_id,test_mode`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        if (!configResponse.ok) throw new Error('Failed to load Square config');

        const [config] = await configResponse.json();
        const isTestMode = config.test_mode;
        const appId = isTestMode ? config.sandbox_app_id : config.production_app_id;
        const locationId = isTestMode ? config.sandbox_location_id : config.production_location_id;

        // Load Square SDK
        const sdkUrl = isTestMode
          ? 'https://sandbox.web.squarecdn.com/v1/square.js'
          : 'https://web.squarecdn.com/v1/square.js';

        await loadScript(sdkUrl);

        // Initialize payments
        squarePayments = window.Square.payments(appId, locationId);

        // Create card element
        squareCard = await squarePayments.card();
        await squareCard.attach('#card-container');

      } catch (error) {
        console.error('Error initializing Square:', error);
        document.getElementById('card-container').innerHTML =
          '<p style="color: var(--error); text-align: center;">Payment system unavailable. Please try again later.</p>';
      }
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
          // Check if already loaded
          const checkInterval = setInterval(() => {
            if (window.Square) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
          return;
        }

        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // Load dwelling spaces for dropdown
    async function loadSpaces() {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/spaces?can_be_dwelling=eq.true&is_archived=eq.false&is_listed=eq.true&select=id,name&order=name`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        if (!response.ok) throw new Error('Failed to load spaces');

        const spaces = await response.json();
        spaces.forEach(space => {
          const option = document.createElement('option');
          option.value = space.id;
          option.textContent = space.name;
          spaceSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading spaces:', error);
      }
    }

    // WhatsApp same as phone checkbox
    whatsappSameCheckbox.addEventListener('change', () => {
      if (whatsappSameCheckbox.checked) {
        whatsappInput.value = phoneInput.value;
        whatsappInput.disabled = true;
      } else {
        whatsappInput.disabled = false;
      }
    });

    // Update WhatsApp when phone changes (if checkbox is checked)
    phoneInput.addEventListener('input', () => {
      if (whatsappSameCheckbox.checked) {
        whatsappInput.value = phoneInput.value;
      }
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear previous errors
      errorBanner.classList.add('hidden');
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

      // Validate required fields
      const firstName = document.getElementById('first_name').value.trim();
      const lastName = document.getElementById('last_name').value.trim();
      const email = document.getElementById('email').value.trim();

      let hasError = false;

      if (!firstName) {
        document.getElementById('first_name').classList.add('error');
        hasError = true;
      }
      if (!lastName) {
        document.getElementById('last_name').classList.add('error');
        hasError = true;
      }
      if (!email) {
        document.getElementById('email').classList.add('error');
        hasError = true;
      }

      if (hasError) {
        showError('Please fill in all required fields.');
        return;
      }

      // Disable form while submitting
      submitBtn.disabled = true;
      submitBtn.textContent = feeAmount > 0 ? 'Processing Payment...' : 'Submitting...';
      form.classList.add('loading');

      try {
        // Build person data
        const personData = {
          first_name: firstName,
          last_name: lastName,
          email: email,
          phone: getValue('phone'),
          whatsapp: getValue('whatsapp'),
          date_of_birth: getValue('date_of_birth') || null,
          gender: getValue('gender') || null,
          current_address: getValue('current_address'),
          desired_space_id: getValue('desired_space_id') || null,
          desired_move_in: getValue('desired_move_in') || null,
          desired_term: getValue('desired_term'),
          employment_status: getValue('employment_status'),
          employer: getValue('employer'),
          monthly_income: getValue('monthly_income') ? parseFloat(getValue('monthly_income')) : null,
          deposit_return_method: getValue('deposit_return_method') || null,
          partner_email: getValue('partner_email'),
          kids_ages: getValue('kids_ages'),
          vehicles: getValue('vehicles'),
          pets: getValue('pets'),
          allergies: getValue('allergies'),
          prior_evictions: document.getElementById('prior_evictions').checked,
          instagram: getValue('instagram'),
          facebook: getValue('facebook'),
          x_handle: getValue('x_handle'),
          myspace: getValue('myspace'),
          referral_source: getValue('referral_source'),
          status: 'candidate'
        };

        // Insert person
        const personResponse = await fetch(`${SUPABASE_URL}/rest/v1/people`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(personData)
        });

        if (!personResponse.ok) {
          const errorData = await personResponse.json();
          throw new Error(errorData.message || 'Failed to submit application');
        }

        const [person] = await personResponse.json();

        // Create rental application record
        const applicationData = {
          person_id: person.id,
          desired_space_id: getValue('desired_space_id') || null,
          desired_move_in: getValue('desired_move_in') || null,
          desired_term: getValue('desired_term') || null,
          application_status: 'submitted'
        };

        const applicationResponse = await fetch(`${SUPABASE_URL}/rest/v1/rental_applications`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(applicationData)
        });

        let applicationId = null;
        if (applicationResponse.ok) {
          const [app] = await applicationResponse.json();
          applicationId = app.id;
        } else {
          console.error('Failed to create rental application');
        }

        // Process payment if fee > 0
        if (feeAmount > 0 && applicationId) {
          if (!squareCard) {
            throw new Error('Payment system not ready. Please refresh and try again.');
          }

          // Tokenize the card
          const tokenResult = await squareCard.tokenize();

          if (tokenResult.status !== 'OK') {
            const errorMessage = tokenResult.errors?.[0]?.message || 'Card payment failed';
            throw new Error(errorMessage);
          }

          // Create pending payment record
          const paymentRecordResponse = await fetch(`${SUPABASE_URL}/rest/v1/square_payments`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify({
              payment_type: FEE_TYPE,
              reference_type: 'rental_application',
              reference_id: applicationId,
              amount: feeAmount,
              fee_code_used: appliedCode,
              original_amount: originalAmount,
              status: 'pending'
            })
          });

          if (!paymentRecordResponse.ok) {
            throw new Error('Failed to create payment record');
          }

          const [paymentRecord] = await paymentRecordResponse.json();

          // Process payment via Edge Function
          const processResponse = await fetch(`${SUPABASE_URL}/functions/v1/process-square-payment`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              sourceId: tokenResult.token,
              amount: Math.round(feeAmount * 100), // Convert to cents
              paymentRecordId: paymentRecord.id,
              buyerEmail: email,
              note: `Rental Application Fee - ${firstName} ${lastName}`
            })
          });

          const processResult = await processResponse.json();

          if (!processResult.success) {
            // Update payment record with failure
            await fetch(`${SUPABASE_URL}/rest/v1/square_payments?id=eq.${paymentRecord.id}`, {
              method: 'PATCH',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                status: 'failed',
                error_message: processResult.error,
                updated_at: new Date().toISOString()
              })
            });

            throw new Error(processResult.error || 'Payment failed');
          }

          // Update payment record with success
          await fetch(`${SUPABASE_URL}/rest/v1/square_payments?id=eq.${paymentRecord.id}`, {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              status: 'completed',
              square_payment_id: processResult.paymentId,
              square_order_id: processResult.orderId,
              square_receipt_url: processResult.receiptUrl,
              updated_at: new Date().toISOString()
            })
          });

          // Update rental application with payment info
          await fetch(`${SUPABASE_URL}/rest/v1/rental_applications?id=eq.${applicationId}`, {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              application_fee_paid: true,
              application_fee_amount: feeAmount,
              application_fee_code: appliedCode
            })
          });

          // Increment code usage if applicable
          if (appliedCode) {
            await fetch(`${SUPABASE_URL}/rest/v1/rpc/increment_fee_code_usage`, {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ code_id: appliedCode })
            });
          }
        } else if (feeAmount === 0 && applicationId) {
          // Record $0 payment
          await fetch(`${SUPABASE_URL}/rest/v1/square_payments`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              payment_type: FEE_TYPE,
              reference_type: 'rental_application',
              reference_id: applicationId,
              amount: 0,
              fee_code_used: appliedCode,
              original_amount: originalAmount,
              status: 'completed'
            })
          });

          // Update rental application
          await fetch(`${SUPABASE_URL}/rest/v1/rental_applications?id=eq.${applicationId}`, {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              application_fee_paid: true,
              application_fee_amount: 0,
              application_fee_code: appliedCode
            })
          });
        }

        // Insert previous residence if provided
        const prevAddress = getValue('prev_address');
        if (prevAddress) {
          const residenceData = {
            person_id: person.id,
            address: prevAddress,
            start_date: getValue('prev_start_date') || null,
            end_date: getValue('prev_end_date') || null,
            landlord_name: getValue('landlord_name'),
            landlord_contact: getValue('landlord_contact'),
            reason_for_leaving: getValue('reason_for_leaving')
          };

          await fetch(`${SUPABASE_URL}/rest/v1/previous_residences`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(residenceData)
          });
        }

        // Get the selected space name if one was selected
        let spaceName = null;
        const selectedSpace = spaceSelect.options[spaceSelect.selectedIndex];
        if (selectedSpace && selectedSpace.value) {
          spaceName = selectedSpace.textContent;
        }

        // Send admin notification email
        try {
          await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              type: 'admin_rental_application',
              to: 'alpacaplayhouse@gmail.com',
              data: {
                first_name: firstName,
                last_name: lastName,
                email: email,
                phone: getValue('phone'),
                current_location: getValue('current_address'),
                space_name: spaceName,
                desired_move_in: getValue('desired_move_in'),
                desired_lease_length: getValue('desired_term'),
                employment_status: getValue('employment_status'),
                employer: getValue('employer'),
                monthly_income: getValue('monthly_income'),
                about_yourself: null,
                why_interested: getValue('referral_source') ? `Referral: ${getValue('referral_source')}` : null,
                additional_notes: [
                  getValue('vehicles') ? `Vehicles: ${getValue('vehicles')}` : null,
                  getValue('pets') ? `Pets: ${getValue('pets')}` : null,
                  getValue('allergies') ? `Allergies: ${getValue('allergies')}` : null,
                  getValue('kids_ages') ? `Children's ages: ${getValue('kids_ages')}` : null,
                  document.getElementById('prior_evictions').checked ? 'Has prior evictions' : null,
                  feeAmount > 0 ? `Application fee paid: $${feeAmount.toFixed(2)}` : (appliedCode ? `Application fee waived (code: ${appliedCode})` : null)
                ].filter(Boolean).join('\n') || null
              }
            })
          });
        } catch (emailError) {
          console.error('Failed to send admin notification email:', emailError);
          // Don't fail the submission if email fails
        }

        // Populate success summary
        populateSuccessSummary(spaceName, feeAmount);

        // Show success
        formContainer.classList.add('hidden');
        successContainer.classList.remove('hidden');

      } catch (error) {
        console.error('Submission error:', error);
        showError(error.message || 'Something went wrong. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
        form.classList.remove('loading');
      }
    });

    function populateSuccessSummary(spaceName, feePaid) {
      // Space name
      if (spaceName) {
        document.getElementById('summarySpace').textContent = spaceName;

        // Find the space to get the monthly rate
        const selectedOption = spaceSelect.options[spaceSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
          // We need to fetch the rate from the space
          fetch(`${SUPABASE_URL}/rest/v1/spaces?id=eq.${selectedOption.value}&select=monthly_rate`, {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          })
          .then(r => r.json())
          .then(([space]) => {
            if (space && space.monthly_rate) {
              document.getElementById('summaryRate').textContent = `$${parseFloat(space.monthly_rate).toLocaleString()}/month`;
              document.getElementById('summaryRateRow').style.display = 'flex';
            }
          })
          .catch(() => {});
        }
      } else {
        document.getElementById('summarySpace').textContent = 'Flexible (we\'ll find the best fit)';
      }

      // Desired move-in date
      const moveIn = getValue('desired_move_in');
      if (moveIn) {
        const moveInDate = new Date(moveIn + 'T12:00:00');
        document.getElementById('summaryMoveIn').textContent = moveInDate.toLocaleDateString('en-US', {
          month: 'long',
          day: 'numeric',
          year: 'numeric'
        });
        document.getElementById('summaryMoveInRow').style.display = 'flex';
      }

      // Desired term
      const term = getValue('desired_term');
      if (term) {
        document.getElementById('summaryTerm').textContent = term;
        document.getElementById('summaryTermRow').style.display = 'flex';
      }

      // Application fee
      if (feePaid > 0) {
        document.getElementById('summaryFee').textContent = `$${feePaid.toFixed(2)} paid`;
        document.getElementById('summaryFeeRow').style.display = 'flex';
      } else if (appliedCode) {
        document.getElementById('summaryFee').textContent = 'Waived';
        document.getElementById('summaryFeeRow').style.display = 'flex';
      }
    }

    function getValue(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : '';
    }

    function showError(message) {
      errorBanner.textContent = message;
      errorBanner.classList.remove('hidden');
      errorBanner.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Test data fill (click on "Secure" to trigger)
    document.getElementById('secureTestTrigger').addEventListener('click', () => {
      // Basic Info
      document.getElementById('first_name').value = 'Test';
      document.getElementById('last_name').value = 'Applicant';
      document.getElementById('email').value = 'test@example.com';
      document.getElementById('phone').value = '512-555-0123';
      document.getElementById('whatsapp').value = '512-555-0123';
      document.getElementById('date_of_birth').value = '1990-01-15';
      document.getElementById('gender').value = 'other';
      document.getElementById('current_address').value = '160 Still Forest Drive, Cedar Creek, TX 78612';

      // Desired Housing - dates far in the future
      document.getElementById('desired_move_in').value = '2030-01-01';
      document.getElementById('desired_term').value = '6 months';

      // Financial
      document.getElementById('employment_status').value = 'Self-employed';
      document.getElementById('employer').value = 'Test Company LLC';
      document.getElementById('monthly_income').value = '5000';
      document.getElementById('deposit_return_method').value = 'zelle';

      // Previous Residence
      document.getElementById('prev_address').value = '1100 Congress Ave, Austin, TX 78701';
      document.getElementById('prev_start_date').value = '2025-01-01';
      document.getElementById('prev_end_date').value = '2029-12-31';
      document.getElementById('landlord_name').value = 'Jane Landlord';
      document.getElementById('landlord_contact').value = '512-555-9999';
      document.getElementById('reason_for_leaving').value = 'Looking for community living';

      // Household
      document.getElementById('partner_email').value = '';
      document.getElementById('kids_ages').value = '';

      // Property Details
      document.getElementById('vehicles').value = 'Honda Civic sedan';
      document.getElementById('pets').value = 'None';
      document.getElementById('allergies').value = 'None';

      // Social
      document.getElementById('instagram').value = '@testuser';
      document.getElementById('facebook').value = 'testuser';
      document.getElementById('x_handle').value = '@testuser';
      document.getElementById('myspace').value = '';

      // Referral
      document.getElementById('referral_source').value = 'Testing';

      console.log('Test data filled for rental application');
    });

    // Initialize
    loadSpaces();
    loadFeeSettings();
  </script>
</body>
</html>
