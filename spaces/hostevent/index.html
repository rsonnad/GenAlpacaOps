<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="icon" type="image/png" href="../../favicon.png">
  <link rel="apple-touch-icon" href="../../apple-touch-icon.png">
  <title>Host an Event - Alpaca Playhouse Austin</title>
  <style>
    /* Site-wide Navigation Bar */
    .site-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 2rem;
      background: #2d3024;
      color: white;
    }

    .site-nav__logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: white;
    }

    .site-nav__icon {
      height: 32px;
      width: auto;
    }

    .site-nav__wordmark {
      height: 18px;
      width: auto;
    }

    .site-nav__logo span {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      font-size: 1.1rem;
      font-weight: 500;
    }

    .site-nav__version {
      font-size: 0.65rem;
      color: rgba(255, 255, 255, 0.4);
      font-weight: 400;
      margin-left: -0.5rem;
    }

    .site-nav__links {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
      gap: 1.5rem;
    }

    .site-nav__links a {
      color: rgba(255, 255, 255, 0.85);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }

    .site-nav__links a:hover,
    .site-nav__links a.active {
      color: white;
    }

    .site-nav__toggle {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
    }

    .site-nav__toggle span {
      display: block;
      width: 22px;
      height: 2px;
      background: white;
      margin: 5px 0;
    }

    /* Mobile Site Navigation */
    .site-nav-mobile {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #2d3024;
      z-index: 200;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .site-nav-mobile.open {
      opacity: 1;
      visibility: visible;
    }

    .site-nav-mobile__close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 2rem;
      color: white;
      cursor: pointer;
    }

    .site-nav-mobile__links {
      list-style: none;
      padding: 0;
      margin: 0;
      text-align: center;
    }

    .site-nav-mobile__links li {
      margin: 1.25rem 0;
    }

    .site-nav-mobile__links a {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      font-size: 1.5rem;
      color: white;
      text-decoration: none;
    }

    .site-nav-mobile__links a.active {
      color: var(--accent);
    }

    @media (max-width: 900px) {
      .site-nav__links {
        display: none;
      }

      .site-nav__toggle {
        display: block;
      }
    }

    @media (max-width: 600px) {
      .site-nav {
        padding: 0.75rem 1rem;
      }

      .site-nav__logo span {
        font-size: 0.95rem;
      }

      .site-nav__icon {
        height: 28px;
      }

      .site-nav__wordmark {
        display: none;
      }
    }

    :root {
      --bg: #faf9f7;
      --bg-card: #ffffff;
      --text: #2d3142;
      --text-muted: #7a7d8c;
      --border: #e8e9ed;
      --accent: #3d8b7a;
      --accent-light: #e5f4f1;
      --error: #e07a5f;
      --error-light: #fdf0ec;
      --success: #5a9e8f;
      --success-light: #e8f5f2;
      --warning: #f59e0b;
      --warning-light: #fffbeb;
      --radius: 8px;
      --shadow: 0 1px 3px rgba(45,49,66,0.06), 0 1px 2px rgba(45,49,66,0.08);
      --shadow-lg: 0 4px 12px rgba(45,49,66,0.08), 0 2px 4px rgba(45,49,66,0.06);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    header {
      padding: 2rem;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    header h1 {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 0.5rem;
    }

    header p {
      color: var(--text-muted);
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .see-spaces-btn {
      display: inline-block;
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: white;
      text-decoration: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.95rem;
      transition: background 0.2s ease;
    }

    .header-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .header-buttons .see-spaces-btn {
      margin-top: 0;
    }

    .apply-btn {
      background: transparent !important;
      border: 2px solid var(--accent) !important;
      color: var(--accent) !important;
    }

    .apply-btn:hover {
      background: var(--accent) !important;
      color: white !important;
    }

    .see-spaces-btn:hover {
      background: #357a6a;
    }

    main {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }

    .intro-section {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .intro-section h2 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--accent);
    }

    .intro-section p {
      margin-bottom: 1rem;
      color: var(--text);
    }

    .intro-section ul {
      margin: 1rem 0 1rem 1.5rem;
    }

    .intro-section li {
      margin-bottom: 0.5rem;
    }

    .fees-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin: 1.5rem 0;
    }

    @media (max-width: 600px) {
      .fees-grid {
        grid-template-columns: 1fr;
      }
    }

    .fee-card {
      background: var(--accent-light);
      border-radius: var(--radius);
      padding: 1rem;
      text-align: center;
    }

    .fee-card .fee-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .fee-card .fee-amount {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    .fee-card .fee-note {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .policy-section {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      overflow: hidden;
    }

    .policy-header {
      padding: 1rem 1.5rem;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .policy-header:hover {
      background: var(--accent-light);
    }

    .policy-header .toggle-icon {
      transition: transform 0.2s ease;
    }

    .policy-section[open] .policy-header .toggle-icon {
      transform: rotate(180deg);
    }

    .policy-content {
      padding: 1.5rem;
    }

    .policy-content h4 {
      font-size: 0.9rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem 0;
      color: var(--text);
    }

    .policy-content h4:first-child {
      margin-top: 0;
    }

    .policy-content p {
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }

    .policy-content ul {
      margin: 0.5rem 0 1rem 1.5rem;
    }

    .policy-content li {
      margin-bottom: 0.375rem;
      font-size: 0.95rem;
    }

    .warning-box {
      background: var(--warning-light);
      border: 1px solid var(--warning);
      border-radius: var(--radius);
      padding: 1rem;
      margin: 1rem 0;
    }

    .warning-box strong {
      color: #92400e;
    }

    .form-container {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .form-section {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .form-section:last-of-type {
      border-bottom: none;
    }

    .form-section h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--accent);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 600px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
    }

    .form-group label .required {
      color: var(--error);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.625rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.95rem;
      background: var(--bg);
      transition: border-color 0.15s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .form-group input.error,
    .form-group select.error,
    .form-group textarea.error {
      border-color: var(--error);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .time-inputs {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .time-inputs input {
      flex: 1;
    }

    .time-inputs span {
      color: var(--text-muted);
    }

    .checkbox-group {
      flex-direction: row;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: 1.125rem;
      height: 1.125rem;
      accent-color: var(--accent);
      cursor: pointer;
      margin-top: 0.125rem;
      flex-shrink: 0;
    }

    .checkbox-group label {
      cursor: pointer;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .spaces-table-container {
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .spaces-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .spaces-table th,
    .spaces-table td {
      padding: 0.625rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .spaces-table th {
      background: var(--bg);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .spaces-table tbody tr {
      cursor: pointer;
    }

    .spaces-table tbody tr:hover {
      background: var(--accent-light);
    }

    .spaces-table tbody tr.unavailable {
      background: var(--bg);
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .spaces-table tbody tr.unavailable:hover {
      background: var(--bg);
    }

    .spaces-table .checkbox-cell {
      width: 40px;
      text-align: center;
    }

    .spaces-table input[type="checkbox"] {
      width: 1.125rem;
      height: 1.125rem;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .spaces-table input[type="checkbox"]:disabled {
      cursor: not-allowed;
      opacity: 0.4;
    }

    .space-name {
      font-weight: 500;
    }

    .space-thumbnail {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.15s ease;
    }

    .space-thumbnail:hover {
      transform: scale(1.05);
    }

    .space-thumbnail-placeholder {
      width: 50px;
      height: 50px;
      background: var(--bg);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.7rem;
    }

    .thumbnail-cell {
      width: 60px;
      padding: 0.375rem 0.5rem !important;
    }

    /* Lightbox styles */
    .lightbox {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
    }

    .lightbox img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: var(--radius);
    }

    .lightbox-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0.5rem;
    }

    .availability-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .availability-badge.available {
      background: var(--success-light);
      color: var(--success);
    }

    .availability-badge.unavailable {
      background: var(--error-light);
      color: var(--error);
    }

    .spaces-loading {
      padding: 2rem;
      text-align: center;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .spaces-table .hide-mobile {
        display: none;
      }
    }

    .acknowledgments-section {
      background: var(--warning-light);
      border: 1px solid var(--warning);
      border-radius: var(--radius);
      padding: 1rem;
    }

    .acknowledgments-section h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 0.75rem;
    }

    .ack-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .ack-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .ack-item input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      accent-color: var(--accent);
      margin-top: 0.125rem;
      flex-shrink: 0;
    }

    .ack-item label {
      font-size: 0.85rem;
      cursor: pointer;
      line-height: 1.4;
    }

    .form-actions {
      padding: 1.5rem;
      background: var(--bg);
      display: flex;
      justify-content: center;
    }

    .btn-submit {
      padding: 0.875rem 2.5rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .btn-submit:hover {
      background: #327568;
    }

    .btn-submit:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }

    .hidden {
      display: none !important;
    }

    .success-message {
      text-align: center;
      padding: 2rem;
    }

    .success-message .icon {
      font-size: 3.5rem;
      margin-bottom: 0.75rem;
    }

    .success-message h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--success);
    }

    .success-message > p {
      color: var(--text-muted);
      margin-bottom: 1rem;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .success-message a.btn-primary {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: white;
      text-decoration: none;
      border-radius: var(--radius);
      font-weight: 500;
      transition: background 0.15s ease;
    }

    .success-message a.btn-primary:hover {
      background: #327568;
    }

    /* Event Summary */
    .event-summary {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin: 1.5rem 0;
      text-align: left;
    }

    .event-summary h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.75rem;
      text-align: center;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-row .label {
      color: var(--text-muted);
    }

    .summary-row .value {
      font-weight: 500;
      color: var(--text);
      text-align: right;
      max-width: 60%;
    }

    /* What's Next Section */
    .whats-next {
      background: var(--accent-light);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin: 1.5rem 0;
      text-align: left;
    }

    .whats-next h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.75rem;
      text-align: center;
    }

    .whats-next ol {
      margin: 0;
      padding-left: 1.25rem;
    }

    .whats-next li {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .whats-next li:last-child {
      margin-bottom: 0;
    }

    .whats-next .payment-note {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Ask a Question Section (in success view) */
    .success-ask-section {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin: 1.5rem 0;
      text-align: left;
    }

    .success-ask-section h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .success-ask-section > p {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 1rem;
    }

    .success-question-input-wrapper {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .success-question-input {
      flex: 1;
      padding: 0.625rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.875rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .success-question-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(61, 139, 122, 0.1);
    }

    .success-ask-btn {
      padding: 0.625rem 1.25rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .success-ask-btn:hover {
      background: #327568;
    }

    .success-ask-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .success-answer-container {
      display: none;
      margin-top: 0.75rem;
      padding: 1rem;
      background: white;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .success-answer-container.visible {
      display: block;
    }

    .success-answer-text {
      font-size: 0.875rem;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .success-answer-feedback {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .success-answer-feedback span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .success-feedback-btn {
      padding: 0.375rem 0.75rem;
      border: 1px solid var(--border);
      background: white;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .success-feedback-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .success-feedback-btn--negative {
      border-color: var(--error, #dc2626);
      color: var(--error, #dc2626);
    }

    .success-feedback-btn--negative:hover {
      background: #fef2f2;
    }

    .success-low-confidence {
      display: none;
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: #fef3c7;
      border-radius: 6px;
      font-size: 0.8rem;
      color: #92400e;
    }

    .success-low-confidence.visible {
      display: block;
    }

    .success-followup-form {
      display: none;
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: var(--bg);
      border-radius: var(--radius);
    }

    .success-followup-form.visible {
      display: block;
    }

    .success-followup-form p {
      margin: 0 0 0.5rem;
      font-size: 0.8rem;
    }

    .success-followup-fields {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      margin-bottom: 0.5rem;
    }

    .success-followup-input {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.8rem;
    }

    .success-followup-btn {
      padding: 0.375rem 0.75rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .success-question-submitted {
      display: none;
      padding: 0.75rem;
      background: #d1fae5;
      border-radius: var(--radius);
      color: #065f46;
      font-size: 0.8rem;
    }

    .success-question-submitted.visible {
      display: block;
    }

    /* Contact form in success view */
    .success-contact-section {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin: 1.5rem 0 0;
      text-align: left;
    }

    .success-contact-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: none;
      border: none;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
      width: 100%;
      padding: 0;
    }

    .success-contact-toggle .toggle-arrow {
      transition: transform 0.2s;
      font-size: 0.75rem;
    }

    .success-contact-toggle.expanded .toggle-arrow {
      transform: rotate(180deg);
    }

    .success-contact-body {
      display: none;
      margin-top: 1rem;
    }

    .success-contact-body.visible {
      display: block;
    }

    .success-contact-methods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .success-contact-method {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .success-contact-method__icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 6px;
      color: var(--accent);
      flex-shrink: 0;
    }

    .success-contact-method__info h4 {
      margin: 0 0 0.125rem;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .success-contact-method__info a,
    .success-contact-method__info span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .success-contact-method__info a {
      color: var(--accent);
      text-decoration: none;
    }

    .success-contact-method__info a:hover {
      text-decoration: underline;
    }

    .success-message-form {
      border-top: 1px solid var(--border);
      padding-top: 1rem;
    }

    .success-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .success-form-group {
      margin-bottom: 0.75rem;
    }

    .success-form-group label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 500;
      font-size: 0.8rem;
    }

    .success-form-group input,
    .success-form-group textarea,
    .success-form-group select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.875rem;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }

    .success-form-group input:focus,
    .success-form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(61, 139, 122, 0.1);
    }

    .success-form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .success-submit-btn {
      width: 100%;
      padding: 0.625rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .success-submit-btn:hover {
      background: #327568;
    }

    .success-form-success {
      display: none;
      padding: 0.75rem;
      background: #d1fae5;
      border-radius: var(--radius);
      color: #065f46;
      font-size: 0.8rem;
      margin-top: 0.75rem;
    }

    .success-form-success.visible {
      display: block;
    }

    .success-loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid white;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.375rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 600px) {
      .success-question-input-wrapper {
        flex-direction: column;
      }

      .success-ask-btn {
        width: 100%;
      }

      .success-form-row {
        grid-template-columns: 1fr;
      }
    }

    .error-banner {
      padding: 1rem 1.5rem;
      background: var(--error-light);
      color: var(--error);
      border-bottom: 1px solid var(--error);
      font-weight: 500;
    }

    /* Deposit Sections */
    .deposit-section {
      background: var(--accent-light);
      border-left: 4px solid var(--accent);
    }

    .deposit-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 600px) {
      .deposit-grid {
        grid-template-columns: 1fr;
      }
    }

    .deposit-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .deposit-card h4 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
    }

    .deposit-card .deposit-description {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 0;
    }

    .deposit-amount {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .deposit-amount .amount {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
    }

    .deposit-amount .amount.free {
      color: var(--success);
    }

    .deposit-amount .original {
      text-decoration: line-through;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-right: 0.5rem;
    }

    .code-row {
      display: flex;
      gap: 0.5rem;
    }

    .code-row input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    .code-row button {
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .code-row button:hover {
      background: var(--border);
    }

    .code-result {
      font-size: 0.8rem;
      padding: 0.375rem 0.5rem;
      border-radius: 4px;
    }

    .code-result.success {
      background: var(--success-light);
      color: var(--success);
    }

    .code-result.error {
      background: var(--error-light);
      color: var(--error);
    }

    .deposit-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--bg-card);
      border-radius: var(--radius);
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .deposit-total .total-amount {
      font-size: 1.5rem;
      color: var(--accent);
    }

    .deposit-total .total-amount.free {
      color: var(--success);
    }

    /* Payment Card Section */
    .payment-card-section {
      display: none;
    }

    .payment-card-section.visible {
      display: block;
    }

    /* Staff Sandbox Toggle */
    .staff-sandbox-bar {
      display: none;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      color: #92400e;
    }
    .staff-sandbox-bar.visible { display: flex; }
    .staff-sandbox-bar label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600; }
    .staff-sandbox-badge {
      background: #f59e0b;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      letter-spacing: 0.5px;
    }
    .sandbox-banner {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #fef3c7;
      color: #92400e;
      padding: 0.5rem;
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
      z-index: 9999;
      border-bottom: 2px solid #f59e0b;
    }
    .sandbox-banner.visible { display: block; }
    body.sandbox-active { padding-top: 2.5rem; }

    #event-card-container {
      min-height: 90px;
      padding: 1rem;
      background: var(--bg);
      border-radius: var(--radius);
      margin-bottom: 0.5rem;
    }

    .payment-note {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      color: var(--accent);
      text-decoration: none;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      header {
        padding: 1.5rem 1rem;
      }

      header h1 {
        font-size: 1.5rem;
      }

      main {
        padding: 1rem;
      }

      .intro-section,
      .form-section {
        padding: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <!-- Staff Sandbox Banner (shown when staff test mode active) -->
  <div id="sandboxBanner" class="sandbox-banner">SANDBOX MODE â€” Payments use Square test credentials</div>
  <!-- Site-wide Navigation -->
  <nav class="site-nav">
    <a href="/" class="site-nav__logo">
      <img src="https://aphrrfprbixmhissnjfn.supabase.co/storage/v1/object/public/housephotos/logos/alpaca-head-white-transparent.png" alt="Alpaca Playhouse Austin" class="site-nav__icon">
      <img src="https://aphrrfprbixmhissnjfn.supabase.co/storage/v1/object/public/housephotos/logos/wordmark-white-transparent.png" alt="Alpaca Playhouse Austin" class="site-nav__wordmark">
      <span title="Site version" class="site-nav__version">v260211.62 2:46p</span>
    </a>
    <ul class="site-nav__links">
      <li><a href="/visiting/">Visiting</a></li>
      <li><a href="/spaces/">Rentals</a></li>
      <li><a href="/spaces/hostevent/" class="active">Events</a></li>
      <li><a href="/community/">Community</a></li>
      <li><a href="/photos/">Photos</a></li>
      <li><a href="/contact/">Contact</a></li>
    </ul>
    <button class="site-nav__toggle" id="siteNavToggle" aria-label="Toggle navigation">
      <span></span><span></span><span></span>
    </button>
  </nav>

  <!-- Mobile Site Navigation -->
  <div class="site-nav-mobile" id="siteNavMobile">
    <button class="site-nav-mobile__close" id="siteNavMobileClose">&times;</button>
    <ul class="site-nav-mobile__links">
      <li><a href="/visiting/">Visiting</a></li>
      <li><a href="/spaces/">Rentals</a></li>
      <li><a href="/spaces/hostevent/" class="active">Events</a></li>
      <li><a href="/community/">Community</a></li>
      <li><a href="/photos/">Photos</a></li>
      <li><a href="/contact/">Contact</a></li>
    </ul>
  </div>

  <header>
    <h1>Host an Event at Alpaca Playhouse</h1>
    <p>A unique venue in Cedar Creek, TX for gatherings, workshops, retreats, and celebrations</p>
    <div class="header-buttons">
      <a href="https://alpacaplayhouse.com/spaces/?view=events" class="see-spaces-btn">See the Event Spaces</a>
      <a href="#formContainer" class="see-spaces-btn apply-btn">Apply to Host</a>
    </div>
  </header>

  <main>
    <!-- Introduction -->
    <div class="intro-section">
      <h2>About Event Hosting</h2>
      <p>
        The Austin Alpaca Playhouse is a unique community venue in Cedar Creek, Texas &mdash; just 13 minutes
        east of Austin Airport. Our property features friendly alpacas, a wood-fired sauna, cold plunge,
        indoor and outdoor gathering spaces, and a welcoming atmosphere for events of all kinds.
      </p>
      <p>
        We welcome a variety of events including:
      </p>
      <ul>
        <li>Private parties and celebrations</li>
        <li>Music performances and gatherings</li>
        <li>Workshops and classes</li>
        <li>Retreats and team gatherings</li>
        <li>Ceremonies (including weddings)</li>
        <li>Photoshoots and creative projects</li>
      </ul>
      <p>
        <strong>Note:</strong> This is a community-minded venue. Meat may be grilled outside but cooking
        meat is not permitted inside the house.
      </p>

      <h2>Standard Fees</h2>
      <div class="fees-grid">
        <div class="fee-card">
          <div class="fee-label">Rental Fee</div>
          <div class="fee-amount" id="feeRentalDisplay">...</div>
          <div class="fee-note">Starting rate*</div>
        </div>
        <div class="fee-card">
          <div class="fee-label">Reservation Deposit</div>
          <div class="fee-amount" id="feeReservationDisplay">...</div>
          <div class="fee-note">Refundable</div>
        </div>
        <div class="fee-card">
          <div class="fee-label">Cleaning Deposit</div>
          <div class="fee-amount" id="feeCleaningDisplay">...</div>
          <div class="fee-note">Refundable</div>
        </div>
      </div>
      <p style="font-size: 0.9rem; color: var(--text-muted);">
        *For certain unpaid events benefiting the community, the rental fee may be waived.
        The reservation deposit and cleaning deposit are fully refundable after your event, provided there is
        no damage and cleaning is completed per the agreement.
      </p>
    </div>

    <!-- Policies -->
    <details class="policy-section" open>
      <summary class="policy-header">
        <span>Venue Policies & Requirements</span>
        <span class="toggle-icon">&#9660;</span>
      </summary>
      <div class="policy-content">
        <h4>Staffing Requirements</h4>
        <p>As the event host, you are responsible for providing:</p>
        <ul>
          <li><strong>Setup staff</strong> - Must arrive 90 minutes before event start</li>
          <li><strong>Cleanup crew</strong> - Post-event cleaning must be complete by 1:01pm the next day</li>
          <li><strong>Parking coordinator</strong> - Must manage parking throughout the event to prevent parking on neighbors' property</li>
        </ul>

        <h4>Guest Limits</h4>
        <p>
          Your approved guest count will be specified in the agreement. A $15 fee applies per additional
          person beyond your approved limit. You agree to candidly report actual attendance.
        </p>

        <h4>Address Privacy</h4>
        <div class="warning-box">
          <strong>Important:</strong> Do NOT post our address in any marketing materials, texts, emails,
          or social media. Instead, direct attendees to <a href="https://alpacaplayhouse.com/visiting" target="_blank" style="color: #92400e;">alpacaplayhouse.com/visiting</a> for directions.
          This page contains important information about parking, alpaca safety, food policies, and venue rules
          that all guests should read before arriving.
          <strong>$100 fee if the address is posted publicly.</strong>
        </div>

        <h4>Noise & Quiet Hours</h4>
        <p>
          Keep outdoor noise and music to a minimum after 9:30pm. Keep doors closed when loud music is
          playing inside. No PA speakers at high volume outdoors after 9:30pm.
          <strong>$100 fee if neighbors complain about noise.</strong>
        </p>

        <h4>Parking</h4>
        <ul>
          <li>Use the gravel lot inside the gate &mdash; park near other vehicles, facing the street or container</li>
          <li><strong>Never park on grass</strong> (risks damage to sprinklers and getting stuck in mud)</li>
          <li>Do not obstruct the circle, garage, sauna area, or delivery access</li>
          <li>Overflow parking is available across the street or on the frontage road (5-minute walk)</li>
          <li><strong>$150 penalty for each neighbor complaint about parking</strong> &mdash; Manage parking to ensure no vehicles are parked in front of neighbors' houses</li>
        </ul>

        <h4>Alpaca & Gate Safety</h4>
        <div class="warning-box">
          <strong>Critical:</strong> <strong>Always keep the back fence gates closed</strong> to prevent alpacas
          from escaping. Please refer to them as "alpacas," not "llamas." Keep all dogs and pets out of
          the alpaca area in the back yard; pets may only be tied in the front yard.
        </div>

        <h4>House Rules</h4>
        <ul>
          <li><strong>No alcohol inside the house</strong> (exceptions only for wedding events)</li>
          <li><strong>No meat inside the house</strong> &mdash; Meat may be grilled outside and stored in the external refrigerator, not the kitchen</li>
          <li><strong>No animals inside the house or backyard</strong> &mdash; Dogs may be tied in the front yard only ($100 fee if violated)</li>
          <li><strong>No RVs parked on property</strong> &mdash; Can park on frontage road ($100 fee if violated)</li>
          <li><strong>No meat inside the house</strong> &mdash; Meat may be grilled outside only</li>
          <li>Wash and replace any used linens and towels</li>
          <li>Return all furniture to original positions (take photos before moving anything)</li>
          <li>Propane usage will be deducted from the deposit</li>
        </ul>

        <h4>Cleaning</h4>
        <p>
          Submit cleaning photos via the provided checklist. If cleaning is not completed, we will hire
          cleaners at $30 + $30/hour, deducted from your deposit.
        </p>
      </div>
    </details>

    <!-- Application Form -->
    <div class="form-container" id="formContainer">
      <form id="eventRequestForm">
        <div id="errorBanner" class="error-banner hidden"></div>

        <!-- Section 1: Your Information -->
        <div class="form-section">
          <h2>Your Information</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="first_name">First Name <span class="required">*</span></label>
              <input type="text" id="first_name" name="first_name" required>
            </div>
            <div class="form-group">
              <label for="last_name">Last Name <span class="required">*</span></label>
              <input type="text" id="last_name" name="last_name" required>
            </div>
            <div class="form-group">
              <label for="email">Email <span class="required">*</span></label>
              <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
              <label for="phone">Phone <span class="required">*</span></label>
              <input type="tel" id="phone" name="phone" required>
            </div>
            <div class="form-group full-width">
              <label for="organization_name">Organization Name (if applicable)</label>
              <input type="text" id="organization_name" name="organization_name" placeholder="Leave blank if hosting personally">
            </div>
            <div class="form-group full-width checkbox-group">
              <input type="checkbox" id="has_hosted_before" name="has_hosted_before">
              <label for="has_hosted_before">I have hosted an event at Alpaca Playhouse before</label>
            </div>
          </div>
        </div>

        <!-- Section 2: Event Details -->
        <div class="form-section">
          <h2>Event Details</h2>
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="event_name">Event Name <span class="required">*</span></label>
              <input type="text" id="event_name" name="event_name" required placeholder="e.g., Sarah's 30th Birthday, Yoga Workshop">
            </div>
            <div class="form-group">
              <label for="event_type">Event Type <span class="required">*</span></label>
              <select id="event_type" name="event_type" required>
                <option value="">Select type...</option>
                <option value="party">Party / Celebration</option>
                <option value="workshop">Workshop / Class</option>
                <option value="retreat">Retreat</option>
                <option value="ceremony">Ceremony</option>
                <option value="meeting">Meeting / Gathering</option>
                <option value="photoshoot">Photoshoot</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="expected_guests">Expected Guests <span class="required">*</span></label>
              <input type="number" id="expected_guests" name="expected_guests" required min="1" max="100" placeholder="Including you and staff">
            </div>
            <div class="form-group">
              <label for="event_date">Event Date <span class="required">*</span></label>
              <input type="date" id="event_date" name="event_date" required>
            </div>
            <div class="form-group">
              <label>Event Time <span class="required">*</span></label>
              <div class="time-inputs">
                <input type="time" id="event_start_time" name="event_start_time" required>
                <span>to</span>
                <input type="time" id="event_end_time" name="event_end_time" required>
              </div>
            </div>
            <div class="form-group full-width">
              <label for="event_description">Event Description <span class="required">*</span></label>
              <textarea id="event_description" name="event_description" required placeholder="Tell us about your event - what you're planning, the purpose, any special requirements..."></textarea>
            </div>
            <div class="form-group full-width checkbox-group">
              <input type="checkbox" id="is_ticketed" name="is_ticketed">
              <label for="is_ticketed">This is a ticketed/paid event</label>
            </div>
            <div class="form-group full-width hidden" id="ticketPriceGroup">
              <label for="ticket_price_range">Ticket Price Range</label>
              <input type="text" id="ticket_price_range" name="ticket_price_range" placeholder="e.g., $20-50, Free-$25, or Sliding scale $10-30">
              <span class="hint">Approximate price or range attendees will pay</span>
            </div>
          </div>
        </div>

        <!-- Section 3: Spaces Needed -->
        <div class="form-section" id="spacesSection">
          <h2>Spaces Needed</h2>
          <p class="hint" style="margin-bottom: 0.5rem;">Select all the spaces you would like to use for your event. Unavailable spaces on your selected date are greyed out.</p>
          <p class="hint" style="margin-bottom: 1rem; font-style: italic;" id="spacesDateHint">Please select an event date above to see availability.</p>
          <div class="spaces-table-container">
            <table class="spaces-table" id="spacesTable">
              <thead>
                <tr>
                  <th class="checkbox-cell"></th>
                  <th class="thumbnail-cell"></th>
                  <th>Space</th>
                  <th>Availability</th>
                </tr>
              </thead>
              <tbody id="spacesTableBody">
                <!-- Populated dynamically by JS -->
                <tr>
                  <td colspan="4" class="spaces-loading">Loading spaces...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Section 4: Staffing -->
        <div class="form-section">
          <h2>Staffing Contacts</h2>
          <p class="hint" style="margin-bottom: 1rem;">Provide contact info for your event staff (can be yourself):</p>
          <div class="form-grid">
            <div class="form-group">
              <label for="setup_staff_name">Setup Coordinator Name <span class="required">*</span></label>
              <input type="text" id="setup_staff_name" name="setup_staff_name" required>
            </div>
            <div class="form-group">
              <label for="setup_staff_phone">Setup Coordinator Phone <span class="required">*</span></label>
              <input type="tel" id="setup_staff_phone" name="setup_staff_phone" required>
            </div>
            <div class="form-group">
              <label for="cleanup_staff_name">Cleanup Coordinator Name <span class="required">*</span></label>
              <input type="text" id="cleanup_staff_name" name="cleanup_staff_name" required>
            </div>
            <div class="form-group">
              <label for="cleanup_staff_phone">Cleanup Coordinator Phone <span class="required">*</span></label>
              <input type="tel" id="cleanup_staff_phone" name="cleanup_staff_phone" required>
            </div>
            <div class="form-group">
              <label for="parking_manager_name">Parking Coordinator Name <span class="required">*</span></label>
              <input type="text" id="parking_manager_name" name="parking_manager_name" required>
            </div>
            <div class="form-group">
              <label for="parking_manager_phone">Parking Coordinator Phone <span class="required">*</span></label>
              <input type="tel" id="parking_manager_phone" name="parking_manager_phone" required>
            </div>
          </div>
        </div>

        <!-- Section 5: Additional Info -->
        <div class="form-section">
          <h2>Additional Information</h2>
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="marketing_materials_link">Marketing Materials Link</label>
              <input type="text" id="marketing_materials_link" name="marketing_materials_link" placeholder="e.g., www.example.com or https://example.com">
            </div>
            <div class="form-group full-width">
              <label for="special_requests">Special Requests or Questions</label>
              <textarea id="special_requests" name="special_requests" placeholder="Any special needs, equipment requests, or questions about the venue..."></textarea>
            </div>
          </div>
        </div>

        <!-- Section 6: Acknowledgments -->
        <div class="form-section">
          <h2>Acknowledgments</h2>
          <div class="acknowledgments-section">
            <h3>Please confirm you understand and agree to the following:</h3>
            <div class="ack-list">
              <div class="ack-item">
                <input type="checkbox" id="ack_no_address_posting" name="ack_no_address_posting" required>
                <label for="ack_no_address_posting">I will NOT post the venue address publicly and will direct attendees to alpacaplayhouse.com/visiting</label>
              </div>
              <div class="ack-item">
                <input type="checkbox" id="ack_parking_management" name="ack_parking_management" required>
                <label for="ack_parking_management">I will manage parking to prevent vehicles from parking in front of neighbors' houses</label>
              </div>
              <div class="ack-item">
                <input type="checkbox" id="ack_noise_curfew" name="ack_noise_curfew" required>
                <label for="ack_noise_curfew">I will keep outdoor noise to a minimum after 9:30pm</label>
              </div>
              <div class="ack-item">
                <input type="checkbox" id="ack_no_alcohol_inside" name="ack_no_alcohol_inside" required>
                <label for="ack_no_alcohol_inside">No alcohol will be brought inside the house</label>
              </div>
              <div class="ack-item">
                <input type="checkbox" id="ack_no_meat_inside" name="ack_no_meat_inside" required>
                <label for="ack_no_meat_inside">No meat will be brought inside the house (grilling outside is OK)</label>
              </div>
              <div class="ack-item">
                <input type="checkbox" id="ack_no_rvs" name="ack_no_rvs" required>
                <label for="ack_no_rvs">No RVs will be parked on the property</label>
              </div>
              <div class="ack-item">
                <input type="checkbox" id="ack_no_animals_inside" name="ack_no_animals_inside" required>
                <label for="ack_no_animals_inside">No animals will be brought inside the house or backyard</label>
              </div>
              <div class="ack-item">
                <input type="checkbox" id="ack_cleaning_responsibility" name="ack_cleaning_responsibility" required>
                <label for="ack_cleaning_responsibility">I am responsible for cleaning and will complete it by 1:01pm the day after the event</label>
              </div>
              <div class="ack-item">
                <input type="checkbox" id="ack_linens_furniture" name="ack_linens_furniture" required>
                <label for="ack_linens_furniture">I will wash used linens and return furniture to original positions</label>
              </div>
              <div class="ack-item">
                <input type="checkbox" id="ack_propane_reimbursement" name="ack_propane_reimbursement" required>
                <label for="ack_propane_reimbursement">I understand propane usage will be deducted from my deposit</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Deposits Section -->
        <div class="form-section deposit-section">
          <h2>Reservation Deposit</h2>
          <p class="hint" style="margin-bottom: 1rem;">
            A reservation deposit is required to secure your event booking. This deposit will be fully applied towards the rental fee or deposit. If you cancel your event the reservation fee will not be refunded.
          </p>
          <p class="hint" style="margin-bottom: 1rem; font-style: italic;">
            Note: The cleaning deposit (<span id="feeCleaningInline">...</span>) and rental fee (<span id="feeRentalInline">...</span>) are due 7 days before your event. We'll send payment instructions and a reminder.
          </p>

          <div class="deposit-grid" style="grid-template-columns: 1fr;">
            <!-- Reservation Deposit -->
            <div class="deposit-card" id="reservationDepositCard">
              <h4>Reservation Deposit</h4>
              <p class="deposit-description">Refunded after successful event completion</p>
              <div class="deposit-amount">
                <span>Amount:</span>
                <div>
                  <span class="original hidden" id="reservationOriginal"></span>
                  <span class="amount" id="reservationAmount">Loading...</span>
                </div>
              </div>
              <div class="code-row">
                <input type="text" id="reservationCode" placeholder="Partner code">
                <button type="button" id="applyReservationCode">Apply</button>
              </div>
              <div class="code-result hidden" id="reservationCodeResult"></div>
            </div>
          </div>

          <div class="deposit-total">
            <span>Total Due Now:</span>
            <span class="total-amount" id="totalDeposit">Loading...</span>
          </div>
          <p class="payment-note" style="margin-top: 0.75rem; font-size: 0.8rem; color: #7a7d8c; text-align: center;"><span id="secureTestTrigger" style="cursor: default;">Secure</span> payment powered by Square</p>

          <!-- Staff Sandbox Toggle (hidden unless staff/admin logged in) -->
          <div id="staffSandboxBar" class="staff-sandbox-bar">
            <label>
              <input type="checkbox" id="staffTestToggle">
              Square Sandbox Mode
            </label>
            <span id="staffTestBadge" class="staff-sandbox-badge" style="display:none;">SANDBOX</span>
          </div>

          <!-- Payment Section (shown when total > 0) -->
          <div class="payment-card-section" id="eventPaymentSection">
            <p class="hint" style="margin-bottom: 0.75rem;">
              Enter your card details to pay the reservation deposit.
            </p>
            <div id="event-card-container">
              <!-- Square Card Element will be inserted here -->
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-submit" id="submitBtn">Submit Event Request</button>
        </div>
      </form>
    </div>

    <!-- Success Message -->
    <div class="form-container hidden" id="successContainer">
      <div class="success-message">
        <div class="icon">&#129433;</div>
        <h2>Request Submitted!</h2>
        <p>Thank you for your interest in hosting an event at Alpaca Playhouse! We've received your request and will review it with all due haste.</p>

        <div class="event-summary">
          <h3>Your Event Request Summary</h3>
          <div class="summary-row">
            <span class="label">Event</span>
            <span class="value" id="summaryEventName"></span>
          </div>
          <div class="summary-row">
            <span class="label">Date</span>
            <span class="value" id="summaryEventDate"></span>
          </div>
          <div class="summary-row">
            <span class="label">Time</span>
            <span class="value" id="summaryEventTime"></span>
          </div>
          <div class="summary-row">
            <span class="label">Expected Guests</span>
            <span class="value" id="summaryGuests"></span>
          </div>
          <div class="summary-row" id="summarySpacesRow" style="display: none;">
            <span class="label">Requested Spaces</span>
            <span class="value" id="summarySpaces"></span>
          </div>
          <div class="summary-row">
            <span class="label">Reservation Deposit Paid</span>
            <span class="value" id="summaryDeposits"></span>
          </div>
        </div>

        <div class="whats-next">
          <h3>What Happens Next</h3>
          <ol>
            <li>We'll review your request with all due haste</li>
            <li>If approved, we'll send you an event agreement to sign electronically</li>
            <li>7 days before your event, the cleaning deposit (<span id="feeCleaningNext">...</span>) and rental fee (<span id="feeRentalNext">...</span>) are due</li>
            <li>We'll send a reminder with payment instructions 10 days before your event</li>
            <li>Event day!</li>
          </ol>
          <p class="payment-note">Note: The cleaning deposit and rental fee must be paid at least 7 days before your event. Payment can be made via Venmo, Zelle, or other available methods.</p>
        </div>

        <!-- Ask a Question -->
        <div class="success-ask-section">
          <h3>Have a Question?</h3>
          <p>Get instant answers about your event, our venue, and more.</p>

          <div class="success-question-input-wrapper">
            <input type="text" id="successQuestionInput" class="success-question-input" placeholder="What would you like to know?" autocomplete="off">
            <button id="successAskBtn" class="success-ask-btn">Ask</button>
          </div>

          <div id="successAnswerContainer" class="success-answer-container">
            <div id="successAnswerText" class="success-answer-text"></div>

            <div id="successLowConfidence" class="success-low-confidence">
              I'm not fully confident in this answer. If this didn't help, let us know below and we'll get back to you.
            </div>

            <div id="successAnswerFeedback" class="success-answer-feedback">
              <span>Was this helpful?</span>
              <button class="success-feedback-btn" id="successFeedbackYes">Yes, thanks!</button>
              <button class="success-feedback-btn success-feedback-btn--negative" id="successFeedbackNo">Not quite</button>
            </div>

            <div id="successFollowupForm" class="success-followup-form">
              <p>Sorry about that! Leave your info and we'll get back to you with an answer.</p>
              <div class="success-followup-fields">
                <input type="text" id="successFollowupName" class="success-followup-input" placeholder="Your name">
                <input type="email" id="successFollowupEmail" class="success-followup-input" placeholder="Email">
                <input type="tel" id="successFollowupPhone" class="success-followup-input" placeholder="Phone (optional)">
              </div>
              <button class="success-followup-btn" id="successFollowupSubmit">Submit</button>
            </div>

            <div id="successQuestionSubmitted" class="success-question-submitted">
              Thanks! We've received your question and will get back to you.
            </div>
          </div>
        </div>

        <!-- Contact Us (expanded by default) -->
        <div class="success-contact-section">
          <button class="success-contact-toggle expanded" id="successContactToggle">
            Send Us a Message <span class="toggle-arrow">&#9650;</span>
          </button>

          <div class="success-contact-body visible" id="successContactBody">
            <div class="success-contact-methods">
              <div class="success-contact-method">
                <div class="success-contact-method__icon">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                </div>
                <div class="success-contact-method__info">
                  <h4>Voice</h4>
                  <a id="successPhoneLink" href="tel:+17372259525">(737) 225-9525</a>
                </div>
              </div>

              <div class="success-contact-method">
                <div class="success-contact-method__icon">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                </div>
                <div class="success-contact-method__info">
                  <h4>SMS / Text</h4>
                  <a href="sms:+17377474737">(737) 747-4737</a>
                </div>
              </div>

              <div class="success-contact-method">
                <div class="success-contact-method__icon">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                  </svg>
                </div>
                <div class="success-contact-method__info">
                  <h4>Email</h4>
                  <a href="mailto:pai@alpacaplayhouse.com">pai@alpacaplayhouse.com</a>
                </div>
              </div>
            </div>

            <form id="successMessageForm" class="success-message-form">
              <div class="success-form-row">
                <div class="success-form-group">
                  <label for="successMsgName">Your Name</label>
                  <input type="text" id="successMsgName" placeholder="How should we address you?">
                </div>
                <div class="success-form-group">
                  <label for="successMsgEmail">Email</label>
                  <input type="email" id="successMsgEmail" placeholder="your@email.com">
                </div>
              </div>

              <div class="success-form-group">
                <label for="successMsgBody">Message</label>
                <textarea id="successMsgBody" placeholder="What would you like to tell us?"></textarea>
              </div>

              <button type="submit" class="success-submit-btn">Send Message</button>
            </form>

            <div id="successFormSuccess" class="success-form-success">
              <strong>Message sent!</strong> We'll get back to you soon.
            </div>
          </div>
        </div>

        <a href="https://alpacaplayhouse.com" class="btn-primary" style="margin-top: 1.5rem;">Learn About Our Venue</a>
      </div>
    </div>
  </main>

  <!-- Supabase library must load before module script -->
  <script type="module" src="../../shared/version-info.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    // Import shared Supabase config (single source of truth)
    import { supabase, SUPABASE_URL, SUPABASE_ANON_KEY } from '../../shared/supabase.js';
    import { initAuth, getAuthState } from '../../shared/auth.js';
    import { getAustinTodayISO, formatLongDate } from '../../shared/timezone.js';
    const SUPABASE_KEY = SUPABASE_ANON_KEY;

    // Fee type constants
    const FEE_TYPES = {
      RENTAL: 'event_rental_fee',
      CLEANING: 'event_cleaning_deposit',
      RESERVATION: 'event_reservation_deposit'
    };

    // Staff sandbox test mode state
    let staffTestMode = false;
    let staffAuthState = null;

    // Non-blocking auth check for staff sandbox toggle
    (async () => {
      try {
        await initAuth();
        staffAuthState = getAuthState();
        if (staffAuthState.isStaff) {
          document.getElementById('staffSandboxBar')?.classList.add('visible');
          const urlParams = new URLSearchParams(window.location.search);
          const urlTest = urlParams.get('staff_test') === '1';
          const sessionTest = sessionStorage.getItem('square_staff_test') === '1';
          if (urlTest || sessionTest) {
            staffTestMode = true;
            sessionStorage.setItem('square_staff_test', '1');
            const toggle = document.getElementById('staffTestToggle');
            if (toggle) toggle.checked = true;
            updateSandboxUI(true);
          }
        }
      } catch (e) {
        // Auth failure is fine â€” regular user, no toggle shown
      }
    })();

    function updateSandboxUI(active) {
      const badge = document.getElementById('staffTestBadge');
      const banner = document.getElementById('sandboxBanner');
      if (badge) badge.style.display = active ? 'inline-block' : 'none';
      if (banner) banner.classList.toggle('visible', active);
      document.body.classList.toggle('sandbox-active', active);
    }

    document.getElementById('staffTestToggle')?.addEventListener('change', (e) => {
      const checked = e.target.checked;
      if (checked) {
        sessionStorage.setItem('square_staff_test', '1');
      } else {
        sessionStorage.removeItem('square_staff_test');
      }
      if (squarePayments) {
        const url = new URL(window.location.href);
        if (checked) {
          url.searchParams.set('staff_test', '1');
        } else {
          url.searchParams.delete('staff_test');
        }
        window.location.href = url.toString();
        return;
      }
      staffTestMode = checked;
      updateSandboxUI(checked);
    });

    // Fee display state
    let rentalFeeAmount = 0;
    let cleaningDepositAmount = 0;

    // Deposit state - only reservation deposit collected at application time
    let reservationAmount = 0;
    let reservationOriginal = 0;
    let reservationCode = null;
    let squareCard = null;
    let squarePayments = null;

    // Elements
    const form = document.getElementById('eventRequestForm');
    const formContainer = document.getElementById('formContainer');
    const successContainer = document.getElementById('successContainer');
    const errorBanner = document.getElementById('errorBanner');
    const submitBtn = document.getElementById('submitBtn');
    const spacesTableBody = document.getElementById('spacesTableBody');
    const spacesDateHint = document.getElementById('spacesDateHint');
    const ticketPriceGroup = document.getElementById('ticketPriceGroup');
    const isTicketedCheckbox = document.getElementById('is_ticketed');
    const eventDateInput = document.getElementById('event_date');

    // Deposit elements (only reservation deposit now)
    const reservationAmountEl = document.getElementById('reservationAmount');
    const reservationOriginalEl = document.getElementById('reservationOriginal');
    const reservationCodeInput = document.getElementById('reservationCode');
    const applyReservationCodeBtn = document.getElementById('applyReservationCode');
    const reservationCodeResult = document.getElementById('reservationCodeResult');
    const totalDepositEl = document.getElementById('totalDeposit');
    const eventPaymentSection = document.getElementById('eventPaymentSection');

    // Store all event spaces and booked spaces
    let allEventSpaces = [];
    let bookedSpaceIds = new Set();
    let availabilityLoaded = false;

    // Set minimum date to today in Austin timezone
    const today = getAustinTodayISO();
    eventDateInput.setAttribute('min', today);

    // Load all event fee settings from database
    async function loadDepositSettings() {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/fee_settings?fee_type=like.event_*&is_active=eq.true`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        if (!response.ok) throw new Error('Failed to load deposit settings');

        const settings = await response.json();
        settings.forEach(s => {
          if (s.fee_type === FEE_TYPES.RESERVATION) {
            reservationOriginal = parseFloat(s.default_amount);
            reservationAmount = reservationOriginal;
          } else if (s.fee_type === FEE_TYPES.RENTAL) {
            rentalFeeAmount = parseFloat(s.default_amount);
          } else if (s.fee_type === FEE_TYPES.CLEANING) {
            cleaningDepositAmount = parseFloat(s.default_amount);
          }
        });

        updateFeeDisplays();
        updateDepositDisplay();
      } catch (error) {
        console.error('Error loading deposit settings:', error);
        reservationAmountEl.textContent = 'Error';
      }
    }

    // Update all fee displays across the page
    function updateFeeDisplays() {
      const fmt = (amt) => `$${Math.round(amt)}`;
      // Standard Fees cards at top
      const rentalDisplay = document.getElementById('feeRentalDisplay');
      const reservationDisplay = document.getElementById('feeReservationDisplay');
      const cleaningDisplay = document.getElementById('feeCleaningDisplay');
      if (rentalDisplay) rentalDisplay.textContent = fmt(rentalFeeAmount);
      if (reservationDisplay) reservationDisplay.textContent = fmt(reservationOriginal);
      if (cleaningDisplay) cleaningDisplay.textContent = fmt(cleaningDepositAmount);
      // Inline references in deposit section and "What Happens Next"
      document.querySelectorAll('#feeCleaningInline, #feeCleaningNext').forEach(el => {
        el.textContent = fmt(cleaningDepositAmount);
      });
      document.querySelectorAll('#feeRentalInline, #feeRentalNext').forEach(el => {
        el.textContent = fmt(rentalFeeAmount);
      });
    }

    // Update deposit display (only reservation deposit)
    function updateDepositDisplay() {
      // Reservation
      if (reservationAmount === 0) {
        reservationAmountEl.textContent = 'FREE';
        reservationAmountEl.classList.add('free');
      } else {
        reservationAmountEl.textContent = `$${reservationAmount.toFixed(2)}`;
        reservationAmountEl.classList.remove('free');
      }
      if (reservationCode && reservationOriginal !== reservationAmount) {
        reservationOriginalEl.textContent = `$${reservationOriginal.toFixed(2)}`;
        reservationOriginalEl.classList.remove('hidden');
      } else {
        reservationOriginalEl.classList.add('hidden');
      }

      // Total (just reservation deposit now)
      const total = reservationAmount;
      if (total === 0) {
        totalDepositEl.textContent = 'FREE';
        totalDepositEl.classList.add('free');
        eventPaymentSection.classList.remove('visible');
      } else {
        totalDepositEl.textContent = `$${total.toFixed(2)}`;
        totalDepositEl.classList.remove('free');
        eventPaymentSection.classList.add('visible');
        initializeSquare();
      }
    }

    // Validate code
    async function validateCode(code, feeType) {
      if (!code) return null;

      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/fee_codes?code=eq.${code.toUpperCase()}&fee_type=eq.${feeType}&is_active=eq.true`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        if (!response.ok) throw new Error('Failed to validate code');

        const [codeData] = await response.json();

        if (!codeData) {
          return { valid: false, message: 'Invalid partner code' };
        }

        if (codeData.expires_at && new Date(codeData.expires_at) < new Date()) {
          return { valid: false, message: 'Partner code has expired' };
        }

        if (codeData.usage_limit !== null && codeData.times_used >= codeData.usage_limit) {
          return { valid: false, message: 'Partner code has reached its usage limit' };
        }

        return {
          valid: true,
          price: parseFloat(codeData.price),
          message: codeData.price === 0 ? 'Deposit waived!' : `Partner code applied! Amount: $${codeData.price.toFixed(2)}`
        };
      } catch (error) {
        console.error('Error validating code:', error);
        return { valid: false, message: 'Error validating code' };
      }
    }

    // Apply reservation code
    applyReservationCodeBtn.addEventListener('click', async () => {
      const code = reservationCodeInput.value.trim();
      if (!code) {
        reservationCodeResult.classList.add('hidden');
        reservationCode = null;
        reservationAmount = reservationOriginal;
        updateDepositDisplay();
        return;
      }

      applyReservationCodeBtn.disabled = true;
      applyReservationCodeBtn.textContent = '...';

      const result = await validateCode(code, FEE_TYPES.RESERVATION);

      applyReservationCodeBtn.disabled = false;
      applyReservationCodeBtn.textContent = 'Apply';

      reservationCodeResult.textContent = result.message;
      reservationCodeResult.classList.remove('hidden', 'success', 'error');
      reservationCodeResult.classList.add(result.valid ? 'success' : 'error');

      if (result.valid) {
        reservationCode = code.toUpperCase();
        reservationAmount = result.price;
      } else {
        reservationCode = null;
        reservationAmount = reservationOriginal;
      }

      updateDepositDisplay();
    });

    // Initialize Square SDK
    let squareIsTestMode = false; // Track which mode SDK was initialized in

    async function initializeSquare() {
      if (squarePayments) return;

      try {
        const configResponse = await fetch(
          `${SUPABASE_URL}/rest/v1/square_config?select=sandbox_app_id,production_app_id,sandbox_location_id,production_location_id,test_mode`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Cache-Control': 'no-cache'
            }
          }
        );

        if (!configResponse.ok) throw new Error('Failed to load Square config');

        const [config] = await configResponse.json();
        squareIsTestMode = staffTestMode || config.test_mode;
        const appId = squareIsTestMode ? config.sandbox_app_id : config.production_app_id;
        const locationId = squareIsTestMode ? config.sandbox_location_id : config.production_location_id;

        const sdkUrl = squareIsTestMode
          ? 'https://sandbox.web.squarecdn.com/v1/square.js'
          : 'https://web.squarecdn.com/v1/square.js';

        console.log(`[Square] Initializing in ${squareIsTestMode ? 'SANDBOX' : 'PRODUCTION'} mode (config.test_mode=${config.test_mode}, staffTestMode=${staffTestMode})`);
        await loadScript(sdkUrl);

        squarePayments = window.Square.payments(appId, locationId);
        squareCard = await squarePayments.card();
        await squareCard.attach('#event-card-container');

      } catch (error) {
        console.error('Error initializing Square:', error);
        document.getElementById('event-card-container').innerHTML =
          '<p style="color: var(--error); text-align: center;">Payment system unavailable.</p>';
      }
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
          const checkInterval = setInterval(() => {
            if (window.Square) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
          return;
        }

        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // Initialize deposits on page load
    loadDepositSettings();

    // Toggle ticket price field visibility
    isTicketedCheckbox.addEventListener('change', () => {
      ticketPriceGroup.classList.toggle('hidden', !isTicketedCheckbox.checked);
    });

    // Load spaces when date changes
    eventDateInput.addEventListener('change', async () => {
      const selectedDate = eventDateInput.value;
      if (selectedDate) {
        await loadAvailableSpaces(selectedDate);
      }
    });

    // Lightbox function
    function openLightbox(imageUrl) {
      const lightbox = document.createElement('div');
      lightbox.className = 'lightbox';
      lightbox.innerHTML = `
        <button class="lightbox-close">&times;</button>
        <img src="${imageUrl}" alt="Space photo">
      `;
      lightbox.addEventListener('click', () => lightbox.remove());
      document.body.appendChild(lightbox);
    }

    // Load all event spaces from database (with media)
    async function loadAllEventSpaces() {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/spaces?can_be_event=eq.true&is_archived=eq.false&select=id,name,media_spaces(display_order,is_primary,media:media_id(url))&order=name`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        if (!response.ok) throw new Error('Failed to load spaces');
        const spacesData = await response.json();

        // Process spaces to extract primary photo
        allEventSpaces = spacesData.map(space => {
          const mediaSpaces = space.media_spaces || [];
          // Sort by display_order and find primary or first
          const sorted = mediaSpaces
            .filter(ms => ms.media?.url)
            .sort((a, b) => {
              if (a.is_primary && !b.is_primary) return -1;
              if (!a.is_primary && b.is_primary) return 1;
              return (a.display_order || 0) - (b.display_order || 0);
            });
          return {
            id: space.id,
            name: space.name,
            photoUrl: sorted[0]?.media?.url || null
          };
        });

        // Render spaces (all disabled until date selected)
        renderSpaces();
      } catch (error) {
        console.error('Error loading spaces:', error);
        spacesTableBody.innerHTML = '<tr><td colspan="4" class="spaces-loading" style="color: var(--error);">Failed to load spaces. Please refresh the page.</td></tr>';
      }
    }

    // Load booked spaces for a specific date
    async function loadAvailableSpaces(date) {
      spacesTableBody.innerHTML = '<tr><td colspan="4" class="spaces-loading">Checking availability...</td></tr>';

      try {
        // Get assignments that overlap with the selected date
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/assignments?select=id,start_date,end_date,desired_departure_date,desired_departure_listed,status,assignment_spaces(space_id)&status=in.(active,pending_contract,contract_sent)`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        if (!response.ok) throw new Error('Failed to check availability');
        const assignments = await response.json();

        // Find spaces that are booked on the selected date
        bookedSpaceIds = new Set();
        const selectedDateObj = new Date(date + 'T00:00:00');

        assignments.forEach(assignment => {
          const startDate = new Date(assignment.start_date + 'T00:00:00');

          // Use desired_departure_date only if listed, otherwise use end_date
          let endDate = null;
          if (assignment.desired_departure_listed && assignment.desired_departure_date) {
            endDate = new Date(assignment.desired_departure_date + 'T00:00:00');
          } else if (assignment.end_date) {
            endDate = new Date(assignment.end_date + 'T00:00:00');
          }

          // Check if assignment overlaps with selected date
          const startsOnOrBefore = startDate <= selectedDateObj;
          const endsOnOrAfter = !endDate || endDate >= selectedDateObj;

          if (startsOnOrBefore && endsOnOrAfter) {
            // This assignment is active on the selected date
            (assignment.assignment_spaces || []).forEach(as => {
              bookedSpaceIds.add(as.space_id);
            });
          }
        });

        availabilityLoaded = true;
        spacesDateHint.textContent = `Showing availability for ${formatLongDate(date + 'T12:00:00')}`;
        renderSpaces();
      } catch (error) {
        console.error('Error checking availability:', error);
        spacesTableBody.innerHTML = '<tr><td colspan="4" class="spaces-loading" style="color: var(--error);">Failed to check availability. Please try again.</td></tr>';
      }
    }

    // Render spaces table
    function renderSpaces() {
      if (allEventSpaces.length === 0) {
        spacesTableBody.innerHTML = '<tr><td colspan="4" class="spaces-loading">No event spaces configured.</td></tr>';
        return;
      }

      const selectedDate = eventDateInput.value;

      // Sort spaces: available first, then by name
      const sortedSpaces = [...allEventSpaces].sort((a, b) => {
        const aAvailable = !bookedSpaceIds.has(a.id);
        const bAvailable = !bookedSpaceIds.has(b.id);
        if (aAvailable !== bAvailable) return bAvailable - aAvailable; // Available first
        return a.name.localeCompare(b.name);
      });

      spacesTableBody.innerHTML = sortedSpaces.map(space => {
        const isAvailable = !bookedSpaceIds.has(space.id);
        const canSelect = selectedDate && isAvailable;
        const rowClass = !canSelect ? 'unavailable' : '';

        let availabilityHtml;
        if (!selectedDate) {
          availabilityHtml = '<span class="availability-badge" style="background: var(--bg); color: var(--text-muted);">Select date</span>';
        } else if (isAvailable) {
          availabilityHtml = '<span class="availability-badge available">Available</span>';
        } else {
          availabilityHtml = '<span class="availability-badge unavailable">Booked</span>';
        }

        const thumbnailHtml = space.photoUrl
          ? `<img src="${space.photoUrl}" alt="${space.name}" class="space-thumbnail" data-full-url="${space.photoUrl}">`
          : '<div class="space-thumbnail-placeholder">No photo</div>';

        return `
          <tr class="${rowClass}" data-space-id="${space.id}">
            <td class="checkbox-cell">
              <input type="checkbox" id="space_${space.id}" name="spaces[]" value="${space.id}" ${!canSelect ? 'disabled' : ''}>
            </td>
            <td class="thumbnail-cell">${thumbnailHtml}</td>
            <td class="space-name">${space.name}</td>
            <td>${availabilityHtml}</td>
          </tr>
        `;
      }).join('');

      // Add click handler to rows for easier selection (but not on thumbnails)
      spacesTableBody.querySelectorAll('tr:not(.unavailable)').forEach(row => {
        row.addEventListener('click', (e) => {
          // Don't toggle checkbox when clicking thumbnail
          if (e.target.classList.contains('space-thumbnail')) return;
          if (e.target.type !== 'checkbox') {
            const checkbox = row.querySelector('input[type="checkbox"]');
            if (checkbox && !checkbox.disabled) {
              checkbox.checked = !checkbox.checked;
            }
          }
        });
      });

      // Add lightbox click handler to thumbnails
      spacesTableBody.querySelectorAll('.space-thumbnail').forEach(img => {
        img.addEventListener('click', (e) => {
          e.stopPropagation();
          openLightbox(img.dataset.fullUrl);
        });
      });
    }

    // Initialize - load all event spaces
    loadAllEventSpaces();

    // Test data fill (click on "Secure" to trigger)
    document.getElementById('secureTestTrigger').addEventListener('click', () => {
      // Contact Info
      document.getElementById('first_name').value = 'Test';
      document.getElementById('last_name').value = 'EventHost';
      document.getElementById('email').value = 'test@example.com';
      document.getElementById('phone').value = '512-555-0123';
      document.getElementById('organization_name').value = 'Test Events LLC';

      // Event Details - date far in the future
      document.getElementById('event_name').value = 'Test Event 2030';
      document.getElementById('event_type').value = 'private_party';
      document.getElementById('expected_guests').value = '25';
      document.getElementById('event_date').value = '2030-06-15';
      document.getElementById('event_start_time').value = '14:00';
      document.getElementById('event_end_time').value = '20:00';
      document.getElementById('event_description').value = 'This is a test event submission for testing purposes. Please ignore this application.';

      // Staff Contacts
      document.getElementById('setup_staff_name').value = 'Setup Person';
      document.getElementById('setup_staff_phone').value = '512-555-1111';
      document.getElementById('cleanup_staff_name').value = 'Cleanup Person';
      document.getElementById('cleanup_staff_phone').value = '512-555-2222';
      document.getElementById('parking_manager_name').value = 'Parking Person';
      document.getElementById('parking_manager_phone').value = '512-555-3333';

      // Optional fields
      document.getElementById('marketing_materials_link').value = 'https://example.com/test-event';
      document.getElementById('special_requests').value = 'Test submission - no special requests';

      // Check all acknowledgment checkboxes
      document.getElementById('ack_no_address_posting').checked = true;
      document.getElementById('ack_parking_management').checked = true;
      document.getElementById('ack_noise_curfew').checked = true;
      document.getElementById('ack_no_alcohol_inside').checked = true;
      document.getElementById('ack_no_meat_inside').checked = true;
      document.getElementById('ack_no_rvs').checked = true;
      document.getElementById('ack_no_animals_inside').checked = true;
      document.getElementById('ack_cleaning_responsibility').checked = true;
      document.getElementById('ack_linens_furniture').checked = true;
      document.getElementById('ack_propane_reimbursement').checked = true;

      console.log('Test data filled for event application');
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear previous errors
      errorBanner.classList.add('hidden');
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

      // Validate required fields
      const requiredFields = [
        'first_name', 'last_name', 'email', 'phone',
        'event_name', 'event_type', 'expected_guests', 'event_date',
        'event_start_time', 'event_end_time', 'event_description',
        'setup_staff_name', 'setup_staff_phone',
        'cleanup_staff_name', 'cleanup_staff_phone',
        'parking_manager_name', 'parking_manager_phone'
      ];

      let hasError = false;
      requiredFields.forEach(field => {
        const el = document.getElementById(field);
        if (!el.value.trim()) {
          el.classList.add('error');
          hasError = true;
        }
      });

      // Check all acknowledgments
      const ackFields = [
        'ack_no_address_posting', 'ack_parking_management', 'ack_noise_curfew',
        'ack_no_alcohol_inside', 'ack_no_meat_inside', 'ack_no_rvs',
        'ack_no_animals_inside', 'ack_cleaning_responsibility',
        'ack_linens_furniture', 'ack_propane_reimbursement'
      ];

      ackFields.forEach(field => {
        const el = document.getElementById(field);
        if (!el.checked) {
          hasError = true;
        }
      });

      if (hasError) {
        showError('Please fill in all required fields and acknowledge all policies.');
        return;
      }

      // Get selected space IDs
      const selectedSpaceIds = Array.from(
        document.querySelectorAll('input[name="spaces[]"]:checked')
      ).map(cb => cb.value);

      // Calculate total deposit (only reservation deposit at application time)
      const totalDeposit = reservationAmount;

      // Disable form
      submitBtn.disabled = true;
      submitBtn.textContent = totalDeposit > 0 ? 'Processing Payment...' : 'Submitting...';

      try {
        // First, create or find the person
        const firstName = getValue('first_name');
        const lastName = getValue('last_name');
        const email = getValue('email');
        const phone = getValue('phone');

        // Check if person exists
        let personId;
        const checkResponse = await fetch(
          `${SUPABASE_URL}/rest/v1/people?email=eq.${encodeURIComponent(email)}&select=id`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );

        const existingPeople = await checkResponse.json();

        if (existingPeople.length > 0) {
          personId = existingPeople[0].id;
        } else {
          // Create new person
          const personResponse = await fetch(`${SUPABASE_URL}/rest/v1/people`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify({
              first_name: firstName,
              last_name: lastName,
              email: email,
              phone: phone,
              type: 'event_client'
            })
          });

          if (!personResponse.ok) {
            throw new Error('Failed to create contact record');
          }

          const [person] = await personResponse.json();
          personId = person.id;
        }

        // Create event hosting request
        const eventData = {
          person_id: personId,
          organization_name: getValue('organization_name') || null,
          has_hosted_before: document.getElementById('has_hosted_before').checked,
          event_name: getValue('event_name'),
          event_description: getValue('event_description'),
          event_type: getValue('event_type'),
          event_date: getValue('event_date'),
          event_start_time: getValue('event_start_time'),
          event_end_time: getValue('event_end_time'),
          expected_guests: parseInt(getValue('expected_guests')),
          is_ticketed: isTicketedCheckbox.checked,
          ticket_price_range: isTicketedCheckbox.checked ? getValue('ticket_price_range') : null,
          marketing_materials_link: getValue('marketing_materials_link') || null,
          special_requests: getValue('special_requests') || null,
          setup_staff_name: getValue('setup_staff_name'),
          setup_staff_phone: getValue('setup_staff_phone'),
          cleanup_staff_name: getValue('cleanup_staff_name'),
          cleanup_staff_phone: getValue('cleanup_staff_phone'),
          parking_manager_name: getValue('parking_manager_name'),
          parking_manager_phone: getValue('parking_manager_phone'),
          ack_no_address_posting: true,
          ack_parking_management: true,
          ack_noise_curfew: true,
          ack_no_alcohol_inside: true,
          ack_no_meat_inside: true,
          ack_no_rvs: true,
          ack_no_animals_inside: true,
          ack_cleaning_responsibility: true,
          ack_linens_furniture: true,
          ack_propane_reimbursement: true,
          request_status: 'submitted',
          reservation_deposit_amount: reservationAmount,
          reservation_deposit_code: reservationCode,
          deposit_status: totalDeposit > 0 ? 'pending' : 'waived'
        };

        const eventResponse = await fetch(`${SUPABASE_URL}/rest/v1/event_hosting_requests`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(eventData)
        });

        if (!eventResponse.ok) {
          const errorData = await eventResponse.json();
          throw new Error(errorData.message || 'Failed to submit request');
        }

        const [eventRequest] = await eventResponse.json();

        // Process deposit payment if total > 0
        if (totalDeposit > 0) {
          if (!squareCard) {
            throw new Error('Payment system not ready. Please refresh and try again.');
          }

          // Tokenize the card
          const tokenResult = await squareCard.tokenize();

          if (tokenResult.status !== 'OK') {
            const rawMsg = tokenResult.errors?.[0]?.message || 'Card payment failed';
            // Detect sandbox-mode errors shown to real users and provide a friendly message
            if (rawMsg.toLowerCase().includes('sandbox') || rawMsg.toLowerCase().includes('test number')) {
              console.error('[Square] Sandbox error in production context:', rawMsg, { squareIsTestMode, staffTestMode });
              throw new Error('Payment processing error. Please refresh the page and try again. If the problem persists, contact us.');
            }
            throw new Error(rawMsg);
          }

          // Create payment record for reservation deposit
          if (reservationAmount > 0) {
            const reservationPaymentResponse = await fetch(`${SUPABASE_URL}/rest/v1/square_payments`, {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
              },
              body: JSON.stringify({
                payment_type: FEE_TYPES.RESERVATION,
                reference_type: 'event_hosting_request',
                reference_id: eventRequest.id,
                amount: reservationAmount,
                fee_code_used: reservationCode,
                original_amount: reservationOriginal,
                status: 'pending',
                is_test: staffTestMode,
                test_mode_overridden_by: staffTestMode && staffAuthState?.appUser?.id ? staffAuthState.appUser.id : null
              })
            });

            if (!reservationPaymentResponse.ok) {
              console.error('Failed to create reservation deposit payment record');
            }
          }

          // Build edge function request
          const edgeFunctionBody = {
            sourceId: tokenResult.token,
            amount: Math.round(totalDeposit * 100), // Convert to cents
            paymentRecordId: eventRequest.id, // Use event request ID as reference
            buyerEmail: email,
            note: `Event Reservation Deposit - ${getValue('event_name')} (${firstName} ${lastName})`
          };

          // If staff sandbox mode, include override + auth token
          if (staffTestMode && staffAuthState?.isStaff) {
            edgeFunctionBody.testModeOverride = true;
            try {
              const { data: { session } } = await supabase.auth.getSession();
              if (session?.access_token) {
                edgeFunctionBody.userAccessToken = session.access_token;
              }
            } catch (e) {
              console.warn('Could not get auth session for test mode override:', e);
            }
          }

          // Process combined payment via Edge Function
          const processResponse = await fetch(`${SUPABASE_URL}/functions/v1/process-square-payment`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(edgeFunctionBody)
          });

          const processResult = await processResponse.json();

          if (!processResult.success) {
            // Update event request with payment failure
            await fetch(`${SUPABASE_URL}/rest/v1/event_hosting_requests?id=eq.${eventRequest.id}`, {
              method: 'PATCH',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                deposit_status: 'failed',
                deposit_error: processResult.error
              })
            });

            throw new Error(processResult.error || 'Payment failed');
          }

          // Update event request with payment success
          await fetch(`${SUPABASE_URL}/rest/v1/event_hosting_requests?id=eq.${eventRequest.id}`, {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              deposit_status: 'paid',
              square_payment_id: processResult.paymentId,
              square_receipt_url: processResult.receiptUrl
            })
          });

          // Update payment records with success
          await fetch(`${SUPABASE_URL}/rest/v1/square_payments?reference_id=eq.${eventRequest.id}&reference_type=eq.event_hosting_request`, {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              status: 'completed',
              square_payment_id: processResult.paymentId,
              square_receipt_url: processResult.receiptUrl,
              updated_at: new Date().toISOString()
            })
          });
        } else {
          // Record $0 deposit if code was used to waive reservation
          if (reservationCode) {
            await fetch(`${SUPABASE_URL}/rest/v1/square_payments`, {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                payment_type: FEE_TYPES.RESERVATION,
                reference_type: 'event_hosting_request',
                reference_id: eventRequest.id,
                amount: 0,
                fee_code_used: reservationCode,
                original_amount: reservationOriginal,
                status: 'completed'
              })
            });
          }
        }

        // Save selected spaces to junction table
        if (selectedSpaceIds.length > 0) {
          const spaceLinks = selectedSpaceIds.map(spaceId => ({
            event_request_id: eventRequest.id,
            space_id: spaceId,
            space_type: 'requested'
          }));

          const spacesResponse = await fetch(`${SUPABASE_URL}/rest/v1/event_request_spaces`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(spaceLinks)
          });

          if (!spacesResponse.ok) {
            console.error('Failed to save requested spaces');
          }
        }

        // Get selected space names for email
        const selectedSpaceNames = selectedSpaceIds.map(id => {
          const space = allEventSpaces.find(s => s.id === id);
          return space ? space.name : id;
        });

        // Send admin notification email
        try {
          await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              type: 'admin_event_request',
              to: 'alpacaplayhouse@gmail.com',
              data: {
                first_name: firstName,
                last_name: lastName,
                email: email,
                phone: phone,
                organization_name: getValue('organization_name') || null,
                has_hosted_before: document.getElementById('has_hosted_before').checked,
                event_name: getValue('event_name'),
                event_type: getValue('event_type'),
                event_date: getValue('event_date'),
                event_start_time: getValue('event_start_time'),
                event_end_time: getValue('event_end_time'),
                expected_guests: getValue('expected_guests'),
                is_ticketed: isTicketedCheckbox.checked,
                ticket_price_range: isTicketedCheckbox.checked ? getValue('ticket_price_range') : null,
                requested_spaces: selectedSpaceNames.join(', ') || 'None selected',
                event_description: getValue('event_description'),
                setup_staff_name: getValue('setup_staff_name'),
                setup_staff_phone: getValue('setup_staff_phone'),
                cleanup_staff_name: getValue('cleanup_staff_name'),
                cleanup_staff_phone: getValue('cleanup_staff_phone'),
                parking_manager_name: getValue('parking_manager_name'),
                parking_manager_phone: getValue('parking_manager_phone'),
                marketing_materials_link: getValue('marketing_materials_link') || null,
                special_requests: getValue('special_requests') || null
              }
            })
          });
        } catch (emailError) {
          console.error('Failed to send admin notification email:', emailError);
          // Don't fail the submission if email fails
        }

        // Populate success summary
        populateEventSuccessSummary(selectedSpaceNames, reservationAmount);

        // Success!
        formContainer.classList.add('hidden');
        successContainer.classList.remove('hidden');

      } catch (error) {
        console.error('Submission error:', error);
        showError(error.message || 'Something went wrong. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Event Request';
      }
    });

    function populateEventSuccessSummary(selectedSpaces, totalDepositPaid) {
      // Event name
      document.getElementById('summaryEventName').textContent = getValue('event_name');

      // Event date
      const eventDate = getValue('event_date');
      if (eventDate) {
        const dateObj = new Date(eventDate + 'T12:00:00');
        document.getElementById('summaryEventDate').textContent = dateObj.toLocaleDateString('en-US', {
          weekday: 'long',
          month: 'long',
          day: 'numeric',
          year: 'numeric'
        });
      }

      // Event time
      const startTime = getValue('event_start_time');
      const endTime = getValue('event_end_time');
      if (startTime && endTime) {
        const formatTime = (t) => {
          const [h, m] = t.split(':');
          const hour = parseInt(h);
          const ampm = hour >= 12 ? 'PM' : 'AM';
          const h12 = hour % 12 || 12;
          return `${h12}:${m} ${ampm}`;
        };
        document.getElementById('summaryEventTime').textContent = `${formatTime(startTime)} - ${formatTime(endTime)}`;
      }

      // Expected guests
      document.getElementById('summaryGuests').textContent = getValue('expected_guests');

      // Requested spaces
      if (selectedSpaces && selectedSpaces.length > 0) {
        document.getElementById('summarySpaces').textContent = selectedSpaces.join(', ');
        document.getElementById('summarySpacesRow').style.display = 'flex';
      }

      // Reservation deposit paid
      if (totalDepositPaid > 0) {
        document.getElementById('summaryDeposits').textContent = `$${totalDepositPaid.toFixed(2)} paid`;
      } else {
        document.getElementById('summaryDeposits').textContent = 'Waived';
      }

    }

    function getValue(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : '';
    }

    function showError(message) {
      errorBanner.textContent = message;
      errorBanner.classList.remove('hidden');
      errorBanner.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Mobile navigation toggle
    const siteNavToggle = document.getElementById('siteNavToggle');
    const siteNavMobile = document.getElementById('siteNavMobile');
    const siteNavMobileClose = document.getElementById('siteNavMobileClose');

    if (siteNavToggle && siteNavMobile) {
      siteNavToggle.addEventListener('click', () => siteNavMobile.classList.add('open'));
      siteNavMobileClose.addEventListener('click', () => siteNavMobile.classList.remove('open'));
    }
  </script>

  <!-- Ask bar + Contact form in success view -->
  <script type="module">
    import { initChatWidget, askQuestion, submitUnansweredQuestion } from '../../shared/chat-widget.js';

    let successCurrentQuestion = '';
    let successCurrentAnswer = '';
    let successIsLowConfidence = false;

    await initChatWidget();

    // --- Ask a Question ---
    const questionInput = document.getElementById('successQuestionInput');
    const askBtn = document.getElementById('successAskBtn');
    const answerContainer = document.getElementById('successAnswerContainer');
    const answerText = document.getElementById('successAnswerText');
    const lowConfidence = document.getElementById('successLowConfidence');
    const answerFeedback = document.getElementById('successAnswerFeedback');
    const followupForm = document.getElementById('successFollowupForm');
    const questionSubmitted = document.getElementById('successQuestionSubmitted');

    askBtn.addEventListener('click', handleAsk);
    questionInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleAsk();
    });

    async function handleAsk() {
      const q = questionInput.value.trim();
      if (!q) return;

      successCurrentQuestion = q;
      askBtn.disabled = true;
      askBtn.innerHTML = '<span class="success-loading-spinner"></span>Thinking...';

      answerContainer.classList.remove('visible');
      lowConfidence.classList.remove('visible');
      followupForm.classList.remove('visible');
      questionSubmitted.classList.remove('visible');
      answerFeedback.style.display = '';

      try {
        const result = await askQuestion(q);
        successCurrentAnswer = result.answer;
        successIsLowConfidence = !result.confident;

        answerText.textContent = result.answer;
        answerContainer.classList.add('visible');

        if (!result.confident) {
          lowConfidence.classList.add('visible');
          await submitUnansweredQuestion(q, null, 'low_confidence');
        }
      } catch (error) {
        answerText.textContent = "Sorry, I had trouble getting an answer. Use the form below to send us a message.";
        answerContainer.classList.add('visible');
        lowConfidence.classList.remove('visible');
        answerFeedback.style.display = 'none';
      } finally {
        askBtn.disabled = false;
        askBtn.textContent = 'Ask';
      }
    }

    document.getElementById('successFeedbackYes').addEventListener('click', async () => {
      answerFeedback.style.display = 'none';
      questionSubmitted.textContent = 'Great! Glad we could help.';
      questionSubmitted.classList.add('visible');
    });

    document.getElementById('successFeedbackNo').addEventListener('click', async () => {
      followupForm.classList.add('visible');
      if (!successIsLowConfidence) {
        await submitUnansweredQuestion(successCurrentQuestion, null, 'user_feedback');
      }
    });

    document.getElementById('successFollowupSubmit').addEventListener('click', async () => {
      const name = document.getElementById('successFollowupName').value.trim();
      const email = document.getElementById('successFollowupEmail').value.trim();
      const phone = document.getElementById('successFollowupPhone').value.trim();

      if (!name && !email && !phone) {
        document.getElementById('successFollowupName').focus();
        return;
      }

      try {
        await submitUnansweredQuestion(successCurrentQuestion, email || null, 'user_feedback', name || null, phone || null);
      } catch (e) {
        console.error('Error submitting question:', e);
      }

      followupForm.classList.remove('visible');
      questionSubmitted.textContent = "Thanks! We'll get back to you with an answer.";
      questionSubmitted.classList.add('visible');
      answerFeedback.style.display = 'none';
    });

    // --- Contact toggle ---
    const contactToggle = document.getElementById('successContactToggle');
    const contactBody = document.getElementById('successContactBody');

    contactToggle.addEventListener('click', () => {
      const expanded = contactToggle.classList.toggle('expanded');
      contactBody.classList.toggle('visible', expanded);
    });

    // --- Contact message form ---
    const messageForm = document.getElementById('successMessageForm');
    const formSuccess = document.getElementById('successFormSuccess');

    // Pre-fill the name from the event form if available
    const eventNameInput = document.getElementById('first_name');
    const eventLastNameInput = document.getElementById('last_name');
    const eventEmailInput = document.getElementById('email');
    if (eventNameInput && eventLastNameInput) {
      const fullName = [eventNameInput.value, eventLastNameInput.value].filter(Boolean).join(' ').trim();
      if (fullName) document.getElementById('successMsgName').value = fullName;
    }
    if (eventEmailInput && eventEmailInput.value) {
      document.getElementById('successMsgEmail').value = eventEmailInput.value;
    }

    messageForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = messageForm.querySelector('.success-submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      const data = {
        name: document.getElementById('successMsgName').value.trim() || 'Not provided',
        email: document.getElementById('successMsgEmail').value.trim() || 'Not provided',
        subject: 'event',
        message: document.getElementById('successMsgBody').value.trim(),
      };

      if (!data.message) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Message';
        document.getElementById('successMsgBody').focus();
        return;
      }

      try {
        const response = await fetch('https://aphrrfprbixmhissnjfn.supabase.co/functions/v1/send-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwaHJyZnByYml4bWhpc3NuamZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzA0MjUsImV4cCI6MjA4NTUwNjQyNX0.yYkdQIq97GQgxK7yT2OQEPi5Tt-a7gM45aF8xjSD6wk',
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwaHJyZnByYml4bWhpc3NuamZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzA0MjUsImV4cCI6MjA4NTUwNjQyNX0.yYkdQIq97GQgxK7yT2OQEPi5Tt-a7gM45aF8xjSD6wk'
          },
          body: JSON.stringify({
            type: 'contact_form',
            to: 'alpacaplayhouse@gmail.com',
            reply_to: data.email !== 'Not provided' ? data.email : undefined,
            data: data
          })
        });

        if (!response.ok) throw new Error('Failed to send');

        messageForm.style.display = 'none';
        formSuccess.classList.add('visible');
      } catch (error) {
        console.error('Error sending message:', error);
        submitBtn.textContent = 'Send Message';
        submitBtn.disabled = false;
        alert('Sorry, there was an error sending your message. Please try texting us instead.');
      }
    });
  </script>
</body>
</html>
