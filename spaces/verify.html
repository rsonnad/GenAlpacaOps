<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="../favicon.png">
  <link rel="apple-touch-icon" href="../apple-touch-icon.png">
  <title>Identity Verification - Alpaca Playhouse</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      background: #f5f5f0;
      color: #333;
      min-height: 100vh;
    }

    .site-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 2rem;
      background: #2d3024;
      color: white;
    }
    .site-nav__logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: white;
      font-size: 1.1rem;
      font-weight: 500;
    }
    .site-nav__icon { height: 32px; width: auto; }

    .container {
      max-width: 500px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: #2d3024;
    }

    .subtitle {
      color: #666;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      margin-bottom: 1rem;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: #3d8b7a;
      background: #f0faf7;
    }
    .upload-area.has-file {
      border-color: #3d8b7a;
      border-style: solid;
      padding: 1rem;
    }

    .upload-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    .upload-text {
      color: #666;
      font-size: 0.9rem;
    }
    .upload-text strong {
      color: #3d8b7a;
    }

    .preview-container {
      display: none;
    }
    .preview-container.visible {
      display: block;
    }
    .preview-img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 6px;
      display: block;
      margin: 0 auto;
    }
    .file-name {
      text-align: center;
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.5rem;
    }
    .change-file {
      display: block;
      text-align: center;
      color: #3d8b7a;
      font-size: 0.85rem;
      cursor: pointer;
      margin-top: 0.5rem;
    }

    .tips {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
      color: #555;
    }
    .tips ul {
      margin: 0.5rem 0 0 1.2rem;
      padding: 0;
    }
    .tips li { margin-bottom: 0.25rem; }

    .btn-submit {
      width: 100%;
      padding: 0.85rem;
      background: #3d8b7a;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-submit:hover { background: #2d7a6a; }
    .btn-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 2rem;
    }
    .loading.visible { display: block; }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #eee;
      border-top: 3px solid #3d8b7a;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      color: #666;
      font-size: 0.95rem;
    }

    .result {
      display: none;
      text-align: center;
      padding: 2rem 1rem;
    }
    .result.visible { display: block; }
    .result-icon { font-size: 3rem; margin-bottom: 1rem; }
    .result-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .result-text {
      color: #666;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    .result-success .result-title { color: #27ae60; }
    .result-review .result-title { color: #e67e22; }

    .error-state {
      text-align: center;
      padding: 2rem;
    }
    .error-state .error-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .error-state h2 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      color: #c0392b;
    }
    .error-state p {
      color: #666;
      font-size: 0.95rem;
    }

    .error-msg {
      display: none;
      background: #fef2f2;
      color: #c0392b;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .error-msg.visible { display: block; }

    input[type="file"] { display: none; }

    @media (max-width: 600px) {
      .site-nav { padding: 0.75rem 1rem; }
      .container { margin: 1rem auto; }
      .card { padding: 1.5rem; }
    }
  </style>
</head>
<body>
  <nav class="site-nav">
    <a href="../" class="site-nav__logo">
      <img src="../images/icon-padded-white.png" alt="" class="site-nav__icon">
      <span>Alpaca Playhouse</span>
    </a>
  </nav>

  <div class="container">
    <div class="card">
      <!-- Loading state while validating token -->
      <div id="validatingState" class="loading visible">
        <div class="spinner"></div>
        <p class="loading-text">Validating your link...</p>
      </div>

      <!-- Error state (invalid/expired token) -->
      <div id="errorState" class="error-state" style="display: none;">
        <div class="error-icon">&#128683;</div>
        <h2 id="errorTitle">Invalid Link</h2>
        <p id="errorMessage">This upload link is no longer valid. Please contact us for a new link.</p>
      </div>

      <!-- Upload form -->
      <div id="uploadForm" style="display: none;">
        <h1>Identity Verification</h1>
        <p class="subtitle">
          Hi <strong id="applicantName"></strong>, please upload a clear photo of your driver's license or state ID to verify your identity.
        </p>

        <div class="tips">
          <strong>Tips for a good photo:</strong>
          <ul>
            <li>Use good lighting - avoid glare and shadows</li>
            <li>Make sure all text is readable</li>
            <li>Include the full card in the frame</li>
            <li>Front side of the ID only</li>
          </ul>
        </div>

        <div id="errorMsg" class="error-msg"></div>

        <div id="uploadArea" class="upload-area">
          <div id="uploadPrompt">
            <div class="upload-icon">&#128247;</div>
            <p class="upload-text"><strong>Tap to take a photo</strong> or choose from gallery</p>
            <p class="upload-text" style="font-size: 0.8rem; margin-top: 0.25rem;">JPG, PNG, or HEIC - max 10MB</p>
          </div>
          <div id="previewContainer" class="preview-container">
            <img id="previewImg" class="preview-img" alt="ID preview">
            <p id="fileName" class="file-name"></p>
            <span class="change-file">Tap to change photo</span>
          </div>
        </div>
        <input type="file" id="fileInput" accept="image/*" capture="environment">

        <button id="submitBtn" class="btn-submit" disabled>Upload & Verify</button>
      </div>

      <!-- Loading state during upload/processing -->
      <div id="processingState" class="loading">
        <div class="spinner"></div>
        <p class="loading-text">Analyzing your ID... This may take a few seconds.</p>
      </div>

      <!-- Success result -->
      <div id="successResult" class="result result-success">
        <div class="result-icon">&#9989;</div>
        <h2 class="result-title">Identity Verified!</h2>
        <p class="result-text">Your identity has been successfully verified. You're all set - no further action is needed.</p>
      </div>

      <!-- Review result -->
      <div id="reviewResult" class="result result-review">
        <div class="result-icon">&#128269;</div>
        <h2 class="result-title">Submitted for Review</h2>
        <p class="result-text">Your ID has been uploaded and is being reviewed by our team. We'll be in touch shortly.</p>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://aphrrfprbixmhissnjfn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwaHJyZnByYml4bWhpc3NuamZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzA0MjUsImV4cCI6MjA4NTUwNjQyNX0.yYkdQIq97GQgxK7yT2OQEPi5Tt-a7gM45aF8xjSD6wk';
    const VERIFY_URL = `${SUPABASE_URL}/functions/v1/verify-identity`;

    let selectedFile = null;
    let tokenValue = null;

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI elements
    const validatingState = document.getElementById('validatingState');
    const errorState = document.getElementById('errorState');
    const uploadForm = document.getElementById('uploadForm');
    const processingState = document.getElementById('processingState');
    const successResult = document.getElementById('successResult');
    const reviewResult = document.getElementById('reviewResult');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadPrompt = document.getElementById('uploadPrompt');
    const previewContainer = document.getElementById('previewContainer');
    const previewImg = document.getElementById('previewImg');
    const fileName = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');
    const errorMsg = document.getElementById('errorMsg');
    const applicantName = document.getElementById('applicantName');

    function showState(state) {
      [validatingState, errorState, uploadForm, processingState, successResult, reviewResult]
        .forEach(el => el.style.display = 'none');
      state.style.display = state.classList.contains('loading') || state.classList.contains('result')
        ? 'block' : (state === errorState ? 'block' : 'block');
      if (state.classList.contains('loading')) state.classList.add('visible');
      if (state.classList.contains('result')) state.classList.add('visible');
    }

    function showError(title, message) {
      document.getElementById('errorTitle').textContent = title;
      document.getElementById('errorMessage').textContent = message;
      showState(errorState);
    }

    // Validate token on page load
    async function validateToken() {
      const params = new URLSearchParams(window.location.search);
      tokenValue = params.get('token');

      if (!tokenValue) {
        showError('Missing Link', 'No upload token found. Please use the link from your email.');
        return;
      }

      try {
        const { data: token, error } = await sb
          .from('upload_tokens')
          .select('*, person:person_id(first_name, last_name)')
          .eq('token', tokenValue)
          .single();

        if (error || !token) {
          showError('Invalid Link', 'This upload link is not valid. Please contact us for a new link.');
          return;
        }

        if (token.is_used) {
          showError('Already Used', 'This upload link has already been used. Your ID has been submitted.');
          return;
        }

        if (new Date(token.expires_at) < new Date()) {
          showError('Link Expired', 'This upload link has expired. Please contact us for a new link.');
          return;
        }

        // Show the form
        const person = token.person;
        if (person) {
          applicantName.textContent = person.first_name || 'there';
        }
        showState(uploadForm);

      } catch (err) {
        console.error('Token validation error:', err);
        showError('Something Went Wrong', 'Unable to validate your link. Please try again later.');
      }
    }

    // File selection
    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        handleFile(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length) {
        handleFile(e.target.files[0]);
      }
    });

    function handleFile(file) {
      // Validate type
      if (!file.type.startsWith('image/')) {
        errorMsg.textContent = 'Please select an image file (JPG, PNG, or HEIC).';
        errorMsg.classList.add('visible');
        return;
      }

      // Validate size (10MB)
      if (file.size > 10 * 1024 * 1024) {
        errorMsg.textContent = 'File is too large. Please select an image under 10MB.';
        errorMsg.classList.add('visible');
        return;
      }

      errorMsg.classList.remove('visible');
      selectedFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        uploadPrompt.style.display = 'none';
        previewContainer.classList.add('visible');
        uploadArea.classList.add('has-file');
        submitBtn.disabled = false;
      };
      reader.readAsDataURL(file);
      fileName.textContent = file.name;
    }

    // Compress image if needed
    async function compressImage(file, maxWidth = 2000, quality = 0.85) {
      if (file.size <= 2 * 1024 * 1024) return file; // Skip if under 2MB

      return new Promise((resolve) => {
        const img = new Image();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        img.onload = () => {
          let { width, height } = img;
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob((blob) => {
            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
          }, 'image/jpeg', quality);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    // Submit
    submitBtn.addEventListener('click', async () => {
      if (!selectedFile || !tokenValue) return;

      showState(processingState);

      try {
        // Compress if needed
        const fileToUpload = await compressImage(selectedFile);

        const formData = new FormData();
        formData.append('token', tokenValue);
        formData.append('file', fileToUpload);

        const response = await fetch(VERIFY_URL, {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (!response.ok) {
          // Show error but allow retry
          errorMsg.textContent = result.error || 'Verification failed. Please try again.';
          errorMsg.classList.add('visible');
          showState(uploadForm);
          return;
        }

        if (result.verification_status === 'auto_approved') {
          showState(successResult);
        } else {
          showState(reviewResult);
        }

      } catch (err) {
        console.error('Upload error:', err);
        errorMsg.textContent = 'Something went wrong. Please try again.';
        errorMsg.classList.add('visible');
        showState(uploadForm);
      }
    });

    // Initialize
    validateToken();
  </script>
</body>
</html>
