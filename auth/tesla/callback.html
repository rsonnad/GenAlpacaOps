<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <title>Tesla Authorization</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #faf9f7;
      color: #2d3142;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      text-align: center;
    }
    .success { color: #2d8a4e; }
    .error { color: #d32f2f; }
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e0e0e0;
      border-top-color: #2d3142;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 1rem auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    a { color: #2d3142; }
  </style>
</head>
<body>
  <div class="card" id="card">
    <h2>Tesla Authorization</h2>
    <div class="spinner"></div>
    <p>Connecting your Tesla account...</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://aphrrfprbixmhissnjfn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwaHJyZnByYml4bWhpc3NuamZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzA0MjUsImV4cCI6MjA4NTUwNjQyNX0.yYkdQIq97GQgxK7yT2OQEPi5Tt-a7gM45aF8xjSD6wk';

    const card = document.getElementById('card');
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    const error = params.get('error');
    const stateParam = params.get('state') || '';

    // State format: "accountId" or "profile:accountId"
    const stateParts = stateParam.split(':');
    const isProfileFlow = stateParts[0] === 'profile';
    const accountId = isProfileFlow ? stateParts[1] : stateParts[0];

    async function exchangeCode() {
      if (error) {
        card.innerHTML = `
          <h2 class="error">Authorization Failed</h2>
          <p>${params.get('error_description') || error}</p>
          <p><a href="/residents/cars.html">Back to Cars</a></p>
        `;
        return;
      }

      if (!code) {
        card.innerHTML = `
          <h2 class="error">No Code Received</h2>
          <p>Tesla did not return an authorization code.</p>
          <p><a href="/residents/cars.html">Back to Cars</a></p>
        `;
        return;
      }

      if (!accountId) {
        card.innerHTML = `
          <h2 class="error">Missing Account ID</h2>
          <p>Could not identify which account to connect. Please try again from the Cars page.</p>
          <p><a href="/residents/cars.html">Back to Cars</a></p>
        `;
        return;
      }

      try {
        // Get a fresh Supabase session from localStorage (survives redirects on same domain)
        // Must use same storageKey as shared/supabase.js so we find the existing session
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { storageKey: 'genalpaca-auth', autoRefreshToken: true, persistSession: true }
        });

        // Force a token refresh â€” the access token may have expired during the Tesla OAuth redirect
        const { data: { session: refreshedSession }, error: refreshErr } = await sb.auth.refreshSession();
        // Fall back to cached session if refresh fails (token might still be valid)
        const { data: { session: cachedSession }, error: sessErr } = refreshErr
          ? await sb.auth.getSession()
          : { data: { session: refreshedSession }, error: null };
        const session = refreshedSession || cachedSession;
        if (!session?.access_token) {
          throw new Error('Your session has expired. Please log in again from the Cars page and retry.');
        }

        const fnUrl = SUPABASE_URL + '/functions/v1/tesla-command';
        const fnRes = await fetch(fnUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({
            action: 'exchangeCode',
            code: code,
            account_id: parseInt(accountId),
          }),
        });

        const data = await fnRes.json().catch(() => null);
        const fnError = fnRes.ok ? null : { message: data?.error || `HTTP ${fnRes.status}` };

        if (fnError) {
          const detail = data?.error || fnError.message || 'Function call failed';
          throw new Error(detail);
        }

        if (data?.error) {
          throw new Error(data.error);
        }

        const backUrl = isProfileFlow
          ? `/residents/profile.html?tesla_connected=${accountId}`
          : '/residents/cars.html';
        const backLabel = isProfileFlow ? 'Back to Profile' : 'Back to Cars';

        card.innerHTML = `
          <h2 class="success">Tesla Connected!</h2>
          <p>Your Tesla account has been successfully linked. Vehicle data will appear within 5 minutes.</p>
          <p><a href="${backUrl}">${backLabel}</a></p>
        `;

        // Auto-redirect after 2 seconds
        if (isProfileFlow) {
          setTimeout(() => { window.location.href = backUrl; }, 2000);
        }
      } catch (err) {
        console.error('Token exchange failed:', err);
        card.innerHTML = `
          <h2 class="error">Connection Failed</h2>
          <p>${err.message}</p>
          <p>Please try again from the <a href="/residents/cars.html">Cars page</a>.</p>
        `;
      }
    }

    exchangeCode();
  </script>
</body>
</html>
